    const luckysheet = {};
    
    import {
        gridHTML,
        columeHeader_word,
        columeHeader_word_index,
        flow,
        colsmenuHTML,
        rightclickHTML,
        pivottableconfigHTML,
        pivottablesumHTML,
        sheetHTML,
        columnHeaderHTML,
        sheetselectlistHTML,
        sheetselectlistitemHTML,
        inputHTML,
        modelHTML,
        maskHTML,
        filtermenuHTML,
        filtersubmenuHTML,
        sheetconfigHTML,
        luckysheetPivotTableHTML,
        luckysheetAlternateformatHtml,
        luckysheetchartpointconfigHTML,
        luckysheetToolHTML,
        menuToolBar,
        luckysheetlodingHTML,
        luckyColor,
        keycode
    } from './controllers/constant'
  
    import luckysheetFreezen from './controllers/freezen'
    // import Store from './store'

    // let visibledatarow = Store.visibledatarow;

    //动态表格
    
    var iscopyself = true;

    //各个部分高度设定
    var  copyType = "normal", copysetting = [];

    luckysheet.defaultcollen = defaultcollen;
    luckysheet.defaultrowlen = defaultrowlen;

    var luckysheet_select_status = false,
        luckysheet_select_save = [{ "row": [0, 0], "column": [0, 0] }],
        luckysheet_selection_range = [],
        luckysheet_copy_save = {},
        luckysheet_paste_iscut = false, luckysheet_filter_save = { "row": [], "column": [] };
    
    //条件格式规则
    var luckysheet_conditionformat_save = [];

    var clearjfundo = true, sourcechange = true, config = {}, filterchage = true, luckysheetCellUpdate = [], luckysheetRightHeadClickIs = "column";

    var luckysheet_sheet_move_status = false, luckysheet_sheet_move_data = [], luckysheet_scroll_status = false;
    var luckysheetisrefreshdetail = true, luckysheetisrefreshtheme = true, luckysheetcurrentisPivotTable = false;

    var luckysheetautoadjust = null, luckysheetautoadjustmousedown = 2, luckysheetautoscrollp = [0, 0];

    var devicePixelRatio = 1;
    var luckysheetdefaultstyle = null;
    var luckysheet_shiftkeydown = false;

    luckysheet.flowdata = null;
    luckysheet.currentSheetIndex = 0;
    luckysheet.luckysheet_shiftpositon = null;

    

    luckysheet.jfredo = [];
    luckysheet.jfundo = [];

    luckysheet.modelHTML = modelHTML;

    var luckysheet_CFiconsImg = new Image();
    luckysheet_CFiconsImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZoAAAGACAYAAACUS6SeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAHBbSURBVHja7J13mFxV+cc/M7OzLbvpjZBKQhISUgAhgAlVkADSRcDyky4iYAAhAmpQQtMIiqigYkV6FRHphgBBKSGBkB5IIb1sdrO72dmZ+f3xniGTzZR755a5s/t+nmefTGbuPec7Z8497ynveU9on5m3YJMuwNnAt4B9gA3A48CPgY0UyPxJUzN/MLMShxwDXAMcAmwGbgD+UlBKhzVn/+yqqwrVFwIuBL7tZnkyYwaK98yaNb/QW6uBk4DLgfHAduDfwI+ApYUmOnHiKC+0AowAfgh8EYgAvwF+AMTd1OlQ40nAtcB+QIMpzx8Cy70oT8U6YZvXn2x+tN8A44ByYE/gMmA18B9g7wB9v58AzwNfADoBA4A/m4c5KPwWuCdDef4X6KVVtF1yGPAx8IDpAFUBPYGvAguBucCRAdJ7CvAecA7QA+gKfB94DKgMiMargaeAQ0159gK+BrwNqLUoIUNzFPAw0C3L5+XmAXoZ6B+A7/ZNM3rJxDTgl2Y0UUwmAxdl+WwI8HOtou2OzwFP5+hERIAxwDPAhADoHQvcbxrvTB3PZ4HaImscDmSbmukO/F6rXWkYmgnAP4wxyUd/U/m6FPF7lQO35bnmMuCvQLSIOs/J8/npQIVW03bDPjaejWrgn8boFJPpRks2jgReKfLo+yygLMfnhwCDtPoF29CMMUam2ka6Y8wDVV2k73Uw0NvCdV9F1kOqiqQzX+WvQqfP2gsDkWlcO79nD/McFWuGoAJZk8nHAcBM8x2LwRAL1+ytVTC4hmawqeiFNHaHInPQkSJ8rxob156ILBp2LYLOkAu/kRJ8egEvFWgw+iPT0cXocJTnGSmkMxJ4zfxbDJ1WjKYSQEPTC3jBYW/qJODX+L8WMhuos3H9JDP876NVQnGZLsbIDHOQxt5mVqGTz9rrgTdtjtpmmhGOouQ1NF2MkRnmQh4XATf7/L02GyO3zcY944FZZhSnKG5QDfwLd9ZZJiBOBOU+f4evAAtsjt5eIVhec0oADU21qdDjXMxnKnCJz99tJuIpt97GPcOA14HRWjUUh5QDTyAL0W5xFPAn/J2OXoV4k75j455aZMr9ZK0GSiZDE0XWVQ7zIK+7kI2efvKO+S6f2LinnzFSB2v1UAokAvwNONaDtM82z5KfbDBG7lUb91Qi+2z+T6uDkm5oQsAfkSknrx6+P5kK6ycLkTWYj2zc0x14EYkqoCh2CCGbcL/sYR6XIDve/WQbsu/rKZvP/B+BKVotOjbpHiW/RNx9vZ5OeByZv32vwDQmG51DsOdJYne/TCdk09xXgUcdfN9DkE2urwGbXCjDLsDvEG+5rcCTSASENVqdA8HtwAU+5HOjGWn8psD7RxmDNRZ7TgZ2p+1CyMbjzkZzoR3izyGOSf8DVrrUFv0S2cvWgqyl3Qgs0SrsnaH5IfAdn/LsgrgTH2rzR031FC/ysXzKzSjsBex5sQGci2wa7ZXWIzzZ5vRDW6oR76NJ5v9VprE4wxie/2qVLirXIaFQ/OIu03l52OZ93wTuxd/NytOQdZv/2bzvGMRzNeWY1Aqch2y2djLqvK9Nx/prSKidc8wzprhI2PxoN/qcby/Tg7CzN+BbPhuZ9JHNWTbvmW4qcvr362xGH/sXqCOCrJ9NylKezwB9tUoXjfPM7+4nEdPg2pmOHoXE1itGRIyLbV7/VdNODGvTOXY6xf8rMs/e1AAPoc5Anhia64uU9zDsxSD6VhHL6ds2e2DX5RjNPYd9t/GQeThOymO8r9cqXTSKVfblyNRuZ4vXX4D/LtLpowarcdGGmPYhksXAPkhh671T8zzPVfi/HaNDGJo9LF77EWAlhvetNvK342s/oojlZGe387UWRnN2A4/ebNHQnqpVumhYfY5WIfu18vFzZO3ACt2QfWBW2KeIZVSB9ZhjV5A7MnQVst5rZ3PoNy0akckUL3xWuzU0b1h8OI5FNkLm4zc2jI2dDZUbi1hOG2xce6iFawYg61TdLVx7iemFWaGzVumi8YbFenQcsMLCtS8jrsxWz3tpKIHnCGCLxeusRK7ugkytWYl1dpIZIVmJUhLFXhgrxYKhud3Cw3GUMTZWuQ5ZuM/HEzbSfLqI5fSkjWuten+Nwto5GVNt5P2KVumike8EwTrEYeNDG2k+jkQZz8cyrHtxPlHEMnoLObfKTYPUC2ubYi/Cusfc+9jb6K1YMDTP5xhO1plh5GKb6SYRL7an8/Ss7Cye/gg5LMpvmhCPGatML9JvuQR/3GqVzLyU47dvBE6jMK/A35B9zS/1rH3X/GvV0DxVpDK6zsa1P8H61KHbsxdnaHV239CALGSex65TRNsQd793Ckw7bob+r2X5MU8E1tqsABOQHdfNPpbRbJvTDffZNExuPRyTsTfFp7jPDchO+LVtjMyZyFSYk9HS3VmesSuw546bRDaT3oi/02hbsrQF2XgT2SIQ91FjI/AldC+N66Rv2PwjcpLeoUjI/FkuVMTUD/d7Y1i24GyD4Xrg66bn3gfrIcwxUxDftZnfJxTmUn2jGdJf6sNvmBp16sMRDP6CuKEfjBzP/KbNDlWu+rsNcQqJIGGSbkKmo+wSM52hn5jnyM5xzIcj0+J2PNe2m05nzKbOvyPrML/24XdrQQKIvqVV2FtDkyrsVz1oCN0Ox7EDawuqIIt/PynAyHyALNyudtAwdMXbaAstZkrmHa3KgSJms/dudSRyHfamn6zMOnxq4/pTTaNvx8hsAk5w0ID/BnGaucnD3yuJzOg8o1XXG9r7oVoRJFyL3T0Os5BgnKtdqLxeOTHETfovazVWfOAi4BGbo5+V5jlyOkqYDvzCw+92HTKbo6ihsU3Kz/58m/c9jbhyb3FBQwvZ16mccpk+HIpP/BCJJmAnztl84PNY23tnhSke1fefYW/vn6KG5jO6IN50dsNU/AGZimpyUUtqnWqei2neSuHBFBXFKiHECcFuiKo3kVBJK13UkkQ2XLo5Q3A/cI3+zGpoCuVeYGIBw/ML8cbLpQ44GncW7H+Hu/P0ipKNb2Mv/BLIOscXsLa52y6tZobgPy6k9SIy9ZzUn1kNTaF80ca1CeByxDXVy0q3AZmSW+UgjaeRSAH6cCh+MNnm9X9CHAYaPdTUiERBn+sgjbdMGi36EwfT0Fhp4BIB+F5Wp75akLDgfp1YuBw4nsLOpXkDeyFJFMUp221ce5sZIbT6oKvOjJoKmSFYgkxlN+rPG1xDk8+luIlgbBq0Emaj3jT6D/msbR7i7tlo857j9eFoN6x04VnzAysRBJLIQv1Un0fahcwQrEK2LOjG5oAbmnxeH48he1yKzfQ8lWkdEjn6pSLpewtxVGix+HAcj/2D15Tg8mCekf/7uOs84kTnm3lmBL4G3FkkfXZmCOrMtUu1+vlPmc3r/4UsRl+Y5Ue/MiDfa7UZNfyT3Q9XW4as4RR7J/1LyE7k+5Aw722JmYf8Apyt6yjBYw4Su+8nGT7bioSxCQIJJAzVv9j9wL4G4HTEu7OYzEPWkv6BRDloS9xcc4mbxnvWrPmB+IEmThxVEhW+EGeAi82PNtf0aFYju4UPCtiQ9H/AOGT9ZRUyrfcY4tsflHAtTyIhzi/NUJ79kHAfi1HaIzchMdBmI7H7NpsRxEFmRBMU1iMenFORM6l2GM2HB8DIpD/rQ0x5vmnKcxMyA7M3sJ/RrJTIiAZkHva3WDsGoNisQTzKLg+wxjpjWH6t1bFDUY1sgEyav4TpfScCqLUJWey/LcDl2YRELnikBH77k5EDEsebkeG/KF50en8MzfxJU/WRd4MZM7QMFKschhy/nD6tW4XExTsL2U1/BR3wfKHUVFCxp6Y8nJK6po3BrgK+gawfTQIW6IimKI9kM4rSjvgcsh+qS5bPI8AYZOPjUbgYTXjixFFWGvAIsmbY3fzb9nWuz3Yga7h3k8VrzmEDPhwYbUYBb2L9VNFUg/4dY8hHmbZvCTKd/jNkbcxrRpL97K+eSJifw9XQKIrihH2AZ3MYmXSqEWeWI/HOA60PEl7mc0APYzScHAdebXrs1yBrjlchO/Cd0h/4K3BE2nv1yHTTneR3q+6OBJ8dl6Hhv96MJCfhvdPN2eSOF3cYMJBguLa7a2hGvVb8eHLtYvruqquCo0Wn8YLIQGTxvJeNe3oYw3SIB41gZyRK+TCPvu9Y4DkkUsA/HKTTAwlKO7jN+7XAz5HF/kvzGJvpGYxMOoMR54xvelwHBlu4ZkB7NDRhff4VxXN6Ie7s/Qvszb9s00BZ4bseGpkUEeTQw04O0rg+TwN9CRIMN9dIYYKFfD7nR8fewjWh9vgAhB1WgM3m73qUFF8CPkRCcSR9+ms1eZ6kxR84uhgj46RR39uMCjq5qOsMn75/byQieqGcbuGac5GTTbMZGysLvT20qgbP0HzJDDVTi4A3aSP3GX9GFhsjPuYZMXn+RYs/UFQjrqtjXEhrAuJEUO6StmE+lsP3HdxrdRR4DvBwlvKxEkm6m1bXYBma/mTe8zHDg+F9KfJQB81b2ZVyJObeIS6meRQSIdmNToyf+3VGOrjXztrUaYgXWUUBhqYC8UxTAmBouiCLk/2z9JAecrHHVapcgr1z2N3ieiRqg1J8IsDfkKCPbnM27kQb93OjipN1h6dsXn8iMs1Ynfae1dNydVTjEWU2H57780wDHImc7X2JawpnVgantKzv6TkTWcD1y+g+CNyi1TkQhJCoGV/2uDOzFvixgzQeBg70qUycbIb7MbKTfqCNe44xHeITkb02dgzNp1qFizuiuQsJVJmPb2H/VL72xuv4d3rf28D56GFoQeF2JBCq19zosEP3K5wdHmYHJxHdNxrDYfdY6FQsti42DI1Th4Awspb2JSRWoRuUIxs5601Z/AUY2l4NzVSblfpOZD7ZbWqR8A2fIHPMXnlxJUwet5k8C+F+vD9y+VO8P9FQsc51wNU+5neXGT0XOso4GtnJPx8JTPk8Mv39G2QH+/eQTZfFrl+LjOH42OZ9hyAef1an7pxMnU0GFiLBO59Gotmf5fB7p6ZgLwJqjCH8OhL9e3IpPRhWps5OQjY82SFqKuwhuBcpuRqYiQSi82P6YyCyw/lYJOJzIQ/brchu8G94NB1xGnqEQFA4r4DnxCkRZMf8RmSqtpDRwkU5Pu9sjE91AMp3ObJz/kUkFI1VDjDPoJeG5qtmpBFuMxL5i2k3nnbQkcg0BVuDxMo7gBKJjZZvRDMBeIDCvNN6Il43XVzSer1PRqYt43G2T+jCAhsBK+m+hRIUirWXrNw0Op1dTrcaibc2IUBlvBIJQ/NRAd/FK0OzN7JhNJylw/2AMZB2yTeLVF2Ejo0nhmYvdvfesMu+Zujnhjvm2UUsJyd5t5iRh5vxqm435aoEhz0sXrcKCf2Sj59j7QTWVAPpZiesCvH2mhTAcl6DTKPN8SDtQgzNVezuTt3WIDyNhOSxyiVkD76ZzomzZs0vD8ohbIUYmi7IoVxu7Is50WKh5WPPIpaT07zrkLUUNw6Gewbv134U+7xh4ZoNyJn1VmJZvWw6OHGL+Te49D1SI6QvBLisNyDrS28HwNAcYOGaLsiU3xAL156ETJmFLP5WnUrh4QhnEf847uxmTnENcra4E1YXsZzcyHsp4o3iZGH1Q1OOcZSgkc+9vM50uj60kebjwGUWrlsGvOfCdyhDXOWPd7ls6jwo783GGL7uYprdC7hnq8XremFt8+73sD4D9DbWPeoCZ2juxRuPsd/hbL73gSKWk1t5v2V6qYW4Im9Czm+vQwkiL5F9zrwRmT79bwHp/ibPCDaJBMh06t6e8nA6tYTKvM6MEP9TREPzQ6xPcbo9qju7VH6otoZmKvB/HuVVaXpo/Qu8fzrezMvmYw7uLro9jf2pr1bEjXUJSpC5wTw/a9sYmdQGXiejpbszvB9HTuL8h0PdISTK8lds3vc84tJbTBrMCOzfLqRVyNTZm/i3Zy69Tn2plNqDdEPzVdxZS8lFP2Nsqgss3MOQmGp+nNewAlmQPQz39xHcanqqVvku3niuKe7zF8Q1/jAzihmKHGDmlMuMwdkCbEPW6j6P83A0IVMXv2nzvv+Y0Y9fvfnO5rvOR6ahlwLvINNHM3FnDbdQ9+b7kdM7/aDFzGyUlMdpah/NocB9+HMWwoGIO+A5BfQC6pENcVdT+lyGnLORb+PVPVl6s0pwiSGHdblJ0oyE3XYE+Tn2Y+S9ifP1Rrsd4ieREFde4mTD5q+RdZhpHupLmtHTC6X2QKQMzSP4GwzzLMTdN/8I6rBm2ilxZI71NbI7XrwCXK7ttuIRl5vRsh3eMZ2jeh91nuaDkXFqaEDCAvVCTvz0gmvN6KnkCJthc78i5D0dCT7YkalD5pcz7e5fisyZt6Ao7lNlGkY7zAO+yK4OKVY2czvtLZ7uU5m40au9zCNjcCvw01KtbGG8jTJrZWTT0VlF5iCkV+LOvhtFycQEoKuN6z9C9q5savO+lViAOxxqHe5TmfzZhTRS01vPuKjLj7iJnhua85EFNj/3ZsRNnv+nzzsgXkM3ID75683rp7VYFA+xEyx2CRJBeUOBowCnbUvYpzL5lUvptJjZCDf2+PwT/73aXKcMCTXxlD53RWc6JRS7SCl5rG4c/QTZV5dt0/LLFkYcTj2kluB9nMMluOuq3Ygcq5JrDRYL5XYm7WD6vEyfN5eYMUPLQCklliFhUXKFmlllPs91FsxU05B+PsvnryOL2E54AjjDw7JIIjvy3R411CHR319DTiC2a/j89Ozz1tDMnzRVHzlF8Rcrh3j5sVfsXNMIDs6i8RjybwqsQ/YMnYl4h40w7y9FTvF8GDnfyQkPIftUDvGgDLYi3ndPelTGaxEvvVexvtdnFeJl127WaHVEoyj+86DpQWdbe3gfd6N952rQPocccfBlJGrHKmRT9XRkvdAKCfOdHvRIZxyZhrrNGLVo2mchcjs1VJM5uvJyxJPrYazHKyuUJcbYvEb+Y1NyeaKWrqEZ9dqtgRCiIyufuOqqYOnpmFOOc4AfAT/J0sP200lmE+LheGVQCidL2Pst5D6kzRMNEyeOcivJecg02jNkjorfYurFFW52MoJyhEDpjGhmVhY3//a7cVQpDjchi89XIgvdjUjssB8Ci7V42iX/RaYpT0M2dY4HtgP/An6A/aOqS2dEU8A9XZAd7d9CjkjdYIbaP0aOhu3YtF+DGEJO9fy2/u6uUI1ETE6avwQyRZTQonHEPsZYH2PK91dIWJigHK3RiETJLoWDC7+JbEAdbUa+T5myXG83IbuG5mTgj+waqmFPI+ZiYDZwgY89sj2Rk0ArkXnaKvOXel1ptKa/rmxzTRVyBvd7wJ3I/pXt+rzuxm/bTF2kfvcTkc1/urnUOocjYZ/Sp1CqkMC2ZyF7zK5AQhAp1jkN2dyY3tu7ARiFxFbc4VZGqSm1Yk9NuTi115Y7TR1M0Q85+fN4YCI215DsGJqjkIWzbDHRypGFupcR7xAvF7MipuE7H/cCgR4E/N00mBfizt6iEOLZc4Xpae1AFgSnYf9skqh5YHoCnwKLfOylTSb7/PgQJDDj17Wds8SBpm51yVG3xyBz+UfhfZTersjR4HYX2TtlaQuWIlGmH0GiTPvFOPP8VmQxQM8iUY/9iNE2wjyrDUgAUjunn1aZ9uJMk0YYcSZ4xDxnfpxHdVgbI5POIKPjTDsJWt1xOwHZvW4l8GZ/86N28bAgrjYjJy+iTfcCHjOF7dTI3IdEqh5rHuIa02i/bvRboQb4mTGAc5C9D/ONsbkO66fxOeGcPJ+fTu5z05Wd0zr/tPhsVJtrx3ioJ2Ke1QtN47hX2t8QMwOQ7S9bWzAUOdtmKd7ufWnLLXnq4FHI4XQ9PNTQ34xCFyDTys+b5/S7Fu/vaTqgtwD7me8TZed04DvAHj6UZb4D1U7B5hHSVgzNGGNk7JwhM8ZU4GqPHg6vPWQipnF32jh/M8dI8l5knSsX5UhI8KsyNE69ERfUe32oeIMs9MJ6qR3JW4bP2yynHuY56u+Rpq/gzd6UVKP5EOJp5TVVFvM50MwoeFGePUzaR7R5vxa4A1krytcxvhnYN8fnQ43B8ZoBFmZXbJVhPkMz2FT0QhqRQ5EjkN3uce9jGlk/pjic9B7yGZEQcoZFrgOTTgUOzpPOuRYqhlNCLtSljkxvMxItpIHrj0xHe2HIvT62OYwcVOg1lTbamX2AWbgfqPN6Mm98TXEpcrZUrufkIAv5HBSQOl1utyJko5fpTTux/ieZxtTNKa4ePhbmjx0aRCsN+C/JfubMEItpDEIJKl2MkRnmII29zaxCJ5e1DfXh++9rsR47YQty0qad0eVMZHrKLawcZXAhEiE6m1GMWUijWyk+BOEcD8cLDh+OFBfh7hHRW30sHyfHGFhdAAwBvyDzdGCTxTRqUYJINbJHwo11lgmIR6SbBxT6FRH4Uh/yOANxkLFKHyQszOEu5W+1Q/41xGkhmsVg5qN7ezE01aZCj3Mxn6mIa5wbzMe/0/2cjMRetHn9DHY/otpqQL1qlKBRjgSDdHMN5CjgT7g3Hb3Ip7I414c8PkEceN61cU9n0xH4kgv52/GyPZPMpxpbMTRd8McByFNDE0XWVQ7zIK+7yO/NYIUY8DufysdJ5NRbsO+K+FNjlFNY3c+jhiZYRJD9HF4shJ9tniU3eMyn8vBrF/M6JBjlf2zcU4V4iH3NYd52t0OcbO6psmlooASnz8Jteu9/RNZVvHr4/mR6ZU6ZhvinB9nQLEWm3pps3ncLO0/Ts7oPoUbb9sAQQhZ9vXTtvQR3vI8eR6aPvGaLj+W/DdlC8A8b95QBfyH7WqkVfoz9vYPHsatH76b2amjSN2z+EtmZ7PV0wuOm1/Geg3TqETfCVMTZHcYo1JmGvRHx5jrZhUrrhOcQn/MnbI46ppvfZpbF62td+F0OMRX4NRsVPt8Q/3dI5ICtSBj2nwBr2rmhuR3ZSOw1NyJ7q37jII2EeUamI8c0p/ah1LEzFE4lEoLECZsd3LsvEnVkLPacIexGPUmtldZQ2JryRuTsHrvehUcD/0aiU/s1ooki3qw9gTfMSNApnZGtFieZ+vOPdOOb+jF+SG43WzfpYgr2UPKfdZGLFjM9kYkfuWBkwJ1QNM+bwn/aprG5EXEtt4KTqbNzkfDrvdKM68kOe7rVpqJNSpueuMT08k/EflSEUuE6dl9n85K7TKfgYYedqcty/I5PFtHQnGdGh34G//0JslH2/QLuXcjO6CiDbdw30bQTj/hgaL6C7Ozvl9bGnWmjrcnWUX2CnbNVVYiH3anGgP43bH7MG31+IHshi3Be7A24HplacwO3Trd7yRS43fSO99jQTEeiF/Rq0zN5Eti/wDQjyDrfpCy/+zNA33ZoZM7D/6O4I8BfcWc6ui01pvE5xoW0Cpk6G10EIwOynODEcWk54slmtxM9AevbKQo1NNcgZwb1S3uvkzFwBzuog/dnqYM9U8972DTMxWAYEqrCTaYi4dfdws1jVF9F5o4bPGoU7HIMO9eCMo06n8O+e3sI2QF9Up5ORrHqnJcU6zuVA4+aDoKbsw7P457rbyGG5iKKd4zJN3G2Z2mFKbuPCpgJsEIhLs4HI+u/2fJ9jsLc8O8i93pkL+AHYazvfv8IcS3Oh52T1I50sXJcnaMgnUwruMlMY2zcds8uZI0m3znuvcwUgJ355pvJHxEBvN+RXgysPkersLb29nNkethqD3e8S9+juxmBu+mWXYih2aeIv2UFzjdBf4qsI8/1QF8hI5qryb1Bv5DOpdVtKyeHkcUgKw/HsViba/2NDWPjVkM+BXENdhsvjguYZYyNm1FYC5k6O9TCNQOQ9TQrPahL2NU1OxedaX9YeY42IJ5GKyxc+zLiymw1QrcbI+XeJt8DXC6bQgzNpiL/nm7kvx6ZUnrXZW3dPHre+yFLGr0tPu9WO/a9w4iXTL6H4yjsue5dh4Txz8cTLhT6Fab3ZwerD2+jR5X4ddPguGVsCjE0Vr2/Rpk/K70bq7THc1byPXR1iCPEhzbSfJzsC/XpLMOZF2dqRPYq7m7UdmJonijib/km7nhipQzWUbi7HaMQQ7PW4nXDkDiPVgyNVf4RRuZib87xcEzG/kFmScSL7ekc12zE+eLpZUhkVDvUYX0+vdHDyjzbjBK3upBWIWs004v0EC/B+hEJpcRLOcq0ETkTpRBvu9+QfS0t9ax9F2fhZAYaI2N3usrq81HI6OARZCG5GHzf5fTqgC8iWweKZWhuxr+QQ+ksBS5Pzdldj3jNpJ+SuA3ZA/JOgRnEzdD/tSyjpBNtWNlsFvUX2AsTU4csgltdpHM6tRdBDgSbgUwnXofENLsI2czZz7zvtAIUskZzH+5551llg+m4tNfTOG8A/q9NvW5E3EdfdjhaujvLM3YF9jYntmUIspPebjTj/2F902ghI5qkMc434e802mbTCXSbejOL8aILaRViaB5Fjhvx+3k/Dlid7tXxR8RN7VDkZL1ZOD8LvhGJI/R7Y1i24M7GvQvMg2fXyBxnHpBzLN7jZI0mjIT4ONmHH7RQ9+YbkUV/P4IepkbHS2jf/AVx705tiHvTYYcqffS+DXG2iCCOJTfh7ATO4abhs3vMxCzzPFsdmRY6ao8BPzAdoj7YC2VzpBkNRm3csx3nRz53ZvcNsFvTOpNuhOMp1L35DvO8f9+H5yDV9i+B3d0HW3A/JEUdsoPfLQ4yFciOkalH9qTMtjkCcDJ19nWfjIwTQ5NqwLribVSIFtM7fYeOQczFaZL0Hv515J5Gs0NPJEK7XSPzimlAttto8JyGoIkjXlxWOcN0RO0YmU3IXjcnhjuMxC87wuP65eSolOvM836Jx8/7yellWYqHVV2PPf/6BmNk3iigYXZiaM7zsUycxDpLGq1Pe6QtbtJ/GSVI/ABZm7HDv81IJjXSt7qfw89YZ99GNiXaOVr8E2R3/lsO8z7NByPjZEST3rl80CNtqfbkxbYWuNSws/em0fRSZhU4AnCyRrOfj2VS5UIP5GwPeuGpSn2/tuuB4xSb1z+NbMRN73wFzdDcaEYydsLofwB8HljgQv6n+/Q9dzi8P46sJb7ggbZrMz3vpWhorM5xNpqRzEwHIwAnazRVPpbJHBfSSM2pznNR1604C/qoeEc/G9c+ikx/txTQs64HWj3+LqmI2XYjWs9CYpOtdknHCJ9+u/tcSKPFdDbecvl5z7ifsRQNjZWGsNH0vv7j0Ag4MTQrfSwTt85lr0MWMd1YsP8d7q0nKO5jdc3jfsRDMlOUAiuGxg+PscsRT067I7RjXR5thXz67e52KZ1UZ9yNzuX9uZ73UjQ0v87zeZOx1C/luMbK5rbN2Ntc15YXfSqPjTiLvNqWDeYBXOUgjaeRxcYkSlCxcujZH5AplmwbnK0cK+3HtJndEzL/gKynNLmsww+Pyg+Aj11Mb7MxNssdpPFPZF0m6ZahsdJwJHwYNv4xxzD9FPLPPf6N3HsPms0D5sQZ4Kd4u+ET0wCcj/uBOpebyldIb/QN7IVOUYrD9DwN1m+QUO+5fkcr0y7/8+G71Nn83hd6VD+9jmaQwJu9MKkQY4Xsb3sL2SeWMy6fXUOTL0ZTE95vxkuaxvUbSCiXTUbXn5AF+OctNtCnGGPyH2Og4ubBuxeJYup0V/Ji0+Bu9qgc3jaVwytvsXnYP9pgnjFQjSi5WOnCs+aUTchRDq9m6KxdieytytexvN70sLOxDH+OILHSwCeQKbYbPBxpP4Q3mz1TMxdnWmzfCh2NfcGm0V5iRpN5n3e7YbjvJ/d+i8dw7hFh1dj81fw56R38xfx5xdPIPoXhyL6FSmR9qFva667m39TrSsQrLv11F/N5Ajnk6gfY21dQKG8ha13PWpgmWWWMTB1KPh4Evpejo/c+7jpl5PrNjjT1c7QZGb9pY4S8EdnXdoVpBEchHl9LTFvwM9wJsZSPBxC35mwRp1tMx/QhH2YYjkcOEjyMXffxhMwznY1OWZ6xpUhkiEdwP5p8W+aa5/1f5PfMTdUdSwMLu4bmX8gi74VZpluu7LBNx8ysznCNuOMVZl3HYc1upvgScirffWRe/I2ZxukCnK3r7MpVVwXr950xw83U5iCnwP4kw2dbzUjbTxaZv0JoQryNbi3irxNHNmlmOlOlHjmW4iWftGzBvmNCoFoyxMPw76aDm+l5fxuZVbL8vBdysNDFSNjrS4CRxqI9ZR6cjZ59fXcbT8UeTyI7wr9qfn//fvf2y03I0b9XImfJNJppkR9iP4itIiP8CWZ09Q1gr7R26n0tHls8i5xDdZYZKY5GplqfMbMptiNbF2JoUmeJJNv0KIo1YvAH7w3dMchRq4cg6zo34O20nl3qEI+/Xwf8IQmZEfe3kWjEG5Bw+z8OoEF8BOvnxLvCxImjaMf4Prpqx+XZgMSodOUUZLuG5mTE4yt9CmVPZPf3xchC2AXaI7PNT4xhSdEJ+DMSWdfdxdTUFFD7Ndy/bTN1kaqfJ5oer6vOKu284VZKnKDUTzuG5ihkITrbonA5sgD2sumVr/JB/56mMU5fVK80hjD9db5F+Bpkb82diNtzg4+/wTfbGJl0piEB9K7A2z0pIeBck88+iEPHayZ/u2eoRJFF4Z5mOmMR/rk6Tyb7/PgQ5IC8r2vzo42jEkxDM8E0wFY2aPVH5vgm4Z0HUgj4pZkecWvT6UHIAthGMyp7yofyL0c8VHJxGRJT6lxkIc6LsrzPGLx0YzEZmc67xOLwucYYpgvYdRFxPXJu0G0+GJx8xz+cbvTt0EdfUfzDSiM9xhgZO6HoxxhjU+2R7suREzy9iGzQE3HNPMyH8j8Ya+dzfxVZZ/Aifto5bYxM247IvcgZKPkM5gvIZrK2niq9kU1y9/pQnoPyfF6FnMehKEqADM1gYzAKeTgPRfzbIy5rDgFXe1wuEWQPgNfYCe9/IhKmvavLGr5lobx/bQx7Nk41RjMX52L/7JNC6oYbnStFUXwyNL1ML7W/g/RPMo2Um8HmhjrUZJUDgT08zmM29qYXJyFuxn1c1GDlnPjUVOXlWT4fYjGNQfrIKYoamhRdjJEZ5kIeFwE3u6i5t4/l82OP099sjLGdHb/jkfDmg13SYNXxIYSstWTalGs1OGGtPnKKooYGZF3laWCci/lMxb2jQ/3cC3GWD3nMRDz61tu4ZxgS5220C/nbjTI9g92nLq3GNqvWR05R1NBEkXUVLxbC70KCTDplCf6ccZHqxfvBO6bMP7FxTz9jpA52mPct2PcO/KnpPKSwem6PGhpF6eCGJoRsxjzJo7wiSITloxymk0A25fmBn1GIFyJrMB/ZuKe7GZEc4yDfpWbkZvdsjlvYedCR1am/Gn3kFKXjkb6P5pfkjszsBuWIm+6RWDt8LBs3mxHApAAbmsmmPIcAFTbui9rMpxMSg+iryJG7hfAccmzCEzZHHdNNHZpl8fpaF+rPIcjG29dcGtl2QQLFnogEtHwSidSwRpsHRXHX0PyQ3O6rbtIFcdM9lMJPpGtEjhz+MuIyu8O8V4ccWrYdWRM6zaHWQsJyh9g9DIrXlJvR4gsUvkn2eTOafdqmsbkR6yd8Opk6OxfZ9Nkr7bc5md3PU7FDNbJHLNVhqTL15gxjeP6rTYSiuGNozsOfw4nS6YUcOXAohceeiiE7+TPxfReMDFhfe0jnWxQnTHgnZArsHgdpvIQcdvZPm0bheI8NzXR2P4+8sxl9HIVE6bVLBFmPnJSlfj4DjAXWajOhKM4II6fkFYNhuBQZtA3fwz136kKmzr5VxN/z2y6k8Soy7edFvLdC1miOyWBk0kfHz2HfDT8E/Irc65G9ivhsKEq7MzRWNyV+BMy3cJ2dEN1Huvx9pgC3u5heIYZmRBF/z5EupTPTGJt6l/UVskYz1cLo+GXsbeK92WKH4FRtIhTFHUPzhoXrViHn02+2cO1vbBgbN48mvQKJzusmhegr5pknbobAn2WMjZuBUQuZOjvEwjUDkHW/7hauvcSC8UrRWZsIRXHH0OQbAWxA5sHthP2/DmsuyE+49D2+A9zhQfkUskbzdBF/zyddTu914DgXjU0hhsaq99co8+d0hJTOK9pEKIo7huZ5sq9p1Jlerd2DzJKm8X86T89/ugvf4RLENTtkU58VCpk6+xHwcRF+yyYkTL/bzDaj2a0upFXIGs30Ij0bS5AjBRRFcUjKvfl682C1dR89Bdm1XghxJBLAc+zu2bMB+BLOPXouBO62aWTqTONlZS2nEEOzATm/ZwbiJuvXUZazKXzaLoIcFzAe8ebbhriJN6S9vhXZpOkkWkIhazT3IVNj03x8LjaYDtYGbSIUxT1DAxIV4H7E5bgrMkfvdL2h0RiU3yP7Erbg3oa48xBXXrtGZjLW5vJTxrYQ1iMnOV6ARFq2c5LpZcB3beb3CYW7VIeR83dO9qG+FerefKPpAF3qg8ZUHVmizYOiuG9oAFpwtgEu24P7ZZfT/Bqym9uOkalH9nu8ifWYa9sd6twBrLB4bcgYYLtG5gNkHWV1gRq/7pORcWJoUga4K95Gr2hB9l+9o02DonhnaEqB/YE/YO8Aq+3GyLxhs8HzK9ZZxIzOzrd53yxkL8gWhyNDv3AS6yxptNbiTTy+uEn/ZW0WFMVdSvG0weuQkCtWaTRGZlYBPWs/DE0VEv/NrpF5Glmk3+Iw//18/O2cHkXdYkajr3mg7TJk6lhRFDU0tgJpNiJrQzPbvN/J4v3bPP4uXdgZY8wOf0CmeJpc0FDl4283x4U0Uut+81zUdSuy/0tRFDU0toxEI+I1l2kvhNWNeNs9/i73AhNt3jMd8baLu6RhpY+/3QyX0qlDgqq6sWD/O7KHuFEUpYMamrkWrmk2Pf4XsnxudW3Ka0PzRRvXJoDLgRuwvg/ICi/69LttxHqUZytsQKYOVzlI42lkH1ZSmwJFCY6hsfJAJjzWfFeez1uQGFX/znGNlbNwNgMfevxdrE59tSD7XO7yQMNP8X4tKo6sQbkdqHM5sv5WyLk0byDrPXFtBhQlWIYmn6tuE95vcnsAme7IRIMxMs/lSeNhcoe/aQb+z4cG2EoInpRb9kMeaVhsGtzNHqX/thl5eBWaZx5ytEGjzXuOx98TVBWlw2LXvfl+cu9jeAzZO+I1FyFuqJcAo02D8Qqyc32BxR72Gch+nHMRl+lOyHrF86aX78eGvelGR68sn68zjajX+zqeRnbfDwd6ItEMqpCTLFOvu5p/U68rEe+99NddzOcJY8x/AHzqQzm+hThUPEt+j8RVxsjU6eOvKME0NP8yo4kLs0xjXOm6wplZI7g8aP4KJQH8xfxZ03FYc/bPnypo0/pqTr47ddBYW2OzDPgiT11q3+AdVlB5NOKOV1ixeAn4ChKypluGz2PIZt0LcLauo3jMxRdfHBgt99xzj/4gRTA0ABcjJxpegpx/sgF4CgkmuVGL1CZPXfo/Tr57HHIq6KlAD9Mz/w5PXaqnO9rjSTOy/aqpp57Xz1JpFLXxVkrF0NQg0zhHIsEX+yLOAT2R6Z8DTI/4FdNDbyjSd2qrcwgypQMyXbI8cDqfurStzkmm0fROZ67RWWlTB/za/BWDPZCp3QPwbo9SEzKdei+FxwwsFZ19kaC/JyKH25UhzjG5PEIbzAg2E0l2j0QeQyKuP4Ksm6oXYhEMzTDgWmTBONselt7mb4LpSW5HFu1vw8Jax/xJU934Lp7rdIlS0VlcZswoRdWnIFOxtT7k9SXgKiRW3VPtVOcYxP2+d5v3y8m9FtetAJ0HA2eZTt2ZqKOIq+TyOqtEdkx/iMxrd7KRbidzz4emcfQyVL7qVILAvsiaYa2PedYi3oj7tkOd5WZ00dvn3/EE3NtYrOQxNEORhdNrsRdXLFNlucakNcwD/apTCQo/ACqKkG+Fybu96TzJPDfF4EJkmk7x0NDsjxzhO97FfMYjQS33dzFN1emuTsUZRxUx7yPboc4Di6gzQqG+m0pG2q7RDEM2O/byIK8+Ju1Dcb7OoDrd1ak4p6edi+NlYbb0q6KuTyVNtVGSYQgloKo+Rpd1zXT7tIlIq+UgG7280llR1srofqsZ0WctvWrqiYQTxBNhNjTUsnBdXz78dE92tJZ5odPW1F6nUIgxkQj7lpWxRzhMp1CIeDJJXTLJikSCD1pbmR+P2wlb0kWrtDeGpgp41KNGMb2iPYYsvBUaeVh1uqtT8ZGWqggrxnRl3dBaEpHdz+3bQhWfjuhMOJ6kz9J6Bs7bSnmT/1FyOlc1ccK+7/P5oUuIRjLnf8TwBcTiEV5fOox/fjCObU1VvuvsFApxXHk5R0ajRNt+GArRExgaiXBkNMrmZJJnW1qYFYupW5nPpE+dTQPG+ZDnWJyd/6463dWp+MSGwZ14++T+rBneOaORSScRCbFmeGfePrk/GwZ38lXngYOWc9NJj3PE8IVZjUyKaCTOEcMXctNJj3PgoOW+6hwdiXBjdTXHZjIyGegeCvG1igqmVFXRORTSClkEQzMUmOJjvlMobDFbdbqrU/GJT8Z1Y8HE3sTL7IUXjJeFWTCxN5+M6+aLzi+NncP5E2dSUdZq676KslbOnziTk8bO8ccYlpXxnaoqagswGCMiEa6tqqKbGhvfDc1UsNQpcIuoydMuqtNdnYoPrN6nCyvGdHWUxooxXVm9j7fLBl8YOZ8Tx7xPoc1vCDhhzPt8YeR8N+RkXfjZOxLhm5WVjs446RkOc1lVVS4XUJ1dc9nQ1CKbB/3mLOwt+KlOd3UqPrC9WznL93NnNLJ8v25s71buic7+3TZz6n7uxG49db93GNDNcTDwjPOFFaEQ51VWFhQ7qy17hsOcWpHV03ub1l53Dc3x2Ns86BadTN5WUZ3u6lR8YNkB3UmG3ZmiSYZDLDuguyc6v7z/25SF3TlKqiyc4Iz93/ZE59HRKN1dnPI6IhqldzisFdUHQ3N0EfM/2qNrVadSdBq6l7O1r7ueWFv7VtHQ3d1RzYBumxnZd42raY7su8aNUc1ujdWR0Wjg01Qyl/PYIuY/1qNrVadSdDYMqimJdA8c7I23mNvpDotEPPEW26+sTCurD4ZmaBHzH+rRtapTKTp1fSpLIt29e6/zRKfb6Q6NRDzR2S0Uood6oHluaDoXMf/OHl2rOpWi01xbVhLp9q71Zt3b7XR7e2gMdJ3Ge0OjKIoHxMq96YHHKtxNt1N5iyc6O1U4OtV9t8WtMg8NTYa0m7UGu2toiunGt82ja1WnUnQicW+2YkRa3U23Je6NQWxpdTTy2s3jwctAPK3J3cp0h9Zgdw3N0iLmv9Sja1WnUnQqtreWRLqbt3vjje92uhsTCc9+q01J3Z/ptaGZW8T853p0repUik7N5h0lke6KzT080el2usvj3oxp6pNJNnhoxBQxNC8VMf+XPLpWdSpFp8dKb04D7rHK3XTnrBroic73Vw1wNb2F8TjbPRh5zGlt1XgzPhiaZ5Ez6f2m0eRtFdXprk7Fa0OzqtH1EP/lTXHXDdjcVQPY2lTtappbm6p532UD1grMisVcTTMJvOpymkpmQ1OPnCHuNw+YvC2PcFWnqzoVjwklkgx6f4uraQ56fwuhhLv979ZEmGfmunuixTNzx9GacN+p9d+xGPUujmr+29rKKp0288XQANwK+GnWY8BtBdynOt3VqXhM3yX1dPvUnTPpun3aRN+l3vQlZi0Zzodr+rmS1odr+jFr6d5Ok8kYIHZ7Mslfd+xwZaprUzLJQzuyrnepB6cHhmYJcIeP+d4JLC7gPtXprk7FB0a+tp5OW5ztVem0pYWRr633LHh9Evjda4ezaquzSNOrtnbjd68dTjLpeM9L1uHQ+62tPObQ2NQnk/yqqSnXmo8u23hgaEBOafTDa2kuzk+uVJ3u6VQ8piyWYOwLa+i6rrA9gF3XNTP2hTWUxbyd4mmKlfPzF77IwnV9C7p/4bq+/PyFL9IUK/e8TF+IxfhTczOFmO9PEwlub2riU50yK4qhaQJOBzZ4mN8Gk4eT1UzV6a5OxQ9j05Jg3xfXsNc7mylrSVi+Z693NrPvi2ss3+OU7S0V3PnSsTzyzoE0tlgzGI0t5TzyzoHc+dKxbG+p8K1MZ7e2cmNjI/+z6DXWnEzyj5YWbm5sZL0aGX/rf5v/LwGOQ7yX+ric1zrkvJQlLqSlOt3VqTinGcgZ7TKUhD0/qqPvknrW7VXDpv7V1PesIB7d2d+LxBLUbtxBj1WN9FnWQMTaKKbZTZ2JZIgXF4xi1tK9OXjIUsYPWMGQHhupjO5cdmyORVm+qSdzVg5k9vKhNMeibuu0tEayMZHg983NPB0Os19ZGaMjEXqGQnQxscu2JhKsTCT4MB7n7dZWmqw7EmzXKu2doQF4F5gIPIZ7Yefnmp63m42i6lQjEyTmAAdbuTASS9Bv4Tb6LZS2NFYZIV4WItKaJNocLzRv13U2x6K8umgkry4aCUBtZTMVZTF2tEapb670Wucb2DjIb30iwb9bWvi3O79lE7BQq7R7hHP0xCcAt+PMeypm0pjgUaOoOpWgcG+hN0ab41Q2tBZqZOzmXbDO+uZKNjbUFmpk7OZ9D7C5SL/lfeh0tC+GJjXMvRYYDfzeZsE3AX8w916Lt5FQVWdbrrpKa7b//Am4vwj53m/ybm86NwKnAVt91vkOMFWrs7tYCa+6GLgQmAKcCBwJjAeGAF3NNVuB5WZo/ArwDNDghsBRoWlWL10MXDg/Oc2WzlGhaZZ1znenzItanopnJIFvAP8Fvmt+Ty9ZjrjQ3409V9xg69y1k/QfYIx5Vo5G9tZUA7k8DroChfhWrzYjmVutdAJnzZofmIo3ceKodmFo2lbS9L9ElveLhjEcD1Kc3fl2SNc5wlTwY035zQKuBpZp+11SJIBfmr8eQJe2F8Sj4fDy/bqNbexafmhrNDwyGQ7tmQzJdaEkdaFEcnVZLLGgemvszSHvbX4/EsvoHlUHbPJSZ2U0Fj51/Dtj9+y69dDKaGxkWTixZziU7AKQSIbqWhPh1c2x6II1dV3ffOy9A95vjkW90AmwCsg6RL+npiYMHGgM0ThgEJDaDLQF+AR4H3j5rqam9z6IxzPF2on50JGzrNN0AtqVW5wVQzPMTNecDWSL+93b/E0ALkY8Nh5AdqsXey3hOGTaqRm4FHguYL/B54Dn0yodwKnAJOAY7C2gKsFhU3oj+9rXhnQz9e9CIFcQsPHACXW9K1kzvHYF8Dvg7kl/W77FD533fPXPtnTu3Xsdh+298DOdF9//f1v8KNx7amqs6pwAnAlwWVXVTp0NDVt8qge2dQKf6TRGqOQJ7TPzlmyfVSIbAaeQ4RAii7Qgu9Z/RI51hfmTsk+JjnrtViffr4cZFaSOON5mpgoKWmTMpbPAdZHPAS+wc8qsLRsLNjYzZmhT78cIOn/9DAHfBm7K8TvnYyvwA+DXuXq6OevnzMrA6OSwZifPkX86czxDFqbOfNNZClNn2ZwBhgJvmpGMk22+5cA1Jq1hRfh+J6UZGczrEwM0knkhTyXsaa4Zr016SVIDPAH8ykFjg7n3LuBxk6bqVJ0lRSZDsz/wusuN23hk3WF/H79b1Bi5tlxOYYuFfhsZNTalzWDTwTrZxTRPNmkOVp2qs5QNzTBkDaOPB3n1MWn7NbK5FBiZ4f0DgHNKxMiosSlNepnfa18P0t7XpN1LdarOUjQ0VcCjHn+RXsgO+SqPv1dPZF0oG9PJ7SIZJCOjxqa0iJg67mWHahgynVKmOlVnqRmaaYjbndeMxftowz/O05gPAr5TQkZGjU3pcC3iMeg1E8k8Naw6VWdgDc1QxLvML6Z4aPn3RVwJ83E90L2EjIwam+DT39Qrv7je5Kk6VWdJGJqpyOK5X0TxLszDnRaHlt2AG0rMyKixCTZXIzvX/aLa5Kk6VWfgDU0tshnTb84iy3GtDjgF2XlrlW/jrSeHF0ZGjU0wqQTOLUK+52JvzVN1dkydRTc0x5N9x7+XdMJGGHALVCCRje3ec3MJGhk1NsFjMrvu2fKLziZv1ak6A21oji5i/m7mfRmwd4EjqwNL0MiosQkWXyiR50h1dkydRTc0Y4uYv1t590FCNRRCqICRUC729tHIpBub54G9tL0vGsU09ONUp+oMuqEZWsT83cr7JofD1yNwLzTNz3w2Mil6IRGgleKwdxHzHq46VWfQDU3nIubvRt7jgfNcSOc23NkIVcyh9LHa3pd0XfYjb9XZMXUW3dCUOne69D1GuWSwikkcpSM+S2HVqTqD/nBsK2L+TvP+MnC4i3puxLkH3vNFLM8Xtb0v2brsV96qs2PqLLqhWVrE/J3kXYlMd7lJX5xvhLoa2FCEstxACYamaEcsL2Ley1Sn6gy6oZlbxPyd5H0l3px3frUxOE6M57E4P8LWrpE5EjkOVim9uuxn3qqzY+osuqF5qYj5F5r3HsD3PdJUg0yhOWEO4hTgh7FJGZkPta0vKi8XMe9XVKfqDLqheRbYXoS8G03ehXAL3p44dx6wTwkYGzUyweEfQFMR8m0GnlGdqjPohqYeeLAIeT9g8rbL54BveKytDHf2pHhpbNTIBIttwMNFyPchoE51qs6gGxpMoxrzMd8YhS3kh4Bf4M9RzCfhjkebF8ZGjUwwuQVo9TG/1gI7RKqzY+osuqFZAtzhY753AosLuO8s4FAfdf7UJaPmprFRIxNcFgJ3+ZjfXcAC1ak6S8XQgJx66YcXw1wKP2Fzms/lcyBwpktpuWFs1MgEnxuA+T7kMx9n5ympzo6ps+iGpgk4HW/3gGwweTQWcO9eFCe2z624F6zSibFRI1MaNAIn+/AcnVzgc6Q6O7bOohsakCm044B1HuS1zqS9pMD77y1SGQ0G7nMxvUKMzXo1MiXFEuSsEC8anQ0m7SWqU3WWqqEBeBeYiLvTaHNNmu86SGNCEcvpEJfTs2Ns1gNHqZEpOd4BPg984GKaH5g031GdqrPUDU3KMk9Azmlx4o0WM2lMcMES/7eI5TTbgzStGBs1MqXNYlP3Z+DMK6kV+LlJa7HqVJ2lRq6w+M3AtcDvkRha5wDVFtNtAv6OuDC7VUAXAn82lj3kU/kkgdfx7kzwlLF5EejR5rN1yAl6rhqZiy++ODCV75577ukIxqYRCWt0DzAVOBvrZ703IfvNbvWhoVGdHVNn0Q1NunW+EJiCHA52JHIGzBB2HvC1FQkuNwcJi/AM0OCy1mXApHbYEM0BDjIjv6ONcXsOuA74WAcF7Wp0cz7wXeAEM1Idl+U5eh8JbfIs/kfoVZ0dU2fRDU3bHn76XyLL+0Vj/pMbaswPmm4Qu5iP69oYxH+OOqVXQzF0zjr1/Ew6Uz2eo5FoDZ/pnPjEHxqKVKS2ytODDkZ7IxWJ40HVqTo7CqF9Zt6S75phyBTa2Vg/q2W7GfrdhoW1mfmTpmb/8KqrrH4Xz3UyY4ZjnbNOPd+RzolP/MHaWlcWrTamzjwvzw4ydaYoHZ5cI5pKZIPkFKDcZrqdgAuQmGR3Aj9C1ny8IBA6Z516vi86Z516fl6dEyeOKvnyVBSl/ZDN62wo8Kbp0ZY7SL8ccSR40/SQ3UZ1dkydiqKUuKHZH/G0Gu9iPuOBWSZtt1CdHVOnoiglbmiGIR5PfTzIq49J240erursmDoVRSlxQ1MFPAr08jC/XsBjWPcnz4Tq7Jg6FUVpB4ZmGuLf7TVjcRaFWXV2TJ2KopS4oRmKeBn5xRQKm0pRnR1Tp6Io7cDQTAWiPuYbNXnaRXV2TJ2KopS4oalFNuX5zVkmb6uozo6pU1GUdmBojsf6zm836WTytorq7Jg6FUVpB4bm6CLmf7RH16rO9qNTUZR2YGjGFjH/sR5dqzrbj05FUdqBoRlaxPyHenSt6mw/OhVFaQeGpnMR8+/s0bWqs/3oVBSlHRgaRVEURfHU0BTzJLdtHl2rOtuPTkVR2oGhWVrE/Jd6dK3qbD86FUVpB4ZmbhHzn+vRtaqz/ehUFKUdGJqXipj/Sx5dqzrbj05FUdqBoXkWOevdbxpN3lZRnR1Tp6Io7cDQ1AMPFiHvB0zeVlGdHVOnoijtwNAA3ArEfMw3BtxWwH2qs2PqVBSlHRiaJcAdPuZ7J7C4gPtUZ8fUqShKOzA0IKcf+uENNBfnJ0Kqzo6nU1GUdmBomoDTgQ0e5rfB5NHoIA3V2TF1KorSDgwNyFTKccA6D/JaZ9Je4kJaqrNj6lQUpR0YGoB3gYm4O50y16T5rotpqs6OqVNRlHZgaFI93AnA7TjzSoqZNCZ41KNVnR1Tp6IoJURon5m35Ltmb+Aa4Byg2mK6TcDfEVdWS15G8ydNzfzBzEprOT51qTOdJ99tzRvqsObM7191laXbZ516viOdE5/4gzWdM2ZkfPviiy+2Wjc8/93vuecefQKVgp4j38jyHCn2KLNwzWLgQmAKcCJwJDAeGAJ0NddsBZYDc4BXgGeABl+/iRiKC3nqUns6T77bV53GUFw469Tzbemc+MQfGnyuG6XxuyveYLWDZ7UjpqihaVecfHdJyJz4xB9KpUQbkAgCD+rj0mEZCnwPmAz0BdYD/7YzY1EghwJTgdHARuBfyF6srS6lvwdwHXAS0AP4ELgBeEF/cv8NzTDgWnJPofQyfwcBFyFTKPcj8/R+bdBTnRbQ6SrFJieYTkZN2nv9gfNNHf4G8KgH+U5Cgq9Gzf/3Ms/DhcBpwFsO0z8GeDhtdI5J/1/A4cDr+tP7Y2gqgRuB7wLl5r1VSEDE2cBCYLN5vzswAjgYON5UxAtMJbwT+BHg1Zi6ves8AdjTR52KDUa9dmug9GRd6yyM4aYxztYhqjIdoI/MaMBNbkwzMun0A140z+9rBaZ9LPCk0d+WiOkInqS123tDMwx4DBhr/j8LuNkMlxNZ7nkD+CPiyfZFMySdiCwoH4ds2HPbAymfzu7AZaaHAvAf4K4A6gxKeSpKOt8nvyNIOXC9Gd24ybgcn9WYkcfxwEyb6X4BeCKLkUmxj/707pLJvXl/0xCOReZCv2aGsf/K0SimkzDXHmbu3WrSmmXSdot8Oochi9TTkIXsI83rOeazoOgMSnkqweeL5ndvMqPfv5hRuVcca6Pxdpu6PJ93Ms/FUTbSPBJ4yoLx3KRVzVtDMwx4DugDLAIOMEPjQkiaew8w00J9TNrDXBoh5NP5B2BAhnsHmM+CorOQ8lzksk4l+HwbmWb9PDIN2w34OvBfZGrVC/aweF0vD/J+0cI11cA/LBq6wxGvSCuu+s9rdfPO0FQhi3q9zJTMJGCZC3ksM73xJSbtx/IMW/NhRedgk2c2DkPcdIuhM4TsUdnHvM5HCBiFeN6ETRqTXNSpBJ9LgV9lmYHYA++OXggV8Tv/FGixaGyeMqO9XM/7sxaNzFZkel3xyNBMQ+ZF65A1gPUu5rPeVIStyLTPNAdpWdFppZc/tAg6RyELp4uA+UholiE50hgCvI0stH5g/kaZtCabtJ3qVILNd0zDl6vRP6Edfu/FwHlmJG/F2DxpnrO2TLJhZFqBr+JtgNkObWiGIhvzUhV7qYt5VCOLd8uQhXlMXoVM+VjVWWEhrYocIzAvdIaQRcgRadeNRxYzh2ZJYya7rsPsY0ZJITOi+Y5DnUqwuRz4pYWRRXU7/f73I1OGVoxNpTE2x6e9N9EYmU4W7o8jDg16zLiHhmYq4ko4i8LXENrSHXgE2Gb+/o3sHp9l8irED/P7HujMVsHd1jkMcRdtS39TLkPbGJlXybzQu0+aUXGqUwkuVyCu7Famr95qx+XwW+Bii8amwnTmvoSsZT3Lrvt/8hmZR7TaeWdoaoGzzf9vtviDWjEyLwBnIH7pIcSD5QkgFVztbJO3VbzQmY2kyQPgLJd0xnPcMyDN2Aw1r/vneTDa6rRbnkpw+S5y8qkVIxNH9py0Z36H7COz4qVZbkb9z1p8HuKIN+fDWu28NTTHm6HlajPqcMvIZHK9PRBYaf6qkRhaVjnB3OOWznz82+js1GY4XqjOZYhrdT5j8wqZveVSvMeuzg//LrA8Fe/oCQwke3T0XEyxYWSSprf/Ugco0/uQNZu4RWPT2aKR+QYaXskXQ3O0ef2MxR5DoUYmvRKk5kGPtJH2US7qtEIiTefRLuk8A4kGkMvY5DIyq4Azc+g8Uqt0UdkfeBNZTP4EWMPOdTQrXAn83Eb9vIBdXfXbO38GzrVobKwYmW8i0cYVHwxNarf6bB+MzErkMKw3zf/H2UjfLZ12eLNN3k51LgWOyGNschmZI8gcDaCQ8lTcZTQSEuXgtPd6Ix5j+bzGAK4GrMakTxmZ+zpgOf/VjEKcGJu4GR39Tautf4YmtQi9oM1nZWSONVSokakHvowcirXIvLeXDa3ZdBaKlTWeRW3ydkNnIcYmZWSW5tG5l1bponET2b2/voPsg8lmbL6H7Bux2khegIQn8ppkQMv674gbciHGJlV+f9Eq66+hSc1lpkI+9EHcBOuQEPF/IfeimhUjsw3Z95Hyjtli/u1sQ2tbnblYa+EaK/uEvNJpx9iszGNkCtWpuEu+UCjfBu7OYGyuQaJyW20kz/fJyIBM/VmhGPtOHkIcYOycBJtAoj//Saur/4amLY8CJ5veWTkS5uJ5oIsDI3M8/obdnpun8m8E3g9A+Sddvk4JNpcAv04zNlOxvqs/Nd3zZx/1Wg3F8mKRynMJsN3m85bQalgcQ7PNvO6C7DqfmOG6g5G4Wl1cMjLd0j63SrrOfMTIva/kWos9Ia90plyYB1hIbwCyp2Yvl3Uq7vKyxeu+hewNuY6drv5WjMy5+D/dcyv5j6NoYaeLvZ+MN+1PVxv3RBDniXO1uvpvaFJTMiPIvYM23dg4Hcnsbf61E0stXacV7jOjsfTpqVXmPauLqHu3ydsNnanNmANspJkyNkPz6FymVbpoXA80Wrz2ImC6DSPzf8giuN8sRDYyZhs1NCFrJR/4rGucaX96FHBvythcoFXWX0Mz17w+BJlOWm3B2DidLjvU/DvXhtZ0nVb5GzDINPojzGs7niZu6xxG9h3/VozNK1mMTSE6FXeZj+yhanQxzdQ+j/uL+L2eMKOHe5H1wphpI+4z7z/qs56xpv3p6SCNkPk+F2m19c/QpDZ7ncjOoHKNeYyNEyOT2iRqZ7oB08imdFrdCNcJ8fi5xfx9B2txj9rqfMklnY/kMTIryb/P5mGXylNxn1fNb+GGsYmb0XcQ9nksQTaGDkTWbVNHOS/yWce+yHqQG8cShJApzG9rtfXH0DxrhsZ7IpGL/2MayUIeFisL/8eaBrMR2dRolWfMPSmd+egPvAP8Ajlj/DTz+h2LI4p0nc+6oHMv0wPMZWRSB7TlMjb7s+t6TaHlqXjDfxAPy+0O0oibDt8DAflOIeTMl5+ZGYGfI5GS/TxGYLTpSFkxMklgh8Xv9SvsbapVCjQ09ewMwXBdWq/c7jSAVe+y682/D5i8rVKf9uBdZ+H635N5nWSE+QyfdUZy3LPKGJilpveYz9hEXNCpeMdMY2waCjQyZyPuu0FgD2M8XwCuMgZwCnK65evYW2sslFE2jcwUJLCmlfYrhETIvkKrrbeGBsS7JIZ4nH0tbRrAqrGxamS+avKIUdhhTZl0ZhvN5Br1fDHPA+KFziXI4momI3MEuzocLCH7PpuF7IwO4FSn4h2vmWfCjrFpNUYmKFGEOyGx9CZl+fwQYwC83L+1j8mjt8XrrzQzFy/YNDZ3mnsVDw3NEiSQH0i4jCE2jI1VIzPEDFMxP+riAvRm05kpr3wM8llnEpm++yjtuneR0/8yebUtRY6fndPGyJxm0trLBZ2K98ZmssWRZixgRgYkivSYPNcMQyIbeMEAY2T62DAyd6b9/2XTflmdxpyB7HVSPDI0IKc0zkX80p9P60HkMjapHf/5jExv0zPqavKY5kBzNp3prLSQzuoi6JyPzDUPN9MBnwOW50hjGbImsy8y5TfKpOGmTsVbZplnZJsFI/NowLSfbfG6r3iQdwiZ0u9r8fqr0zp36byKvWnMu9CYgZ4amibgdGRH/TAkKOS+aT/W8ey62z517PEbefLYFwn6uLe5/3SceeXk0pniY9ObzPXwLy+SzqQZfXyEtR3/SeQo50XIruYxJq1hLulUvOd18/xkCku0wzTojwVQt9VTW4d4kPcX2Om2n49ryB2Q1M7IMoIcXKh4ZGhSUz7HAetM5XkDWQcAWRAchoSnOdZ8ni+S8tdMGnuZNI8jc/Rhu+TSmeK8LCObley+M7iYOu3wNdNoDXFZp+KPsZmA7EupM9M5LyDrH48FVPMmi9dt8SDvYy1eNxVrAUlnmefFSqzEL2h19dbQgKwbTDRTMrWIO2O6F83T5gFpzJHmZHPPX00ac02a77qoPZfOsGmA90OmlV41f9PMe0sCpNPKb+SHTsV7UmtsXZEjho8F/hdgvcWMdWZlQ+Z12HOCecOisemiVdVdynL0xCcgR8ROMb2uScAKJDLAG2b6J9Xj6Y6sOxxiGsWB5v0YMm/6I/LHTCp0xJBP5wvsdN/ujuwRCqLOTOV5qNE5wCedipLOrchR5pU5rvEq1tlHeT6/Aeux4tKZDRxjjGjXLNdohA2XCe0zM+9vtTcyB3oO2c/baEsTsqP5Nix6Q82flCUG5sxKq9/FF50clqV9v+qqYOmcMUNrt1I4O5+7U81IulOWevkN0p0YDnPY/9n5HPVAYqi1dQZIkH9NxgrjgKfY3fs0DpxEapO2PkeejmjSWYyc4TDFjAaORHa4D0nrEWxFFtfnIJs9n6GwzWpOUJ2K4j6pWGffQ6ad+iKOQM+bjo9XYWg2Ia7/M8wz0oJMH9+GO6fsvo8451yBeNX2Mc/mT7EXckqxYWgms/Ps8fORXb9nmh+5GtkA9QQyBfVgEfWqTkXxn1SsM79ZbEYXXtGARNGerj+xt6Smzj5FQk2AnKrXD9jMznNOUryKrDO86rYQi1NnRddpceqs+Dp1yK+UItanoP1BnyNXDU3b/Rwhcu/xmGkaSMfRgrMamMzGpmg6Lc0973xIiqdTHwxFUQJGuMD7DkPmMV9DPDiCiupUFEUpUUOTYiKyKPg6slAYVFSnoihKiRqaFIciC96z2XkIVxBRnYqiKCVqaFJMAP4J/Bdx3Q0F9HurTkVRlBI1NCkOBP6BhNc4KcANpOpUFEUpUUOT4gBk9+07wCkBbiBVp6IoSokamhT7IRsU30PC2tcEtDxUp6IoSokamhTjkLhI64BLA1wuqlNRFMUHQxP3MN9qJAKxG6hOd3UqiqL4Zmi8DOIYY9ezvZ2gOt3VqSiK4iplPuc3F7gdOSNmfYDLRXUqiqKUmKF5Azmk6J/kjvlVbFSnoihKiRma55BT+v4T8HJQnYqiKCVkaBLA48jxru8F+LurTkVRlBIzNC3A3/D21D3VqSiK0gENzXbg98jpkSsD/F1Vp6IoSokZmi3A3cixxBsD/B1Vp6IoSokZmrXAz4HfAvUB/m6qU1EUJeCGZivQJe3/y4CfAn8CmgP0HVSnoihKgMkVGeAyZI2gHnGpHWF63UFrFFWnoihKiY5o/mH+go7qVBRFKdERjaIoiqKooVEURVHU0CiKoihqaBRFURRFDY2iKIqihkZRFEVRdiWU/E8Fo0LTPgX2MO+tnZ+ctofvSg7Lsp1kZmX6/3bRmfY6WDqfunRXnSffHRydiqIoRRrRXGAa7tXA+QHWqzoVRVFKcUTjwEg9D4SAY5BzU7we0ahOHdEEkilXrPUzu0OQI7yHAzOBKXf8ou+qYuls2B5mwIAYx03eSjwO8Xgo9VE34FFgLHLc+LkTJ47a4YXObdsijB7dxJFHb6OxMUzS3rmzruls2RGiulOCE760lepOCVp2hNws6oJ1Fhsn0ZvPAI42r78MPBTQ76g6lfZEGXAHMMH8/xRgA/DtYgmKhGFHc4jWVohEIB7/7KOngEnm9dmmE3V2AMtUdXqME2eAi7O8DhqqU2lP7JVmZFKGp6iNTUV5gk2byti4sYyqqs8G4kPTGsUUpwWwPFVngA1NH+DwtP8fZt4LGqpTaW/0zvBe16I2ImXQ3BxmyeJKQjtblJ4ZLo0HsDxVZ4ANzalABJgPLDCvTw3g91OdSqnRBTgPuBQYk+HzUIC0HgGcQhKqq+OsXFHBpo0RKisTIEeRt6XVSzGhUB6dmfFdZ97yDL5O3wzNmebfR4CHzesvB/D7qU6llKgBbgamAz8BbkMW/NNJBkTrr4FXgCeAuRUVyZ5btkRYtqySikr/JaYW/8Ph3DqzjAwCV54B1umboRmITO2AeEA8Yl4fDgwI0HdTnUqpMQlZ1O+LeBhNBs4NoM7jgEvS/j8GmBEOw7o1UVpjoVyjC08oiyTZVh8mFttlZJNRZ6mUZ0c3NNciUztzgA/N33vmvakB+m5tdX5QAjo/CLBOxXsOyfDeoQHUeUSG9yaEw5BIiNeZ34amsirBmk/LWbMmSk1NPDXCyaizVMqzIxuak4Bvmdc/Ar5o/m40733LXFNsMumkBHQSUJ2Ku0SyvF9u49piEsvw3g6QqatQEVaRysqguSnM4oVVhMPJlIasOkulPDuiobkQmdYJA38GnjY97qmIf/efzGePmGuLRTadlIBOAqhTcdfA7Ad8BTgggxHJtLhRrDWZPoj77OAMn8UtvuebzmSSwTU1cZYvq2Dt2ijV1Ymi6QyF5C9ZmuVZFENTARwPvAzca3pczyD7PA5B1hEON68vNp+Vm2tfNvdW+PA9rOhMEVSdbSmmTsUbJpvf9PfIsd4nBlTnocBi4DHz7wmloLO8InnCtvoIixdWEo0W32ciVHrl6d2I01T+84D+QNS838181jdtOB8DbjXTOnF2XT+4FnHLO8VMAU0FjjR/LUjcr1ZgS1paq4A/As/aeEid6sToCaJOfNapeDNiCZtRSCbX0+lAP/O6CvEqeyZgvdcw8CBQm9ZGPAp0B5qCrDOZ5NFoWbL7+g3RpuYdIVJrRr5WgDLYvj3M9u0hunZN0LIjUirl6bmheRhxq8zGZuBxxAtigXlvFPCltGtOMu/NB34I/B24ygwVuyOeVZk4Lu0HyEchOke30Zk+LA2Szmx4qVNxl1rgeuBgYDnwY/Nvih5IjKp0RiBurOt81noVEu5oBXA5u+7R6Mfu3o6VwEjESSXQOiPh5MhkkvcS8RChUBKfth19pjMSSV5eXx9p+eTjCgYMaAlaeRbV0PwWuNr8f7lp2NaZXtla4CPT4NUi88rDgYva/IIh4G4zxbPI/F2ILGbvY3ryIWSe8sfAEHPfvTa02tH5OaPzwjw1bUERddrBC52Ku0xBNlnWABOR3fqnszM4aqcs91X6rPNaM5JOsTc7Y+xBZoeE1Ggt8DqTEPHZIWE3nRXlyaM/Xl7JmLFNRKPJ8lgsFITyLLqhuQbxcLjONFiXmQdklRkRPG96XnvmSesIdnXTWw0sND2RF41Vv8nkkUQ2pv3AhlYrOkemTU3YIc5O12IvdTrFTZ2Ku1ycNpKNINOeg9JGNdmaPr8XE65r8/+jzEhrblody1b3VKcFndHy5NimpvDchoYwvXu3xrMYmnhHejhS88k3INGD64GDgHeRRfQPjZHYs4C09wReMmkcArxj0q43ed1g8yGzorOfw/LwWqdbuKFTcZd+ed4Lym9TleG9/gEsz5LVmUzSPxIRF+ukPpGfGZoUjyObhBYAvUzDvR9wCzCtgLSnmV7255CzE3qZEc4Ek1ehuK0zhV86neK2TsWf5ysoZNqf0aI63dcZCukDkO1B+Mj0lucA1ciZKFWIZ9R0G+nebO6pBh5A5qffRxZKP3JBdyad1QXoTO+V/N3onOODTie9Jy90Kt6QLBFNqrP96wxcj2srspN+PbIAd5l5/wbgLgtp/grxvsHcO8ykdaxJ2y3a6vyOTZ3pXG7SWG/S9ENnIXipU1EUxdeh/Xp2hkH5Ttp1cyyk+V5a2pea1zeaNN3GiU4CoJOA6VQURfHN0AD8BdlQNAA40Ly3j4U0U9ccaO5tMml5RaE6CYBOAqhTURTFN0PTAMw2rw8y/46ykOaoNvfMNml5RaE6CYBOAqhTURTFN0MD8LH5d2CGBnwJslP9NPO6raEZ2CYNL7GiMxupe5YXQacd/NSpKIrim6HZbv6NIJ5Og4CNyCL/aOQ0uCfM68vMZ4PMtZG0nrzXWNGZjUibNPzSaRc/dSqKovhmaIaaf9eYxvs2xOvpV+zq095i3tsbuN30vteYz/by4XtY1ZmJlM5hPuu0i586FUVRXKMsx2flyNGyAP9FAmZ+HwmzcQayZtDHfL7OXPMcO6Ml9zb/TkSiGMc8+g6F6mxIuweThp86U9QgwTCDolNRFMU3Q/N50wjWAW8gmwW/j+zl6JLlnjrgl8gu/TfM/7sYY/OKR99BdSqKopSooUkdzvM8srj+ADvdhj9FwqCkFqaHAMcgsZ1+YEYSZ5l7v2zS8qphVJ1KUAlleY2F93HpekUpCUPTF3GprUQW2K8G/sbu0UcjwNeAn5kG9C12TvecwM7Q+V414KpTCRrpoUiyRetNtPnN8z2jTsObRPO8V2bhvvJsn6fF94rabG981Zknn/aos6hkcwYYhITcB1kTqDQ96PHI+fbZzrj+s7nmFXPPYeazkSZNt1GdSlCoy/DehrTX29oYlZTRSPfKzHQA2uY2/88UEWKrDZ2ZjFlDG52ZSH8/li3dROKziMV1DhtGT3Xm+d3ao87ijmhmhd/d7c2Jif3T96G0IscJ3zor/K6Vg1FXT0zs/wVk/WFaWmGMmhV+95MMeTnRn1Fnhgc6o04go07gE5fLuVR0lhyzZs13dP/EiaPckvIAcEHa7/MWsLRNw/I0cDI7p7+eZedx3CDHaqxjp1PIduDJNvksM2lPSKtPD9jQ+ZAZKadYC/yvjXF8AZm6TfEBu54G+whyoF86fw2FksQTIRKJEKFQciGE5rLrqaIvBkFnm/8vRM64ae86AzmiWWJ6Uq8Ch84Kv3uzRSMjD3/43cSs8LvTgUNNGpvZdVOnW+yiE4kabeeU8AQS7Vl1Kk6ZbozCemAWcKUxAulch6yzrTdG5Zo2n8811yw0HYzfAfe3uaYVOc1zlknnSVOfrHIBsq9ss8nvKHYPdf8Vo3OzyWdym88/AM5BNiBvRE7XvSUUgkQilH4Gy5dMo7sZ+HebBrloOjPk1RF0FndEk8VQLEbOOP+MjRsX1SBrA0ea6Zwh7PSWqkMWsueYaZ5/9uw5vGFW+N3/mesd8+TmBzO9vYvOUChEMpm0pdMMc/PqPKX7Wa7pNNjSGQ6HGxKJhHs6n3wy62emHAmHwyQSiULKMy+nnHKKqxW5kPrp8rO0CnHUyMVHiCt7rg7FfebPK3aQO1IGZpT1RQsjuAcAGraHGTAgxtlf3UQ8DmknStabv4RpHLd7pXPbtgijRzdx5NHbaGwM09IS2k1nDlzT2bIjRHWnBCd8aSvVnRI0NYVtl6cXOp2O/G1yCLKfcjgwE5hSZuEBHgZcC6Gzy8urO0WjnYhGKwmHo4RCMiBKJhO9E4lY71iseUIstv3ilpbG7Rs3LnoAuK1nz+F+9byHAddWVFSe06NH7+q+ffegS5daKisriETCvPnmgow6IfkAssHTV53ZyvOQQ0YSjyd6Nzfv6F1XVz9h/fp1F69fv6axtTX2oOnl+Knz+2Vl0bN69uxd3bt3b7p160KnTtU0NcVYtmwd9fXbfSnPjz7aeeROeXk54XCY1tZWamtr2bhx0bBIJPL9aLT8rJ49U797Z6qrqygrk/rZ2pro3djY1LuubtuEtWvXXLxx4/rGLVuWPhiPx29Zu7b7kvr6esrKykgkErS07Nzfu88++xBAyoA70qbOTjHTM98ulqBIGHY0h2hthUgE4jtXHJ9i596xs82U4dkBLFPV6XH9LMthYCqBaaFQeEpVVbfyysquhMORLD3gCOFwhLKySqqqupJIxDs1N2+9oKlpyzc2blx0J/Cjnj2HN2e8+bDm3LJTn2fvgVcC02pqaq8cOHCv6MCB/ams3NVBI5lMEgqFcupMJhN3ImsnnurMV56RSJiysggVFVG6dKlh4MA9iMX2rV6x4tPzPv54ydfr67fd4UhnfiqBH1dVVX934MDB0UGD+lNdvetZbS0tccLhEOGwg/J0yIcfflgJTKuu7nTlgAGDo4MGDaCyspxQKLzbyYbl5WHKy2vp0qWWAQP2oLm5pfqTT1aet3Llx1+fPXv2HcCPxo0b10xpsFfaQ5x6sM8upqGpKE+waVMZGzeWMXhwC7FYBCQKxqQ2l54WwPJUnT7Uz7IsRmYo8GhFRe34Tp16EQ7bc24IhyNUV/egsrJL+fbtG67ZsaP+2I0bF33Zg9HN0HA4/NigQUPHDR8+jKqqCsc6zfTHEg8qScHlGY2WMXToQAYO7BddtGjpNR9/vGRyLBY7zQud4XD48X79BowdOXI4NTWdAlme77///tBQKPTYnnsOHDdy5AiqqysJh/Mf8RMKQSgUprq6khEjhjJgwJ7RBQsWXrN69Yovvv/++2eMGTOmFNa9emd4r2sxBYXLoHlbmCWLKxmy12cjwp4ZLo0HsDxVpw/1M5zByOwPvF5T03t8be0ethvFXRueMmpr96Cmpvd4YJZJ2y32j0ajb4wf/7lx48aNtm1kcukEXNXpVnlGo2WMHj2C/fc/aExlZeUbbuuMRqNvjho1Zuz48WNsGxm/ynPevHn7R6PRN0ePHjduzJjR1NRUWzIyu2sMU1NTzZgxoxk9ety4aDT6xrx58/YPwIPaBTgPOeRuTCZ7GaBG5QjgFJJQXR1n5YoKNm2MUFmZgMwxBlu9FBMK5dGZGd915i3PYOssqH6G2xiZYcBztbV79KmsdK+TVFnZldraPfoAz5k8nDIsGo3+e7/9Duo9cGA/T3TiTvBKT8pzjz16cdBBh/SqrKx83i2d0Wj0hX33HddryJBBlJWVBbI8Fy5cOCwajT6/777jew0e3J+KinLn0z4V5Qwe3J999x3fKxqNPr9w4cJiBi2tQTzIpgM/Qda6hre5Jijn0f8acax4AphbUZHsuWVLhGXLKqmo9F9iytMtQ59jF51ZRgaBK8+A6iy4fobTjEwV8GhNTe9eFRW1riusqKilpqZ3L+Axk1ehVIXD4cf23Xe/nv369fJUJxKPrGCdXpZn9+5dOOCAg3qUlZU94VRnOBx+bMSIUd3799+DSCQcyPJcuHBhFfDoyJH79thzzz6uGUOAsrIy9tyzLyNH7tsDeMzkVQwmIWstfYFuiBvsuQFscI4DLkn7/xhgRjgM69ZEaY2Fco0uPKEskmRbfZhYbJeRTUadpVKeAdRZcP1Mb1WmVVTUjnOz552ph1tRUTsW2XhYKNMGDRo6duDAPQKv0+vy7NWrO3vvPXLfcDj848KnG0I37rnnwLEDB/YnEokEsjzLy8sBpvXvP2jcgAH9XDUyO41NhAED+tG//6CxwDSTp98ckuG9QwPY4ByR4b0J4bBEBojH8d3QVFYlWPNpOWvWRKmpiadGOBl1lkp5BlBnwfUzbEYzQ0Oh8JROnXp5rrRTp96EQuEpBU6hDa2pqb1y+PBhhDyuySmdBU75+Faew4btRW1t5+8WqrOysmrKiBF7U14eDWx5zps3b2hVVdWVw4cP91RneXmU4cOHU1VVfeW8efO8nELLZtHLbVxbTDKFTNkBMnUVKsIqUlkZNDeFWbywinA4mdKQVWeplGeRcL1+pkY0U6uqukWdLFRbJRyOUFXVLcrOc2vs9L6nDhy4V5mThX8/dPpZnpFImOHD9ymLRCLX2f+O4esHDBhUVlVVGfTf/bqBA/cqq6mp9lxnTU01AwcOKQuFQtd59ADvh+wUPyDDQ5ppfrtYazJ9EPfZwRk+i1t8zzedySSDa2riLF9Wwdq1UaqrE0XTKd6Nu/1wpVCentXP8MaNi2ohdLaXUzyZplIgdJbkbZna8vKKcwYO3NN3nYAtnX6X5x579Ka8vOIrdnVGImVfGTx4oGdTZm6U55NPPlkbiZSdNXjwQMJh77vK4XAIKZOyrzz55JNuL65NBp4Bfg/8AziRYHIoEs3iMfPvCaWgs7wiecK2+giLF1YSjRbfZyJUeuXpWf0MA8eXl1d3yrYZ06vebXl5dSfgeBu3Hd+zZ+/qysrywOv0vzxD9OvXv9quzl69eldXVlYEvjx79epT7ccodqdBrKBXrz52yzPVI4ySParudOSMoSpgD8RrJ2hTY2HgwbTOQBnwKM4cTnzRmUzyaLQsWbV+Q5TmHSHCYf9FRcpg+/Yw27eHqChPBK08i1Y/w8DR0Wgn37+xyfNoG7cc3afPHiWhsxjl2atXb9s6e/fu7flalxvl2bdvX397oiEwedrRWWse1BeQYJhD2nzeg10j7wKMoDhurFchkaN/y+7z7v2AAW1tLzuPuQi0zkg4OTKZhEQ8RCiU9F1nJJIsb2wM88nHFYTDySCVZ1HrZxkwtqyswvcaZPIca+OWsZ0715aEzmKUZ21tp3Zbnl27dvFdp8nTjs4pyCa2GuSo7a7A6eyM0p2t91Hp81e7FjmiIsXebQxqeY7ecOB1JiHis0PCbjorypNHf7y8kjFjm4hGk+VpQUaLWZ5FrZ9hYGgk4r8rp8lzqI1bhlZXV5SEzmKUp9m8aLM8q30f0RRSnlVV/s8ymDzt6LzYPMSpRuQUdj2cLltB+72Y0NbJ4ag2BjXbInRcdVrTGS1Pjm1qCtPQECYaTQZFZ1HrZxjoHC7CZKbJs7ONWzqHw2GSyaTtv0Qi6bvOUijPaLRwr7iUgZJgpdb/jOOBLZ2pKMz+jrxsl2e/PO8FZUd/Jqvdn+BRsjqTSfpHIuJinUwGRmdR62fJHAUKMHv2AoIV6ik4JBIJ3/KqqalizJjCTpKOx+M888yijvKzhAOoaQe7nz/fojrd1xkKaf1Mz2ibn41Um4Zxm41bVGcOWlpitnXGYoXH5LM7kkn9tbbGbetsbfW/PE2e2xwmkwxg45JUnR1SZ1HrZxhYGo/731EweS61cYvqzEF9faNtnY2NjSR9HNsnk0kaG+3rbGpq8r08TZ5LURTFFUMzt7XV/2gH8fgOkCilVlGdOdi8eYttndu21fuu0+RpS+fWrXW+6zR5ztUmQlHcMTQvxWLbfc+4pWU7wEs2blGdWUgkkqxZ86ltnevXr/d9RLN+/XrbOteuXevromoyCWvXrrWrU1GUHIbm2ZaWxu2JhH/edolEnJaWxkZkk5NVVGcW1q/fSkPDVts6N2xY39jc7N/oq7l5Bxs2rG+yr3NdEXSus6tTUZRshqZnz+H1kHywuXmrjw/yViD5gORtmaLplLyDqTMeT7Bs2XISibhtnfF468OffLKSeDzug844klfrQ3Z0nnLKKfXxeOtDH3+8wpGbup3R4ccfryAeb33wlFNOqdcmQlHcGdEA3NrUtCXmRy88kYjT1LQlhsTRsYvqbMOKFevZuHF1QToTicT0FSs+bm1qavZcZ1NTMytXftyaSCRutntvMpm8ecWK5a0NDY2e69y+vZEVK5a3JpPJW7R5UBQXDU3PnsOXJJOJO7ZvX+/Dg7yeZDJxZ8+ewxcXcLvvOpFoq4HUuWlTPYsXLyCRiBess7m56Y6FCxen3KM9oaUlxsKFi2lsbLyjEJ1jxoxZ0tTU+PNFixb5orOpqfGOMWPGLNbmQVHcHdEATNuxo36ul1M+zc1b2bGjfi4OT65UnbB163bmz19IY+NWRzqTyeSPVq9eMW/FilWeTKHF43FWrFjF6tUr5hWqs6WlBWDaqlWfzF258tPUXhxXaW1tZeXKT1m9+pN5wDSTp6Iobhqanj2HNwGnNzSs37Bjh/tT0zt21NPQsH4DcHrPnsOdzIH4phMIpM716+v44IOFbNq0yhWdiUTitIUL529etWoN8bh7myPj8QSrVq1h4cL5mxOJxGlOdI4YMaIJOH3Bgg82rV691lVj09oaZ/XqdSxY8MGmZDJ52ogRIxq1aVAUb0Y09Ow5fAlwXH39mnVu9sSbm7dSX79mHXCcycMpnus0eQRKZyzWytKla5g/fwEbN65wVWcsFjvmgw/e37h8+Se0trY6TrC1tZXlyz/hgw/e3xiLxY5xQ+eIESOWxGKxYz/4YM6Gjz9eyY4dzkcdO3a08PHHK/nggzkbYrHYsSNGjFji4vMVyvIaC+/j0vWKUvT6uVusm549h78LTGxoWD+3vn4NiUThjU4iEae+fg0NDevnAhNN2m7hmU6TdmB0xmJxVqzYwJw5y1i0aD5bt67xRGcsFjtk/vx5H8yZM4+GhsL3AjU0bGfOnHnMnz/vg1gsdoibOseMGfNuLBY7dP78ufPmzfuQhobGguK8JRIJGhoamTfvQ+bPnzsvFosdOmbMmHddfpDT3eSyDcHSxWcKHV+WI81CiOZ5r8zCfeXZPk+L7xW18F2KpjNPPu1RZ1HrZ8agambUMWHHjvrbt2z5ONbYuAk7HlSJRJzGxk1s2bI8tmNH/e3ABJdGMplGDK7qdGmEULDOeDxJS0sr27Y18umnm5k/fyVvv72QhQsX8umnCzzXmUgkDly9esXPXn/99daPPlqUChljicbGRj76aBGvv/566+rVK36WSCQO9ELnuHHjliQSiYNWrfrk9jfeeL114cKlNDY2k0gkcm7sTCbFwDQ2NrNw4VLeeOP11lWrPrk9kUgcNG7cOKc6M4Uv2JD2elubhzb1UDak/X9dhjQ2t/l/Jg8TO8PlTI1FQxudmUh/P5Yt3UTis4jFdQ4bRk915vnd2qPOotbPrEJ79hzeDFy7ceOi3zc2brqmsXHzOeXl1dXRaCei0UrC4WgqND2JRIJEIkYs1kwstp2WlsYmSP4duK1A7zJbM17AtclkwpFOCvPacl3n7NkfBUHn95qaGu9dvHjB1KVLF5/ds2fvqt69e9OtWxeqq6soKyv7bHqssbGJLVvqWL9+PRs3rm9OJOIPJBKJW0KhkKc6R48e3VxbW3vt7Nmzf79kyYKpy5aJzr59+9K1axeqqqooK4sYnXGamprYurWOtWvXfqYzHo/fcvDBBy+ur3dlDe0B4IK0h/8tdo2Vtg14Gjg5bXrhWWBL2jUvmYe5j/n/duDJNvksM2lPSM1Smryt8hDwtbT/rwX+16bxeQE4Ju29D4AFaf9/BPhhm3T/GgoliSdCJBIhQqHkQgjNZdczZF4Mgs42/1+IhBpq7zqLWj9Dr732oSWVGzcuqgFOBI4ExiNHgXZN61EtB+YArwDP9Ow5vMFKuo890p07fpH9qN4pV6wF4PAjZ1stUFs621js7K1vUwVnnT056+cPPvAvACqrdpS8zlAoRDKZJBwOk0gkbOkMh8MNiUTiszSc6sxH/wGDHNXPVSs/yZtHLp1p9bQ/cAdwGLAIOXnxjTaX7WOu2Q+YB1wOzG8zw/BN4BpTPx4Brmd3J4pDgNuB4cBMYModv+i7ykp5TblibYVpdA4HVgFnAR+1uawbcs7954y+s8216ZwN3Gx0PgR8Z/v2MHv2j3Hc5K0kEhCPhwYCjyIHyP0POGfixFGbvdS5vSG8qv/AFo6bXEc8DvF4aDedGbJzVWcsFvooGk0y+YSt9OjRSlNTuKDydFPnrFnzi1o/Q9+9fE034H7gWKwdL9oCPAycf/qXN7cYY1GJnEP9lSxziW1pNVb+bKDOiqExlaognUDLhIPfAzmWtGCdFhtGRzrNe6rTBZ39BwxqMcbEM52KouQnDPwCmIz1M6zLzVDx+sce6c5jj3QH+IF5L2oxjTKT5502tBasM+091dmBdK5a+UlqxOKHTkVRchiaQrtr6fcd50Iabl6rOlWn3zoVRclhaHoWeG+ftNdupJEP1ak6g6xTUZQchkZRlCzo+oyiqKFRFEVR1NAoiqIoamgURVEURQ2NoiiKooZGURRFUdTQKIqiKGpoFEVRlHZlaOoKvDc9mJsbaeRDdarOIOtUFCWHoXm0wHsfS3vtRhr5UJ2qM8g6FUXJQhlwFVALfAFrx3a2mgfw9rT3bgX6IefXWwl+mEDOUvieDa2qU3UGWaeiKDkMTR0SPt0JLcC3zJ9XqE7VGWSdiqLkMDQdgrdm7+c4jbPO9jZ9t/BDpznfR1EUxZKh6QLci/WpiTgyNXE5Ow/AKgfuAk6zODWRRA6WuhjrC7WqU3UGWaeiKDkMzQzgTJv3XYwcRXqT+f9U4CKbaXwFOafa6n2qU3UGWaeiKFkIA2cUeO/paa/dSCMfqlN1Blmnoig5DE2XAu/t3mZ6w2ka+VCdqjPIOhVFyWFoFEVRFEUNjaIoiqKGRlEURVHU0CiKoihqaBRFURQ1NIqiKIqihkZRFEVRQ6MoiqJ0BEOzscB716W9diONfKhO1RlknYqi5DA0/yrw3mfTXj/nQhr5UJ2qM8g6FUXJYWguNw9zq8V7WoC/Ajenvfdj4G/sjJabj1bzEE+xoVV1qs4g61QUJQv/PwAlukJhy2ScjQAAAABJRU5ErkJggg==";

    luckysheet.getluckysheet_select_save = function () {
        return luckysheet_select_save;
    };

    luckysheet.setluckysheet_select_save = function (v) {
        luckysheet_select_save = v;
    };
    
    luckysheet.getluckysheet_scroll_status = function () {
        return luckysheet_scroll_status;
    };

    luckysheet.setluckysheet_scroll_status = function (v) {
        luckysheet_scroll_status = v;
    };

    

    var luckysheetdefaultstyle = {
        font: 'normal '+ Math.ceil(10 * window.devicePixelRatio) +'pt 微软雅黑, "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif',
        fillStyle: "#000000",
        textBaseline: "middle",
        strokeStyle: "#dfdfdf",
        rowFillStyle: "#5e5e5e",
        textAlign: 'center'
    }
    luckysheet.luckysheetdefaultstyle = luckysheetdefaultstyle;

    //编辑器qksheet表格编辑所需一些方法
    luckysheet.setluckysheet_pointEditZoom = function(v){
        luckysheetConfigsetting.pointEditZoom = v;
    }

    // 替换temp中的${xxx}为指定内容 ,temp:字符串，这里指html代码，dataarry：一个对象{"xxx":"替换的内容"}
    // 例：luckysheet.replaceHtml("${image}",{"image":"abc","jskdjslf":"abc"})   ==>  abc
    luckysheet.replaceHtml = function (temp, dataarry) {
        return temp.replace(/\$\{([\w]+)\}/g, function (s1, s2) { var s = dataarry[s2]; if (typeof (s) != "undefined") { return s; } else { return s1; } });
    };

    //是否为非编辑模式
    luckysheet.isEditMode = function(){
        if(luckysheet.luckysheetConfigsetting.editMode){
            return true;
        }
        else{
            return false;
        }
    }


    //判断数据类型
    luckysheet.getObjType = function(obj){
        var toString = Object.prototype.toString;

        var map = {
            '[object Boolean]':  'boolean',
            '[object Number]':   'number',
            '[object String]':   'string',
            '[object Function]': 'function',
            '[object Array]':    'array',
            '[object Date]':     'date',
            '[object RegExp]':   'regExp',
            '[object Undefined]':'undefined',
            '[object Null]':     'null',
            '[object Object]':   'object'
        }

        // if(obj instanceof Element){
        //     return 'element';
        // }

        return map[toString.call(obj)];
    }

    luckysheet.func_methods = {
        //单元格数据生成一维数组
        getCellDataArr: function(rangeObj, nullCellType, isNeglectNullCell){
            var dataArr = [];

            if(rangeObj.data == null){
                if(!isNeglectNullCell){
                    if(nullCellType == "number"){
                        dataArr.push(0);
                    }
                    else if(nullCellType == "text"){
                        dataArr.push("");
                    }
                }
            }
            else{
                if(luckysheet.getObjType(rangeObj.data) == "array"){
                    for(var i = 0; i < rangeObj.data.length; i++){
                        for(var j = 0; j < rangeObj.data[i].length; j++){
                            if(rangeObj.data[i][j] != null && !luckysheet.func_methods.isRealNull(rangeObj.data[i][j].v)){
                                dataArr.push(rangeObj.data[i][j].v);
                            }
                            else{
                                if(!isNeglectNullCell){
                                    if(nullCellType == "number"){
                                        dataArr.push(0);
                                    }
                                    else if(nullCellType == "text"){
                                        dataArr.push("");
                                    }
                                }
                            }
                        }
                    }
                }
                else{
                    if(luckysheet.func_methods.isRealNull(rangeObj.data.v)){
                        if(!isNeglectNullCell){
                            if(nullCellType == "number"){
                                dataArr.push(0);
                            }
                            else if(nullCellType == "text"){
                                dataArr.push("");
                            }
                        }
                    }
                    else{
                        dataArr.push(rangeObj.data.v);
                    }
                }
            }

            return dataArr;
        },
        //单元格数据生成二维数组
        getCellDataDyadicArr: function(rangeObj, nullCellType){
            var dataArr = [];

            if(rangeObj.data == null){
                var rowArr = [];

                if(nullCellType == "number"){
                    rowArr.push(0);
                }
                else if(nullCellType == "text"){
                    rowArr.push("");
                }

                dataArr.push(rowArr);
            }
            else{
                if(luckysheet.getObjType(rangeObj.data) == "array"){
                    for(var i = 0; i < rangeObj.data.length; i++){
                        var rowArr = [];

                        for(var j = 0; j < rangeObj.data[i].length; j++){
                            var value;

                            if(rangeObj.data[i][j] != null && !luckysheet.func_methods.isRealNull(rangeObj.data[i][j].v)){
                                value = rangeObj.data[i][j].v;
                            }
                            else{
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }

                            rowArr.push(value);
                        }

                        dataArr.push(rowArr);
                    }
                }
                else{
                    var rowArr = [];

                    var value = rangeObj.data.v;

                    if(luckysheet.func_methods.isRealNull(value)){
                        if(nullCellType == "number"){
                            value = 0;
                        }
                        else if(nullCellType == "text"){
                            value = "";
                        }
                    }

                    rowArr.push(value);

                    dataArr.push(rowArr);
                }
            }

            return dataArr;
        },
        //数组数据生成一维数组
        getDataArr: function(arr, isNeglectNaN){
            var dataArr = [];

            if(isNeglectNaN == null){
                isNeglectNaN = false;
            }

            if(luckysheet.getObjType(arr[0]) == "array"){
                for(var i = 0; i < arr.length; i++){
                    for(var j = 0; j < arr[i].length; j++){
                        if(isNeglectNaN && !luckysheet.func_methods.isRealNum(arr[i][j])){
                            continue;
                        }

                        dataArr.push(arr[i][j]);
                    }
                }
            }
            else{
                for(var i = 0; i < arr.length; i++){
                    if(isNeglectNaN && !luckysheet.func_methods.isRealNum(arr[i])){
                        continue;
                    }

                    dataArr.push(arr[i]);
                }   
            }

            return dataArr;
        },
        getDataDyadicArr: function(arr){
            var dataArr = [];

            if(luckysheet.getObjType(arr[0]) == "array"){
                for(var i = 0; i < arr.length; i++){
                    var rowArr = [];

                    for(var j = 0; j < arr[i].length; j++){
                        rowArr.push(arr[i][j]);
                    }

                    dataArr.push(rowArr);
                }
            }
            else{
                var rowArr = [];

                for(var i = 0; i < arr.length; i++){
                    rowArr.push(arr[i]);
                }   

                dataArr.push(rowArr);
            }

            return dataArr;
        },
        //是否是规则二维数组
        isDyadicArr: function(arr){
            var isDyadic = true;

            if(arr.length > 1){
                var collen = arr[0].length;

                for(var i = 1; i < arr.length; i++){
                    if(arr[i].length != collen){
                        isDyadic = false;
                        break;
                    }
                }
            }

            return isDyadic;
        },
        //获取单个单元格数据，数组第一个值
        getFirstValue: function(data, nullCellType){
            if(nullCellType == null){
                nullCellType = "number";
            }

            var value;

            if(luckysheet.getObjType(data) == "array"){
                if(luckysheet.getObjType(data[0]) == "array"){
                    if(!luckysheet.func_methods.isDyadicArr(data)){
                        return luckysheet.formula.error.v;
                    }

                    value = data[0][0];
                }
                else{
                    value = data[0];
                }
            }
            else if(luckysheet.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null){
                    if(nullCellType == "number"){
                        value = 0;
                    }
                    else if(nullCellType == "text"){
                        value = "";
                    }
                }
                else{
                    var cell_r = window.luckysheetCurrentRow;
                    var cell_c = window.luckysheetCurrentColumn;

                    if(data.rowl == 1 && data.coll == 1){
                        value = data.data;

                        if(value == null || luckysheet.func_methods.isRealNull(value.v)){
                            if(nullCellType == "number"){
                                value = 0;
                            }
                            else if(nullCellType == "text"){
                                value = "";
                            }
                        }
                        else{
                            value = value.v;
                        }
                    }
                    else{
                        if(data.data[0][0].mc != null && data.data[0][0].mc.rs == data.rowl && data.data[0][0].mc.cs == data.coll){
                            value = data.data[0][0];

                            if(value == null || luckysheet.func_methods.isRealNull(value.v)){
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }
                            else{
                                value = value.v;
                            }
                        }
                        else if(data.rowl == 1 || data.coll == 1){
                            var cellrange = luckysheet.formula.getcellrange(data.startCell);
                            var str = cellrange.row[0],
                                edr = str + data.rowl - 1,
                                stc = cellrange.column[0],
                                edc = stc + data.coll - 1;

                            if(data.rowl == 1){
                                if(cell_c < stc || cell_c > edc){
                                    return luckysheet.formula.error.v;
                                }

                                value = data.data[0][cell_c - stc];
                            }
                            else if(data.coll == 1){
                                if(cell_r < str || cell_r > edr){
                                    return luckysheet.formula.error.v;
                                }

                                value = data.data[cell_r - str][0];
                            }

                            if(value == null || luckysheet.func_methods.isRealNull(value.v) || value.mc != null){
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }
                            else{
                                value = value.v;
                            }
                        }
                        else{
                            return luckysheet.formula.error.v;
                        }
                    }
                }
            }
            else{
                value = data;
            }

            return value;
        },
        //获取单元格的逻辑值
        getCellBoolen: function(data){
            var cumulative = luckysheet.func_methods.getFirstValue(data);

            if(luckysheet.func_methods.valueIsError(cumulative)){
                return cumulative;
            }

            if(luckysheet.getObjType(cumulative) == "boolean"){
                
            }
            else if(luckysheet.getObjType(cumulative) == "string" && (cumulative.toLowerCase() == "true" || cumulative.toLowerCase() == "false")){
                if(cumulative.toLowerCase() == "true"){
                    cumulative = true;
                }
                else if(cumulative.toLowerCase() == "false"){
                    cumulative = false;
                }
            }
            else if(luckysheet.func_methods.isRealNum(cumulative)){
                cumulative = parseFloat(cumulative);

                cumulative = cumulative == 0 ? false : true;
            }
            else{
                return luckysheet.formula.error.v;
            }

            return cumulative;
        },
        //获取单元格的日期
        getCellDate: function(data){
            var date_text;

            if(luckysheet.getObjType(data) == "array"){
                if(luckysheet.getObjType(data[0]) == "array"){
                    if(!luckysheet.func_methods.isDyadicArr(data)){
                        return luckysheet.formula.error.v;
                    }

                    date_text = data[0][0];
                }
                else{
                    date_text = data[0];
                }
            }
            else if(luckysheet.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null || luckysheet.getObjType(data.data) == "array" || luckysheet.func_methods.isRealNull(data.data.v)){
                    return luckysheet.formula.error.v;
                }

                date_text = data.data.v;

                if(data.data.ct != null && data.data.ct.t == "d"){
                    date_text = luckysheet.mask.update("YYYY-MM-DD h:mm:ss", date_text);
                }
            }
            else{
                date_text = data;
            }

            return date_text;
        },
        getCellrangeDate: function(data){
            var date = [];

            if(luckysheet.getObjType(data) == "array"){
                if(luckysheet.getObjType(data[0]) == "array" && !luckysheet.func_methods.isDyadicArr(data)){
                    return luckysheet.formula.error.v;
                }

                date = date.concat(luckysheet.func_methods.getDataArr(data, false));
            }
            else if(luckysheet.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null){
                    date.push(0);
                }
                else{
                    if(luckysheet.getObjType(data.data) == "array"){
                        for(var i = 0; i < data.data.length; i++){
                            for(var j = 0; j < data.data[i].length; j++){
                                if(data.data[i][j] != null && !luckysheet.func_methods.isRealNull(data.data[i][j].v)){
                                    var value = data.data[i][j].v;

                                    if(data.data[i][j].ct != null && data.data[i][j].ct.t == "d"){
                                        value = luckysheet.mask.update("YYYY-MM-DD h:mm:ss", value);
                                    }

                                    date.push(value);
                                }
                                else{
                                    date.push(0);
                                }
                            }
                        }
                    }
                    else{
                        var value = data.data.v;

                        if(data.data.ct != null && data.data.ct.t == "d"){
                            value = luckysheet.mask.update("YYYY-MM-DD h:mm:ss", value);
                        }

                        date.push(value);
                    }
                }
            }
            else{
                date.push(data);
            }

            return date;
        },
        //是否是纯数字
        isRealNum: function(val){
            if(val == null || val.toString().replace(/\s/g, "") === ""){
                return false;
            }

            if(typeof val == "boolean"){
                return false;
            }

            if(!isNaN(val)){
                return true;
            }
            else{
                return false;
            }
        },
        //是否是空值
        isRealNull: function(val){
            if(val == null || val.toString().replace(/\s/g, "") == ""){
                return true;
            }
            else{
                return false;
            }
        },
        //是否是错误类型
        valueIsError: function(value){
            var isError = false;

            for(let x in luckysheet.formula.error){
                if(value == luckysheet.formula.error[x]){
                    isError = true;
                    break;
                }
            }

            return isError;
        },
        //获取正则字符串（处理 . * ? ~* ~?）
        getRegExpStr: function(str){
            return str.replace("~*", "\\*").replace("~?", "\\?").replace(".", "\\.").replace("*", ".*").replace("?", ".");
        },
        //阶乘
        factorial: function(num){
            if (num == 0 || num == 1) { 
                return 1; 
            } 
            else { 
                return (num * luckysheet.func_methods.factorial(num - 1)); 
            } 
        },
        //双阶乘
        factorialDouble: function(num){
            if (num <= 0) { 
                return 1; 
            } 
            else { 
                return (num * luckysheet.func_methods.factorialDouble(num - 2)); 
            } 
        },
        //总体方差
        variance: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return sum_variance / count;
        },
        //样本方差
        variance_s: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return sum_variance / (count - 1);
        },
        //总体标准偏差
        standardDeviation: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return Math.sqrt(sum_variance / count);
        },
        //样本标准偏差
        standardDeviation_s: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return Math.sqrt(sum_variance / (count - 1));
        },
        //是否是闰年
        isLeapYear: function(year){
            return new Date(year, 1, 29).getMonth() === 1;
        },
        //2月是否有29
        feb29Between: function(date1, date2){
            var year1 = moment(date1).year();
            var mar1year1 = moment().set({ 'year': year1, 'month': 2, 'date': 1 });

            if (luckysheet.func_methods.isLeapYear(year1) && moment(date1) < moment(mar1year1) && moment(date2) >= moment(mar1year1)) {
                return true;
            }

            var year2 = moment(date2).year();
            var mar1year2 = moment().set({ 'year': year2, 'month': 2, 'date': 1 });
            
            return (luckysheet.func_methods.isLeapYear(year2) && moment(date2) >= moment(mar1year2) && moment(date1) < moment(mar1year2));
        },
        //SQL 查询
        findResultIndex: function(database, criterias){
            var matches = {};
                    
            for (var i = 1; i < database[0].length; ++i) {
                matches[i] = true;
            }

            var maxCriteriaLength = criterias[0].length;

            for (i = 1; i < criterias.length; ++i) {
                if (criterias[i].length > maxCriteriaLength) {
                    maxCriteriaLength = criterias[i].length;
                }
            }

            for (var k = 1; k < database.length; ++k) {
                for (var l = 1; l < database[k].length; ++l) {
                    var currentCriteriaResult = false;
                    var hasMatchingCriteria   = false;
  
                    for (var j = 0; j < criterias.length; ++j) {
                        var criteria = criterias[j];
    
                        if (criteria.length < maxCriteriaLength) {
                            continue;
                        }

                        var criteriaField = criteria[0];
    
                        if (database[k][0] !== criteriaField) {
                            continue;
                        }
    
                        hasMatchingCriteria = true;
    
                        for (var p = 1; p < criteria.length; ++p) {
                            currentCriteriaResult = currentCriteriaResult || eval(database[k][l] + criteria[p]);  // jshint ignore:line
                        }
                    }
  
                    if (hasMatchingCriteria) {
                        matches[l] = matches[l] && currentCriteriaResult;
                    }
                }
            }

            var result = [];

            for (var n = 0; n < database[0].length; ++n) {
                if (matches[n]) {
                    result.push(n - 1);
                }
            }
            
            return result;
        },
        findField: function(database, title){
            var index = null;
                    
            for (var i = 0; i < database.length; i++) {
                if (database[i][0] == title) {
                    index = i;
                    break;
                }
            }

            if (index == null) {
                return luckysheet.formula.error.v;
            }
            
            return index;
        },
        rest: function(array, idx){
            idx = idx || 1;
                    
            if (!array || typeof array.slice !== 'function') {
                return array;
            }
            
            return array.slice(idx);
        },
        compact: function(array){
            if (!array) { 
                return array; 
            }
            
            var result = [];
            
            for (var i = 0; i < array.length; ++i) {
                if (!array[i]) { 
                    continue; 
                }
                
                result.push(array[i]);
            }
                
            return result;
        }
    }

    //颜色 16进制转rgb
    luckysheet.hexToRgb = function (hex) {
        var color = [], rgb = [];
        hex = hex.replace(/#/, "");
        if (hex.length == 3) { // 处理 "#abc" 成 "#aabbcc"
            var tmp = [];
            for (var i = 0; i < 3; i++) {
                tmp.push(hex.charAt(i) + hex.charAt(i));
            }
            hex = tmp.join("");
        }
        for (var i = 0; i < 3; i++) {
            color[i] = "0x" + hex.substr(i + 2, 2);
            rgb.push(parseInt(Number(color[i])));
        }
        return 'rgb(' + rgb.join(",") + ')';
    };

    //颜色 rgb转16进制
    luckysheet.rgbTohex = function(color) {
        if(color.indexOf("rgba") > -1){
            var rgb = color.replace("rgba(", "").replace(")", "").split(',');
        }
        else{
            var rgb = color.replace("rgb(", "").replace(")", "").split(',');
        }
        
        var r = parseInt(rgb[0]);
        var g = parseInt(rgb[1]);
        var b = parseInt(rgb[2]);
     
        var hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        return hex;
    };

    //列下标  字母转数字
    luckysheet.luckysheetABCatNum = function (abc) {
        abc = abc.toUpperCase();
        var abc_len = abc.length;
        if (abc_len == 0) {
            return NaN;
        }

        var abc_array = abc.split("");
        var wordlen = columeHeader_word.length;
        var ret = 0;
        for (var i = abc_len - 1; i >= 0; i--) {
            if (i == abc_len - 1) {
                ret += columeHeader_word_index[abc_array[i]];
            }
            else {
                ret += Math.pow(wordlen, abc_len - i - 1) * (columeHeader_word_index[abc_array[i]] + 1);
            }
        }
        return ret;
    };

    //列下标  数字转字母
    luckysheet.luckysheetchatatABC = function (index) {
        var wordlen = columeHeader_word.length;
        if (index < wordlen) {
            return columeHeader_word[index];
        }
        else {
            var last = 0, pre = 0, ret = "";
            var i = 1, n = 0;
            while (index >= (wordlen / (wordlen - 1)) * (Math.pow(wordlen, i++) - 1)) {
                n = i;
            }
            var index_ab = index - (wordlen / (wordlen - 1)) * (Math.pow(wordlen, n - 1) - 1);//970
            last = index_ab + 1;

            for (var x = n; x > 0; x--) {
                var last1 = last, x1 = x;//-702=268, 3
                if (x == 1) {
                    last1 = last1 % wordlen;
                    if (last1 == 0) {
                        last1 = 26;
                    }
                    return ret + columeHeader_word[last1 - 1];
                }
                last1 = Math.ceil(last1 / Math.pow(wordlen, x - 1));
                //last1 = last1 % wordlen;
                ret += columeHeader_word[last1 - 1];
                if (x > 1) {
                    last = last - (last1 - 1) * wordlen;
                }
            }
        }
    };

    

    luckysheet.ceateABC = function (index) {
        var wordlen = columeHeader_word.length;
        if (index < wordlen) {
            return columeHeader_word;
        }
        else {
            var relist = [];
            var i = 2, n = 0;
            while (index < (wordlen / (wordlen - 1)) * (Math.pow(wordlen, i) - 1)) {
                n = i;
                i++;
            }
            for (var x = 0; x < n; x++) {

                if (x == 0) {
                    relist = relist.concat(columeHeader_word);
                }
                else {
                    relist = relist.concat(luckysheet.createABCdim(x), index);
                }
            }
        }
    };

    luckysheet.convertRowColumn = function (a) {
        if (a.length == 0) {
            return [];
        }
        var b = [];
        for (var j = 0; j < a[0].length; j++) {
            b[j] = [];
            for (var i = 0; i < a.length; i++) {
                b[j][i] = a[i][j];
            }

        }
        return b;
    };

    luckysheet.createABCdim = function (x, count) {
        var chwl = columeHeader_word.length;
        if (x == 1) {
            var ret = [];
            var c = 0, con = true;
            for (var i = 0; i < chwl; i++) {
                var b = columeHeader_word[i];
                for (var n = 0; n < chwl; n++) {
                    var bq = b + columeHeader_word[n];
                    ret.push(bq);
                    c++;
                    if (c > index) {
                        return ret;
                    }
                }
            }
        }
        else if (x == 2) {
            var ret = [];
            var c = 0, con = true;
            for (var i = 0; i < chwl; i++) {
                var bb = columeHeader_word[i];
                for (var w = 0; w < chwl; w++) {
                    var aa = columeHeader_word[w];
                    for (var n = 0; n < chwl; n++) {
                        var bqa = bb + aa + columeHeader_word[n];
                        ret.push(bqa);
                        c++;
                        if (c > index) {
                            return ret;
                        }
                    }
                }
            }

        }
    };

    

    luckysheet.browser = {
        mobilecheck: function() {
            var a = !1;
            return function(b) {
                (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0, 4))) && (a = !0);
            }(navigator.userAgent || navigator.vendor || window.opera), document.body && document.body.clientWidth && document.body.clientHeight && document.body.clientWidth < 350 && document.body.clientHeight < 500 && (a = !0), a;
        },
        iphoneCheck: function() {
            var a = !1;
            return /iPhone/i.test(navigator.userAgent) && (a = !0), !0;
        },
        isWeixin:function() {
            var a = navigator.userAgent.toLowerCase();
            return "micromessenger" == a.match(/MicroMessenger/i) ? !0 : !1;
        },
        isAndroid:function() {
            var a = navigator.userAgent,
                b = (navigator.appVersion, a.indexOf("Android") > -1 || a.indexOf("Linux") > -1);
            return b;
        },
        tabletCheck:function() {
            var a = /ipad|android|android 3.0|xoom|sch-i800|playbook|tablet|kindle/i.test(navigator.userAgent.toLowerCase());
            return a;
        },
        BrowserType: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            var isEdge = userAgent.indexOf("Edge") > -1; //判断是否IE的Edge浏览器
            var isFF = userAgent.indexOf("Firefox") > -1; //判断是否Firefox浏览器
            var isSafari = userAgent.indexOf("Safari") > -1 && userAgent.indexOf("Chrome") == -1; //判断是否Safari浏览器
            var isChrome = userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Safari") > -1; //判断Chrome浏览器
            if (isIE) {
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
                reIE.test(userAgent);
                var fIEVersion = parseFloat(RegExp["$1"]);
                if (fIEVersion == 7) {
                    return "IE7";
                } else if (fIEVersion == 8) {
                    return "IE8";
                } else if (fIEVersion == 9) {
                    return "IE9";
                } else if (fIEVersion == 10) {
                    return "IE10";
                // } else if (fIEVersion == 11) {
                //     return "IE11";
                } else {
                    return "0";
                } //IE版本过低
            } //isIE end
            if (isFF) {
                return "FF";
            }
            if (isOpera) {
                return "Opera";
            }
            if (isSafari) {
                return "Safari";
            }
            if (isChrome) {
                return "Chrome";
            }
            if (isEdge) {
                return "Edge";
            }
            if (isIE11) {
                return "IE11";
            }
        }, //myBrowser() end
        //判断是否是IE浏览器
        isIE: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            if (isIE || isIE11) {
                return "1";
            } else {
                return "-1";
            }
        },
        //判断是否是IE浏览器，包括Edge浏览器
        IEVersion: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            var isEdge = userAgent.indexOf("Windows NT 6.1; Trident/7.0;") > -1 && !isIE; //判断是否IE的Edge浏览器
            if (isIE) {
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
                reIE.test(userAgent);
                var fIEVersion = parseFloat(RegExp["$1"]);
                if (fIEVersion == 7) {
                    return "IE7";
                } else if (fIEVersion == 8) {
                    return "IE8";
                } else if (fIEVersion == 9) {
                    return "IE9";
                } else if (fIEVersion == 10) {
                    return "IE10";
                // } else if (fIEVersion == 11) {
                //     return "IE11";
                } else {
                    return "0";
                } //IE版本过低
            } else if (isEdge) {
                return "Edge";
            } else if (isIE11) {
                return "IE11";
            } else {
                return "-1"; //非IE
            }
        },
        luckysheetrefreshfixednum:null,
        luckysheetrefreshfixed:function(){
            var _this = this;
            if(_this.luckysheetrefreshfixednum==null){
                if(_this.BrowserType()=="FF"){
                    _this.luckysheetrefreshfixednum = 5;
                }
                else{
                    _this.luckysheetrefreshfixednum = 0;
                }
            }

            return _this.luckysheetrefreshfixednum;
        }
    };

    //设备是移动端
    var mobilecheck = luckysheet.browser.mobilecheck();
    if(mobilecheck){
        //去除滚动条
        cellMainSrollBarSize = 0;

        //滑动滚动表格
        var luckysheet_touchmove_status = false,
            luckysheet_touchmove_startPos = {},
            luckysheet_touchhandle_status = false;
        $(document).on("touchstart", "#luckysheet-grid-window-1", function(event){
            luckysheet_touchmove_status = true;

            var touch = event.originalEvent.targetTouches[0];
            luckysheet_touchmove_startPos = {
                x: touch.pageX,
                y: touch.pageY
            }
        })
        $(document).on("touchmove", "#luckysheet-grid-window-1", function(event){
            if(event.originalEvent.targetTouches.length > 1 || (event.scale && event.scale !== 1)){
                return;
            }

            var touch = event.originalEvent.targetTouches[0];

            if(luckysheet_touchmove_status){//滚动
                var slideX = touch.pageX - luckysheet_touchmove_startPos.x;
                var slideY = touch.pageY - luckysheet_touchmove_startPos.y;

                luckysheet_touchmove_startPos = {
                    x: touch.pageX,
                    y: touch.pageY
                }

                var scrollLeft = $("#luckysheet-cell-main").scrollLeft();
                var scrollTop = $("#luckysheet-cell-main").scrollTop();

                scrollLeft -= slideX;
                scrollTop -= slideY;

                if(scrollLeft < 0){
                    scrollLeft = 0;
                }

                if(scrollTop < 0){
                    scrollTop = 0;
                }

                if(Math.abs(slideX) < Math.abs(slideY)){
                    $("#luckysheet-scrollbar-y").scrollTop(scrollTop);
                }
                else{
                    $("#luckysheet-scrollbar-x").scrollLeft(scrollLeft);
                }
            }
            else if(luckysheet_touchhandle_status){//选区
                var mouse = luckysheet.mouseposition(touch.pageX, touch.pageY);
                var x = mouse[0] + $("#luckysheet-cell-main").scrollLeft();
                var y = mouse[1] + $("#luckysheet-cell-main").scrollTop();

                var rowLocation = luckysheet.rowLocation(y), 
                    row = rowLocation[1], 
                    row_pre = rowLocation[0], 
                    row_index = rowLocation[2];
                var colLocation = luckysheet.colLocation(x), 
                    col = colLocation[1], 
                    col_pre = colLocation[0], 
                    col_index = colLocation[2];

                var last = $.extend(true, {}, luckysheet_select_save[luckysheet_select_save.length - 1]);

                var top = 0, height = 0, rowseleted = [];
                if (last.top > row_pre) {
                    top = row_pre;
                    height = last.top + last.height - row_pre;

                    if(last.row[1] > last.row_focus){
                        last.row[1] = last.row_focus;
                    }

                    rowseleted = [row_index, last.row[1]];
                }
                else if (last.top == row_pre) {
                    top = row_pre;
                    height = last.top + last.height - row_pre;
                    rowseleted = [row_index, last.row[0]];
                }
                else {
                    top = last.top;
                    height = row - last.top - 1;

                    if(last.row[0] < last.row_focus){
                        last.row[0] = last.row_focus;
                    }

                    rowseleted = [last.row[0], row_index];
                }

                var left = 0, width = 0, columnseleted = [];
                if (last.left > col_pre) {
                    left = col_pre;
                    width = last.left + last.width - col_pre;

                    if(last.column[1] > last.column_focus){
                        last.column[1] = last.column_focus;
                    }

                    columnseleted = [col_index, last.column[1]];
                }
                else if (last.left == col_pre) {
                    left = col_pre;
                    width = last.left + last.width - col_pre;
                    columnseleted = [col_index, last.column[0]];
                }
                else {
                    left = last.left;
                    width = col - last.left - 1;

                    if(last.column[0] < last.column_focus){
                        last.column[0] = last.column_focus;
                    }

                    columnseleted = [last.column[0], col_index];
                }

                var changeparam = luckysheet.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    top = changeparam[2];
                    height = changeparam[3];
                    left = changeparam[4];
                    width = changeparam[5];
                }

                last["row"] = rowseleted;
                last["column"] = columnseleted;

                last["left_move"] = left;
                last["width_move"] = width;
                last["top_move"] = top;
                last["height_move"] = height;

                luckysheet_select_save[luckysheet_select_save.length - 1] = last;

                luckysheet.selectHightlightShow();
                
                luckysheetFreezen.scrollFreezen();
            }

            event.stopPropagation();
        })
        $(document).on("touchend", function(event){
            luckysheet_touchmove_status = false;
            luckysheet_touchmove_startPos = {};

            luckysheet_touchhandle_status = false;
        })

        //滑动选择选区
        $(document).on("touchstart", ".luckysheet-cs-touchhandle", function(event){
            luckysheet_touchhandle_status = true;
            event.stopPropagation();
        })  
        
        //禁止微信下拉拖出微信背景
        document.addEventListener("touchmove", function(event){
            event.preventDefault();
        }, {
            passive: false
        })
    }

    luckysheet.controlHistory = {
        redo: function (e) {
            if (luckysheet.jfredo.length == 0) {
                return;
            }

            var ctr = luckysheet.jfredo.pop();
            luckysheet.jfundo.push(ctr);
            clearjfundo = false;
            
            if (luckysheet.sheetmanage.hasSheet(ctr.sheetIndex) && luckysheet.currentSheetIndex != ctr.sheetIndex) {
                luckysheet.sheetmanage.changeSheetExec(ctr.sheetIndex);
            }

            if (ctr.type == "datachange") {
                //如果有单元格为null,则对应公式应该删除
                for(var s = 0; s < ctr.range.length; s++){
                    var st_r = ctr.range[s].row[0];
                    var ed_r = ctr.range[s].row[1];
                    var st_c = ctr.range[s].column[0];
                    var ed_c = ctr.range[s].column[1];

                    for(var r = st_r;r < ed_r + 1; r++){
                        for(var c = st_c; c < ed_c +1; c++){
                            if(ctr.data[r][c] == null){
                                luckysheet.formula.delFunctionGroup(r,c);
                            }
                        }
                    }
                }
                luckysheet.formula.execFunctionGroup(null, null, null, null, ctr.data);//取之前的数据

                luckysheet.jfrefreshgrid(ctr.data, ctr.range, ctr.config, ctr.cdformat, ctr.RowlChange);
            }
            else if (ctr.type == "pasteCut") {
                var s = {
                    "sheetIndex": ctr.source["sheetIndex"],
                    "data": ctr.source["curData"],
                    "curData": ctr.source["data"],
                    "config": ctr.source["curConfig"],
                    "curConfig": ctr.source["config"],
                    "cdformat": ctr.source["curCdformat"],
                    "curCdformat": ctr.source["cdformat"],
                    "range": ctr.source["range"]
                }
                var t = {
                    "sheetIndex": ctr.target["sheetIndex"],
                    "data": ctr.target["curData"],
                    "curData": ctr.target["data"],
                    "config": ctr.target["curConfig"],
                    "curConfig": ctr.target["config"],
                    "cdformat": ctr.target["curCdformat"],
                    "curCdformat": ctr.target["cdformat"],
                    "range": ctr.target["range"]
                }
                luckysheet.jfrefreshgrid_pastcut(s, t, ctr.RowlChange);
            }
            else if (ctr.type == "cellchange") {
                luckysheet.formula.execFunctionGroup(ctr.uprow, ctr.upcolumn, ctr.value);
                luckysheet.jfrefreshcell(ctr.value, ctr.uprow, ctr.upcolumn);
            }
            else if (ctr.type == "rangechange") {
                //如果有单元格为null,则对应公式应该删除
                for(var s = 0; s < ctr.range.length; s++){
                    var st_r = ctr.range[s].row[0];
                    var ed_r = ctr.range[s].row[1];
                    var st_c = ctr.range[s].column[0];
                    var ed_c = ctr.range[s].column[1];

                    for(var r = st_r;r < ed_r + 1; r++){
                        for(var c = st_c; c < ed_c +1; c++){
                            if(ctr.data[r][c] == null){
                                luckysheet.formula.delFunctionGroup(r,c);
                            }
                        }
                    }
                }
                luckysheet.formula.execFunctionGroup(null, null, null, null, ctr.data);//取之前的数据
                
                luckysheet.jfrefreshrange(ctr.data, ctr.range, ctr.cdformat);
            }
            else if (ctr.type == "resize") {
                config = ctr.config;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                if(ctr.ctrlType == "resizeR"){
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.config["rowlen"], { "k": "rowlen" });
                }
                else if(ctr.ctrlType == "resizeC"){
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.config["columlen"], { "k": "columlen" });
                }

                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);
            }
            else if (ctr.type == "cellRowChange") {
                luckysheet.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, ctr.ctrlType, ctr.ctrlValue, ctr.cdformat);
            }
            else if (ctr.type == "extend") {
                luckysheet.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, "dele", ctr.ctrlValue);
            }
            else if (ctr.type == "dele") {
                var ctrlValue1 = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue1.restore = true;
                luckysheet.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, "extend", ctrlValue1);
            }
            else if (ctr.type == "addRC") { //增加行列撤销操作
                var ctrlValue = $.extend(true, {}, ctr.ctrlValue);
                if(ctrlValue.direction == "rightbottom"){
                    ctrlValue.index = ctrlValue.index + 1;
                }

                luckysheet.jfrefreshgrid_adRC(ctr.data, ctr.config, "delRC", ctrlValue, ctr.calc, ctr.filterObj, ctr.cf, ctr.af, ctr.freezen);
            }
            else if (ctr.type == "delRC") { //删除行列撤销操作
                var ctrlValue = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue.restore = true;
                ctrlValue.direction = "lefttop";

                luckysheet.jfrefreshgrid_adRC(ctr.data, ctr.config, "addRC", ctrlValue, ctr.calc, ctr.filterObj, ctr.cf, ctr.af, ctr.freezen);
            }
            else if (ctr.type == "datachangeAll") {
                luckysheet.formula.execFunctionGroup();
                luckysheet.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, null, ctr.range, "datachangeAll", ctr.ctrlValue);
            }
            else if (ctr.type == "datachangeAll_filter_clear") {
                luckysheet.createFilterOptions(ctr.filter_save);

                $("#luckysheet-filter-options-sheet" + luckysheet.currentSheetIndex + " .luckysheet-filter-options").each(function(i){
                    var $top = $(this);
                    var item = ctr.optiongroups[i];
                    luckysheet.labelFilterOptionState($top, item.optionstate, item.rowhidden, item.caljs, false, item.st_r, item.ed_r, item.cindex, item.st_c, item.ed_c);
                });

                luckysheet.server.saveParam("fsr", luckysheet.currentSheetIndex, { "filter": ctr.optiongroups, "filter_select": ctr.filter_save });

                //config
                config = ctr.config;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].config = config;

                if(config["rowhidden"] == null){
                    config["rowhidden"] = {};
                }

                luckysheet.server.saveParam("cg", luckysheet.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);

                // var $t = $("#luckysheet-filter-options-sheet" + luckysheet.currentSheetIndex + " .luckysheet-filter-options").eq(0);
                // luckysheet.filterseletedbyindex($t.data("str"), $t.data("edr"), $t.data("stc"), $t.data("edc"));
                $("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();
            }
            else if (ctr.type == "datachangeAll_filter") {
                var $top = $("#luckysheet-filter-options-sheet" + luckysheet.currentSheetIndex + " .luckysheet-filter-options").eq(ctr["optionsindex"]);
                var st_r = $top.data("str"), 
                    ed_r = $top.data("edr"), 
                    cindex = $top.data("cindex"), 
                    st_c = $top.data("stc"), 
                    ed_c = $top.data("edc");

                luckysheet.labelFilterOptionState($top, luckysheet.json.hasKey(ctr.rowhidenPre), ctr.rowhidenPre, ctr.caljs, true, st_r, ed_r, cindex, st_c, ed_c);

                //config
                config = ctr.config;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].config = config;

                if(config["rowhidden"] == null){
                    config["rowhidden"] = {};
                }

                luckysheet.server.saveParam("cg", luckysheet.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);
                
                // luckysheet.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                $("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();
            }
            else if (ctr.type == "filtershow") {
                $('#luckysheet-filter-selected-sheet' + ctr.sheetIndex + ', #luckysheet-filter-options-sheet' + ctr.sheetIndex).remove();
                
                if(luckysheet.server.allowUpdate){
                    luckysheet.server.saveParam("all", ctr.sheetIndex, null, { "k": "filter_select" });
                }
            }
            else if(ctr.type == "pivotTable_change"){
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].pivotTable = ctr.pivotTable;

                luckysheet.pivotTable.getCellData(ctr.sheetIndex);
                luckysheet.pivotTable.initialPivotManage(true);

                luckysheet.pivotTable.refreshPivotTable();
            }
            else if (ctr.type == "addSheet") {
                luckysheet.sheetmanage.deleteSheet(ctr.index);
                luckysheet.sheetmanage.changeSheetExec(ctr.currentSheetIndex);
                $("#luckysheet-input-box").removeAttr("style");
                $("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "copySheet") {
                luckysheet.sheetmanage.deleteSheet(ctr.index);
                luckysheet.sheetmanage.changeSheetExec(ctr.copyindex);
            }
            else if (ctr.type == "deleteSheet") {
                var isDupName = false;

                for(var i = 0; i < luckysheetfile.length; i++){
                    if(luckysheetfile[i].name == ctr.name){
                        isDupName = true;
                    }
                }

                if(!isDupName){
                    luckysheet.sheetmanage.createSheetbydata(ctr, "isrenew");
                    $("#luckysheet-input-box").removeAttr("style");
                    $("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();
                }
            }
            else if (ctr.type == "sheetName") {
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].name = ctr.oldtxt;
                $("#luckysheet-sheets-item" + ctr.sheetIndex).find(".luckysheet-sheets-item-name").html(ctr.oldtxt);

                luckysheet.server.saveParam("all", ctr.sheetIndex, ctr.oldtxt, { "k": "name" });
            }
            else if (ctr.type == "sheetColor") {
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].color = ctr.oldcolor;
                
                var luckysheetcurrentSheetitem = $("#luckysheet-sheets-item" + ctr.sheetIndex);
                luckysheetcurrentSheetitem.find(".luckysheet-sheets-item-color").remove();

                if(ctr.oldcolor != null){
                    luckysheetcurrentSheetitem.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + ctr.oldcolor + ';"></div>');
                }

                luckysheet.server.saveParam("all", ctr.sheetIndex, ctr.oldcolor, { "k": "color" });
            }
            else if (ctr.type == "insertChart") {
                //chartMix
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.store && store.commit("deleteChart",ctr.chart_json.chart_id);//同步store中数据
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "moveChart") {
                //回到上一次的状态
                $("#" + ctr.chart_id + "_c").css({ "top": ctr.y, "left": ctr.x });
                $("#luckysheet-scrollbar-y").scrollTop(ctr.scrollTop1);
                $("#luckysheet-scrollbar-x").scrollLeft(ctr.scrollLeft1);

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.x,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.y,
                    chartId:ctr.chart_id
                });

                luckysheet.server.saveParam("c", ctr.sheetIndex, { "left":ctr.x, "top":ctr.y, "scrollTop": ctr.scrollTop1, "scrollLeft": ctr.scrollLeft1  }, { "op":"xy", "cid": ctr.chart_id });
                // luckysheet.server.saveParam("c", ctr.sheetIndex, { "left":ctr.x, "top":ctr.y }, { "op":"xy", "cid": ctr.chart_id });
            }
            else if (ctr.type == "resizeChart") {//chartMix,增加位置x，y
                $("#" + ctr.chart_id + "_c").css({ "height": ctr.myHeight1, "width": ctr.myWidth1 ,"top": ctr.y, "left": ctr.x });
                $("#luckysheet-scrollbar-y").scrollTop(ctr.scrollTop1);
                $("#luckysheet-scrollbar-x").scrollLeft(ctr.scrollLeft1);
                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"height",
                    value:ctr.myHeight1,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"width",
                    value:ctr.myWidth1,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.x,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.y,
                    chartId:ctr.chart_id
                });
                //resize
                !!window.generator && generator.resize(ctr.chart_id);

                luckysheet.server.saveParam("c", ctr.sheetIndex, { "width":ctr.myWidth1, "height":ctr.myHeight1,"top": ctr.y, "left": ctr.x, "scrollTop": ctr.scrollTop1, "scrollLeft": ctr.scrollLeft1  }, { "op":"wh", "cid": ctr.chart_id});
            }
            else if (ctr.type == "updateChartRange") {
                //console.log(ctr.p_chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet("updateChartRange",ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
                luckysheet.chartparam.luckysheet_chart_redo_click = false;

                luckysheet.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chart_id );

                if(!luckysheet.isEditMode()){
                    // $("#luckysheet-data-visualization").hide();
                    // luckysheet.luckysheetsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartType") {
                //console.log(ctr.p_chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet("updateChartType",ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
                luckysheet.chartparam.luckysheet_chart_redo_click = false;


                //luckysheet.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck );

                luckysheet.chartTypeChange(ctr.p_chartType,ctr.p_selfOption,ctr.p_defaultOption,ctr.p_chartStyle,ctr.p_chartMarkConfig,ctr.p_chartTitleConfig,ctr.p_chart_id);

                if(!luckysheet.isEditMode()){
                    // $("#luckysheet-data-visualization").hide();
                    // luckysheet.luckysheetsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartTheme") {
                if(luckysheet.chartparam.luckysheetcurrentChart!=null){
                    luckysheet.chartparam.luckysheetcurrentChart.dispose();
                }

                var chartTheme = "default0000";
                if(ctr.p_chartTheme != null && ctr.p_chartTheme.length > 0 && luckysheet.getObjType(ctr.p_chartTheme) != "object" && ctr.p_chartTheme != "default0000"){
                    chartTheme = eval('('+ ctr.p_chartTheme +')');
                }

                luckysheet.chartparam.luckysheetcurrentChart = jgridChart = echarts.init($("#" + ctr.p_chart_id).find(".luckysheet-modal-dialog-content").get(0), chartTheme);

                luckysheet.chartparam.luckysheet_chart_default_config = eval('('+ ctr.p_defaultOption +')');
                luckysheet.chartparam.luckysheet_chart_self_config = eval('('+ ctr.p_selfOption +')');
                var $t = $("#"+ctr.p_chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                $t.mousedown();
                luckysheet.chartparam.luckysheetCurrentChartMove = false;
                $t.mouseup();
                luckysheet.chartparam.luckysheet_chart_redo_click = false;

                luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.chartparam.luckysheet_chart_default_config);
                luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.luckysheetChartConfigHanddle(ctr.p_chartType, "theme", luckysheet.chartparam.luckysheet_chart_self_config));

                // luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.chartparam.luckysheet_chart_default_config);
                // luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.luckysheetChartConfigHanddle(jgridCurrentChartType.data("type"), "theme", luckysheet.chartparam.luckysheet_chart_self_config));

                $t.attr("chartTheme", ctr.p_chartTheme);

                if(luckysheet.server.allowUpdate){
                    luckysheet.server.saveParam("c", ctr.p_sheetIndex, {"chartTheme": ctr.p_chartTheme}, { "op": "update", "cid": ctr.p_chart_id});
                }

                if(!luckysheet.isEditMode()){
                    // $("#luckysheet-data-visualization").hide();
                    // luckysheet.luckysheetsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChart") {
                //console.log(ctr.p_chart_id);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet(ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;

                if(!luckysheet.isEditMode()){
                    // $("#luckysheet-data-visualization").hide();
                    // luckysheet.luckysheetsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartAll") {
                //console.log(ctr.p_chart_id);
                var chart_json = ctr.pre_Chart_json;//取上一次的数据
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.generator && generator.patchVueSet(chart_json);
                !!window.generator && generator.generateChart(chart_json.defaultOption, chart_json.chartTheme, chart_json.chartAllType, $("#" + chart_json.chart_id).get(0));
                // !!window.store && store.commit("showNeedRangeShow",chart_json.chart_id);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "deleteChart") {
                //chartMix
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.store && store.commit("insertChart", ctr.chart_json);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "mergeChange") {
                luckysheet.jfrefreshgrid(ctr.data, ctr.range, ctr.config);
            }
            else if (ctr.type == "updateCF"){
                var historyRules = ctr["data"]["historyRules"];

                for(var i = 0; i < historyRules.length; i++){
                    //条件规则
                    var sheetIndex = historyRules[i]["sheetIndex"];
                    luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"] = historyRules[i]["luckysheet_conditionformat_save"];
                
                    if(luckysheet.server.allowUpdate){
                        luckysheet.server.saveParam("all", sheetIndex, historyRules[i]["luckysheet_conditionformat_save"], { "k": "luckysheet_conditionformat_save" });
                    }
                }

                //刷新一次表格
                luckysheet.conditionformat.ref();
            }
            else if (ctr.type == "updateAF"){
                var historyRules = ctr["data"]["historyRules"];

                var index = luckysheet.sheetmanage.getSheetIndex(ctr["sheetIndex"]);

                luckysheetfile[index]["luckysheet_alternateformat_save"] = $.extend(true, [], historyRules);

                setTimeout(function () {
                    luckysheet.luckysheetrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "borderChange"){
                if(ctr.config["borderInfo"] == null){
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, [], { "k": "borderInfo" });
                }
                else{
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.config["borderInfo"], { "k": "borderInfo" });
                }

                config = ctr.config;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                setTimeout(function () {
                    luckysheet.luckysheetrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "postil"){
                luckysheet.postil.ref(ctr.data, ctr.rc);

                for(var i = 0; i < ctr.rc.length; i++){
                    var r = ctr.rc[i].split("_")[0];
                    var c = ctr.rc[i].split("_")[1];

                    if(ctr.data[r][c] != null && ctr.data[r][c].ps != null){
                        luckysheet.postil.buildPs(r, c, ctr.data[r][c].ps);
                    }
                    else{
                        luckysheet.postil.buildPs(r, c, null);
                    }
                }
            }
            
            luckysheet.cleargridelement(e);
            clearjfundo = true;
        },
        undo: function () {
            if (luckysheet.jfundo.length == 0) {
                return;
            }

            var ctr = luckysheet.jfundo.pop();
            luckysheet.jfredo.push(ctr);
            clearjfundo = false;

            if (luckysheet.sheetmanage.hasSheet(ctr.sheetIndex) && luckysheet.currentSheetIndex != ctr.sheetIndex) {
                luckysheet.sheetmanage.changeSheetExec(ctr.sheetIndex);
            }

            if (ctr.type == "datachange") {
                luckysheet.formula.execFunctionGroup();

                luckysheet.jfrefreshgrid(ctr.curdata, ctr.range, ctr.curConfig, ctr.curCdformat, ctr.RowlChange);
            }
            else if (ctr.type == "pasteCut") {
                luckysheet.jfrefreshgrid_pastcut(ctr.source, ctr.target, ctr.RowlChange);
            }
            else if (ctr.type == "cellchange") {
                luckysheet.formula.execFunctionGroup(ctr.uprow, ctr.upcolumn, ctr.curvalue);
                luckysheet.jfrefreshcell(ctr.curvalue, ctr.uprow, ctr.upcolumn);
            }
            else if (ctr.type == "rangechange") {
                luckysheet.formula.execFunctionGroup();
                luckysheet.jfrefreshrange(ctr.curdata, ctr.range, ctr.curCdformat);
            }
            else if (ctr.type == "resize") {
                config = ctr.curconfig;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                if(ctr.ctrlType == "resizeR"){
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["rowlen"], { "k": "rowlen" });
                }
                else if(ctr.ctrlType == "resizeC"){
                    luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["columlen"], { "k": "columlen" });
                }

                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);
            }
            else if (ctr.type == "cellRowChange") {
                luckysheet.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue, ctr.curCdformat);
            }
            else if (ctr.type == "extend") {
                luckysheet.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue);
            }
            else if (ctr.type == "dele") {
                var ctrlValue1 = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue1.restore = true;
                luckysheet.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue);
            }
            else if (ctr.type == "addRC") { //增加行列重做操作
                luckysheet.jfrefreshgrid_adRC(ctr.curData, ctr.curConfig, "addRC", ctr.ctrlValue, ctr.curCalc, ctr.curFilterObj, ctr.curCf, ctr.curAf, ctr.curFreezen);
            }
            else if (ctr.type == "delRC") { //删除行列重做操作
                luckysheet.jfrefreshgrid_adRC(ctr.curData, ctr.curConfig, "delRC", ctr.ctrlValue, ctr.curCalc, ctr.curFilterObj, ctr.curCf, ctr.curAf, ctr.curFreezen);
            }
            else if (ctr.type == "datachangeAll") {
                luckysheet.formula.execFunctionGroup();
                luckysheet.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, null, ctr.currange, "datachangeAll", ctr.ctrlValue);
            }
            else if (ctr.type == "datachangeAll_filter_clear") {
                luckysheet.server.saveParam("fsc", luckysheet.currentSheetIndex, null);
                
                //config
                config = ctr.curconfig;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].config = config;

                luckysheet.server.saveParam("cg", luckysheet.currentSheetIndex, {}, { "k": "rowhidden" });

                //行高、列宽 刷新  
                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);
                

                $("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide().find("input").val();
                $("#luckysheet-filter-selected span").data("type", "0").data("type", null).text("无");

                $('#luckysheet-filter-selected-sheet' + luckysheet.currentSheetIndex + ', #luckysheet-filter-options-sheet' + luckysheet.currentSheetIndex).remove();
                $("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();
            }
            else if (ctr.type == "datachangeAll_filter") {
                var $top = $("#luckysheet-filter-options-sheet" + luckysheet.currentSheetIndex + " .luckysheet-filter-options").eq(ctr["optionsindex"]);
                var st_r = $top.data("str"), 
                    ed_r = $top.data("edr"), 
                    cindex = $top.data("cindex"), 
                    st_c = $top.data("stc"), 
                    ed_c = $top.data("edc");

                luckysheet.labelFilterOptionState($top, luckysheet.json.hasKey(ctr.rowhidden), ctr.rowhidden, ctr.caljs, true, st_r, ed_r, cindex, st_c, ed_c);

                //config
                config = ctr.curconfig;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].config = config;

                luckysheet.server.saveParam("cg", luckysheet.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                luckysheet.jfrefreshgrid_rhcw(luckysheet.flowdata.length, luckysheet.flowdata[0].length);

                // luckysheet.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                $("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();
            }
            else if (ctr.type == "filtershow") {
                luckysheet_select_save = [ctr.filter_save];
                filterchage = false;
                luckysheet.createFilter();
                filterchage = true;
                luckysheet.server.saveParam("all", ctr.sheetIndex, ctr.filter_save, { "k": "filter_select" });
            }
            else if (ctr.type == "pivotTable_change") {
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].pivotTable = ctr.pivotTablecur;
                //console.log(ctr.pivotTablecur);
                luckysheet.pivotTable.getCellData(ctr.sheetIndex);
                luckysheet.pivotTable.initialPivotManage(true);

                luckysheet.pivotTable.refreshPivotTable();
            }
            else if (ctr.type == "addSheet") {
                luckysheet.sheetmanage.createSheetbydata(ctr.sheetconfig);
                $("#luckysheet-input-box").removeAttr("style");
                $("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "copySheet") {
                luckysheet.sheetmanage.copySheet(ctr.copyindex);
            }
            else if (ctr.type == "deleteSheet") {
                luckysheet.sheetmanage.deleteSheet(ctr.index);
                if (ctr.order == 0) {
                    luckysheet.sheetmanage.changeSheetExec(luckysheetfile[0].index);
                }
                else {
                    luckysheet.sheetmanage.changeSheetExec(luckysheetfile[ctr.order - 1].index);
                }
                
                $("#luckysheet-input-box").removeAttr("style");
                $("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "sheetName") {
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].name = ctr.txt;
                $("#luckysheet-sheets-item" + ctr.sheetIndex).find(".luckysheet-sheets-item-name").html(ctr.txt);
                
                luckysheet.server.saveParam("all", ctr.sheetIndex, ctr.txt, { "k": "name" });
            }
            else if (ctr.type == "sheetColor") {
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].color = ctr.color;

                var luckysheetcurrentSheetitem = $("#luckysheet-sheets-item" + ctr.sheetIndex);
                luckysheetcurrentSheetitem.find(".luckysheet-sheets-item-color").remove();
                
                if(ctr.color != null){
                    luckysheetcurrentSheetitem.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + ctr.color + ';"></div>');
                }
                
                luckysheet.server.saveParam("all", ctr.sheetIndex, ctr.color, { "k": "color" });
            }
            else if (ctr.type == "insertChart") {
                //chartMix
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.store && store.commit("insertChart", ctr.chart_json);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "moveChart") {
                $("#" + ctr.chart_id + "_c").css({ "top": ctr.myTop, "left": ctr.myLeft });
                $("#luckysheet-scrollbar-y").scrollTop(ctr.scrollTop);
                $("#luckysheet-scrollbar-x").scrollLeft(ctr.scrollLeft);
                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.myLeft,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.myTop,
                    chartId:ctr.chart_id
                });
                
                luckysheet.server.saveParam("c", ctr.sheetIndex, { "left":ctr.myLeft, "left":ctr.myTop, "scrollTop": ctr.scrollTop, "scrollLeft": ctr.scrollLeft  }, { "op":"xy", "cid": ctr.chart_id});
                // luckysheet.server.saveParam("c", ctr.sheetIndex, { "left":ctr.myLeft, "top":ctr.myTop }, { "op":"xy", "cid": ctr.chart_id});
            }
            else if (ctr.type == "resizeChart") {
                $("#" + ctr.chart_id + "_c").css({ "height": ctr.myHeight, "width": ctr.myWidth,"top": ctr.myTop, "left": ctr.myLeft });
                $("#luckysheet-scrollbar-y").scrollTop(ctr.scrollTop);
                $("#luckysheet-scrollbar-x").scrollLeft(ctr.scrollLeft);

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"height",
                    value:ctr.myHeight,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"width",
                    value:ctr.myWidth,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.myLeft,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.myTop,
                    chartId:ctr.chart_id
                });

                !!window.generator && generator.resize(ctr.chart_id);
                luckysheet.server.saveParam("c", ctr.sheetIndex, { "width":ctr.myWidth, "height":ctr.myHeight,"top":  ctr.myTop, "left": ctr.myLeft, "scrollTop": ctr.scrollTop, "scrollLeft": ctr.scrollLeft  }, { "op":"wh", "cid": ctr.chart_id});
            }
            else if (ctr.type == "updateChartRange") {
                //console.log(ctr.p_chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet("updateChartRange",ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
                luckysheet.chartparam.luckysheet_chart_redo_click = false;

                luckysheet.chartrangechange(ctr["row"], ctr["column"], ctr.sheetIndex, ctr.dataSheetIndex, ctr.chart_selection_id,ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chart_id);

                // $("#luckysheet-data-visualization").hide();
                // luckysheet.luckysheetsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChartType") {
                //console.log(ctr.p_chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet("updateChartType",ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
                luckysheet.chartparam.luckysheet_chart_redo_click = false;

                //luckysheet.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck );

                luckysheet.chartTypeChange(ctr.chartType,ctr.selfOption,ctr.defaultOption,ctr.chartStyle,ctr.chartMarkConfig,ctr.chartTitleConfig,ctr.chart_id);

                // $("#luckysheet-data-visualization").hide();
                // luckysheet.luckysheetsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChartTheme") {
                if(luckysheet.chartparam.luckysheetcurrentChart!=null){
                    luckysheet.chartparam.luckysheetcurrentChart.dispose();
                }

                var chartTheme = "default0000";
                if(ctr.chartTheme != null && ctr.chartTheme.length > 0 && luckysheet.getObjType(ctr.chartTheme) != "object" && ctr.chartTheme != "default0000"){
                    chartTheme = eval('(' + ctr.chartTheme + ')');
                }

                luckysheet.chartparam.luckysheetcurrentChart = jgridChart = echarts.init($("#" + ctr.chart_id).find(".luckysheet-modal-dialog-content").get(0), chartTheme);

                luckysheet.chartparam.luckysheet_chart_default_config = eval('('+ ctr.defaultOption +')');
                luckysheet.chartparam.luckysheet_chart_self_config = eval('('+ ctr.selfOption +')');
                var $t = $("#" + ctr.chart_id);
                luckysheet.chartparam.luckysheet_chart_redo_click = true;
                $t.mousedown();
                luckysheet.chartparam.luckysheetCurrentChartMove = false;
                $t.mouseup();
                luckysheet.chartparam.luckysheet_chart_redo_click = false;

                luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.chartparam.luckysheet_chart_default_config);
                luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.luckysheetChartConfigHanddle(ctr.chartType, "theme", luckysheet.chartparam.luckysheet_chart_self_config));

                // luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.chartparam.luckysheet_chart_default_config);
                // luckysheet.chartparam.luckysheetcurrentChart.setOption(luckysheet.luckysheetChartConfigHanddle(jgridCurrentChartType.data("type"), "theme", luckysheet.chartparam.luckysheet_chart_self_config));

                $t.attr("chartTheme", ctr.chartTheme);
                luckysheet.server.saveParam("c", ctr.sheetIndex, {"chartTheme": ctr.chartTheme}, { "op": "update", "cid": ctr.chart_id});

                // $("#luckysheet-data-visualization").hide();
                // luckysheet.luckysheetsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChart") {
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                luckysheet.updateChartTosheet(ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;

                // $("#luckysheet-data-visualization").hide();
                // luckysheet.luckysheetsizeauto();
                !!window.generator && generator.hideChartSettingComponent();
            }
            else if (ctr.type == "updateChartAll") {
                //console.log(ctr.p_chart_id);
                var chart_json = ctr.chart_json;//取下一次的数据
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.generator && generator.patchVueSet(chart_json);
                !!window.generator && generator.generateChart(chart_json.defaultOption, chart_json.chartTheme, chart_json.chartAllType, $("#" + chart_json.chart_id).get(0));
                // !!window.store && store.commit("showNeedRangeShow",chart_json.chart_id);
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "deleteChart") {
                //chartMix
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = false;
                !!window.store && store.commit("deleteChart",ctr.chart_json.chart_id);//同步store中数据
                luckysheet.chartparam.luckysheetInsertChartTosheetChange = true;
            }
            else if (ctr.type == "mergeChange") {
                luckysheet.jfrefreshgrid(ctr.curData, ctr.range, ctr.curConfig);
            }
            else if (ctr.type == "updateCF"){
                var currentRules = ctr["data"]["currentRules"];

                for(var i = 0; i < currentRules.length; i++){
                    //条件规则
                    var sheetIndex = currentRules[i]["sheetIndex"];
                    luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"] = currentRules[i]["luckysheet_conditionformat_save"];
                    
                    if(luckysheet.server.allowUpdate){
                        luckysheet.server.saveParam("all", sheetIndex, currentRules[i]["luckysheet_conditionformat_save"], { "k": "luckysheet_conditionformat_save" });
                    }
                }

                //刷新一次表格
                luckysheet.conditionformat.ref();
            }
            else if (ctr.type == "updateAF"){
                var currentRules = ctr["data"]["currentRules"];

                var index = luckysheet.sheetmanage.getSheetIndex(ctr["sheetIndex"]);

                luckysheetfile[index]["luckysheet_alternateformat_save"] = $.extend(true, [], currentRules);

                setTimeout(function () {
                    luckysheet.luckysheetrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "borderChange"){
                luckysheet.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["borderInfo"], { "k": "borderInfo" });

                config = ctr.curconfig;
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                setTimeout(function () {
                    luckysheet.luckysheetrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "postil"){
                luckysheet.postil.ref(ctr.curdata, ctr.rc);

                for(var i = 0; i < ctr.rc.length; i++){
                    var r = ctr.rc[i].split("_")[0];
                    var c = ctr.rc[i].split("_")[1];

                    if(ctr.curdata[r][c] != null && ctr.curdata[r][c].ps != null){
                        luckysheet.postil.buildPs(r, c, ctr.curdata[r][c].ps);
                    }
                    else{
                        luckysheet.postil.buildPs(r, c, null);
                    }
                }
            }
            
            clearjfundo = true;
        }
    };

    luckysheet.editor = {
        //worker+blob实现深拷贝替换extend
        deepCopyFlowDataState:false,
        deepCopyFlowDataCache:"",
        deepCopyFlowDataWorker:null,
        deepCopyFlowData:function(flowData){
            var _this = this;
            if(_this.deepCopyFlowDataState){
                if(_this.deepCopyFlowDataWorker != null){
                    _this.deepCopyFlowDataWorker.terminate();  
                }
                return _this.deepCopyFlowDataCache;
            }
            else{
                if(flowData == null){
                    flowData = luckysheet.flowdata;
                }

                return $.extend(true, [], flowData);
            }
        },
        webWorkerFlowDataCache:function(flowData){
            var _this = this;

            try{
                if(_this.deepCopyFlowDataWorker != null){//存新的webwork前先销毁以前的
                    _this.deepCopyFlowDataWorker.terminate();
                }

                var funcTxt = 'data:text/javascript;chartset=US-ASCII,onmessage = function (e) { postMessage(e.data); };';
                _this.deepCopyFlowDataState = false;
                //var worker_blob = new Blob([funcTxt]);

                //适配IE
                if(luckysheet.browser.isIE() == 1){
                    var response = "self.onmessage=function(e){postMessage(e.data);}";
                    var worker = new Worker('./plugins/Worker-helper.js');
                    worker.postMessage(response);
                }else{
                    var worker = new Worker(funcTxt);
                }

                _this.deepCopyFlowDataWorker = worker;
                worker.postMessage(flowData);
                worker.onmessage = function(e) { 
                    _this.deepCopyFlowDataCache = e.data;
                    _this.deepCopyFlowDataState = true;
                };
            }
            catch(e){
                _this.deepCopyFlowDataCache = $.extend(true,[],flowData);
            }
        },
        // webWorkerFlowDataCache:function(flowData){
        //     var _this = this;
        //     _this.deepCopyFlowDataState = false;
        //     var funcTxt = 'data:text/javascript;chartset=US-ASCII,onmessage = function (e) { postMessage(e.data); };';
        //     //var worker_blob = new Blob([funcTxt]); 
        //     var worker = new Worker(funcTxt);
        //     _this.deepCopyFlowDataWorker = worker;
        //     worker.postMessage(flowData);
        //     worker.onmessage = function(e) { 
        //         _this.deepCopyFlowDataCache = e.data;
        //         console.log("onmessage: e.data",e.data);
        //         _this.deepCopyFlowDataState = true;
        //         //_this.deepCopyFlowDataWorker = null;
        //         worker.terminate();
        //     };

        // },
        controlHandler: function (dataChe) {
            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据

            var last = luckysheet_select_save[luckysheet_select_save.length - 1];
            var curR = last["row"] == null ? 0 : last["row"][0];
            var curC = last["column"] == null ? 0 : last["column"][0];
            var rlen = dataChe.length, clen = dataChe[0].length;

            var addr = curR + rlen - d.length, addc = curC + clen - d[0].length;
            if(addr > 0 || addc > 0){
                d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
            }

            for (var r = 0; r < rlen; r++) {
                var x = [].concat(d[r + curR]);
                for (var c = 0; c < clen; c++) {
                    var value = "";
                    if (dataChe[r] != null && dataChe[r][c] != null) {
                        value = dataChe[r][c];
                    }
                    x[c + curC] = value;
                }
                d[r + curR] = x;
            }

            if (addr > 0 || addc > 0) {
                luckysheet.jfrefreshgridall(d[0].length, d.length, d, null, luckysheet_select_save, "datachangeAll");
            }
            else {
                luckysheet.jfrefreshrange(d, luckysheet_select_save);
            }
        },
        clearRangeByindex: function (st_r, ed_r, st_c, ed_c, sheetIndex) {
            var index = luckysheet.sheetmanage.getSheetIndex(sheetIndex);
            var d = $.extend(true, [], luckysheetfile[index]["data"]);
            
            for (var r = st_r; r <= ed_r; r++) {
                var x = [].concat(d[r]);
                for (var c = st_c; c <= ed_c; c++) {
                    luckysheet.formula.delFunctionGroup(r, c);
                    luckysheet.formula.execFunctionGroup(r, c, "");
                    //var value = "";
                    //if (dataChe[r] != null && dataChe[r][c] != null) {
                    //    value = dataChe[r][c];
                    //}
                    x[c] = null;
                }
                d[r] = x;
            }

            //luckysheet.flowdata = flowdata_new = data;

            if(sheetIndex == luckysheet.currentSheetIndex){
                var rlen = ed_r - st_r + 1, clen = ed_c - st_c + 1;
                if (rlen > 5000) {
                    luckysheet.jfrefreshgrid(d, st_r, ed_r, st_c, ed_c);
                }
                else {
                    luckysheet.jfrefreshrange(d, { "row": [st_r, ed_r], "column": [st_c, ed_c] });
                }
            }
            else{
                luckysheetfile[index]["data"] = d;
            }
        },
        controlHandlerD: function (dataChe) {
            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据

            var last = luckysheet_select_save[luckysheet_select_save.length - 1];
            var r1 = last["row"][0], r2 = last["row"][1];
            var c1 = last["column"][0], c2 = last["column"][1];
            var rlen = dataChe.length, clen = dataChe[0].length;

            var addr = r1 + rlen - d.length, addc = c1 + clen - d[0].length;
            if(addr >0 || addc > 0){
                d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
            }

            for(var r = r1; r <= r2; r++){
                for(var c = c1; c <= c2; c++){
                    d[r][c] = null;
                }
            }

            for(var i = 0; i < rlen; i++){
                for(var j = 0; j < clen; j++){
                    d[r1 + i][c1 + j] = dataChe[i][j];
                }
            }

            var range = [
                { "row": [r1, r2], "column": [c1, c2] },
                { "row": [r1, r1 + rlen - 1], "column": [c1, c1 + clen - 1] }
            ];

            luckysheet.jfrefreshgrid(d, range);
        }
    };

    luckysheet.selection = {
        clearcopy: function (e) {
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                if (!!e) {
                    clipboardData = e.originalEvent.clipboardData;
                }
            }
            var cpdata = " ";
            copyType = "normal";
            copysetting = [];

            luckysheet_selection_range = [];
            luckysheet.selectionCopyShow();
            luckysheet_copy_save = {};
            
            if (!clipboardData) {
                var textarea = $("#luckysheet-copy-content").css("visibility", "hidden");
                textarea.val(cpdata);
                textarea.focus();
                textarea.select();
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { textarea.blur().css("visibility", "visible"); }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        getHtmlBorderStyle:function(type, color){
            var style = "";
            var borderType = {"0":"none", "1":"Thin", "2":"Hair", "3":"Dotted", "4":"Dashed", "5":"DashDot", "6":"DashDotDot", "7":"Double", "8":"Medium", "9":"MediumDashed", "10":"MediumDashDot", "11":"MediumDashDotDot", "12":"SlantedDashDot", "13":"Thick"};
            type = borderType[type.toString()];

            if(type.indexOf("Medium") > -1){
                style += "1pt ";
            }
            else if(type == "Thick"){
                style += "1.5pt ";
            }
            else {
                style += "0.5pt ";    
            }

            if(type == "Hair"){
                style += "double ";
            }
            else if(type.indexOf("DashDotDot") > -1){
                style += "dotted ";
            }
            else if(type.indexOf("DashDot") > -1){
                style += "dashed ";
            }
            else if(type.indexOf("Dotted") > -1){
                style += "dotted "; 
            }
            else if(type.indexOf("Dashed") > -1){
                style += "dashed ";
            }
            else{
                style += "solid ";
            }

            return style + color + ";";
        },
        copy: function (e) {//copy事件
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                clipboardData = e.originalEvent.clipboardData;
            }

            luckysheet_selection_range = [];
            //copy范围
            var minR = luckysheet_select_save[0].row[0], maxR = luckysheet_select_save[0].row[1];
            var minC = luckysheet_select_save[0].column[0], maxC = luckysheet_select_save[0].column[1];
            var copyRange = [], RowlChange = false, HasMC = false;
            for(var s = 0; s < luckysheet_select_save.length; s++){
                if(luckysheet_select_save[s].row[0] < minR){
                    minR = luckysheet_select_save[s].row[0];
                }

                if(luckysheet_select_save[s].row[1] > maxR){
                    maxR = luckysheet_select_save[s].row[1];
                }

                if(luckysheet_select_save[s].column[0] < minC){
                    minC = luckysheet_select_save[s].column[0];
                }

                if(luckysheet_select_save[s].column[1] > maxC){
                    maxC = luckysheet_select_save[s].column[1];
                }

                for(var copyR = luckysheet_select_save[s].row[0]; copyR <= luckysheet_select_save[s].row[1]; copyR++){
                    if (config["rowhidden"] != null && config["rowhidden"][copyR] != null) {
                        continue;
                    }

                    if (config["rowlen"] != null && (copyR in config["rowlen"])){
                        RowlChange = true;
                    }

                    for(var copyC = luckysheet_select_save[s].column[0]; copyC <= luckysheet_select_save[s].column[1]; copyC++){
                        var cell = luckysheet.flowdata[copyR][copyC];

                        if(luckysheet.getObjType(cell) == "object" && ("mc" in cell) && cell.mc.rs != null){
                            HasMC = true;
                        }
                    }
                }

                luckysheet_selection_range.push({ "row": luckysheet_select_save[s].row, "column": luckysheet_select_save[s].column });
                copyRange.push({ "row": luckysheet_select_save[s].row, "column": luckysheet_select_save[s].column });
            }

            luckysheet.selectionCopyShow();

            //qksheet内copy保存
            luckysheet_copy_save = { 
                "dataSheetIndex": luckysheet.currentSheetIndex, 
                "copyRange": copyRange, 
                "RowlChange": RowlChange, 
                "HasMC": HasMC 
            };

            //copy范围数据拼接成table 赋给剪贴板
            var _this = this;
            
            if(config["borderInfo"] && config["borderInfo"].length > 0){ //边框
                var borderInfoCompute = luckysheet.getBorderInfoCompute();
            }

            var cpdata = "", d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);
            var r_first = !0, c_first = !0, colgroup = "";
            for (var r = minR; r <= maxR; r++) {
                var row = [];
                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                    continue;
                }
                cpdata += '<tr>';

                for (var c = minC; c <= maxC; c++) {
                    var column = '<td ${span} style="${style}">';

                    if (d[r] != null && d[r][c] != null) {
                        var style = "", span = "";

                        if(r == minR){
                            if(config == null || config["columlen"] == null || config["columlen"][c.toString()] == null){
                                colgroup += '<colgroup width="72px"></colgroup>';
                            }
                            else {
                                colgroup += '<colgroup width="'+ config["columlen"][c.toString()] +'px"></colgroup>';
                            }
                        }

                        if(c == minC){
                            if(config == null || config["rowlen"] == null || config["rowlen"][r.toString()] == null){
                                style += 'height:19px;';
                            }
                            else {
                                style += 'height:'+ config["rowlen"][r.toString()] + 'px;';
                            }
                        }

                        var reg = /^(w|W)((0?)|(0\.0+))$/;
                        var c_value;
                        if(d[r][c].ct != null && d[r][c].ct.fa != null && d[r][c].ct.fa.match(reg)){
                            c_value = luckysheet.getcellvalue(r, c, d);
                        }
                        else{
                            c_value = luckysheet.getcellvalue(r, c, d, "m");
                        }

                        style += luckysheet.menuButton.getStyleByCell(d, r, c);

                        if(luckysheet.getObjType(d[r][c]) == "object" && ("mc" in d[r][c])){
                            if("rs" in d[r][c]["mc"]){
                                span = 'rowspan="'+ d[r][c]["mc"].rs +'" colspan="'+ d[r][c]["mc"].cs +'"';

                                //边框
                                if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                                    var bl_obj = { "color": {}, "style": {} }, 
                                        br_obj = { "color": {}, "style": {} }, 
                                        bt_obj = { "color": {}, "style": {} }, 
                                        bb_obj = { "color": {}, "style": {} };

                                    for(var bd_r = r; bd_r < (r + d[r][c]["mc"].rs); bd_r++){
                                        for(var bd_c = c; bd_c < (c + d[r][c]["mc"].cs); bd_c++){
                                            if(bd_r == r && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].t){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].t.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].t.color;

                                                if(bt_obj["style"][linetype] == null){
                                                    bt_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bt_obj["style"][linetype] = bt_obj["style"][linetype] + 1;
                                                }

                                                if(bt_obj["color"][bcolor] == null){
                                                    bt_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bt_obj["color"][bcolor] = bt_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_r == (r + d[r][c]["mc"].rs - 1) && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].b){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].b.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].b.color;

                                                if(bb_obj["style"][linetype] == null){
                                                    bb_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bb_obj["style"][linetype] = bb_obj["style"][linetype] + 1;
                                                }

                                                if(bb_obj["color"][bcolor] == null){
                                                    bb_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bb_obj["color"][bcolor] = bb_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_c == c && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].l){
                                                var linetype = borderInfoCompute[r + "_" + c].l.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].l.color;
                                                
                                                if(bl_obj["style"][linetype] == null){
                                                    bl_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bl_obj["style"][linetype] = bl_obj["style"][linetype] + 1;
                                                }

                                                if(bl_obj["color"][bcolor] == null){
                                                    bl_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bl_obj["color"][bcolor] = bl_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_c == (c + d[r][c]["mc"].cs - 1) && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].r){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].r.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].r.color;

                                                if(br_obj["style"][linetype] == null){
                                                    br_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    br_obj["style"][linetype] = br_obj["style"][linetype] + 1;
                                                }

                                                if(br_obj["color"][bcolor] == null){
                                                    br_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    br_obj["color"][bcolor] = br_obj["color"][bcolor] + 1;
                                                }
                                            }
                                        }
                                    }

                                    var rowlen = d[r][c]["mc"].rs, collen = d[r][c]["mc"].cs;

                                    if(JSON.stringify(bl_obj).length > 23){
                                        var bl_color = null, bl_style = null;

                                        for(x in bl_obj.color){
                                            if(bl_obj.color[x] >= (rowlen / 2)){
                                                bl_color = x;
                                            }
                                        }

                                        for(x in bl_obj.style){
                                            if(bl_obj.style[x] >= (rowlen / 2)){
                                                bl_style = x;
                                            }
                                        }

                                        if(bl_color != null && bl_style != null){
                                            style += "border-left:" + _this.getHtmlBorderStyle(bl_style, bl_color);
                                        }
                                    }

                                    if(JSON.stringify(br_obj).length > 23){
                                        var br_color = null, br_style = null;

                                        for(x in br_obj.color){
                                            if(br_obj.color[x] >= (rowlen / 2)){
                                                br_color = x;
                                            }
                                        }

                                        for(x in br_obj.style){
                                            if(br_obj.style[x] >= (rowlen / 2)){
                                                br_style = x;
                                            }
                                        }

                                        if(br_color != null && br_style != null){
                                            style += "border-right:" + _this.getHtmlBorderStyle(br_style, br_color);
                                        }
                                    }

                                    if(JSON.stringify(bt_obj).length > 23){
                                        var bt_color = null, bt_style = null;

                                        for(x in bt_obj.color){
                                            if(bt_obj.color[x] >= (collen / 2)){
                                                bt_color = x;
                                            }
                                        }

                                        for(x in bt_obj.style){
                                            if(bt_obj.style[x] >= (collen / 2)){
                                                bt_style = x;
                                            }
                                        }

                                        if(bt_color != null && bt_style != null){
                                            style += "border-top:" + _this.getHtmlBorderStyle(bt_style, bt_color);
                                        }
                                    }

                                    if(JSON.stringify(bb_obj).length > 23){
                                        var bb_color = null, bb_style = null;

                                        for(x in bb_obj.color){
                                            if(bb_obj.color[x] >= (collen / 2)){
                                                bb_color = x;
                                            }
                                        }

                                        for(x in bb_obj.style){
                                            if(bb_obj.style[x] >= (collen / 2)){
                                                bb_style = x;
                                            }
                                        }

                                        if(bb_color != null && bb_style != null){
                                            style += "border-bottom:" + _this.getHtmlBorderStyle(bb_style, bb_color);
                                        }
                                    }
                                }
                            }
                            else{
                                continue;
                            }
                        }
                        else{
                            //边框
                            if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                                //左边框
                                if(borderInfoCompute[r + "_" + c].l){
                                    var linetype = borderInfoCompute[r + "_" + c].l.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].l.color;
                                    style += "border-left:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //右边框
                                if(borderInfoCompute[r + "_" + c].r){
                                    var linetype = borderInfoCompute[r + "_" + c].r.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].r.color;
                                    style += "border-right:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //下边框
                                if(borderInfoCompute[r + "_" + c].b){
                                    var linetype = borderInfoCompute[r + "_" + c].b.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].b.color;
                                    style += "border-bottom:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //上边框
                                if(borderInfoCompute[r + "_" + c].t){
                                    var linetype = borderInfoCompute[r + "_" + c].t.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].t.color;
                                    style += "border-top:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }
                            }
                        }

                        column = luckysheet.replaceHtml(column, {"style":style, "span":span});

                        if(c_value == null){
                            c_value = luckysheet.getcellvalue(r, c, d);
                        }

                        if(c_value == null){
                            c_value = "";
                        }
                        column += c_value;
                    }
                    else {
                        var style = "";
                        
                        //边框
                        if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                            //左边框
                            if(borderInfoCompute[r + "_" + c].l){
                                var linetype = borderInfoCompute[r + "_" + c].l.style;
                                var bcolor = borderInfoCompute[r + "_" + c].l.color;
                                style += "border-left:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //右边框
                            if(borderInfoCompute[r + "_" + c].r){
                                var linetype = borderInfoCompute[r + "_" + c].r.style;
                                var bcolor = borderInfoCompute[r + "_" + c].r.color;
                                style += "border-right:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //下边框
                            if(borderInfoCompute[r + "_" + c].b){
                                var linetype = borderInfoCompute[r + "_" + c].b.style;
                                var bcolor = borderInfoCompute[r + "_" + c].b.color;
                                style += "border-bottom:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //上边框
                            if(borderInfoCompute[r + "_" + c].t){
                                var linetype = borderInfoCompute[r + "_" + c].t.style;
                                var bcolor = borderInfoCompute[r + "_" + c].t.color;
                                style += "border-top:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }
                        }

                        column += "";
                        if(r == minR){
                            if(config == null || config["columlen"] == null || config["columlen"][c.toString()] == null){
                                colgroup += '<colgroup width="72px"></colgroup>';
                            }
                            else {
                                colgroup += '<colgroup width="'+ config["columlen"][c.toString()] +'px"></colgroup>';
                            }
                        }

                        if(c == minC){
                            if(config == null || config["rowlen"] == null || config["rowlen"][r.toString()] == null){
                                style += 'height:19px;';
                            }
                            else {
                                style += 'height:'+ config["rowlen"][r.toString()] + 'px;';
                            }
                        }

                        column = luckysheet.replaceHtml(column, {"style":style, "span":""});
                    }

                    column += '</td>';
                    cpdata += column;
                }

                cpdata += "</tr>";
            }
            cpdata = '<table data-type="luckysheet_copy_action_table">' + colgroup + cpdata + '</table>';

            //console.log(luckysheet_selection_range, luckysheet_select_save);
            /*if (cpdata.length == 0) {
                return;
            }*/

            iscopyself = true;
            copyType = "normal";
            copysetting = [];
            // cpdata = cpdata.substring(0, cpdata.length);
            // cpdata = cpdata.substring(0, cpdata.length - 1);
            if (!clipboardData) {
                var textarea = $("#luckysheet-copy-content");
                textarea.html(cpdata);
                textarea.focus();
                textarea.select();
                document.execCommand("selectAll");
                document.execCommand("Copy");
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { 
                    $("#luckysheet-copy-content").blur(); 
                }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        copybyformat: function (e, txt) {//copy事件
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                clipboardData = e.originalEvent.clipboardData;
            }

            luckysheet_selection_range = [{ "row": luckysheet_select_save[0].row, "column": luckysheet_select_save[0].column }];
            luckysheet.selectionCopyShow();

            var cpdata = txt;

            /*if (cpdata.length == 0) {
                return;
            }*/
            iscopyself = true;
            copyType = "normal";
            copysetting = [];
            if (!clipboardData) {
                var textarea = $("#luckysheet-copy-content");
                textarea.text(cpdata);
                textarea.focus();
                textarea.select();
                document.execCommand("selectAll");
                document.execCommand("Copy");
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { textarea.blur(); }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        isPasteAction:false, 
        paste: function (e, triggerType) {//paste事件
            var textarea = $("#luckysheet-copy-content");
            var $t = this;
            textarea.focus();
            textarea.select();
            // 等50毫秒，keyPress事件发生了再去处理数据
            setTimeout(function () {
                var data = textarea.html();

                if (data.indexOf("luckysheet_copy_action_table") >- 1 && luckysheet_copy_save["copyRange"] != null && luckysheet_copy_save["copyRange"].length > 0) {
                    if(luckysheet_paste_iscut){
                        luckysheet_paste_iscut = false;
                        luckysheet.selection.pasteHandlerOfCutPaste(luckysheet_copy_save);
                        luckysheet.selection.clearcopy(e);
                    }
                    else{
                        luckysheet.selection.pasteHandlerOfCopyPaste(luckysheet_copy_save);
                    }
                    // textarea.html("");
                    // textarea.blur();
                }
                else if (triggerType != "btn") {
                    $t.pasteHandler(data);
                    // textarea.html("");
                    // textarea.blur();
                }
                else {
                    if(luckysheet.isEditMode()){
                        alert("在表格中进行复制粘贴: Ctrl + C 进行复制, Ctrl + V 进行粘贴, Ctrl + X 进行剪切");
                    }
                    else{
                        luckysheet.tooltip.info("在表格中进行复制粘贴", "<span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + C</span>&nbsp;&nbsp;进行复制<br/><span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + V</span>&nbsp;&nbsp;进行粘贴<br/><span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + X</span>&nbsp;&nbsp;进行剪切");
                    }
                }
            }, 10);
        },
        pasteHandler: function (data, borderInfo) {
            if(luckysheet_select_save.length > 1){
                if(luckysheet.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示', "不能对多重选择区域执行此操作，请选择单个区域，然后再试"); 
                }
            }

            if (typeof (data) == "object") {
                if (data.length == 0) { return; };

                var cfg = $.extend(true, {}, config);
                if(cfg["merge"] == null){
                    cfg["merge"] = {};
                }

                if(JSON.stringify(borderInfo).length > 2 && cfg["borderInfo"] == null){
                    cfg["borderInfo"] = [];
                }

                var copyh = data.length, copyc = data[0].length;

                var minh = luckysheet_select_save[0].row[0], maxh = minh + copyh - 1;            //应用范围首尾行
                var minc = luckysheet_select_save[0].column[0], maxc = minc + copyc - 1;         //应用范围首尾列

                //应用范围包含部分合并单元格，则return提示
                var hasPartMC = false;
                if(cfg["merge"] != null){
                    hasPartMC = luckysheet.hasPartMC(cfg, minh, maxh, minc, maxc);
                }
                
                if(hasPartMC){
                    if(luckysheet.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示', "不能对合并单元格做部分更改");  
                    }

                    return;
                }
                
                var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据
                var rowMaxLength = d.length;
                var cellMaxLength = d[0].length;

                //若应用范围超过最大行或最大列，增加行列
                var addr = maxh - rowMaxLength + 1, addc = maxc - cellMaxLength + 1;
                if(addr > 0 || addc > 0){
                    d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
                }

                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }
                
                var RowlChange = false;
                var offsetMC = {};
                for (var h = minh; h <= maxh; h++) {
                    var x = [].concat(d[h]);
                    
                    var currentRowLen = defaultrowlen;
                    if(cfg["rowlen"][h] != null){
                        currentRowLen = cfg["rowlen"][h];
                    }

                    for (var c = minc; c <= maxc; c++) {
                        if(luckysheet.getObjType(x[c]) == "object" && ("mc" in x[c])){
                            if("rs" in x[c].mc){
                                delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                            }

                            delete x[c].mc;
                        }

                        var value = null;
                        if (data[h - minh] != null && data[h - minh][c - minc] != null) {
                            value = data[h - minh][c - minc];
                        }

                        x[c] = $.extend(true, {}, value);

                        if(value != null && "mc" in x[c]){
                            if(x[c]["mc"].rs != null){
                                x[c]["mc"].r = h;
                                x[c]["mc"].c = c;

                                cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                            }
                            else{
                                x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                            }
                        }

                        if(borderInfo[(h - minh) + "_" + (c - minc)]){
                            var bd_obj = {
                                "rangeType": "cell",
                                "value": { 
                                    "row_index": h, 
                                    "col_index": c, 
                                    "l": borderInfo[(h - minh) + "_" + (c - minc)].l, 
                                    "r": borderInfo[(h - minh) + "_" + (c - minc)].r,
                                    "t": borderInfo[(h - minh) + "_" + (c - minc)].t,
                                    "b": borderInfo[(h - minh) + "_" + (c - minc)].b 
                                }
                            }

                            cfg["borderInfo"].push(bd_obj);
                        }
                        
                        var fontset = luckysheetfontformat(x[c]);
                        var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];
                        //比较计算高度和当前高度取最大高度
                        if(oneLineTextHeight > currentRowLen){
                            currentRowLen = oneLineTextHeight;
                            RowlChange = true;
                        }
                    }
                    d[h] = x;

                    if(currentRowLen != defaultrowlen){
                        cfg["rowlen"][h] = currentRowLen;
                    }
                }

                luckysheet_select_save = [{ "row": [minh, maxh], "column": [minc, maxc] }];
                
                if(addr > 0 || addc > 0 || RowlChange){
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, null, true);
                }
                else{
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg);
                    luckysheet.selectHightlightShow();
                }
            }
            else {
                data = data.replace(/\r/g, "");
                var dataChe = [];
                var che = data.split("\n"), colchelen = che[0].split("\t").length;
                for (var i = 0; i < che.length; i++) {
                    if (che[i].split("\t").length < colchelen) {
                        continue;
                    }
                    dataChe.push(che[i].split("\t"));
                }
                
                var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据

                var last = luckysheet_select_save[luckysheet_select_save.length - 1];
                var curR = last["row"] == null ? 0 : last["row"][0];
                var curC = last["column"] == null ? 0 : last["column"][0];
                var rlen = dataChe.length, clen = dataChe[0].length;

                //应用范围包含部分合并单元格，则return提示
                var hasPartMC = false;
                if(config["merge"] != null){
                    hasPartMC = luckysheet.hasPartMC(config, curR, curR + rlen - 1, curC, curC + clen - 1);
                }
                
                if(hasPartMC){
                    if(luckysheet.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                    }
                    return;
                }

                var addr = curR + rlen - d.length, addc = curC + clen - d[0].length;
                if(addr > 0 || addc > 0){
                    d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
                }

                for (var r = 0; r < rlen; r++) {
                    var x = [].concat(d[r + curR]);
                    for (var c = 0; c < clen; c++) {
                        var cell = {};

                        var mask = luckysheet.mask.genarate(dataChe[r][c]);
                        cell.v = mask[2];
                        cell.ct = mask[1];
                        cell.m = mask[0];

                        x[c + curC] = cell;
                    }
                    d[r + curR] = x;
                }

                last["row"] = [curR, curR + rlen - 1];
                last["column"] = [curC, curC + clen - 1];

                if (addr > 0 || addc > 0) {
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, null, null, true);
                }
                else {
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save);
                    luckysheet.selectHightlightShow();
                }
            }
        },
        pasteHandlerOfCutPaste: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];

            var copySheetIndex = copyRange["dataSheetIndex"];
            var copyData = $.extend(true, [], luckysheet.getdatabyselection({"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, copySheetIndex));

            var copyh = copyData.length, copyc = copyData[0].length;

            //应用范围
            var last = luckysheet_select_save[luckysheet_select_save.length - 1];
            var minh = last["row_focus"], maxh = minh + copyh - 1;         //应用范围首尾行
            var minc = last["column_focus"], maxc = minc + copyc - 1;      //应用范围首尾列

            //应用范围包含部分合并单元格，则提示
            var hasPartMC = false;
            if(cfg["merge"] != null){
                hasPartMC = luckysheet.hasPartMC(cfg, minh, maxh, minc, maxc);
            }
            
            if(hasPartMC){
                if(luckysheet.isEditMode()){
                    alert("不能对合并单元格做部分更改");
                }
                else{
                    luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                }
                return;
            }

            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据
            var rowMaxLength = d.length;
            var cellMaxLength = d[0].length;

            var addr = copyh + minh - rowMaxLength, addc = copyc + minc - cellMaxLength;
            if(addr > 0 || addc > 0){
                d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
            }

            var borderInfoCompute = luckysheet.getBorderInfoCompute(copySheetIndex);
            
            //剪切粘贴在当前表操作，删除剪切范围内数据和合并单元格
            if(luckysheet.currentSheetIndex == copySheetIndex){
                for(var i = copyRange["copyRange"][0].row[0]; i <= copyRange["copyRange"][0].row[1]; i++){
                    for(var j = copyRange["copyRange"][0].column[0]; j <= copyRange["copyRange"][0].column[1]; j++){
                        var cell = d[i][j];

                        if(luckysheet.getObjType(cell) == "object" && ("mc" in cell)){
                            if("rs" in cell["mc"]){
                                delete cfg["merge"][cell["mc"].r + "_" + cell["mc"].c];
                            }
                            delete cell["mc"];
                        }

                        d[i][j] = null;
                    }
                }

                //边框
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var source_borderInfo = [];

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var bd_rangeType = cfg["borderInfo"][i].rangeType;

                        if(bd_rangeType == "range"){
                            var bd_range = cfg["borderInfo"][i].range;
                            var bd_emptyRange = [];

                            for(var j = 0; j < bd_range.length; j++){
                                bd_emptyRange = bd_emptyRange.concat(luckysheet.conditionformat.CFSplitRange(bd_range[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart"));
                            }

                            cfg["borderInfo"][i].range = bd_emptyRange;

                            source_borderInfo.push(cfg["borderInfo"][i]);
                        }
                        else if(bd_rangeType == "cell"){
                            var bd_r = cfg["borderInfo"][i].value.row_index;
                            var bd_c = cfg["borderInfo"][i].value.col_index;

                            if(!(bd_r >= copyRange["copyRange"][0].row[0] && bd_r <= copyRange["copyRange"][0].row[1] && bd_c >= copyRange["copyRange"][0].column[0] && bd_c <= copyRange["copyRange"][0].column[1])){
                                source_borderInfo.push(cfg["borderInfo"][i]);
                            }
                        }
                    }

                    cfg["borderInfo"] = source_borderInfo;
                }
            }

            var offsetMC = {};
            for (var h = minh; h <= maxh; h++) {
                var x = [].concat(d[h]);

                for (var c = minc; c <= maxc; c++) {
                    if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)]){
                        var bd_obj = {
                            "rangeType": "cell",
                            "value": {
                                "row_index": h,
                                "col_index": c,
                                "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].l,
                                "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].r,
                                "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].t,
                                "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].b
                            }
                        }

                        if(cfg["borderInfo"] == null){
                            cfg["borderInfo"] = [];
                        }

                        cfg["borderInfo"].push(bd_obj);
                    }
                    else if(borderInfoCompute[h + "_" + c]){
                        var bd_obj = {
                            "rangeType": "cell",
                            "value": {
                                "row_index": h,
                                "col_index": c,
                                "l": null,
                                "r": null,
                                "t": null,
                                "b": null
                            }
                        }

                        if(cfg["borderInfo"] == null){
                            cfg["borderInfo"] = [];
                        }

                        cfg["borderInfo"].push(bd_obj);
                    }

                    if(luckysheet.getObjType(x[c]) == "object" && ("mc" in x[c])){
                        if("rs" in x[c].mc){
                            delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                        }
                        delete x[c].mc;
                    }

                    var value = null;
                    if (copyData[h - minh] != null && copyData[h - minh][c - minc] != null) {
                        value = copyData[h - minh][c - minc];
                    }

                    x[c] = $.extend(true, {}, value);

                    if(value != null && copyHasMC && ("mc" in x[c])){
                        if(x[c]["mc"].rs != null){
                            x[c]["mc"].r = h;
                            x[c]["mc"].c = c;

                            cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                            offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                        }
                        else{
                            x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                        }
                    }
                }
                d[h] = x;
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];
            
            //若有行高改变，重新计算行高改变
            if(copyRowlChange){
                if(luckysheet.currentSheetIndex != copySheetIndex){
                    cfg = luckysheet.rowlenByRange(d, minh, maxh, cfg);
                }
                else{
                    cfg = luckysheet.rowlenByRange(d, copyRange["copyRange"][0].row[0], copyRange["copyRange"][0].row[1], cfg);
                    cfg = luckysheet.rowlenByRange(d, minh, maxh, cfg);
                }
            }

            if(luckysheet.currentSheetIndex != copySheetIndex){
                //跨表操作
                var sourceData = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(copySheetIndex)]["data"]);
                var sourceConfig = $.extend(true, {}, luckysheetfile[luckysheet.sheetmanage.getSheetIndex(copySheetIndex)]["config"]);

                var sourceCurData = $.extend(true, [], sourceData);
                var sourceCurConfig = $.extend(true, {}, sourceConfig);
                if(sourceCurConfig["merge"] == null){
                    sourceCurConfig["merge"] = {};
                }

                var source_r1 = copyRange["copyRange"][0].row[0], source_r2 = copyRange["copyRange"][0].row[1];
                var source_c1 = copyRange["copyRange"][0].column[0], source_c2 = copyRange["copyRange"][0].column[1];

                for(var source_r = source_r1; source_r <= source_r2; source_r++){
                    for(var source_c = source_c1; source_c <= source_c2; source_c++){
                        var cell = sourceCurData[source_r][source_c];

                        if(luckysheet.getObjType(cell) == "object" && ("mc" in cell)){
                            if("rs" in cell["mc"]){
                                delete sourceCurConfig["merge"][cell["mc"].r + "_" + cell["mc"].c];
                            }
                            delete cell["mc"];
                        }
                        sourceCurData[source_r][source_c] = null;
                    }
                }

                if(copyRowlChange){
                    sourceCurConfig = luckysheet.rowlenByRange(sourceCurData, source_r1, source_r2, sourceCurConfig);
                }

                //边框
                if(sourceCurConfig["borderInfo"] && sourceCurConfig["borderInfo"].length > 0){
                    var source_borderInfo = [];

                    for(var i = 0; i < sourceCurConfig["borderInfo"].length; i++){
                        var bd_rangeType = sourceCurConfig["borderInfo"][i].rangeType;

                        if(bd_rangeType == "range"){
                            var bd_range = sourceCurConfig["borderInfo"][i].range;
                            var bd_emptyRange = [];

                            for(var j = 0; j < bd_range.length; j++){
                                bd_emptyRange = bd_emptyRange.concat(luckysheet.conditionformat.CFSplitRange(bd_range[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart"));
                            }

                            sourceCurConfig["borderInfo"][i].range = bd_emptyRange;

                            source_borderInfo.push(sourceCurConfig["borderInfo"][i]);
                        }
                        else if(bd_rangeType == "cell"){
                            var bd_r = sourceCurConfig["borderInfo"][i].value.row_index;
                            var bd_c = sourceCurConfig["borderInfo"][i].value.col_index;

                            if(!(bd_r >= copyRange["copyRange"][0].row[0] && bd_r <= copyRange["copyRange"][0].row[1] && bd_c >= copyRange["copyRange"][0].column[0] && bd_c <= copyRange["copyRange"][0].column[1])){
                                source_borderInfo.push(sourceCurConfig["borderInfo"][i]);
                            }
                        }
                    }

                    sourceCurConfig["borderInfo"] = source_borderInfo;
                }

                //条件格式
                var source_cdformat = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(copySheetIndex)]["luckysheet_conditionformat_save"]);
                var source_curCdformat = $.extend(true, [], source_cdformat);
                var ruleArr = [];
                if(source_curCdformat != null && source_curCdformat.length > 0){
                    for(var i = 0; i < source_curCdformat.length; i++){
                        var source_curCdformat_cellrange = source_curCdformat[i].cellrange;
                        var emptyRange = [];
                        var emptyRange2 = [];

                        for(var j = 0; j < source_curCdformat_cellrange.length; j++){
                            var range = luckysheet.conditionformat.CFSplitRange(source_curCdformat_cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart");
                            emptyRange = emptyRange.concat(range);

                            var range2 = luckysheet.conditionformat.CFSplitRange(source_curCdformat_cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "operatePart");
                            if(range2.length > 0){
                                emptyRange2 = emptyRange2.concat(range2);
                            }
                        }

                        source_curCdformat[i].cellrange = emptyRange;

                        if(emptyRange2.length > 0){
                            var ruleObj = $.extend(true, {}, source_curCdformat[i]);
                            ruleObj.cellrange = emptyRange2;
                            ruleArr.push(ruleObj);
                        }
                    }
                }

                var target_cdformat = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"]);
                var target_curCdformat = $.extend(true, [], target_cdformat);
                if(ruleArr.length > 0){
                    target_curCdformat = target_curCdformat.concat(ruleArr);
                }

                var source = {
                    "sheetIndex": copySheetIndex,
                    "data": sourceData,
                    "curData": sourceCurData,
                    "config": sourceConfig,
                    "curConfig": sourceCurConfig,
                    "cdformat": source_cdformat,
                    "curCdformat": source_curCdformat,
                    "range": {
                        "row": copyRange["copyRange"][0].row,
                        "column": copyRange["copyRange"][0].column
                    }
                }
                var target = {
                    "sheetIndex": luckysheet.currentSheetIndex,
                    "data": luckysheet.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": target_cdformat,
                    "curCdformat": target_curCdformat,
                    "range": {
                        "row": [minh, maxh],
                        "column": [minc, maxc]
                    }
                }
            }
            else{
                //条件格式
                var cdformat = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"]);
                var curCdformat = $.extend(true, [], cdformat);
                if(curCdformat != null && curCdformat.length > 0){
                    for(var i = 0; i < curCdformat.length; i++){
                        var cellrange = curCdformat[i].cellrange;
                        var emptyRange = [];

                        for(var j = 0; j < cellrange.length; j++){
                            var range = luckysheet.conditionformat.CFSplitRange(cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "allPart");
                            emptyRange = emptyRange.concat(range);
                        }

                        curCdformat[i].cellrange = emptyRange;
                    }
                }

                //当前表操作
                var source = {
                    "sheetIndex": luckysheet.currentSheetIndex,
                    "data": luckysheet.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": cdformat,
                    "curCdformat": curCdformat,
                    "range": {
                        "row": copyRange["copyRange"][0].row,
                        "column": copyRange["copyRange"][0].column
                    }
                }
                var target = {
                    "sheetIndex": luckysheet.currentSheetIndex,
                    "data": luckysheet.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": cdformat,
                    "curCdformat": curCdformat,
                    "range": {
                        "row": [minh, maxh],
                        "column": [minc, maxc]
                    }
                }
            }

            if(addr > 0 || addc > 0){
                luckysheet.jfrefreshgrid_pastcut(source, target, true);
            }
            else{
                luckysheet.jfrefreshgrid_pastcut(source, target, copyRowlChange);
            }
        },
        pasteHandlerOfCopyPaste: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];
            var copySheetIndex = copyRange["dataSheetIndex"];

            var arr = [], isSameRow = false;
            for(var i = 0; i < copyRange["copyRange"].length; i++){
                var arrData = luckysheet.getdatabyselection({"row": copyRange["copyRange"][i].row, "column": copyRange["copyRange"][i].column}, copySheetIndex);
                if(copyRange["copyRange"].length > 1){
                    if(copyRange["copyRange"][0].row[0] == copyRange["copyRange"][1].row[0] && copyRange["copyRange"][0].row[1] == copyRange["copyRange"][1].row[1]){
                        arrData = arrData[0].map(function(col, a){
                            return arrData.map(function(row){
                                return row[a];
                            });
                        });

                        arr = arr.concat(arrData);

                        isSameRow = true;
                    }
                    else if(copyRange["copyRange"][0].column[0] == copyRange["copyRange"][1].column[0] && copyRange["copyRange"][0].column[1] == copyRange["copyRange"][1].column[1]){
                        arr = arr.concat(arrData);
                    }
                }
                else{
                    arr = arrData;
                }
            }

            if(isSameRow){
                arr = arr[0].map(function(col, b){
                    return arr.map(function(row){
                        return row[b];
                    })
                })
            }

            var copyData = $.extend(true, [], arr);

            //多重选择选择区域 单元格如果有函数 则只取值 不取函数
            if(copyRange["copyRange"].length > 1){
                for(var i = 0; i < copyData.length; i++){
                    for(var j = 0; j < copyData[i].length; j++){
                        if(copyData[i][j] != null && copyData[i][j].f != null){
                            delete copyData[i][j].f;
                            delete copyData[i][j].spl;
                        }
                    }
                }
            }

            var copyh = copyData.length, copyc = copyData[0].length;

            //应用范围
            var last = luckysheet_select_save[luckysheet_select_save.length - 1];
            var minh = last["row"][0], maxh = last["row"][1];         //应用范围首尾行
            var minc = last["column"][0], maxc = last["column"][1];   //应用范围首尾列

            var mh = (maxh - minh + 1) % copyh;
            var mc = (maxc - minc + 1) % copyc;

            if(mh != 0 || mc != 0){ //若应用范围不是copydata行列数的整数倍，则取copydata的行列数
                maxh = minh + copyh - 1;
                maxc = minc + copyc - 1;
            }

            //应用范围包含部分合并单元格，则提示
            var hasPartMC = false;
            if(cfg["merge"] != null){
                hasPartMC = luckysheet.hasPartMC(cfg, minh, maxh, minc, maxc);
            }
            
            if(hasPartMC){
                if(luckysheet.isEditMode()){
                    alert("不能对合并单元格做部分更改");
                }
                else{
                    luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                }
                return;
            }

            var timesH = (maxh - minh + 1) / copyh;
            var timesC = (maxc - minc + 1) / copyc;

            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据
            var rowMaxLength = d.length;
            var cellMaxLength = d[0].length;

            //若应用范围超过最大行或最大列，增加行列
            var addr = copyh + minh - rowMaxLength, addc = copyc + minc - cellMaxLength;
            if(addr > 0 || addc > 0){
                d = luckysheet.datagridgrowth([].concat(d), addr, addc, true);
            }

            var borderInfoCompute = luckysheet.getBorderInfoCompute(copySheetIndex);

            var mth = 0, mtc = 0, maxcellCahe = 0, maxrowCache = 0;
            for(var th = 1; th <= timesH; th++){
                for(var tc = 1; tc <= timesC; tc++){
                    mth = minh + (th - 1) * copyh;
                    mtc = minc + (tc - 1) * copyc;
                    maxrowCache = minh + th * copyh;
                    maxcellCahe = minc + tc * copyc;

                    //行列位移值 用于单元格有函数
                    var offsetRow = mth - copyRange["copyRange"][0].row[0];
                    var offsetCol = mtc - copyRange["copyRange"][0].column[0];

                    var offsetMC = {};
                    for (var h = mth; h < maxrowCache; h++) {
                        var x = [].concat(d[h]);

                        for (var c = mtc; c < maxcellCahe; c++) {
                            if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].l,
                                        "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].r,
                                        "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].t,
                                        "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].b
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[h + "_" + c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }

                            if(luckysheet.getObjType(x[c]) == "object" && "mc" in x[c]){
                                if("rs" in x[c].mc){
                                    delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                                }
                                delete x[c].mc;
                            }

                            var value = null;
                            if (copyData[h - mth] != null && copyData[h - mth][c - mtc] != null) {
                                value = $.extend(true, {}, copyData[h - mth][c - mtc]);
                            }

                            if(value != null && value.f != null){
                                var func = value.f;

                                if(offsetRow > 0){
                                    func = "=" + luckysheet.formula.functionCopy(func, "down", offsetRow);
                                }

                                if(offsetRow < 0){
                                    func = "=" + luckysheet.formula.functionCopy(func, "up", Math.abs(offsetRow));
                                }

                                if(offsetCol > 0){
                                    func = "=" + luckysheet.formula.functionCopy(func, "right", offsetCol);
                                }

                                if(offsetCol < 0){
                                    func = "=" + luckysheet.formula.functionCopy(func, "left", Math.abs(offsetCol));
                                }

                                var funcV = luckysheet.formula.execfunction(func, h, c, true);

                                if(value.spl != null){
                                    value.f = funcV[2];
                                    value.v = funcV[1];
                                    value.spl = funcV[3].data;
                                }
                                else{
                                    value.f = funcV[2];
                                    value.v = funcV[1];

                                    if(value.ct != null && value.ct["fa"] != null){
                                        value.m = luckysheet.mask.update(value.ct["fa"], funcV[1]);
                                    }
                                }
                            }

                            x[c] = $.extend(true, {}, value);

                            if(value != null && copyHasMC && ("mc" in x[c])){
                                if(x[c]["mc"].rs != null){
                                    x[c]["mc"].r = h;
                                    x[c]["mc"].c = c;

                                    cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                    offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                                }
                                else{
                                    x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                                }
                            }
                        }

                        d[h] = x;
                    }
                }
            }

            //复制范围 是否有 条件格式
            if(copyRange["copyRange"].length == 1){
                var c_file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(copySheetIndex)];
                var a_file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];

                var c_r1 = copyRange["copyRange"][0].row[0],
                    c_r2 = copyRange["copyRange"][0].row[1],
                    c_c1 = copyRange["copyRange"][0].column[0],
                    c_c2 = copyRange["copyRange"][0].column[1];
                
                var ruleArr_cf = $.extend(true, [], c_file["luckysheet_conditionformat_save"]);
                var cdformat = $.extend(true, [], a_file["luckysheet_conditionformat_save"]);

                if(ruleArr_cf != null && ruleArr_cf.length > 0){
                    for(var i = 0; i < ruleArr_cf.length; i++){
                        var cf_range = ruleArr_cf[i].cellrange;

                        var emptyRange = [];

                        for(var th = 1; th <= timesH; th++){
                            for(var tc = 1; tc <= timesC; tc++){
                                mth = minh + (th - 1) * copyh;
                                mtc = minc + (tc - 1) * copyc;
                                maxrowCache = minh + th * copyh;
                                maxcellCahe = minc + tc * copyc;

                                for(var j = 0; j < cf_range.length; j++){
                                    var range = luckysheet.conditionformat.CFSplitRange(cf_range[j], {"row": [c_r1, c_r2], "column": [c_c1, c_c2]}, {"row": [mth, maxrowCache - 1], "column": [mtc, maxcellCahe - 1]}, "operatePart");
                                    if(range.length > 0){
                                        emptyRange = emptyRange.concat(range);
                                    }
                                }
                            }
                        }

                        if(emptyRange.length > 0){
                            ruleArr_cf[i].cellrange = emptyRange;
                            cdformat.push(ruleArr_cf[i]);
                        }
                    }
                }
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];

            if(copyRowlChange || addr > 0 || addc > 0){
                cfg = luckysheet.rowlenByRange(d, minh, maxh, cfg);

                if(copyRange["copyRange"].length == 1 && ruleArr_cf != null && ruleArr_cf.length > 0){
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, cdformat, true);
                }
                else{
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, null, true);
                }
            }
            else{
                if(copyRange["copyRange"].length == 1 && ruleArr_cf != null && ruleArr_cf.length > 0){
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, cdformat);
                }
                else{
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg);
                }

                luckysheet.selectHightlightShow();
            }
        },
        pasteHandlerOfPaintModel: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];

            var copySheetIndex = copyRange["dataSheetIndex"];
            var copyData = $.extend(true, [], luckysheet.getdatabyselection({"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, copySheetIndex));

            //应用范围
            var last = luckysheet_select_save[luckysheet_select_save.length - 1];
            var minh = last["row"][0], maxh = last["row"][1];         //应用范围首尾行
            var minc = last["column"][0], maxc = last["column"][1];   //应用范围首尾列

            var copyh = copyData.length, copyc = copyData[0].length;

            if(minh == maxh && minc == maxc){
                //应用范围是一个单元格，自动增加到复制范围大小 (若自动增加的范围包含部分合并单元格，则提示)
                var hasPartMC = false;
                if(cfg["merge"] != null){
                    hasPartMC = luckysheet.hasPartMC(cfg, minh, minh + copyh - 1, minc, minc + copyc - 1);
                }
                
                if(hasPartMC){
                    if(luckysheet.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        luckysheet.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                    }
                    return;
                }

                maxh = minh + copyh - 1; 
                maxc = minc + copyc - 1;
            }

            var timesH = Math.ceil((maxh - minh + 1) / copyh);  //复制行 组数
            var timesC = Math.ceil((maxc - minc + 1) / copyc);  //复制列 组数

            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据
            var cellMaxLength = d[0].length;
            var rowMaxLength = d.length;

            var borderInfoCompute = luckysheet.getBorderInfoCompute(copySheetIndex);

            var mth = 0, mtc = 0, record, row1, cell1, column, maxcellCahe = 0, maxrowCache = 0, editorable, olddata;
            for (var th = 1; th <= timesH; th++) {
                for (var tc = 1; tc <= timesC; tc++) {
                    mth = minh + (th - 1) * copyh;
                    mtc = minc + (tc - 1) * copyc;

                    maxrowCache = minh + th * copyh > rowMaxLength ? rowMaxLength : minh + th * copyh;
                    if(maxrowCache > (maxh + 1)){
                        maxrowCache = maxh + 1;
                    }

                    maxcellCahe = minc + tc * copyc > cellMaxLength ? cellMaxLength : minc + tc * copyc;
                    if(maxcellCahe > (maxc + 1)){
                        maxcellCahe = maxc + 1;
                    }

                    var offsetMC = {};
                    for (var h = mth; h < maxrowCache; h++) {
                        var x = [].concat(d[h]);

                        for (var c = mtc; c < maxcellCahe; c++) {
                            if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].l,
                                        "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].r,
                                        "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].t,
                                        "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].b
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[h + "_" + c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }

                            if(luckysheet.getObjType(x[c]) == "object" && ("mc" in x[c])){
                                if("rs" in x[c].mc){
                                    delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                                }
                                delete x[c].mc;
                            }

                            var value = null;
                            if (copyData[h - mth] != null && copyData[h - mth][c - mtc] != null) {
                                value = copyData[h - mth][c - mtc];
                            }

                            if(value != null){
                                delete value["v"];
                                delete value["m"];
                                delete value["f"];
                                delete value["spl"];

                                if(luckysheet.getObjType(x[c]) == "object"){

                                }
                                else{
                                    x[c] = {"v": x[c] };
                                }

                                x[c] = $.extend(true, x[c], value);

                                if(copyHasMC && ("mc" in x[c])){
                                    if(x[c]["mc"].rs != null){
                                        x[c]["mc"].r = h;
                                        if(x[c]["mc"].rs + h >= maxrowCache){
                                            x[c]["mc"].rs = maxrowCache - h;
                                        }

                                        x[c]["mc"].c = c;
                                        if(x[c]["mc"].cs + c >= maxcellCahe){
                                            x[c]["mc"].cs = maxcellCahe - c;
                                        }

                                        cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                        offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                                    }
                                    else{
                                        x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                                    }
                                }

                                if(x[c].v != null){
                                    if(value["ct"] != null && value["ct"]["fa"] != null){
                                        var mask = luckysheet.mask.update(value["ct"]["fa"], x[c].v);
                                        x[c].m = mask;
                                    }
                                }
                            }
                        }
                        d[h] = x;
                    }
                }
            }

            //复制范围 是否有 条件格式
            var ruleArr = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(copySheetIndex)]["luckysheet_conditionformat_save"]);
            var cdformat = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"]);

            if(ruleArr != null && ruleArr.length > 0){
                for(var i = 0; i < ruleArr.length; i++){
                    var cdformat_cellrange = ruleArr[i].cellrange;

                    var emptyRange = [];

                    for(var j = 0; j < cdformat_cellrange.length; j++){
                        var range = luckysheet.conditionformat.CFSplitRange(cdformat_cellrange[j], {"row": copyRange["copyRange"][0]["row"], "column": copyRange["copyRange"][0]["column"]}, {"row": [minh, maxh], "column": [minc, maxc]}, "operatePart");
                        if(range.length > 0){
                            emptyRange = emptyRange.concat(range);
                        }
                    }

                    if(emptyRange.length > 0){
                        ruleArr[i].cellrange = [{"row": [minh, maxh], "column": [minc, maxc]}];
                        cdformat.push(ruleArr[i]);
                    }
                }
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];

            if(copyRowlChange){
                cfg = luckysheet.rowlenByRange(d, minh, maxh, cfg);

                if(ruleArr != null && ruleArr.length > 0){
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, cdformat, true);
                }
                else{
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, null, true);
                }
            }
            else{
                if(ruleArr != null && ruleArr.length > 0){
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, cdformat);
                }
                else{
                    luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg);
                }

                luckysheet.selectHightlightShow();
            }
        },
        matchcopy: function (data1, data2) {
            var data1cache = [], data2cache = [], data1len, data2len;
            if (typeof (data1) == "object") {
                data1cache = data1;
            }
            else {
                data1cache = data1.split("\n");
                for (var i = 0; i < data1cache.length; i++) {
                    data1cache[i] = data1cache[i].split("\t");
                }
            }
            data1len = data1cache.length;

            if (typeof (data2) == "object") {
                data2cache = data2;
            }
            else {
                data2cache = data2.split("\n");
                for (var i = 0; i < data2cache.length; i++) {
                    data2cache[i] = data2cache[i].split("\t");
                }
            }

            data2len = data2cache.length;

            if (data1len != data2len) {
                return false;
            }


            for (var r1 = 0; r1 < data1len; r1++) {
                if (config["rowhidden"] != null && config["rowhidden"][r1] != null) {
                    continue;
                }
                for (var r2 = 0; r2 < data2len; r2++) {
                    if (data1cache[r1].length != data2cache[r2].length) {
                        return false;
                    }
                }
            }

            for (var r = 0; r < data1len; r++) {
                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                    continue;
                }
                for (var c = 0; c < data1cache[0].length; c++) {
                    if (luckysheet.getcellvalue(r, c, data1cache) != luckysheet.getcellvalue(r, c, data2cache)) {
                        return false;
                    }
                }
            }

            return true;
        }
    };

    luckysheet.datecontroll = {
        isdatetime: function (s) {
            if (s == null || s.toString().length < 5) {
                return false;
            }
            else if(checkDateTime(s)){
                return true;
            }
            else {
                return false;
            }

            function checkDateTime(str){
                var reg1 = /^(\d{4})-(\d{1,2})-(\d{1,2})(\s(\d{1,2}):(\d{1,2})(:(\d{1,2}))?)?$/;
                var reg2 = /^(\d{4})\/(\d{1,2})\/(\d{1,2})(\s(\d{1,2}):(\d{1,2})(:(\d{1,2}))?)?$/;

                if(!reg1.test(str) && !reg2.test(str)){
                    return false;
                }

                var year = RegExp.$1,
                    month = RegExp.$2,
                    day = RegExp.$3;

                if(year < 1900){
                    return false;
                }

                if(month > 12){
                    return false;
                }

                if(day > 31){
                    return false;
                }

                if(month == 2){
                    if(new Date(year, 1, 29).getDate() == 29 && day > 29){
                        return false;
                    }
                    else if(new Date(year, 1, 29).getDate() != 29 && day > 28){
                        return false;
                    }
                }

                return true;
            }
        },
        diff: function (now, then) {
            return moment(now).diff(moment(then));
        }
    };

    luckysheet.isdatatype = function (s) {
        var type = "string";
        if (luckysheet.datecontroll.isdatetime(s)) {
            type = "date";
        }
        else if (!isNaN(parseFloat(s)) && !luckysheet.hasChinaword(s)) {
            type = "num";
        }
        return type;
    }

    luckysheet.isdatatypemulti = function (s) {
        var type = {};
        if (luckysheet.datecontroll.isdatetime(s)) {
            type["date"] = true;
        }

        if (!isNaN(parseFloat(s)) && !luckysheet.hasChinaword(s)) {
            type["num"] = true;
        }

        return type;
    }

    luckysheet.numfloatlen = function (n) {
        if (n != null && !isNaN(parseFloat(n)) && !luckysheet.hasChinaword(n)) {
            var value = numeral(n).value();
            var lens = value.toString().split(".");
            if (lens.length == 1) {
                lens = 0;
            }
            else {
                lens = lens[1].length;
            }
            return lens;
        }
        else {
            return null;
        }
    }

    luckysheet.range_config = function(rangeConfigCheck, rangeRowCheck, rangeColCheck){
        if(rangeConfigCheck){
            luckysheet.chartparam.jgridCurrentChartData = luckysheet.jgfridturntrans(luckysheet.chartparam.jgridCurrentChartData);
        }

        if (rangeRowCheck) {
            //luckysheet.chartparam.jgridCurrentChartData.shift();
        }
        else {
            var addrow = [];
            //旧图表转置功能和设置列行配合
            var c_st,c_length;
            if(rangeConfigCheck){
                c_st = luckysheet.chartparam.jgridCurrentChartSelection["row"][0];
                c_length = luckysheet.chartparam.jgridCurrentChartSelection["row"][1];
            }else{
                c_st = luckysheet.chartparam.jgridCurrentChartSelection["column"][0];
                c_length = luckysheet.chartparam.jgridCurrentChartSelection["column"][1]
            }
             
            for (var i = c_st; i <= c_length; i++) {
                if(rangeColCheck && i==c_st){//选中列为标签列时，先添加标题
                    addrow.push("");
                }else{
                    addrow.push(luckysheet.luckysheetchatatABC(i));
                }
                
                
            }
            luckysheet.chartparam.jgridCurrentChartData.unshift(addrow);
        }

        if (rangeColCheck) {
            // for (var i = 0; i < luckysheet.chartparam.jgridCurrentChartData.length; i++) {
            //     luckysheet.chartparam.jgridCurrentChartData[i].shift();
            // }
        }
        else {
            //console.log(luckysheet.chartparam.jgridCurrentChartData, luckysheet.chartparam.jgridCurrentChartSelection);
            var curlen = luckysheet.chartparam.jgridCurrentChartData.length;
            //var $rowcheck = $("#luckysheet-datavisual-range-config-row");
            luckysheet.chartparam.jgridCurrentChartData[0].unshift(""); //无论rangeRowCheck为何值都添加
            for (var i = 1; i < curlen; i++) {
                // if(rangeRowCheck && i==0 || ){
                //     luckysheet.chartparam.jgridCurrentChartData[i].unshift("");
                // }
                // else{
                    var fix = 0;
                    if(rangeRowCheck){
                        fix = 1;
                    }
                    luckysheet.chartparam.jgridCurrentChartData[i].unshift(luckysheet.luckysheetchatatABC(luckysheet.chartparam.jgridCurrentChartSelection["column"][0]) + (i + luckysheet.chartparam.jgridCurrentChartSelection["row"][0] + fix));
                // }
                
            }
            //luckysheet.chartparam.jgridCurrentChartData.unshift(addrow);
        }
    }

    luckysheet.numFormat = function (num, type) {
        if (num == null || isNaN(parseFloat(num)) || luckysheet.hasChinaword(num) || num == -Infinity || num == Infinity) {
            return null;
        }

        var floatlen = 6, ismustfloat = false;
        if (type == null || type == "auto") {
            if (num < 1) {
                floatlen = 6;
            }
            else {
                floatlen = 1;
            }
        }
        else {
            if (luckysheet.isdatatype(type) == "num") {
                floatlen = parseInt(type);
                ismustfloat = true;
            }
            else {
                floatlen = 6;
            }
        }

        var format = "", value = null;
        for (var i = 0; i < floatlen; i++) {
            format += "0";
        }

        if (!ismustfloat) {
            format = "[" + format + "]";
        }

        if(num >= 1e+21){
            value = parseFloat(numeral(num).value());
        }
        else{
            value = parseFloat(numeral(num).format("0." + format));
        }

        return value;
    }

    luckysheet.array = {
        transpose: function (getdata) {
            var arr = [];
            //console.log(getdata);
            if (getdata.length == 0) {
                return [];
            }

            if (getdata[0].length == 0) {
                return [];
            }

            for (var c = 0; c < getdata[0].length; c++) {
                var a = [];
                for (var r = 0; r < getdata.length; r++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = luckysheet.getcellvalue(r, c, getdata);
                    }
                    //console.log(value);
                    a.push(value);
                }
                arr.push(a);
            }

            return arr;
        },
        minusClear:function(p, m){
            if(m.row[0]>p.row[1] || m.row[1]<p.row[0] || m.column[0]>p.column[1] || m.column[1]<p.column[0]){
                return null;
            }

            if(m.row[0]==p.row[0] && m.row[1]<p.row[1] && m.column[0]>p.column[0] && m.column[1]<p.column[1]){
                return [];
            }

            var ret = [], range = {row:[], column:[]};

            var row = null, column = [p.column[0], p.column[1]];
            if(m.row[1]>p.row[0] && m.row[1]<p.row[1]){
                row = [m.row[1]+1, p.row[1]];
            }
            else if(m.row[0]>p.row[0] && m.row[0]<p.row[1]){
                row = [p.row[0], m.row[0]-1];
            }

            if(row!=null){
                ret.push({"row":row, "column":column});
            }
            

            var row = [p.row[0], p.row[1]], column = null;
            if(m.column[1]>p.column[0] && m.column[1]<p.column[1]){
                column = [m.column[1]+1, p.column[1]];
            }
            else if(m.column[0]>p.column[0] && m.column[0]<p.column[1]){
                column = [p.column[0], m.column[0]-1];
            }

            if(column!=null){
                ret.push({"row":row, "column":column});
            }

            //console.log(ret);
            
            return ret;

            // for(var r =p.row[0];r<=p.row[1];r++){
            //     var 
            //     for(var c =p.column[0];c<=p.column[1];c++){

            //     }
            // }
        }
    }

    luckysheet.analysis = {
        "STDEVP": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return luckysheet.numFormat(Math.sqrt(cov / array1d.length));
        },
        "STDEV": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return luckysheet.numFormat(Math.sqrt(cov / (array1d.length - 1)));
        },
        "VARP": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return luckysheet.numFormat(cov / array1d.length);
        },
        "VAR": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return luckysheet.numFormat(cov / (array1d.length - 1));
        },
    };

    luckysheet.tooltip = {
        info: function (title, content) {
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-info").remove();
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-info", "addclass": "", "title": title, "content": content, "botton": '<button class="btn btn-default luckysheet-model-close-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-info").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-info").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        confirm: function (title, content, func1, func2, name1, name2) {
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-confirm").remove();
            if(name1==null){
                name1 = "确定";
            }
            if(name2==null){
                name2 = "取消";
            }
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-confirm", "addclass": "", "style": "z-index:100003", "title": title, "content": content, "botton": '<button class="btn btn-primary luckysheet-model-conform-btn">&nbsp;&nbsp;'+ name1 +'&nbsp;&nbsp;</button><button class="btn btn-default luckysheet-model-cancel-btn">&nbsp;&nbsp;'+ name2 +'&nbsp;&nbsp;</button>' }));
            var $t = $("#luckysheet-confirm").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-confirm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            $t.find(".luckysheet-model-conform-btn").click(function () {
                if (typeof func1 == 'function') {
                    func1();
                }
                $("#luckysheet-confirm").hide();
                $("#luckysheet-modal-dialog-mask").hide();  
            });
            $t.find(".luckysheet-model-cancel-btn").click(function () {
                if (typeof func2 == 'function') {
                    func2();
                }
                $("#luckysheet-confirm").hide();
                $("#luckysheet-modal-dialog-mask").hide();
            });
        },
        screenshot: function (title, content, imgurl) {
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-confirm").remove();
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-confirm", "addclass": "", "style": "z-index:100003", "title": title, "content": content, "botton": '<a style="text-decoration:none;color:#fff;" class="download btn btn-primary luckysheet-model-conform-btn">&nbsp;&nbsp;下载&nbsp;&nbsp;</a>&nbsp;&nbsp;<button class="btn btn-primary luckysheet-model-copy-btn">&nbsp;&nbsp;复制到剪切板&nbsp;&nbsp;</button><button class="btn btn-default luckysheet-model-cancel-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>' }));
            var $t = $("#luckysheet-confirm").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-confirm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            $t.find(".luckysheet-model-conform-btn").click(function () {
                if(luckysheet.browser.isIE() == "1"){
                    alert("下载功能IE浏览器不支持！");
                }
                else{
                    if (!!window.ActiveXObject || "ActiveXObject" in window){
                        if ($("#IframeReportImg").length === 0){
                            $('<iframe style="display:none;" id="IframeReportImg" name="IframeReportImg" onload="downloadImg();" width="0" height="0" src="about:blank"></iframe>').appendTo("body");
                        }
                        if ($('#IframeReportImg').attr("src") != imgurl) {
                            $('#IframeReportImg').attr("src",imgurl);
                        } else {
                            if ($('#IframeReportImg').src != "about:blank") {
                                window.frames["IframeReportImg"].document.execCommand("SaveAs");
                            }
                        }
                    }  
                }
            });
            $t.find(".luckysheet-model-cancel-btn").click(function () {
                $("#luckysheet-confirm").hide();
                $("#luckysheet-modal-dialog-mask").hide();
            });

            $('#luckysheet-confirm .luckysheet-model-copy-btn').click(function(){
                var dt = new clipboard.DT();
                dt.setData("text/html", "<img src='"+ imgurl +"'>");
                if(luckysheet.browser.isIE() == "1"){
                    alert("请在图片上右键点击'复制'");
                }
                else{
                    clipboard.write(dt);
                    alert("已成功复制（如果粘贴失败，请在图片上右键点击'复制图片'）");  
                }
            });
        },
        chartPointConfig: function (id, savefunc1, closefunc2) {
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": id, "addclass": "luckysheet-chart-point-config-c", "title": "数据点批量设置", "content": luckysheetchartpointconfigHTML, "botton": '<button class="btn btn-danger luckysheet-model-save-btn">&nbsp;&nbsp;保存设置&nbsp;&nbsp;</button><button class="btn btn-default luckysheet-model-close-btn">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>', "style": "z-index:100003;height:80%;width:80%;top:10%;left:10%;" }));
            $("#luckysheet-modal-dialog-mask").show();
            var winw = $(window).width(), winh = $(window).height();
            $("#" + id).find(".luckysheet-chart-point-config").css("height", winh - 160);
            $("#" + id).css({ "height": winh - 90, width: winw - 100, "left": 7, "top": 14 }).show().find(".luckysheet-model-save-btn").click(function () {
                if (typeof savefunc1 == 'function') {
                    savefunc1();
                }

                $("#" + id).hide();
                $("#luckysheet-modal-dialog-mask").hide();
            });

            $("#" + id).find(".luckysheet-model-save-btn").click(function () {
                if (typeof closefunc2 == 'function') {
                    closefunc2();
                }

                $("#" + id).hide();
                $("#luckysheet-modal-dialog-mask").hide();
            });

        },
        sheetConfig: function () {

        },
        hoverTipshowState:false,
        hoverTipshowTimeOut:null,
        createHoverTip:function (obj, to) {
	        $(obj).on("mouseover", to, function (e) {

	            if (luckysheet.tooltip.hoverTipshowState) {
	                return;
	            }
                clearTimeout(luckysheet.tooltip.hoverTipshowTimeOut);
                luckysheet.tooltip.hoverTipshowTimeOut = setTimeout(function(){

                
    	            var $t = $(e.currentTarget), toffset = $t.offset(), $toolup = $("#luckysheet-tooltip-up");
    	            var tips = $t.data("tips");
    	            if (tips == null || tips.length == 0) {
    	                tips = $t.prev().data("tips");
    	                if (tips == null || tips.length == 0) {
    	                    return;
    	                }
    	            }

    	            if ($toolup.length == 0) {
    	                $("body").append(luckysheetToolHTML);
    	                $toolup = $("#luckysheet-tooltip-up");
    	            }

    	            $toolup.removeClass("jfk-tooltip-hide").find("div.jfk-tooltip-contentId").html(tips);
    	            var toolwidth = $toolup.outerWidth();
    	            $toolup.find("div.jfk-tooltip-arrow").css("left", (toolwidth) / 2);

                    var toolleft = toffset.left + ($t.outerWidth() - toolwidth) / 2;
                    if(toolleft<2){
                        toolleft = 2;
                        $toolup.find("div.jfk-tooltip-arrow").css("left", $t.outerWidth()/2);
                    }

    	            $toolup.css({ "top": toffset.top + $t.outerHeight() + 1, "left": toolleft });
                }, 300);

	        }).on("mouseout", to, function (e) {
	            luckysheet.tooltip.hoverTipshowState = false;
                clearTimeout(luckysheet.tooltip.hoverTipshowTimeOut);
	            $("#luckysheet-tooltip-up").addClass("jfk-tooltip-hide");
	        }).on("click", to, function (e) {
	            luckysheet.tooltip.hoverTipshowState = true;
                clearTimeout(luckysheet.tooltip.hoverTipshowTimeOut);
	            $("#luckysheet-tooltip-up").addClass("jfk-tooltip-hide");
	        });
        },
        popover:function(content, position, close, style, btntxt,exitsFuc){
            if(btntxt==null){
                btntxt = "关闭";
            }

            var htmldiv = '<div id="luckysheetpopover" class="luckysheetpopover"><div class="luckysheetpopover-content">格式刷开启</div><div class="luckysheetpopover-btn">'+ btntxt +'</div></div>';
            $("#luckysheetpopover").remove();
            $("body").append(htmldiv);
            //var winW = $(window).width(),winH = $(window).height();
            $("#luckysheetpopover .luckysheetpopover-content").html(content);
            var w = $("#luckysheetpopover").outerWidth(),h = $("#luckysheetpopover").outerHeight();
            var pcss = {};

            if(position == 'topLeft'){
                pcss.top = "20px";
                pcss.left = "20px";
            }
            else if(position == 'topCenter'){
                pcss.top = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'topRight'){
                pcss.top = "20px";
                pcss.right = "20px";
            }
            else if(position == 'midLeft'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.left = "20px";
            }
            else if(position == 'center'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'midRight'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.right = "20px";
            }
            else if(position == 'bottomLeft'){
                pcss.bottom = "20px";
                pcss.left = "20px";
            }
            else if(position == 'bottomCenter'){
                pcss.bottom = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'bottomRight'){
                pcss.bottom = "20px";
                pcss.right = "20px";
            }
            else{
                pcss.top = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }

            if(style=="white"){
                pcss.background = "rgba(255,255,255,0.65)";
                pcss.color = "#000";
                $("#luckysheetpopover .luckysheetpopover-btn").css({"border":"1px solid #000"});
            }

            setTimeout(function(){
                $("#luckysheetpopover .luckysheetpopover-content").css({"margin-left": -$("#luckysheetpopover .luckysheetpopover-btn").outerWidth()/2});
            }, 1);
            $("#luckysheetpopover").css(pcss).fadeIn();
            $("#luckysheetpopover .luckysheetpopover-btn").click(function(){
                if(typeof(exitsFuc) == "function"){
                    exitsFuc();
                }
            });

            if(close!=null && typeof(close)=="number"){
                setTimeout(function(){
                    $("#luckysheetpopover").fadeOut().remove();
                    if(typeof(exitsFuc) == "function"){
                        exitsFuc();
                    }
                }, close);
            }

        }

    }

    luckysheet.mask = (function(){
        var SSF = ({});
        var make_ssf = function make_ssf(SSF) {
            SSF.version = '0.10.2';

            function _strrev(x) {
                var o = "",
                    i = x.length - 1;
                while (i >= 0) o += x.charAt(i--);
                return o;
            }

            function fill(c, l) {
                var o = "";
                while (o.length < l) o += c;
                return o;
            }

            function pad0(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }

            function pad_(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill(' ', d - t.length) + t;
            }

            function rpad_(v, d) {
                var t = "" + v;
                return t.length >= d ? t : t + fill(' ', d - t.length);
            }

            function pad0r1(v, d) {
                var t = "" + Math.round(v);
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }

            function pad0r2(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }
            var p2_32 = Math.pow(2, 32);

            function pad0r(v, d) {
                if (v > p2_32 || v < -p2_32) return pad0r1(v, d);
                var i = Math.round(v);
                return pad0r2(i, d);
            }

            function isgeneral(s, i) {
                i = i || 0;
                return s.length >= 7 + i && (s.charCodeAt(i) | 32) === 103 && (s.charCodeAt(i + 1) | 32) === 101 && (s.charCodeAt(i + 2) | 32) === 110 && (s.charCodeAt(i + 3) | 32) === 101 && (s.charCodeAt(i + 4) | 32) === 114 && (s.charCodeAt(i + 5) | 32) === 97 && (s.charCodeAt(i + 6) | 32) === 108;
            }
            var days = [
                ['Sun', 'Sunday'],
                ['Mon', 'Monday'],
                ['Tue', 'Tuesday'],
                ['Wed', 'Wednesday'],
                ['Thu', 'Thursday'],
                ['Fri', 'Friday'],
                ['Sat', 'Saturday']
            ];
            var months = [
                ['J', 'Jan', 'January'],
                ['F', 'Feb', 'February'],
                ['M', 'Mar', 'March'],
                ['A', 'Apr', 'April'],
                ['M', 'May', 'May'],
                ['J', 'Jun', 'June'],
                ['J', 'Jul', 'July'],
                ['A', 'Aug', 'August'],
                ['S', 'Sep', 'September'],
                ['O', 'Oct', 'October'],
                ['N', 'Nov', 'November'],
                ['D', 'Dec', 'December']
            ];

            function init_table(t) {
                t[0] = 'General';
                t[1] = '0';
                t[2] = '0.00';
                t[3] = '#,##0';
                t[4] = '#,##0.00';
                t[9] = '0%';
                t[10] = '0.00%';
                t[11] = '0.00E+00';
                t[12] = '# ?/?';
                t[13] = '# ??/??';
                t[14] = 'm/d/yy';
                t[15] = 'd-mmm-yy';
                t[16] = 'd-mmm';
                t[17] = 'mmm-yy';
                t[18] = 'h:mm AM/PM';
                t[19] = 'h:mm:ss AM/PM';
                t[20] = 'h:mm';
                t[21] = 'h:mm:ss';
                t[22] = 'm/d/yy h:mm';
                t[37] = '#,##0 ;(#,##0)';
                t[38] = '#,##0 ;[Red](#,##0)';
                t[39] = '#,##0.00;(#,##0.00)';
                t[40] = '#,##0.00;[Red](#,##0.00)';
                t[45] = 'mm:ss';
                t[46] = '[h]:mm:ss';
                t[47] = 'mmss.0';
                t[48] = '##0.0E+0';
                t[49] = '@';
                t[56] = '"上午/下午 "hh"時"mm"分"ss"秒 "';
                t[65535] = 'General';
            }
            var table_fmt = {};
            init_table(table_fmt);

            function frac(x, D, mixed) {
                var sgn = x < 0 ? -1 : 1;
                var B = x * sgn;
                var P_2 = 0,
                    P_1 = 1,
                    P = 0;
                var Q_2 = 1,
                    Q_1 = 0,
                    Q = 0;
                var A = Math.floor(B);
                while (Q_1 < D) {
                    A = Math.floor(B);
                    P = A * P_1 + P_2;
                    Q = A * Q_1 + Q_2;
                    if ((B - A) < 0.00000005) break;
                    B = 1 / (B - A);
                    P_2 = P_1;
                    P_1 = P;
                    Q_2 = Q_1;
                    Q_1 = Q;
                }
                if (Q > D) {
                    if (Q_1 > D) {
                        Q = Q_2;
                        P = P_2;
                    } else {
                        Q = Q_1;
                        P = P_1;
                    }
                }
                if (!mixed) return [0, sgn * P, Q];
                var q = Math.floor(sgn * P / Q);
                return [q, sgn * P - q * Q, Q];
            }

            function parse_date_code(v, opts, b2) {
                if (v > 2958465 || v < 0) return null;
                var date = (v | 0),
                    time = Math.floor(86400 * (v - date)),
                    dow = 0;
                var dout = [];
                var out = {
                    D: date,
                    T: time,
                    u: 86400 * (v - date) - time,
                    y: 0,
                    m: 0,
                    d: 0,
                    H: 0,
                    M: 0,
                    S: 0,
                    q: 0
                };
                if (Math.abs(out.u) < 1e-6) out.u = 0;
                if (opts && opts.date1904) date += 1462;
                if (out.u > 0.9999) {
                    out.u = 0;
                    if (++time == 86400) {
                        out.T = time = 0;
                        ++date;
                        ++out.D;
                    }
                }
                if (date === 60) {
                    dout = b2 ? [1317, 10, 29] : [1900, 2, 29];
                    dow = 3;
                } else if (date === 0) {
                    dout = b2 ? [1317, 8, 29] : [1900, 1, 0];
                    dow = 6;
                } else {
                    if (date > 60) --date;
                    /* 1 = Jan 1 1900 in Gregorian */
                    var d = new Date(1900, 0, 1);
                    d.setDate(d.getDate() + date - 1);
                    dout = [d.getFullYear(), d.getMonth() + 1, d.getDate()];
                    dow = d.getDay();
                    if (date < 60) dow = (dow + 6) % 7;
                    if (b2) dow = fix_hijri(d, dout);
                }
                out.y = dout[0];
                out.m = dout[1];
                out.d = dout[2];
                out.S = time % 60;
                time = Math.floor(time / 60);
                out.M = time % 60;
                time = Math.floor(time / 60);
                out.H = time;
                out.q = dow;
                return out;
            }
            SSF.parse_date_code = parse_date_code;
            var basedate = new Date(1899, 11, 31, 0, 0, 0);
            var dnthresh = basedate.getTime();
            var base1904 = new Date(1900, 2, 1, 0, 0, 0);

            function datenum_local(v, date1904) {
                var epoch = v.getTime();
                if (date1904) epoch -= 1461 * 24 * 60 * 60 * 1000;
                else if (v >= base1904) epoch += 24 * 60 * 60 * 1000;
                return (epoch - (dnthresh + (v.getTimezoneOffset() - basedate.getTimezoneOffset()) * 60000)) / (24 * 60 * 60 * 1000);
            }

            function general_fmt_int(v) {
                return v.toString(10);
            }
            SSF._general_int = general_fmt_int;
            var general_fmt_num = (function make_general_fmt_num() {
                var gnr1 = /\.(\d*[1-9])0+$/,
                    gnr2 = /\.0*$/,
                    gnr4 = /\.(\d*[1-9])0+/,
                    gnr5 = /\.0*[Ee]/,
                    gnr6 = /(E[+-])(\d)$/;

                function gfn2(v) {
                    var w = (v < 0 ? 12 : 11);
                    var o = gfn5(v.toFixed(12));
                    if (o.length <= w) return o;
                    o = v.toPrecision(10);
                    if (o.length <= w) return o;
                    return v.toExponential(5);
                }

                function gfn3(v) {
                    var o = v.toFixed(11).replace(gnr1, ".$1");
                    if (o.length > (v < 0 ? 12 : 11)) o = v.toPrecision(6);
                    return o;
                }

                function gfn4(o) {
                    for (var i = 0; i != o.length; ++i)
                        if ((o.charCodeAt(i) | 0x20) === 101) return o.replace(gnr4, ".$1").replace(gnr5, "E").replace("e", "E").replace(gnr6, "$10$2");
                    return o;
                }

                function gfn5(o) {
                    return o.indexOf(".") > -1 ? o.replace(gnr2, "").replace(gnr1, ".$1") : o;
                }
                return function general_fmt_num(v) {
                    var V = Math.floor(Math.log(Math.abs(v)) * Math.LOG10E),
                        o;
                    if (V >= -4 && V <= -1) o = v.toPrecision(10 + V);
                    else if (Math.abs(V) <= 9) o = gfn2(v);
                    else if (V === 10) o = v.toFixed(10).substr(0, 12);
                    else o = gfn3(v);
                    return gfn5(gfn4(o));
                };
            })();
            SSF._general_num = general_fmt_num;

            function general_fmt(v, opts) {
                switch (typeof v) {
                    case 'string':
                        return v;
                    case 'boolean':
                        return v ? "TRUE" : "FALSE";
                    case 'number':
                        return (v | 0) === v ? general_fmt_int(v) : general_fmt_num(v);
                    case 'undefined':
                        return "";
                    case 'object':
                        if (v == null) return "";
                        if (v instanceof Date) return format(14, datenum_local(v, opts && opts.date1904), opts);
                }
                throw new Error("unsupported value in General format: " + v);
            }
            SSF._general = general_fmt;

            function fix_hijri() {
                return 0;
            }
            /*jshint -W086 */
            function write_date(type, fmt, val, ss0) {
                var o = "",
                    ss = 0,
                    tt = 0,
                    y = val.y,
                    out, outl = 0;
                switch (type) {
                    case 98:
                        /* 'b' buddhist year */ y = val.y + 543;
                        /* falls through */
                    case 121:
                        /* 'y' year */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = y % 100;
                                outl = 2;
                                break;
                            default:
                                out = y % 10000;
                                outl = 4;
                                break;
                        }
                        break;
                    case 109:
                        /* 'm' month */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.m;
                                outl = fmt.length;
                                break;
                            case 3:
                                return months[val.m - 1][1];
                            case 5:
                                return months[val.m - 1][0];
                            default:
                                return months[val.m - 1][2];
                        }
                        break;
                    case 100:
                        /* 'd' day */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.d;
                                outl = fmt.length;
                                break;
                            case 3:
                                return days[val.q][0];
                            default:
                                return days[val.q][1];
                        }
                        break;
                    case 104:
                        /* 'h' 12-hour */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = 1 + (val.H + 11) % 12;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad hour format: ' + fmt;
                        }
                        break;
                    case 72:
                        /* 'H' 24-hour */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.H;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad hour format: ' + fmt;
                        }
                        break;
                    case 77:
                        /* 'M' minutes */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.M;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad minute format: ' + fmt;
                        }
                        break;
                    case 115:
                        /* 's' seconds */ if (fmt != 's' && fmt != 'ss' && fmt != '.0' && fmt != '.00' && fmt != '.000') throw 'bad second format: ' + fmt;
                        if (val.u === 0 && (fmt == "s" || fmt == "ss")) return pad0(val.S, fmt.length);
                        if (ss0 >= 2) tt = ss0 === 3 ? 1000 : 100;
                        else tt = ss0 === 1 ? 10 : 1;
                        ss = Math.round((tt) * (val.S + val.u));
                        if (ss >= 60 * tt) ss = 0;
                        if (fmt === 's') return ss === 0 ? "0" : "" + ss / tt;
                        o = pad0(ss, 2 + ss0);
                        if (fmt === 'ss') return o.substr(0, 2);
                        return "." + o.substr(2, fmt.length - 1);
                    case 90:
                        /* 'Z' absolute time */ switch (fmt) {
                            case '[h]':
                            case '[hh]':
                                out = val.D * 24 + val.H;
                                break;
                            case '[m]':
                            case '[mm]':
                                out = (val.D * 24 + val.H) * 60 + val.M;
                                break;
                            case '[s]':
                            case '[ss]':
                                out = ((val.D * 24 + val.H) * 60 + val.M) * 60 + Math.round(val.S + val.u);
                                break;
                            default:
                                throw 'bad abstime format: ' + fmt;
                        }
                        outl = fmt.length === 3 ? 1 : 2;
                        break;
                    case 101:
                        /* 'e' era */ out = y;
                        outl = 1;
                }
                if (outl > 0) return pad0(out, outl);
                else return "";
            }
            /*jshint +W086 */
            function commaify(s) {
                var w = 3;
                if (s.length <= w) return s;
                var j = (s.length % w),
                    o = s.substr(0, j);
                for (; j != s.length; j += w) o += (o.length > 0 ? "," : "") + s.substr(j, w);
                return o;
            }
            var write_num = (function make_write_num() {
                var pct1 = /%/g;

                function write_num_pct(type, fmt, val) {
                    var sfmt = fmt.replace(pct1, ""),
                        mul = fmt.length - sfmt.length;
                    return write_num(type, sfmt, val * Math.pow(10, 2 * mul)) + fill("%", mul);
                }

                function write_num_cm(type, fmt, val) {
                    var idx = fmt.length - 1;
                    while (fmt.charCodeAt(idx - 1) === 44) --idx;
                    return write_num(type, fmt.substr(0, idx), val / Math.pow(10, 3 * (fmt.length - idx)));
                }

                function write_num_exp(fmt, val) {
                    var o;
                    var idx = fmt.indexOf("E") - fmt.indexOf(".") - 1;
                    if (fmt.match(/^#+0.0E\+0$/)) {
                        if (val == 0) return "0.0E+0";
                        else if (val < 0) return "-" + write_num_exp(fmt, -val);
                        var period = fmt.indexOf(".");
                        if (period === -1) period = fmt.indexOf('E');
                        var ee = Math.floor(Math.log(val) * Math.LOG10E) % period;
                        if (ee < 0) ee += period;
                        o = (val / Math.pow(10, ee)).toPrecision(idx + 1 + (period + ee) % period);
                        if (o.indexOf("e") === -1) {
                            var fakee = Math.floor(Math.log(val) * Math.LOG10E);
                            if (o.indexOf(".") === -1) o = o.charAt(0) + "." + o.substr(1) + "E+" + (fakee - o.length + ee);
                            else o += "E+" + (fakee - ee);
                            while (o.substr(0, 2) === "0.") {
                                o = o.charAt(0) + o.substr(2, period) + "." + o.substr(2 + period);
                                o = o.replace(/^0+([1-9])/, "$1").replace(/^0+\./, "0.");
                            }
                            o = o.replace(/\+-/, "-");
                        }
                        o = o.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/, function($$, $1, $2, $3) {
                            return $1 + $2 + $3.substr(0, (period + ee) % period) + "." + $3.substr(ee) + "E";
                        });
                    } else o = val.toExponential(idx);
                    if (fmt.match(/E\+00$/) && o.match(/e[+-]\d$/)) o = o.substr(0, o.length - 1) + "0" + o.charAt(o.length - 1);
                    if (fmt.match(/E\-/) && o.match(/e\+/)) o = o.replace(/e\+/, "e");
                    return o.replace("e", "E");
                }
                var frac1 = /# (\?+)( ?)\/( ?)(\d+)/;

                function write_num_f1(r, aval, sign) {
                    var den = parseInt(r[4], 10),
                        rr = Math.round(aval * den),
                        base = Math.floor(rr / den);
                    var myn = (rr - base * den),
                        myd = den;
                    return sign + (base === 0 ? "" : "" + base) + " " + (myn === 0 ? fill(" ", r[1].length + 1 + r[4].length) : pad_(myn, r[1].length) + r[2] + "/" + r[3] + pad0(myd, r[4].length));
                }

                function write_num_f2(r, aval, sign) {
                    return sign + (aval === 0 ? "" : "" + aval) + fill(" ", r[1].length + 2 + r[4].length);
                }
                var dec1 = /^#*0*\.([0#]+)/;
                var closeparen = /\).*[0#]/;
                var phone = /\(###\) ###\\?-####/;

                function hashq(str) {
                    var o = "",
                        cc;
                    for (var i = 0; i != str.length; ++i) switch ((cc = str.charCodeAt(i))) {
                        case 35:
                            break;
                        case 63:
                            o += " ";
                            break;
                        case 48:
                            o += "0";
                            break;
                        default:
                            o += String.fromCharCode(cc);
                    }
                    return o;
                }

                function rnd(val, d) {
                    var dd = Math.pow(10, d);
                    return "" + (Math.round(val * dd) / dd);
                }

                function dec(val, d) {
                    if (d < ('' + Math.round((val - Math.floor(val)) * Math.pow(10, d))).length) {
                        return 0;
                    }
                    return Math.round((val - Math.floor(val)) * Math.pow(10, d));
                }

                function carry(val, d) {
                    if (d < ('' + Math.round((val - Math.floor(val)) * Math.pow(10, d))).length) {
                        return 1;
                    }
                    return 0;
                }

                function flr(val) {
                    if (val < 2147483647 && val > -2147483648) return "" + (val >= 0 ? (val | 0) : (val - 1 | 0));
                    return "" + Math.floor(val);
                }

                function write_num_flt(type, fmt, val) {
                    if (type.charCodeAt(0) === 40 && !fmt.match(closeparen)) {
                        var ffmt = fmt.replace(/\( */, "").replace(/ \)/, "").replace(/\)/, "");
                        if (val >= 0) return write_num_flt('n', ffmt, val);
                        return '(' + write_num_flt('n', ffmt, -val) + ')';
                    }
                    if (fmt.charCodeAt(fmt.length - 1) === 44) return write_num_cm(type, fmt, val);
                    if (fmt.indexOf('%') !== -1) return write_num_pct(type, fmt, val);
                    if (fmt.indexOf('E') !== -1) return write_num_exp(fmt, val);
                    if (fmt.charCodeAt(0) === 36) return "$" + write_num_flt(type, fmt.substr(fmt.charAt(1) == ' ' ? 2 : 1), val);
                    var o;
                    var r, ri, ff, aval = Math.abs(val),
                        sign = val < 0 ? "-" : "";
                    if (fmt.match(/^00+$/)) return sign + pad0r(aval, fmt.length);
                    if (fmt.match(/^[#?]+$/)) {
                        o = pad0r(val, 0);
                        if (o === "0") o = "";
                        return o.length > fmt.length ? o : hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(frac1))) return write_num_f1(r, aval, sign);
                    if (fmt.match(/^#+0+$/)) return sign + pad0r(aval, fmt.length - fmt.indexOf("0"));
                    if ((r = fmt.match(dec1))) {
                        o = rnd(val, r[1].length).replace(/^([^\.]+)$/, "$1." + hashq(r[1])).replace(/\.$/, "." + hashq(r[1])).replace(/\.(\d*)$/, function($$, $1) {
                            return "." + $1 + fill("0", hashq(r[1]).length - $1.length);
                        });
                        return fmt.indexOf("0.") !== -1 ? o : o.replace(/^0\./, ".");
                    }
                    fmt = fmt.replace(/^#+([0.])/, "$1");
                    if ((r = fmt.match(/^(0*)\.(#*)$/))) {
                        return sign + rnd(aval, r[2].length).replace(/\.(\d*[1-9])0*$/, ".$1").replace(/^(-?\d*)$/, "$1.").replace(/^0\./, r[1].length ? "0." : ".");
                    }
                    if ((r = fmt.match(/^#{1,3},##0(\.?)$/))) return sign + commaify(pad0r(aval, 0));
                    if ((r = fmt.match(/^#,##0\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_flt(type, fmt, -val) : commaify("" + (Math.floor(val) + carry(val, r[1].length))) + "." + pad0(dec(val, r[1].length), r[1].length);
                    }
                    if ((r = fmt.match(/^#,#*,#0/))) return write_num_flt(type, fmt.replace(/^#,#*,/, ""), val);
                    if ((r = fmt.match(/^([0#]+)(\\?-([0#]+))+$/))) {
                        o = _strrev(write_num_flt(type, fmt.replace(/[\\-]/g, ""), val));
                        ri = 0;
                        return _strrev(_strrev(fmt.replace(/\\/g, "")).replace(/[0#]/g, function(x) {
                            return ri < o.length ? o.charAt(ri++) : x === '0' ? '0' : "";
                        }));
                    }
                    if (fmt.match(phone)) {
                        o = write_num_flt(type, "##########", val);
                        return "(" + o.substr(0, 3) + ") " + o.substr(3, 3) + "-" + o.substr(6);
                    }
                    var oa = "";
                    if ((r = fmt.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(r[4].length, 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, false);
                        o = "" + sign;
                        oa = write_num("n", r[1], ff[1]);
                        if (oa.charAt(oa.length - 1) == " ") oa = oa.substr(0, oa.length - 1) + "0";
                        o += oa + r[2] + "/" + r[3];
                        oa = rpad_(ff[2], ri);
                        if (oa.length < r[4].length) oa = hashq(r[4].substr(r[4].length - oa.length)) + oa;
                        o += oa;
                        return o;
                    }
                    if ((r = fmt.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(Math.max(r[1].length, r[4].length), 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, true);
                        return sign + (ff[0] || (ff[1] ? "" : "0")) + " " + (ff[1] ? pad_(ff[1], ri) + r[2] + "/" + r[3] + rpad_(ff[2], ri) : fill(" ", 2 * ri + 1 + r[2].length + r[3].length));
                    }
                    if ((r = fmt.match(/^[#0?]+$/))) {
                        o = pad0r(val, 0);
                        if (fmt.length <= o.length) return o;
                        return hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(/^([#0?]+)\.([#0]+)$/))) {
                        o = "" + val.toFixed(Math.min(r[2].length, 10)).replace(/([^0])0+$/, "$1");
                        ri = o.indexOf(".");
                        var lres = fmt.indexOf(".") - ri,
                            rres = fmt.length - o.length - lres;
                        return hashq(fmt.substr(0, lres) + o + fmt.substr(fmt.length - rres));
                    }
                    if ((r = fmt.match(/^00,000\.([#0]*0)$/))) {
                        ri = dec(val, r[1].length);
                        return val < 0 ? "-" + write_num_flt(type, fmt, -val) : commaify(flr(val)).replace(/^\d,\d{3}$/, "0$&").replace(/^\d*$/, function($$) {
                            return "00," + ($$.length < 3 ? pad0(0, 3 - $$.length) : "") + $$;
                        }) + "." + pad0(ri, r[1].length);
                    }
                    switch (fmt) {
                        case "###,##0.00":
                            return write_num_flt(type, "#,##0.00", val);
                        case "###,###":
                        case "##,###":
                        case "#,###":
                            var x = commaify(pad0r(aval, 0));
                            return x !== "0" ? sign + x : "";
                        case "###,###.00":
                            return write_num_flt(type, "###,##0.00", val).replace(/^0\./, ".");
                        case "#,###.00":
                            return write_num_flt(type, "#,##0.00", val).replace(/^0\./, ".");
                        default:
                    }
                    throw new Error("unsupported format |" + fmt + "|");
                }

                function write_num_cm2(type, fmt, val) {
                    var idx = fmt.length - 1;
                    while (fmt.charCodeAt(idx - 1) === 44) --idx;
                    return write_num(type, fmt.substr(0, idx), val / Math.pow(10, 3 * (fmt.length - idx)));
                }

                function write_num_pct2(type, fmt, val) {
                    var sfmt = fmt.replace(pct1, ""),
                        mul = fmt.length - sfmt.length;
                    return write_num(type, sfmt, val * Math.pow(10, 2 * mul)) + fill("%", mul);
                }

                function write_num_exp2(fmt, val) {
                    var o;
                    var idx = fmt.indexOf("E") - fmt.indexOf(".") - 1;
                    if (fmt.match(/^#+0.0E\+0$/)) {
                        if (val == 0) return "0.0E+0";
                        else if (val < 0) return "-" + write_num_exp2(fmt, -val);
                        var period = fmt.indexOf(".");
                        if (period === -1) period = fmt.indexOf('E');
                        var ee = Math.floor(Math.log(val) * Math.LOG10E) % period;
                        if (ee < 0) ee += period;
                        o = (val / Math.pow(10, ee)).toPrecision(idx + 1 + (period + ee) % period);
                        if (!o.match(/[Ee]/)) {
                            var fakee = Math.floor(Math.log(val) * Math.LOG10E);
                            if (o.indexOf(".") === -1) o = o.charAt(0) + "." + o.substr(1) + "E+" + (fakee - o.length + ee);
                            else o += "E+" + (fakee - ee);
                            o = o.replace(/\+-/, "-");
                        }
                        o = o.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/, function($$, $1, $2, $3) {
                            return $1 + $2 + $3.substr(0, (period + ee) % period) + "." + $3.substr(ee) + "E";
                        });
                    } else o = val.toExponential(idx);
                    if (fmt.match(/E\+00$/) && o.match(/e[+-]\d$/)) o = o.substr(0, o.length - 1) + "0" + o.charAt(o.length - 1);
                    if (fmt.match(/E\-/) && o.match(/e\+/)) o = o.replace(/e\+/, "e");
                    return o.replace("e", "E");
                }

                function write_num_int(type, fmt, val) {
                    if (type.charCodeAt(0) === 40 && !fmt.match(closeparen)) {
                        var ffmt = fmt.replace(/\( */, "").replace(/ \)/, "").replace(/\)/, "");
                        if (val >= 0) return write_num_int('n', ffmt, val);
                        return '(' + write_num_int('n', ffmt, -val) + ')';
                    }
                    if (fmt.charCodeAt(fmt.length - 1) === 44) return write_num_cm2(type, fmt, val);
                    if (fmt.indexOf('%') !== -1) return write_num_pct2(type, fmt, val);
                    if (fmt.indexOf('E') !== -1) return write_num_exp2(fmt, val);
                    if (fmt.charCodeAt(0) === 36) return "$" + write_num_int(type, fmt.substr(fmt.charAt(1) == ' ' ? 2 : 1), val);
                    var o;
                    var r, ri, ff, aval = Math.abs(val),
                        sign = val < 0 ? "-" : "";
                    if (fmt.match(/^00+$/)) return sign + pad0(aval, fmt.length);
                    if (fmt.match(/^[#?]+$/)) {
                        o = ("" + val);
                        if (val === 0) o = "";
                        return o.length > fmt.length ? o : hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(frac1))) return write_num_f2(r, aval, sign);
                    if (fmt.match(/^#+0+$/)) return sign + pad0(aval, fmt.length - fmt.indexOf("0"));
                    if ((r = fmt.match(dec1))) {
                        o = ("" + val).replace(/^([^\.]+)$/, "$1." + hashq(r[1])).replace(/\.$/, "." + hashq(r[1]));
                        o = o.replace(/\.(\d*)$/, function($$, $1) {
                            return "." + $1 + fill("0", hashq(r[1]).length - $1.length);
                        });
                        return fmt.indexOf("0.") !== -1 ? o : o.replace(/^0\./, ".");
                    }
                    fmt = fmt.replace(/^#+([0.])/, "$1");
                    if ((r = fmt.match(/^(0*)\.(#*)$/))) {
                        return sign + ("" + aval).replace(/\.(\d*[1-9])0*$/, ".$1").replace(/^(-?\d*)$/, "$1.").replace(/^0\./, r[1].length ? "0." : ".");
                    }
                    if ((r = fmt.match(/^#{1,3},##0(\.?)$/))) return sign + commaify(("" + aval));
                    if ((r = fmt.match(/^#,##0\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_int(type, fmt, -val) : commaify(("" + val)) + "." + fill('0', r[1].length);
                    }
                    if ((r = fmt.match(/^#,#*,#0/))) return write_num_int(type, fmt.replace(/^#,#*,/, ""), val);
                    if ((r = fmt.match(/^([0#]+)(\\?-([0#]+))+$/))) {
                        o = _strrev(write_num_int(type, fmt.replace(/[\\-]/g, ""), val));
                        ri = 0;
                        return _strrev(_strrev(fmt.replace(/\\/g, "")).replace(/[0#]/g, function(x) {
                            return ri < o.length ? o.charAt(ri++) : x === '0' ? '0' : "";
                        }));
                    }
                    if (fmt.match(phone)) {
                        o = write_num_int(type, "##########", val);
                        return "(" + o.substr(0, 3) + ") " + o.substr(3, 3) + "-" + o.substr(6);
                    }
                    var oa = "";
                    if ((r = fmt.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(r[4].length, 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, false);
                        o = "" + sign;
                        oa = write_num("n", r[1], ff[1]);
                        if (oa.charAt(oa.length - 1) == " ") oa = oa.substr(0, oa.length - 1) + "0";
                        o += oa + r[2] + "/" + r[3];
                        oa = rpad_(ff[2], ri);
                        if (oa.length < r[4].length) oa = hashq(r[4].substr(r[4].length - oa.length)) + oa;
                        o += oa;
                        return o;
                    }
                    if ((r = fmt.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(Math.max(r[1].length, r[4].length), 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, true);
                        return sign + (ff[0] || (ff[1] ? "" : "0")) + " " + (ff[1] ? pad_(ff[1], ri) + r[2] + "/" + r[3] + rpad_(ff[2], ri) : fill(" ", 2 * ri + 1 + r[2].length + r[3].length));
                    }
                    if ((r = fmt.match(/^[#0?]+$/))) {
                        o = "" + val;
                        if (fmt.length <= o.length) return o;
                        return hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(/^([#0]+)\.([#0]+)$/))) {
                        o = "" + val.toFixed(Math.min(r[2].length, 10)).replace(/([^0])0+$/, "$1");
                        ri = o.indexOf(".");
                        var lres = fmt.indexOf(".") - ri,
                            rres = fmt.length - o.length - lres;
                        return hashq(fmt.substr(0, lres) + o + fmt.substr(fmt.length - rres));
                    }
                    if ((r = fmt.match(/^00,000\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_int(type, fmt, -val) : commaify("" + val).replace(/^\d,\d{3}$/, "0$&").replace(/^\d*$/, function($$) {
                            return "00," + ($$.length < 3 ? pad0(0, 3 - $$.length) : "") + $$;
                        }) + "." + pad0(0, r[1].length);
                    }
                    switch (fmt) {
                        case "###,###":
                        case "##,###":
                        case "#,###":
                            var x = commaify("" + aval);
                            return x !== "0" ? sign + x : "";
                        default:
                            if (fmt.match(/\.[0#?]*$/)) return write_num_int(type, fmt.slice(0, fmt.lastIndexOf(".")), val) + hashq(fmt.slice(fmt.lastIndexOf(".")));
                    }
                    throw new Error("unsupported format |" + fmt + "|");
                }
                return function write_num(type, fmt, val) {
                    return (val | 0) === val ? write_num_int(type, fmt, val) : write_num_flt(type, fmt, val);
                };
            })();

            function split_fmt(fmt) {
                var out = [];
                var in_str = false /*, cc*/ ;
                for (var i = 0, j = 0; i < fmt.length; ++i) switch (( /*cc=*/ fmt.charCodeAt(i))) {
                    case 34:
                        /* '"' */ in_str = !in_str;
                        break;
                    case 95:
                    case 42:
                    case 92:
                        /* '_' '*' '\\' */
                        ++i;
                        break;
                    case 59:
                        /* ';' */ out[out.length] = fmt.substr(j, i - j);
                        j = i + 1;
                }
                out[out.length] = fmt.substr(j);
                if (in_str === true) throw new Error("Format |" + fmt + "| unterminated string ");
                return out;
            }
            SSF._split = split_fmt;
            var abstime = /\[[HhMmSs]*\]/;

            function fmt_is_date(fmt) {
                var i = 0,
                    /*cc = 0,*/ c = "",
                    o = "";
                while (i < fmt.length) {
                    switch ((c = fmt.charAt(i))) {
                        case 'G':
                            if (isgeneral(fmt, i)) i += 6;
                            i++;
                            break;
                        case '"':
                            for (;
                                ( /*cc=*/ fmt.charCodeAt(++i)) !== 34 && i < fmt.length;) ++i;
                            ++i;
                            break;
                        case '\\':
                            i += 2;
                            break;
                        case '_':
                            i += 2;
                            break;
                        case '@':
                            ++i;
                            break;
                        case 'B':
                        case 'b':
                            if (fmt.charAt(i + 1) === "1" || fmt.charAt(i + 1) === "2") return true;
                            /* falls through */
                        case 'M':
                        case 'D':
                        case 'Y':
                        case 'H':
                        case 'S':
                        case 'E':
                            /* falls through */
                        case 'm':
                        case 'd':
                        case 'y':
                        case 'h':
                        case 's':
                        case 'e':
                        case 'g':
                            return true;
                        case 'A':
                        case 'a':
                            if (fmt.substr(i, 3).toUpperCase() === "A/P") return true;
                            if (fmt.substr(i, 5).toUpperCase() === "AM/PM") return true;
                            ++i;
                            break;
                        case '[':
                            o = c;
                            while (fmt.charAt(i++) !== ']' && i < fmt.length) o += fmt.charAt(i);
                            if (o.match(abstime)) return true;
                            break;
                        case '.':
                            /* falls through */
                        case '0':
                        case '#':
                            while (i < fmt.length && ("0#?.,E+-%".indexOf(c = fmt.charAt(++i)) > -1 || (c == '\\' && fmt.charAt(i + 1) == "-" && "0#".indexOf(fmt.charAt(i + 2)) > -1))) { /* empty */ }
                            break;
                        case '?':
                            while (fmt.charAt(++i) === c) { /* empty */ }
                            break;
                        case '*':
                            ++i;
                            if (fmt.charAt(i) == ' ' || fmt.charAt(i) == '*') ++i;
                            break;
                        case '(':
                        case ')':
                            ++i;
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            while (i < fmt.length && "0123456789".indexOf(fmt.charAt(++i)) > -1) { /* empty */ }
                            break;
                        case ' ':
                            ++i;
                            break;
                        default:
                            ++i;
                            break;
                    }
                }
                return false;
            }
            SSF.is_date = fmt_is_date;

            function eval_fmt(fmt, v, opts, flen) {
                var out = [],
                    o = "",
                    i = 0,
                    c = "",
                    lst = 't',
                    dt, j, cc;
                var hr = 'H';
                /* Tokenize */
                while (i < fmt.length) {
                    switch ((c = fmt.charAt(i))) {
                        case 'G':
                            /* General */ if (!isgeneral(fmt, i)) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            out[out.length] = {
                                t: 'G',
                                v: 'General'
                            };
                            i += 7;
                            break;
                        case '"':
                            /* Literal text */ for (o = "";
                                (cc = fmt.charCodeAt(++i)) !== 34 && i < fmt.length;) o += String.fromCharCode(cc);
                            out[out.length] = {
                                t: 't',
                                v: o
                            };
                            ++i;
                            break;
                        case '\\':
                            var w = fmt.charAt(++i),
                                t = (w === "(" || w === ")") ? w : 't';
                            out[out.length] = {
                                t: t,
                                v: w
                            };
                            ++i;
                            break;
                        case '_':
                            out[out.length] = {
                                t: 't',
                                v: " "
                            };
                            i += 2;
                            break;
                        case '@':
                            /* Text Placeholder */ out[out.length] = {
                                t: 'T',
                                v: v
                            };
                            ++i;
                            break;
                        case 'B':
                        case 'b':
                            if (fmt.charAt(i + 1) === "1" || fmt.charAt(i + 1) === "2") {
                                if (dt == null) {
                                    dt = parse_date_code(v, opts, fmt.charAt(i + 1) === "2");
                                    if (dt == null) return "";
                                }
                                out[out.length] = {
                                    t: 'X',
                                    v: fmt.substr(i, 2)
                                };
                                lst = c;
                                i += 2;
                                break;
                            }
                            /* falls through */
                        case 'M':
                        case 'D':
                        case 'Y':
                        case 'H':
                        case 'S':
                        case 'E':
                            c = c.toLowerCase();
                            /* falls through */
                        case 'm':
                        case 'd':
                        case 'y':
                        case 'h':
                        case 's':
                        case 'e':
                        case 'g':
                            if (v < 0) return "";
                            if (dt == null) {
                                dt = parse_date_code(v, opts);
                                if (dt == null) return "######";
                            }
                            o = c;
                            while (++i < fmt.length && fmt.charAt(i).toLowerCase() === c) o += c;
                            if (c === 'm' && lst.toLowerCase() === 'h') c = 'M';
                            if (c === 'h') c = hr;
                            out[out.length] = {
                                t: c,
                                v: o
                            };
                            lst = c;
                            break;
                        case 'A':
                        case 'a':
                            var q = {
                                t: c,
                                v: c
                            };
                            if (dt == null) dt = parse_date_code(v, opts);
                            if (fmt.substr(i, 3).toUpperCase() === "A/P") {
                                if (dt != null) q.v = dt.H >= 12 ? "P" : "A";
                                q.t = 'T';
                                hr = 'h';
                                i += 3;
                            } else if (fmt.substr(i, 5).toUpperCase() === "AM/PM") {
                                if (dt != null) q.v = dt.H >= 12 ? "PM" : "AM";
                                q.t = 'T';
                                i += 5;
                                hr = 'h';
                            } else {
                                q.t = "t";
                                ++i;
                            }
                            if (dt == null && q.t === 'T') return "";
                            out[out.length] = q;
                            lst = c;
                            break;
                        case '[':
                            o = c;
                            while (fmt.charAt(i++) !== ']' && i < fmt.length) o += fmt.charAt(i);
                            if (o.slice(-1) !== ']') throw 'unterminated "[" block: |' + o + '|';
                            if (o.match(abstime)) {
                                if (dt == null) {
                                    dt = parse_date_code(v, opts);
                                    if (dt == null) return "";
                                }
                                out[out.length] = {
                                    t: 'Z',
                                    v: o.toLowerCase()
                                };
                                lst = o.charAt(1);
                            } else if (o.indexOf("$") > -1) {
                                o = (o.match(/\$([^-\[\]]*)/) || [])[1] || "$";
                                if (!fmt_is_date(fmt)) out[out.length] = {
                                    t: 't',
                                    v: o
                                };
                            }
                            break;
                            /* Numbers */
                        case '.':
                            if (dt != null) {
                                o = c;
                                while (++i < fmt.length && (c = fmt.charAt(i)) === "0") o += c;
                                out[out.length] = {
                                    t: 's',
                                    v: o
                                };
                                break;
                            }
                            /* falls through */
                        case '0':
                        case '#':
                            o = c;
                            while ((++i < fmt.length && "0#?.,E+-%".indexOf(c = fmt.charAt(i)) > -1) || (c == '\\' && fmt.charAt(i + 1) == "-" && i < fmt.length - 2 && "0#".indexOf(fmt.charAt(i + 2)) > -1)) o += c;
                            out[out.length] = {
                                t: 'n',
                                v: o
                            };
                            break;
                        case '?':
                            o = c;
                            while (fmt.charAt(++i) === c) o += c;
                            out[out.length] = {
                                t: c,
                                v: o
                            };
                            lst = c;
                            break;
                        case '*':
                            ++i;
                            if (fmt.charAt(i) == ' ' || fmt.charAt(i) == '*') ++i;
                            break; // **
                        case '(':
                        case ')':
                            out[out.length] = {
                                t: (flen === 1 ? 't' : c),
                                v: c
                            };
                            ++i;
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            o = c;
                            while (i < fmt.length && "0123456789".indexOf(fmt.charAt(++i)) > -1) o += fmt.charAt(i);
                            out[out.length] = {
                                t: 'D',
                                v: o
                            };
                            break;
                        case ' ':
                            out[out.length] = {
                                t: c,
                                v: c
                            };
                            ++i;
                            break;
                        default:
                            // if ("¤฿BsBr₵₡₫ƒFtRs.₭kr£₤Lm₥₦₱PQRSkRp৲৳R$S/.〒₮₩¥NT￥zł₴₪៛руб€＄,$-+/():!^&'~{}<>=€acfijklopqrtuvwxzP".indexOf(c) === -1) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            if ("¤฿BsBr₵₡₫ƒFtRs.₭kr£₤Lm₥₦₱PQRSkRp৲৳R$S/.〒₮₩¥NT￥zł₴₪៛руб€＄,$-+/():!^&'~{}<>=€acfijklopqrtuvwxzP$￥LekdinAf$dhAflRial?￡BirrKzMOPPGKRsGsB/R$ррlevkrKMzBsPNuFBuKPkrRD$NfkCFA?CVEGMDFrCDHTGNAfLFdjKGSFGGHSRielKCFknKshLSLL￡LtRFRONArRfMWKRMMURsMROS/KMDLMTnRC$kr€GELCHFSLLSCRDbSZLSDGSOSSomFCFPTShT$VUVQUGXгрнsomWSTNT$FtDramRpZMWFCFA".indexOf(c) === -1) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            out[out.length] = {
                                t: 't',
                                v: c
                            };
                            ++i;
                            break;
                    }
                }
                var bt = 0,
                    ss0 = 0,
                    ssm;
                for (i = out.length - 1, lst = 't'; i >= 0; --i) {
                    switch (out[i].t) {
                        case 'h':
                        case 'H':
                            out[i].t = hr;
                            lst = 'h';
                            if (bt < 1) bt = 1;
                            break;
                        case 's':
                            if ((ssm = out[i].v.match(/\.0+$/))) ss0 = Math.max(ss0, ssm[0].length - 1);
                            if (bt < 3) bt = 3;
                            /* falls through */
                        case 'd':
                        case 'y':
                        case 'M':
                        case 'e':
                            lst = out[i].t;
                            break;
                        case 'm':
                            if (lst === 's') {
                                out[i].t = 'M';
                                if (bt < 2) bt = 2;
                            }
                            break;
                        case 'X':
                            /*if(out[i].v === "B2");*/ break;
                        case 'Z':
                            if (bt < 1 && out[i].v.match(/[Hh]/)) bt = 1;
                            if (bt < 2 && out[i].v.match(/[Mm]/)) bt = 2;
                            if (bt < 3 && out[i].v.match(/[Ss]/)) bt = 3;
                    }
                }
                switch (bt) {
                    case 0:
                        break;
                    case 1:
                        if (dt.u >= 0.5) {
                            dt.u = 0;
                            ++dt.S;
                        }
                        if (dt.S >= 60) {
                            dt.S = 0;
                            ++dt.M;
                        }
                        if (dt.M >= 60) {
                            dt.M = 0;
                            ++dt.H;
                        }
                        break;
                    case 2:
                        if (dt.u >= 0.5) {
                            dt.u = 0;
                            ++dt.S;
                        }
                        if (dt.S >= 60) {
                            dt.S = 0;
                            ++dt.M;
                        }
                        break;
                }
                /* replace fields */
                var nstr = "",
                    jj;
                for (i = 0; i < out.length; ++i) {
                    switch (out[i].t) {
                        case 't':
                        case 'T':
                        case ' ':
                        case 'D':
                            break;
                        case 'X':
                            out[i].v = "";
                            out[i].t = ";";
                            break;
                        case 'd':
                        case 'm':
                        case 'y':
                        case 'h':
                        case 'H':
                        case 'M':
                        case 's':
                        case 'e':
                        case 'b':
                        case 'Z':
                            out[i].v = write_date(out[i].t.charCodeAt(0), out[i].v, dt, ss0);
                            out[i].t = 't';
                            break;
                        case 'n':
                        case '(':
                        case '?':
                            jj = i + 1;
                            while (out[jj] != null && (
                                    (c = out[jj].t) === "?" || c === "D" || ((c === " " || c === "t") && out[jj + 1] != null && (out[jj + 1].t === '?' || out[jj + 1].t === "t" && out[jj + 1].v === '/')) || (out[i].t === '(' && (c === ' ' || c === 'n' || c === ')')) || (c === 't' && (out[jj].v === '/' || out[jj].v === ' ' && out[jj + 1] != null && out[jj + 1].t == '?')))) {
                                out[i].v += out[jj].v;
                                out[jj] = {
                                    v: "",
                                    t: ";"
                                };
                                ++jj;
                            }
                            nstr += out[i].v;
                            i = jj - 1;
                            break;
                        case 'G':
                            out[i].t = 't';
                            out[i].v = general_fmt(v, opts);
                            break;
                    }
                }
                var vv = "",
                    myv, ostr;
                if (nstr.length > 0) {
                    if (nstr.charCodeAt(0) == 40) /* '(' */ {
                        myv = (v < 0 && nstr.charCodeAt(0) === 45 ? -v : v);
                        ostr = write_num('(', nstr, myv);
                    } else {
                        myv = (v < 0 && flen > 1 ? -v : v);
                        ostr = write_num('n', nstr, myv);
                        if (myv < 0 && out[0] && out[0].t == 't') {
                            ostr = ostr.substr(1);
                            out[0].v = "-" + out[0].v;
                        }
                    }
                    jj = ostr.length - 1;
                    var decpt = out.length;
                    for (i = 0; i < out.length; ++i)
                        if (out[i] != null && out[i].t != 't' && out[i].v.indexOf(".") > -1) {
                            decpt = i;
                            break;
                        }
                    var lasti = out.length;
                    if (decpt === out.length && ostr.toUpperCase().indexOf("E") === -1) {
                        for (i = out.length - 1; i >= 0; --i) {
                            if (out[i] == null || 'n?('.indexOf(out[i].t) === -1) continue;
                            if (jj >= out[i].v.length - 1) {
                                jj -= out[i].v.length;
                                out[i].v = ostr.substr(jj + 1, out[i].v.length);
                            } else if (jj < 0) out[i].v = "";
                            else {
                                out[i].v = ostr.substr(0, jj + 1);
                                jj = -1;
                            }
                            out[i].t = 't';
                            lasti = i;
                        }
                        if (jj >= 0 && lasti < out.length) out[lasti].v = ostr.substr(0, jj + 1) + out[lasti].v;
                    } else if (decpt !== out.length && ostr.toUpperCase().indexOf("E") === -1) {
                        jj = ostr.indexOf(".") - 1;
                        for (i = decpt; i >= 0; --i) {
                            if (out[i] == null || 'n?('.indexOf(out[i].t) === -1) continue;
                            j = out[i].v.indexOf(".") > -1 && i === decpt ? out[i].v.indexOf(".") - 1 : out[i].v.length - 1;
                            vv = out[i].v.substr(j + 1);
                            for (; j >= 0; --j) {
                                if (jj >= 0 && (out[i].v.charAt(j) === "0" || out[i].v.charAt(j) === "#")) vv = ostr.charAt(jj--) + vv;
                            }
                            out[i].v = vv;
                            out[i].t = 't';
                            lasti = i;
                        }
                        if (jj >= 0 && lasti < out.length) out[lasti].v = ostr.substr(0, jj + 1) + out[lasti].v;
                        jj = ostr.indexOf(".") + 1;
                        for (i = decpt; i < out.length; ++i) {
                            if (out[i] == null || ('n?('.indexOf(out[i].t) === -1 && i !== decpt)) continue;
                            j = out[i].v.indexOf(".") > -1 && i === decpt ? out[i].v.indexOf(".") + 1 : 0;
                            vv = out[i].v.substr(0, j);
                            for (; j < out[i].v.length; ++j) {
                                if (jj < ostr.length) vv += ostr.charAt(jj++);
                            }
                            out[i].v = vv;
                            out[i].t = 't';
                            lasti = i;
                        }
                    }
                }
                for (i = 0; i < out.length; ++i)
                    if (out[i] != null && 'n(?'.indexOf(out[i].t) > -1) {
                        myv = (flen > 1 && v < 0 && i > 0 && out[i - 1].v === "-" ? -v : v);
                        out[i].v = write_num(out[i].t, out[i].v, myv);
                        out[i].t = 't';
                    }
                var retval = "";
                for (i = 0; i !== out.length; ++i)
                    if (out[i] != null) retval += out[i].v;
                return retval;
            }
            SSF._eval = eval_fmt;
            var cfregex = /\[[=<>]/;
            var cfregex2 = /\[(=|>[=]?|<[>=]?)(-?\d+(?:\.\d*)?)\]/;

            function chkcond(v, rr) {
                if (rr == null) return false;
                var thresh = parseFloat(rr[2]);
                switch (rr[1]) {
                    case "=":
                        if (v == thresh) return true;
                        break;
                    case ">":
                        if (v > thresh) return true;
                        break;
                    case "<":
                        if (v < thresh) return true;
                        break;
                    case "<>":
                        if (v != thresh) return true;
                        break;
                    case ">=":
                        if (v >= thresh) return true;
                        break;
                    case "<=":
                        if (v <= thresh) return true;
                        break;
                }
                return false;
            }

            function choose_fmt(f, v) {
                var fmt = split_fmt(f);
                var l = fmt.length,
                    lat = fmt[l - 1].indexOf("@");
                if (l < 4 && lat > -1) --l;
                if (fmt.length > 4) throw new Error("cannot find right format for |" + fmt.join("|") + "|");
                if (typeof v !== "number") return [4, fmt.length === 4 || lat > -1 ? fmt[fmt.length - 1] : "@"];
                switch (fmt.length) {
                    case 1:
                        fmt = lat > -1 ? ["General", "General", "General", fmt[0]] : [fmt[0], fmt[0], fmt[0], "@"];
                        break;
                    case 2:
                        fmt = lat > -1 ? [fmt[0], fmt[0], fmt[0], fmt[1]] : [fmt[0], fmt[1], fmt[0], "@"];
                        break;
                    case 3:
                        fmt = lat > -1 ? [fmt[0], fmt[1], fmt[0], fmt[2]] : [fmt[0], fmt[1], fmt[2], "@"];
                        break;
                    case 4:
                        break;
                }
                var ff = v > 0 ? fmt[0] : v < 0 ? fmt[1] : fmt[2];
                if (fmt[0].indexOf("[") === -1 && fmt[1].indexOf("[") === -1) return [l, ff];
                if (fmt[0].match(cfregex) != null || fmt[1].match(cfregex) != null) {
                    var m1 = fmt[0].match(cfregex2);
                    var m2 = fmt[1].match(cfregex2);
                    return chkcond(v, m1) ? [l, fmt[0]] : chkcond(v, m2) ? [l, fmt[1]] : [l, fmt[m1 != null && m2 != null ? 2 : 1]];
                }
                return [l, ff];
            }

            function format(fmt, v, o) {
                if (o == null) o = {};
                var sfmt = "";
                switch (typeof fmt) {
                    case "string":
                        if (fmt == "m/d/yy" && o.dateNF) sfmt = o.dateNF;
                        else sfmt = fmt;
                        break;
                    case "number":
                        if (fmt == 14 && o.dateNF) sfmt = o.dateNF;
                        else sfmt = (o.table != null ? (o.table) : table_fmt)[fmt];
                        break;
                }

                //new runze 增加万 亿 格式  
                //注："w":2万2500  "w0":2万2500  "w0.0":2万2500.2  "w0.00":2万2500.23......自定义精确度
                var reg = /^(w|W)((0?)|(0\.0+))$/;
                if(!!sfmt.match(reg)){
                    if(isNaN(v)){
                        return v;
                    }

                     //var v =300101886.436;
                    var acc = sfmt.slice(1); //取得0/0.0/0.00
                    var isNegative = false;
                    if(!isNaN(v) && Number(v) < 0){
                        isNegative = true;
                        v = Math.abs(v);
                    }
                    var vInt = parseInt(v);
                     
                    var vlength = vInt.toString().length;
                    if( vlength> 4){
                        if(vlength > 8){
                            var y =parseInt (v / 100000000);  //亿
                            var w = parseInt(parseFloat(v).subtract(y*100000000) / 10000); //万
                            var q = parseFloat(v).subtract(y*100000000 + w*10000); //千以后
                            if(acc != ""){
                                q = numeral(q).format(acc); //处理精确度
                            }
                            v = y + "亿" + w + "万" + q;
                        }else{
                            var w = parseInt(v / 10000); //万
                            var q = parseFloat(v).subtract(w*10000) //千以后
                            if(acc != ""){
                                q = numeral(q).format(acc); //处理精确度
                            }
                            v = w + "万" + q;
                        }
                        

                        if(v.indexOf("亿0万0") != -1){
                            v = v.replace("0万0","");
                        }else if(v.indexOf("亿0万") != -1){
                            v = v.replace("0万","");
                        }else if(v.indexOf("万0") != -1){
                            v = v.replace("万0","万");
                        }

                        //舍弃正则后顾断言写法，旧浏览器不识别（360 V9）
                        if (v.indexOf("亿") != -1 && v.indexOf("万") == -1) { //1亿/1亿111 => 1亿/1亿0111
                            var afterYi = v.substring(v.indexOf("亿") + 1);
                            if (afterYi.substring(0, 1) !== "." && afterYi != "") {
                                switch ((parseInt(afterYi) + "").length) {
                                    case 1:
                                        afterYi = "000" + afterYi;
                                        break;
                                    case 2:
                                        afterYi = "00" + afterYi;
                                        break;
                                    case 3:
                                        afterYi = "0" + afterYi;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("亿") + 1) + afterYi;
                            }
                        } else if (v.indexOf("亿") == -1 && v.indexOf("万") != -1) { //3万0011
                            var afterWan = v.substring(v.indexOf("万") + 1);
                            if (afterWan.substring(0, 1) !== "." && afterWan != "") {
                                switch ((parseInt(afterWan) + "").length) {
                                    case 1:
                                        afterWan = "000" + afterWan;
                                        break;
                                    case 2:
                                        afterWan = "00" + afterWan;
                                        break;
                                    case 3:
                                        afterWan = "0" + afterWan;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("万") + 1) + afterWan;
                            }
                        } else if (v.indexOf("亿") != -1 && v.indexOf("万") != -1) { //1亿0053万0611
                            var afterYi = v.substring(v.indexOf("亿") + 1,v.indexOf("万")),
                                afterWan = v.substring(v.indexOf("万") + 1);

                            switch ((parseInt(afterYi) + "").length) {
                                case 1:
                                    afterYi = "000" + afterYi;
                                    break;
                                case 2:
                                    afterYi = "00" + afterYi;
                                    break;
                                case 3:
                                    afterYi = "0" + afterYi;
                                    break;
                            }
                            v = v.substring(0, v.indexOf("亿") + 1) + afterYi + v.substring(v.indexOf("万"))
                            

                            if (afterWan.substring(0, 1) !== "." && afterWan != "") {
                                switch ((parseInt(afterWan) + "").length) {
                                    case 1:
                                        afterWan = "000" + afterWan;
                                        break;
                                    case 2:
                                        afterWan = "00" + afterWan;
                                        break;
                                    case 3:
                                        afterWan = "0" + afterWan;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("万") + 1) + afterWan
                            }
                        }
       
                    }else{
                        if(acc != ""){
                            v = numeral(v).format(acc); //处理精确度
                        }
                    }
                    if(isNegative){
                        return '-' + v;
                    }else{
                        return v;
                    }
                    
                }

                if (isgeneral(sfmt, 0)) return general_fmt(v, o);
                if (v instanceof Date) v = datenum_local(v, o.date1904);
                var f = choose_fmt(sfmt, v);
                if (isgeneral(f[1])) return general_fmt(v, o);
                if (v === true) v = "TRUE";
                else if (v === false) v = "FALSE";
                else if (v === "" || v == null) return "";
                return eval_fmt(f[1], v, o, f[0]);
            }

            function load_entry(fmt, idx) {
                if (typeof idx != 'number') {
                    idx = +idx || -1;
                    for (var i = 0; i < 0x0188; ++i) {
                        if (table_fmt[i] == undefined) {
                            if (idx < 0) idx = i;
                            continue;
                        }
                        if (table_fmt[i] == fmt) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) idx = 0x187;
                }
                table_fmt[idx] = fmt;
                return idx;
            }
            SSF.load = load_entry;
            SSF._table = table_fmt;
            SSF.get_table = function get_table() {
                return table_fmt;
            };
            SSF.load_table = function load_table(tbl) {
                for (var i = 0; i != 0x0188; ++i)
                    if (tbl[i] !== undefined) load_entry(tbl[i], i);
            };
            SSF.init_table = init_table;
            SSF.format = format;
        };
        make_ssf(SSF);

        var XLMLFormatMap /*{[string]:string}*/ = ({
            "General Number": "General",
            "General Date": SSF._table[22],
            "Long Date": "dddd, mmmm dd, yyyy",
            "Medium Date": SSF._table[15],
            "Short Date": SSF._table[14],
            "Long Time": SSF._table[19],
            "Medium Time": SSF._table[18],
            "Short Time": SSF._table[20],
            "Currency": '"$"#,##0.00_);[Red]\\("$"#,##0.00\\)',
            "Fixed": SSF._table[2],
            "Standard": SSF._table[4],
            "Percent": SSF._table[10],
            "Scientific": SSF._table[11],
            "Yes/No": '"Yes";"Yes";"No";@',
            "True/False": '"True";"True";"False";@',
            "On/Off": '"Yes";"Yes";"No";@'
        });

        var unescapexml = (function() {
            /* 22.4.2.4 bstr (Basic String) */
            var encregex = /&(?:quot|apos|gt|lt|amp|#x?([\da-fA-F]+));/g,
                coderegex = /_x([\da-fA-F]{4})_/g;
            return function unescapexml(text) {
                var s = text + '',
                    i = s.indexOf("<![CDATA[");
                if (i == -1) return s.replace(encregex, function($$, $1) {
                    return encodings[$$] || String.fromCharCode(parseInt($1, $$.indexOf("x") > -1 ? 16 : 10)) || $$;
                }).replace(coderegex, function(m, c) {
                    return String.fromCharCode(parseInt(c, 16));
                });
                var j = s.indexOf("]]>");
                return unescapexml(s.slice(0, i)) + s.slice(i + 9, j) + unescapexml(s.slice(j + 3));
            };
        })();

        function xlml_format(format, value) {
            var fmt = XLMLFormatMap[format] || unescapexml(format);
            if (fmt === "General") return SSF._general(value);
            return SSF.format(fmt, value);
        }

        luckysheet.xlml_format = xlml_format;
        luckysheet.SSF = SSF;

        var basedate = new Date(1899, 11, 31, 0, 0, 0);
        var dnthresh = basedate.getTime();
        var base1904 = new Date(1900, 2, 1, 0, 0, 0);

        function datenum(v, date1904) {
            var epoch = v.getTime();
            if (date1904) epoch -= 1462 * 24 * 60 * 60 * 1000;
            return (epoch - dnthresh) / (24 * 60 * 60 * 1000);
        }

        function datenum_local(v, date1904) {
            var epoch = Date.UTC(v.getFullYear(), v.getMonth(), v.getDate(), v.getHours(), v.getMinutes(), v.getSeconds());
            var dnthresh_utc = Date.UTC(1899, 11, 31, 0, 0, 0);

            if (date1904) epoch -= 1461 * 24 * 60 * 60 * 1000;
            else if (v >= base1904) epoch += 24 * 60 * 60 * 1000;
            return (epoch - dnthresh_utc) / (24 * 60 * 60 * 1000);
        }

        function numdate(v) {
            var out = new Date();
            out.setTime(v * 24 * 60 * 60 * 1000 + dnthresh);
            return out;
        }
        /* ISO 8601 Duration */
        function parse_isodur(s) {
            var sec = 0,
                mt = 0,
                time = false;
            var m = s.match(/P([0-9\.]+Y)?([0-9\.]+M)?([0-9\.]+D)?T([0-9\.]+H)?([0-9\.]+M)?([0-9\.]+S)?/);
            if (!m) throw new Error("|" + s + "| is not an ISO8601 Duration");
            for (var i = 1; i != m.length; ++i) {
                if (!m[i]) continue;
                mt = 1;
                if (i > 3) time = true;
                switch (m[i].slice(m[i].length - 1)) {
                    case 'Y':
                        throw new Error("Unsupported ISO Duration Field: " + m[i].slice(m[i].length - 1));
                    case 'D':
                        mt *= 24;
                        /* falls through */
                    case 'H':
                        mt *= 60;
                        /* falls through */
                    case 'M':
                        if (!time) throw new Error("Unsupported ISO Duration Field: M");
                        else mt *= 60;
                        /* falls through */
                    case 'S':
                        break;
                }
                sec += mt * parseInt(m[i], 10);
            }
            return sec;
        }
        var good_pd_date = new Date('2017-02-19T19:06:09.000Z');
        if (isNaN(good_pd_date.getFullYear())) good_pd_date = new Date('2/19/17');
        var good_pd = good_pd_date.getFullYear() == 2017;
        /* parses a date as a local date */
        function parseDate(str, fixdate) {
            var d = new Date(str);
            //console.log(d);
            if (good_pd) {
                if (fixdate > 0) d.setTime(d.getTime() + d.getTimezoneOffset() * 60 * 1000);
                else if (fixdate < 0) d.setTime(d.getTime() - d.getTimezoneOffset() * 60 * 1000);
                return d;
            }
            if (str instanceof Date) return str;
            if (good_pd_date.getFullYear() == 1917 && !isNaN(d.getFullYear())) {
                var s = d.getFullYear();
                if (str.indexOf("" + s) > -1) return d;
                d.setFullYear(d.getFullYear() + 100);
                return d;
            }
            var n = str.match(/\d+/g) || ["2017", "2", "19", "0", "0", "0"];
            var out = new Date(+n[0], +n[1] - 1, +n[2], (+n[3] || 0), (+n[4] || 0), (+n[5] || 0));
            if (str.indexOf("Z") > -1) out = new Date(out.getTime() - out.getTimezoneOffset() * 60 * 1000);
            return out;
        }

        luckysheet.parseDate = parseDate;

        /* TODO: stress test */
        function fuzzynum(s) {
            var v = Number(s);
            if(typeof s == "number"){
                return s;
            }
            if (!isNaN(v)) return v;
            var wt = 1;
            var ss = s.replace(/([\d]),([\d])/g, "$1$2").replace(/[$]/g, "").replace(/[%]/g, function() {
                wt *= 100;
                return "";
            });
            if (!isNaN(v = Number(ss))) return v / wt;
            ss = ss.replace(/[(](.*)[)]/, function($$, $1) {
                wt = -wt;
                return $1;
            });
            if (!isNaN(v = Number(ss))) return v / wt;
            return v;
        }

        luckysheet.fuzzynum = fuzzynum;

        function fuzzydate(s) {
            var o = new Date(s),
                n = new Date(NaN);
            var y = o.getYear(),
                m = o.getMonth(),
                d = o.getDate();
            if (isNaN(d)) return n;
            if (y < 0 || y > 8099) return n;
            if ((m > 0 || d > 1) && y != 101) return o;
            if (s.toLowerCase().match(/jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/)) return o;
            if (s.match(/[^-0-9:,\/\\]/)) return n;
            return o;
        }

        luckysheet.fuzzydate = fuzzydate;

        return {
            //万 单位格式增加！！！
            genarate: function(value){
                var ret = [];
                var m = null, ct = {}, v = value;
                
                if(value == null){
                    return null;
                }

                if(value.toString().substr(0, 1) === "'"){
                    m = value.toString().substr(1);
                    ct = { "fa": "@", "t": "s" };
                }
                else if(value.toString().toUpperCase() === "TRUE"){
                    m = "TRUE";
                    ct = { "fa": "General", "t": "b" };
                    v = true;
                }
                else if(value.toString().toUpperCase() === "FALSE"){
                    m = "FALSE";
                    ct = { "fa": "General", "t": "b" };
                    v = false;
                }
                else if(luckysheet.func_methods.valueIsError(value)){
                    m = value.toString();
                    ct = { "fa": "General", "t": "e" };
                }
                else if(/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(value)){
                    m = value.toString();
                    ct = { "fa": "@", "t": "s" };
                }
                else if(luckysheet.func_methods.isRealNum(value) && Math.abs(parseFloat(value)) > 0 && (Math.abs(parseFloat(value)) >= 1e+11 || Math.abs(parseFloat(value)) < 1e-9)){
                    v = numeral(value).value();

                    var str = v.toExponential();
                    if(str.indexOf(".") > -1){
                        var strlen = str.split(".")[1].split("e")[0].length;
                        if(strlen > 5){
                            strlen = 5;
                        }

                        ct = { "fa": "#0."+ new Array(strlen + 1).join("0") +"E+00", "t": "n" }; 
                    }
                    else{
                        ct = { "fa": "#0.E+00", "t": "n" };
                    }

                    m = SSF.format(ct.fa, v);
                }
                else if(value.toString().indexOf("%") > -1){
                    var index = value.toString().indexOf("%");
                    var value2 = value.toString().substr(0, index);
                    var value3 = value2.replace(/,/g, "");

                    if(index == value.toString().length - 1 && luckysheet.func_methods.isRealNum(value3)){
                        if(value2.indexOf(".") > -1){
                            if(value2.indexOf(".") == value2.lastIndexOf(".")){
                                var value4 = value2.split(".")[0];
                                var value5 = value2.split(".")[1];

                                var len = value5.length;
                                if(len > 9){
                                    len = 9;
                                }

                                if(value4.indexOf(",") > -1){
                                    var isThousands = true;
                                    var ThousandsArr = value4.split(",");

                                    for(var i = 1; i < ThousandsArr.length; i++){
                                        if(ThousandsArr[i].length < 3){
                                            isThousands = false;
                                            break;
                                        }
                                    }

                                    if(isThousands){
                                        ct = { "fa": "#,##0." + new Array(len + 1).join("0") + "%", "t": "n" };
                                        v = numeral(value).value();
                                        m = SSF.format(ct.fa, v);
                                    }
                                    else{
                                        m = value.toString();
                                        ct = { "fa": "@", "t": "s" };
                                    }
                                }
                                else{
                                    ct = { "fa": "0." + new Array(len + 1).join("0") + "%", "t": "n" };
                                    v = numeral(value).value();
                                    m = SSF.format(ct.fa, v);
                                }
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else if(value2.indexOf(",") > -1){
                            var isThousands = true;
                            var ThousandsArr = value2.split(",");

                            for(var i = 1; i < ThousandsArr.length; i++){
                                if(ThousandsArr[i].length < 3){
                                    isThousands = false;
                                    break;
                                }
                            }

                            if(isThousands){
                                ct = { "fa": "#,##0%", "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else{
                            ct = { "fa": "0%", "t": "n" };
                            v = numeral(value).value();
                            m = SSF.format(ct.fa, v);
                        }
                    }
                    else{
                        m = value.toString();
                        ct = { "fa": "@", "t": "s" };
                    }
                }
                else if(value.toString().indexOf(".") > -1){
                    if(value.toString().indexOf(".") == value.toString().lastIndexOf(".")){
                        var value1 = value.toString().split(".")[0];
                        var value2 = value.toString().split(".")[1];

                        var len = value2.length;
                        if(len > 9){
                            len = 9;
                        }

                        if(value1.indexOf(",") > -1){
                            var isThousands = true;
                            var ThousandsArr = value1.split(",");

                            for(var i = 1; i < ThousandsArr.length; i++){
                                if(!luckysheet.func_methods.isRealNum(ThousandsArr[i]) || ThousandsArr[i].length < 3){
                                    isThousands = false;
                                    break;
                                }
                            }

                            if(isThousands){
                                ct = { "fa": "#,##0." + new Array(len + 1).join("0"), "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else{
                            if(luckysheet.func_methods.isRealNum(value1) && luckysheet.func_methods.isRealNum(value2)){
                                ct = { "fa": "0." + new Array(len + 1).join("0"), "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                    }
                    else{
                        m = value.toString();
                        ct = { "fa": "@", "t": "s" };
                    }
                }
                else if(luckysheet.func_methods.isRealNum(value)){
                    m = value.toString();
                    ct = { "fa": "General", "t": "n" };
                    v = parseFloat(value);
                }
                else if (luckysheet.datecontroll.isdatetime(value) && (value.toString().indexOf(".") > -1 || value.toString().indexOf(":") > -1 || value.toString().length < 16)){
                    v = datenum_local(parseDate(value.toString().replace(/-/g, "/")));

                    if(v.toString().indexOf(".") > -1){
                        if(value.toString().length > 18){
                            ct.fa = "yyyy-MM-dd hh:mm:ss";
                        }
                        else if(value.toString().length > 11){
                            ct.fa = "yyyy-MM-dd hh:mm";
                        }
                        else{
                            ct.fa = "yyyy-MM-dd";
                        }
                    }
                    else{
                        ct.fa = "yyyy-MM-dd";
                    }
                    
                    ct.t = "d";
                    m = SSF.format(ct.fa, v);
                }
                else{
                    m = value;
                    ct.fa = "General";
                    ct.t = "g";
                }

                return [m, ct, v];
            },
            update:function(fmt, v){
               return SSF.format(fmt, v);
            },
            is_date:function(fmt, v){
               return SSF.is_date(fmt, v);
            },
            valueShowEs:function(r, c, d){
                var value = luckysheet.getcellvalue(r, c, d, "m");
                if(value == null){
                    value = luckysheet.getcellvalue(r, c, d, "v");
                }
                else{
                    if (!isNaN(fuzzynum(value))){
                        if(typeof(value) == "string" && value.indexOf("%") > -1){
                            
                        }
                        else{
                            value = luckysheet.getcellvalue(r, c, d, "v");
                        }
                    }
                    // else if (!isNaN(parseDate(value).getDate())){
                    else if (d[r][c].ct != null && d[r][c].ct.t == "d"){

                    }
                    else if (d[r][c].ct != null && d[r][c].ct.t == "b"){

                    }
                    else{
                        value = luckysheet.getcellvalue(r, c, d, "v");
                    }
                }
                return value;
            }
        }

    })();
    


    

   

    //条件格式
    luckysheet.conditionformat = {
        fileClone: [],
        editorRule: null, //{"sheetIndex": sheetIndex,"itemIndex": itemIndex,"data": luckysheetfile[sheetIndex].luckysheet_conditionformat_save[itemIndex]}
        ruleTypeHtml: '<div class="ruleTypeBox"><div class="ruleTypeItem"><span class="icon">► </span><span>基于各自值设置所有单元格的格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>只为包含以下内容的单元格设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对排名靠前或靠后的数值设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对高于或低于平均值的数值设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对唯一值或重复值设置格式</span></div></div>',
        textCellColorHtml: '<div id="textCellColor"><div class="colorbox"><input id="checkTextColor" type="checkbox" checked="checked"><label for="checkTextColor">文本颜色：</label><input id="textcolorshow" data-tips="文本颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="#9c0006" style="display: none;"></div><div class="colorbox"><input id="checkCellColor" type="checkbox" checked="checked"><label for="checkCellColor">单元格颜色：</label><input id="cellcolorshow" data-tips="单元格颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="#ffc7ce" style="display: none;"></div></div>',
        selectRange: [],
        selectStatus: false,
        dataBarList: [
            { "format": ["#638ec6", "#ffffff"] },  //蓝-白渐变 数据条
            { "format": ["#63c384", "#ffffff"] },  //绿-白渐变 数据条
            { "format": ["#ff555a", "#ffffff"] },  //红-白渐变 数据条
            { "format": ["#ffb628", "#ffffff"] },  //橙-白渐变 数据条
            { "format": ["#008aef", "#ffffff"] },  //浅蓝-白渐变 数据条
            { "format": ["#d6007b", "#ffffff"] },  //紫-白渐变 数据条

            { "format": ["#638ec6"] },  //蓝色 数据条
            { "format": ["#63c384"] },  //绿色 数据条
            { "format": ["#ff555a"] },  //红色 数据条
            { "format": ["#ffb628"] },  //橙色 数据条
            { "format": ["#008aef"] },  //浅蓝色 数据条
            { "format": ["#d6007b"] }   //紫色 数据条
        ],
        colorGradationList: [
            { "format": ["rgb(99, 190, 123)", "rgb(255, 235, 132)", "rgb(248, 105, 107)"] },  //绿-黄-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(255, 235, 132)", "rgb(99, 190, 123)"] },  //红-黄-绿色阶

            { "format": ["rgb(99, 190, 123)", "rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //绿-白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)", "rgb(99, 190, 123)"] },  //红-白-绿色阶
            
            { "format": ["rgb(90, 138, 198)", "rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //蓝-白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)", "rgb(90, 138, 198)"] },  //红-白-蓝色阶
            
            { "format": ["rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)"] },  //红-白色阶

            { "format": ["rgb(99, 190, 123)", "rgb(252, 252, 255)"] },  //绿-白色阶
            { "format": ["rgb(252, 252, 255)", "rgb(99, 190, 123)"] },  //白-绿色阶

            { "format": ["rgb(99, 190, 123)", "rgb(255, 235, 132)"] },  //绿-黄色阶
            { "format": ["rgb(255, 235, 132)", "rgb(99, 190, 123)"] }   //黄-绿色阶
        ],
        init: function(){
            // 管理规则
            $(document).off("change.CFchooseSheet").on("change.CFchooseSheet", "#luckysheet-administerRule-dialog .chooseSheet", function(){
                var index = $("#luckysheet-administerRule-dialog .chooseSheet option:selected").val();
                luckysheet.conditionformat.getConditionRuleList(index);
            });
            $(document).off("click.CFadministerRuleItem").on("click.CFadministerRuleItem", "#luckysheet-administerRule-dialog .ruleList .listBox .item", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            $(document).off("click.CFadministerRuleConfirm").on("click.CFadministerRuleConfirm", "#luckysheet-administerRule-dialog-confirm", function(){
                //保存之前的规则
                var fileH = $.extend(true, [], luckysheet.getluckysheetfile());
                var historyRules = luckysheet.conditionformat.getHistoryRules(fileH);
                
                //保存当前的规则
                var fileClone = $.extend(true, [], luckysheet.conditionformat.fileClone);
                for(var c = 0; c < fileClone.length; c++){
                    var sheetIndex = fileClone[c]["index"];
                    luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"] = fileClone[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"];
                }

                var fileC = $.extend(true, [], luckysheet.getluckysheetfile());
                var currentRules = luckysheet.conditionformat.getCurrentRules(fileC);
                
                //刷新一次表格
                luckysheet.conditionformat.ref(historyRules, currentRules);
                
                //隐藏一些dom
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-administerRule-dialog").hide();

                //发送给后台
                if(luckysheet.server.allowUpdate){
                    var files = $.extend(true, [], luckysheet.getluckysheetfile());
                    for(var i = 0; i < files.length; i++){
                        luckysheet.server.saveParam("all", files[i]["index"], files[i]["luckysheet_conditionformat_save"], { "k": "luckysheet_conditionformat_save" });
                    }
                }
            });

            $(document).off("click.CFadministerRuleClose").on("click.CFadministerRuleClose", "#luckysheet-administerRule-dialog-close", function(){
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-administerRule-dialog").hide();
                luckysheet.conditionformat.fileClone = [];
            });
            $(document).off("click.CFadministerRuleFa").on("click.CFadministerRuleFa", "#luckysheet-administerRule-dialog .item .fa-table", function(){
                $(this).parents("#luckysheet-administerRule-dialog").hide();

                var sheetIndex = $("#luckysheet-administerRule-dialog .chooseSheet select option:selected").val();
                if(sheetIndex != luckysheet.currentSheetIndex){
                    luckysheet.sheetmanage.changeSheetExec(sheetIndex);
                }

                var txt = $(this).siblings("input").val().trim();
                var dataItem = $(this).parents(".item").attr("data-item");

                luckysheet.conditionformat.multiRangeDialog(dataItem, txt);

                luckysheet.conditionformat.selectRange = [];

                var range = luckysheet.conditionformat.getRangeByTxt(txt);
                if(range.length > 0){
                    for(var s = 0; s < range.length; s++){
                        var r1 = range[s].row[0], r2 = range[s].row[1];
                        var c1 = range[s].column[0], c2 = range[s].column[1];

                        var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                        var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                        luckysheet.conditionformat.selectRange.push({ 
                            "left": col_pre, 
                            "width": col - col_pre - 1, 
                            "top": row_pre, 
                            "height": row - row_pre - 1, 
                            "left_move": col_pre, 
                            "width_move": col - col_pre - 1, 
                            "top_move": row_pre, 
                            "height_move": row - row_pre - 1, 
                            "row": [r1, r2], 
                            "column": [c1, c2], 
                            "row_focus": r1, 
                            "column_focus": c1 
                        });
                    }
                }
                
                luckysheet.selectionCopyShow(luckysheet.conditionformat.selectRange);
            });
            $(document).off("click.CFmultiRangeConfirm").on("click.CFmultiRangeConfirm", "#luckysheet-multiRange-dialog-confirm", function(){
                $(this).parents("#luckysheet-multiRange-dialog").hide();

                var dataItem = $(this).attr("data-item");
                var v = $(this).parents("#luckysheet-multiRange-dialog").find("input").val();
                $("#luckysheet-administerRule-dialog .item[data-item="+dataItem+"] input").val(v);

                var sheetIndex = $("#luckysheet-administerRule-dialog .chooseSheet option:selected").val();
                luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"][dataItem].cellrange = luckysheet.conditionformat.getRangeByTxt(v);
                
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-administerRule-dialog").show();

                var range = [];
                luckysheet.selectionCopyShow(range);
            });
            $(document).off("click.CFmultiRangeClose").on("click.CFmultiRangeClose", "#luckysheet-multiRange-dialog-close", function(){
                $(this).parents("#luckysheet-multiRange-dialog").hide();
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-administerRule-dialog").show();

                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide();

                var range = [];
                luckysheet.selectionCopyShow(range);
            });
            
            // 新建规则
            $(document).off("click.CFnewConditionRule").on("click.CFnewConditionRule", "#newConditionRule", function(){
                if(luckysheet_select_save.length == 0){
                    if(luckysheet.isEditMode()){
                        alert("请选择应用范围");
                    }
                    else{
                        luckysheet.tooltip.info("请选择应用范围", "");
                    }
                    return;
                }
                
                luckysheet.conditionformat.newConditionRuleDialog(1);
            });
            $(document).off("click.CFnewConditionRuleConfirm").on("click.CFnewConditionRuleConfirm", "#luckysheet-newConditionRule-dialog-confirm", function(){
                var index = $("#luckysheet-newConditionRule-dialog .ruleTypeItem.on").index();
                var type1 = $("#luckysheet-newConditionRule-dialog #type1 option:selected").val();
                var type2 = $("#luckysheet-newConditionRule-dialog ." + type1 + "Box #type2 option:selected").val();
                
                var format;
                if(index == 0){
                    if(type1 == "dataBar"){ //数据条
                        var color = $(this).parents("#luckysheet-newConditionRule-dialog").find(".dataBarBox .luckysheet-conditionformat-config-color").spectrum("get").toHexString();

                        if(type2 == "gradient"){ //渐变填充
                            format = [color, "#ffffff"];
                        }
                        else if(type2 == "solid"){ //实心填充
                            format = [color];
                        }

                        var rule = {
                            "type": "dataBar", 
                            "cellrange": $.extend(true, [], luckysheet_select_save), 
                            "format": format
                        };
                    }
                    else if(type1 == "colorGradation"){ //色阶
                        var maxcolor = $(this).parents("#luckysheet-newConditionRule-dialog").find(".colorGradationBox .maxVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();
                        var midcolor = $(this).parents("#luckysheet-newConditionRule-dialog").find(".colorGradationBox .midVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();
                        var mincolor = $(this).parents("#luckysheet-newConditionRule-dialog").find(".colorGradationBox .minVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();

                        if(type2 == "threeColor"){ //三色
                            format = [maxcolor, midcolor, mincolor];
                        }
                        else if(type2 == "twoColor"){ //双色
                            format = [maxcolor, mincolor];
                        }

                        var rule = {
                            "type": "colorGradation", 
                            "cellrange": $.extend(true, [], luckysheet_select_save), 
                            "format": format
                        };
                    }
                    else if(type1 == "icons"){ //图标集
                        var len = $(this).parents("#luckysheet-newConditionRule-dialog").find(".iconsBox .model").attr("data-len");
                        var leftMin = $(this).parents("#luckysheet-newConditionRule-dialog").find(".iconsBox .model").attr("data-leftmin");
                        var top = $(this).parents("#luckysheet-newConditionRule-dialog").find(".iconsBox .model").attr("data-top");

                        format = {
                            "len": len, 
                            "leftMin": leftMin,
                            "top": top
                        };

                        var rule = {
                            "type": "icons", 
                            "cellrange": $.extend(true, [], luckysheet_select_save), 
                            "format": format
                        };
                    }
                }
                else{
                    var conditionName = "", conditionRange = [], conditionValue = [];

                    if(index == 1){
                        if(type1 == "number"){ //单元格值
                            conditionName = type2;

                            if(type2 == "betweenness"){
                                var v1 = $("#luckysheet-newConditionRule-dialog #conditionVal input").val().trim();
                                var v2 = $("#luckysheet-newConditionRule-dialog #conditionVal2 input").val().trim();

                                //条件值是否是选区
                                var rangeArr1 = luckysheet.conditionformat.getRangeByTxt(v1);
                                if(rangeArr1.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr1.length == 1){
                                    var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                                    var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v1 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                                        conditionValue.push(v1);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr1.length == 0){
                                    if(isNaN(v1) || v1 == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v1);
                                    }
                                }

                                var rangeArr2 = luckysheet.conditionformat.getRangeByTxt(v2);
                                if(rangeArr2.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr2.length == 1){
                                    var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                                    var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v2 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                                        conditionValue.push(v2);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr2.length == 0){
                                    if(isNaN(v2) || v2 == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v2);
                                    }
                                }
                            }
                            else{
                                //条件值
                                var v = $("#luckysheet-newConditionRule-dialog #conditionVal input").val().trim();

                                //条件值是否是选区
                                var rangeArr = luckysheet.conditionformat.getRangeByTxt(v);
                                if(rangeArr.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr.length == 1){
                                    var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                    var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                        conditionValue.push(v);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr.length == 0){
                                    if(isNaN(v) || v == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v);
                                    }
                                }
                            }
                        }
                        else if(type1 == "text"){ //特定文本
                            conditionName = "textContains";

                            //条件值
                            var v = $("#luckysheet-newConditionRule-dialog #conditionVal input").val().trim();

                            //条件值是否是选区
                            var rangeArr = luckysheet.conditionformat.getRangeByTxt(v);
                            if(rangeArr.length > 1){
                                luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                return;
                            }
                            else if(rangeArr.length == 1){
                                var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                if(r1 == r2 && c1 == c2){
                                    v = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                    
                                    conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                    conditionValue.push(v);
                                }
                                else{
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                            }
                            else if(rangeArr.length == 0){
                                if(isNaN(v) || v == ""){
                                    luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                    return;
                                }
                                else{
                                    conditionValue.push(v);
                                }
                            }
                        }
                        else if(type1 == "date"){ //发生日期
                            conditionName = "occurrenceDate";

                            //条件值
                            var v = $("#luckysheet-newConditionRule-dialog #daterange-btn").val();

                            if(v == "" || v == null){
                                luckysheet.conditionformat.infoDialog("请选择日期", "");
                                return;
                            }
                            
                            conditionValue.push(v);
                        }
                    }
                    else if(index == 2){ //排名靠前靠后
                        //条件名称
                        if(type1 == "top"){
                            if($("#luckysheet-newConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "top10%";
                            }
                            else{
                                var conditionName = "top10";
                            }
                        }
                        else if(type1 == "last"){
                            if($("#luckysheet-newConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "last10%";
                            }
                            else{
                                var conditionName = "last10";
                            }
                        }

                        //条件值
                        var v = $("#luckysheet-newConditionRule-dialog #conditionVal input").val().trim();

                        if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                            luckysheet.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                            return;
                        }
                        
                        conditionValue.push(v);
                    }
                    else if(index == 3){ //平均值
                        if(type1 == "AboveAverage"){
                            conditionName = "AboveAverage";
                            conditionValue.push("AboveAverage");
                        }
                        else if(type1 == "SubAverage"){
                            conditionName = "SubAverage";
                            conditionValue.push("SubAverage");
                        }
                    }
                    else if(index == 4){ //重复值
                        conditionName = "duplicateValue";
                        conditionValue.push(type1);
                    }

                    //格式颜色
                    if($("#luckysheet-newConditionRule-dialog #checkTextColor").is(":checked")){
                        var textcolor = $("#luckysheet-newConditionRule-dialog #textcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var textcolor = null;    
                    }
                    
                    if($("#luckysheet-newConditionRule-dialog #checkCellColor").is(":checked")){
                        var cellcolor = $("#luckysheet-newConditionRule-dialog #cellcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var cellcolor = null;    
                    }

                    format = {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    };

                    var rule = {
                        "type": "default",
                        "cellrange": $.extend(true, [], luckysheet_select_save),
                        "format": format, 
                        "conditionName": conditionName, 
                        "conditionRange": conditionRange, 
                        "conditionValue": conditionValue 
                    };
                }

                $("#luckysheet-newConditionRule-dialog").hide();
                
                //新建规则的入口
                var source = $(this).attr("data-source");
                
                if(source == 0){
                    $("#luckysheet-modal-dialog-mask").hide();
                    
                    //保存之前的规则
                    var fileH = $.extend(true, [], luckysheet.getluckysheetfile());
                    var historyRules = luckysheet.conditionformat.getHistoryRules(fileH);
                    
                    //保存当前的规则
                    var ruleArr = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] == undefined ? [] : luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"];
                    ruleArr.push(rule);
                    luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] = ruleArr;

                    var fileC = $.extend(true, [], luckysheet.getluckysheetfile());
                    var currentRules = luckysheet.conditionformat.getCurrentRules(fileC);
                    
                    //刷新一次表格
                    luckysheet.conditionformat.ref(historyRules, currentRules);

                    //发送给后台
                    if(luckysheet.server.allowUpdate){
                        luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_conditionformat_save" });
                    }
                }
                else if(source == 1){
                    //临时存储新规则
                    var ruleArr = !!luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] ? luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] : [];
                    ruleArr.push(rule);
                    luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] = ruleArr;
                    
                    //新建规则隐藏，管理规则显示
                    luckysheet.conditionformat.administerRuleDialog();
                }
            });
            $(document).off("click.CFnewConditionRuleClose").on("click.CFnewConditionRuleClose", "#luckysheet-newConditionRule-dialog-close", function(){
                //新建规则的入口
                var source = $(this).attr("data-source");
                if(source == 0){
                    $("#luckysheet-modal-dialog-mask").hide();
                }
                if(source == 1){
                    $("#luckysheet-administerRule-dialog").show();
                }
                
                //新建规则隐藏
                $("#luckysheet-newConditionRule-dialog").hide();
                
                //隐藏虚线框
                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide(); 
            });
            
            // 编辑规则
            $(document).off("click.CFeditorConditionRule").on("click.CFeditorConditionRule", "#editorConditionRule", function(){
                var sheetIndex = $("#luckysheet-administerRule-dialog .chooseSheet option:selected").val();
                var itemIndex = $("#luckysheet-administerRule-dialog .ruleList .listBox .item.on").attr("data-item");
                var rule = {
                    "sheetIndex": sheetIndex,
                    "itemIndex": itemIndex,
                    "data": luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"][itemIndex]
                };
                luckysheet.conditionformat.editorRule = rule;
                luckysheet.conditionformat.editorConditionRuleDialog();
            });
            $(document).off("click.CFeditorConditionRuleConfirm").on("click.CFeditorConditionRuleConfirm", "#luckysheet-editorConditionRule-dialog-confirm",function(){
                var index = $("#luckysheet-editorConditionRule-dialog .ruleTypeItem.on").index();
                var type1 = $("#luckysheet-editorConditionRule-dialog #type1 option:selected").val();
                var type2 = $("#luckysheet-editorConditionRule-dialog ." + type1 + "Box #type2 option:selected").val();

                var cellrange = luckysheet.conditionformat.editorRule["data"].cellrange;
                
                var format;
                if(index == 0){
                    if(type1 == "dataBar"){ //数据条
                        var color = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".dataBarBox .luckysheet-conditionformat-config-color").spectrum("get").toHexString();

                        if(type2 == "gradient"){ //渐变填充
                            format = [color, "#ffffff"];
                        }
                        else if(type2 == "solid"){ //实心填充
                            format = [color];
                        }

                        var rule = {
                            "type": "dataBar", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                    else if(type1 == "colorGradation"){ //色阶
                        var maxcolor = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".colorGradationBox .maxVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();
                        var midcolor = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".colorGradationBox .midVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();
                        var mincolor = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".colorGradationBox .minVal .luckysheet-conditionformat-config-color").spectrum("get").toRgbString();

                        if(type2 == "threeColor"){ //三色
                            format = [maxcolor, midcolor, mincolor];
                        }
                        else if(type2 == "twoColor"){ //双色
                            format = [maxcolor, mincolor];
                        }

                        var rule = {
                            "type": "colorGradation", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                    else if(type1 == "icons"){ //图标集
                        var len = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".iconsBox .model").attr("data-len");
                        var leftMin = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".iconsBox .model").attr("data-leftmin");
                        var top = $(this).parents("#luckysheet-editorConditionRule-dialog").find(".iconsBox .model").attr("data-top");

                        format = {
                            "len": len, 
                            "leftMin": leftMin,
                            "top": top
                        };

                        var rule = {
                            "type": "icons", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                }
                else{
                    var conditionName = "", conditionRange = [], conditionValue = [];

                    if(index == 1){
                        if(type1 == "number"){ //单元格值
                            conditionName = type2;

                            if(type2 == "betweenness"){
                                var v1 = $("#luckysheet-editorConditionRule-dialog #conditionVal input").val().trim();
                                var v2 = $("#luckysheet-editorConditionRule-dialog #conditionVal2 input").val().trim();

                                //条件值是否是选区
                                var rangeArr1 = luckysheet.conditionformat.getRangeByTxt(v1);
                                if(rangeArr1.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr1.length == 1){
                                    var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                                    var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v1 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                                        conditionValue.push(v1);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr1.length == 0){
                                    if(isNaN(v1) || v1 == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v1);
                                    }
                                }

                                var rangeArr2 = luckysheet.conditionformat.getRangeByTxt(v2);
                                if(rangeArr2.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr2.length == 1){
                                    var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                                    var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v2 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                                        conditionValue.push(v2);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr2.length == 0){
                                    if(isNaN(v2) || v2 == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v2);
                                    }
                                }
                            }
                            else{
                                //条件值
                                var v = $("#luckysheet-editorConditionRule-dialog #conditionVal input").val().trim();

                                //条件值是否是选区
                                var rangeArr = luckysheet.conditionformat.getRangeByTxt(v);
                                if(rangeArr.length > 1){
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr.length == 1){
                                    var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                    var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                        conditionValue.push(v);
                                    }
                                    else{
                                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr.length == 0){
                                    if(isNaN(v) || v == ""){
                                        luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v);
                                    }
                                }
                            }
                        }
                        else if(type1 == "text"){ //特定文本
                            conditionName = "textContains";

                            //条件值
                            var v = $("#luckysheet-editorConditionRule-dialog #conditionVal input").val().trim();

                            //条件值是否是选区
                            var rangeArr = luckysheet.conditionformat.getRangeByTxt(v);
                            if(rangeArr.length > 1){
                                luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                return;
                            }
                            else if(rangeArr.length == 1){
                                var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                if(r1 == r2 && c1 == c2){
                                    v = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                                    
                                    conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                    conditionValue.push(v);
                                }
                                else{
                                    luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                            }
                            else if(rangeArr.length == 0){
                                if(isNaN(v) || v == ""){
                                    luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                    return;
                                }
                                else{
                                    conditionValue.push(v);
                                }
                            }
                        }
                        else if(type1 == "date"){ //发生日期
                            conditionName = "occurrenceDate";

                            //条件值
                            var v = $("#luckysheet-editorConditionRule-dialog #daterange-btn").val();

                            if(v == "" || v == null){
                                luckysheet.conditionformat.infoDialog("请选择日期", "");
                                return;
                            }
                            
                            conditionValue.push(v);
                        }
                    }
                    else if(index == 2){ //排名靠前靠后
                        //条件名称
                        if(type1 == "top"){
                            if($("#luckysheet-editorConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "top10%";
                            }
                            else{
                                var conditionName = "top10";
                            }
                        }
                        else if(type1 == "last"){
                            if($("#luckysheet-editorConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "last10%";
                            }
                            else{
                                var conditionName = "last10";
                            }
                        }

                        //条件值
                        var v = $("#luckysheet-editorConditionRule-dialog #conditionVal input").val().trim();

                        if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                            luckysheet.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                            return;
                        }
                        
                        conditionValue.push(v);
                    }
                    else if(index == 3){ //平均值
                        if(type1 == "AboveAverage"){
                            conditionName = "AboveAverage";
                            conditionValue.push("AboveAverage");
                        }
                        else if(type1 == "SubAverage"){
                            conditionName = "SubAverage";
                            conditionValue.push("SubAverage");
                        }
                    }
                    else if(index == 4){ //重复值
                        conditionName = "duplicateValue";
                        conditionValue.push(type1);
                    }

                    //格式颜色
                    if($("#luckysheet-editorConditionRule-dialog #checkTextColor").is(":checked")){
                        var textcolor = $("#luckysheet-editorConditionRule-dialog #textcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var textcolor = null;    
                    }
                    
                    if($("#luckysheet-editorConditionRule-dialog #checkCellColor").is(":checked")){
                        var cellcolor = $("#luckysheet-editorConditionRule-dialog #cellcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var cellcolor = null;    
                    }

                    format = {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    };

                    var rule = {
                        "type": "default",
                        "cellrange": cellrange,
                        "format": format, 
                        "conditionName": conditionName, 
                        "conditionRange": conditionRange, 
                        "conditionValue": conditionValue 
                    };
                }

                //修改编辑的规则
                var sheetIndex = luckysheet.conditionformat.editorRule["sheetIndex"];
                var itemIndex = luckysheet.conditionformat.editorRule["itemIndex"];
                luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"][itemIndex] = rule;
                
                //编辑规则隐藏，管理规则显示
                $("#luckysheet-editorConditionRule-dialog").hide();
                luckysheet.conditionformat.administerRuleDialog();
            });
            $(document).off("click.CFeditorConditionRuleClose").on("click.CFeditorConditionRuleClose", "#luckysheet-editorConditionRule-dialog-close",function(){
                //编辑规则隐藏，管理规则显示
                $("#luckysheet-editorConditionRule-dialog").hide();
                $("#luckysheet-administerRule-dialog").show();
                //隐藏虚线框
                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide();
            });

            // 新建规则、编辑规则 类型切换
            $(document).off("click.CFnewEditorRuleItem").on("click.CFnewEditorRuleItem", ".luckysheet-newEditorRule-dialog .ruleTypeItem", function(){
                $(this).addClass("on").siblings().removeClass("on");
                
                var index = $(this).index();
                $(this).parents(".luckysheet-newEditorRule-dialog").find(".ruleExplainBox").html(luckysheet.conditionformat.getRuleExplain(index));

                luckysheet.conditionformat.colorSelectInit();
            });
            $(document).off("change.CFnewEditorRuleType1").on("change.CFnewEditorRuleType1", ".luckysheet-newEditorRule-dialog #type1", function(){
                var optionVal = $(this).find("option:selected").val();

                if(optionVal == "dataBar" || optionVal == "colorGradation" || optionVal == "icons" || optionVal == "number" || optionVal == "text" || optionVal == "date"){
                    $(this).parents(".luckysheet-newEditorRule-dialog").find("." + optionVal + "Box").show().siblings().hide();
                }

                if(optionVal == "date"){
                    luckysheet.conditionformat.daterangeInit($(this).parents(".luckysheet-newEditorRule-dialog").attr("id"));
                }
            });
            $(document).off("change.CFnewEditorRuleType2").on("change.CFnewEditorRuleType2", ".luckysheet-newEditorRule-dialog #type2", function(){
                var type1 = $(this).parents(".luckysheet-newEditorRule-dialog").find("#type1 option:selected").val();

                if(type1 == "colorGradation"){ 
                    var type2 = $(this).find("option:selected").val();

                    if(type2 == "threeColor"){
                        $(this).parents(".luckysheet-newEditorRule-dialog").find(".midVal").show();
                    }
                    else{
                        $(this).parents(".luckysheet-newEditorRule-dialog").find(".midVal").hide();
                    }
                }
                else if(type1 == "number"){
                    var type2 = $(this).find("option:selected").val();

                    if(type2 == "betweenness"){
                        $(this).parents(".luckysheet-newEditorRule-dialog").find(".txt").show();
                        $(this).parents(".luckysheet-newEditorRule-dialog").find("#conditionVal2").show();
                    }
                    else{
                        $(this).parents(".luckysheet-newEditorRule-dialog").find(".txt").hide();
                        $(this).parents(".luckysheet-newEditorRule-dialog").find("#conditionVal2").hide();
                    }
                }
            });
            $(document).off("click.CFiconsShowbox").on("click.CFiconsShowbox", ".luckysheet-newEditorRule-dialog .iconsBox .showbox", function(){
                $(this).parents(".iconsBox").find("ul").toggle();
            });
            $(document).off("click.CFiconsLi").on("click.CFiconsLi", ".luckysheet-newEditorRule-dialog .iconsBox li", function(){
                var len = $(this).find("div").attr("data-len");
                var leftmin = $(this).find("div").attr("data-leftmin");
                var top = $(this).find("div").attr("data-top");
                var title = $(this).find("div").attr("title");
                var position = $(this).find("div").css("background-position");

                $(this).parents(".iconsBox").find(".showbox .model").css("background-position", position);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-len", len);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-leftmin", leftmin);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-top", top);
                $(this).parents(".iconsBox").find(".showbox .model").attr("title", title);

                $(this).parents("ul").hide();
            });

            // 删除规则
            $(document).off("click.CFdeleteConditionRule").on("click.CFdeleteConditionRule", "#deleteConditionRule", function(){
                var sheetIndex = $("#luckysheet-administerRule-dialog .chooseSheet option:selected").val();
                var itemIndex = $("#luckysheet-administerRule-dialog .ruleList .listBox .item.on").attr("data-item");
                luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["luckysheet_conditionformat_save"].splice(itemIndex, 1);
                luckysheet.conditionformat.administerRuleDialog();
            });
            
            // 规则子菜单弹出层 点击确定修改样式
            $(document).off("click.CFdefault").on("click.CFdefault", "#luckysheet-conditionformat-dialog-confirm", function(){
                //条件名称
                var conditionName = $("#luckysheet-conditionformat-dialog .box").attr("data-itemvalue");
                
                //条件单元格
                var conditionRange = [];
                
                //条件值
                var conditionValue = [];
                if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "equal" || conditionName == "textContains"){
                    var v = $("#luckysheet-conditionformat-dialog #conditionVal").val().trim();
                    
                    //条件值是否是选区
                    var rangeArr = luckysheet.conditionformat.getRangeByTxt(v);
                    if(rangeArr.length > 1){
                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr.length == 1){
                        var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                        var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                            
                            conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                            conditionValue.push(v);
                        }
                        else{
                            luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr.length == 0){
                        if(isNaN(v) || v == ""){
                            luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v);
                        }
                    }
                }
                else if(conditionName == "betweenness"){//介于
                    var v1 = $("#luckysheet-conditionformat-dialog #conditionVal").val().trim();
                    var v2 = $("#luckysheet-conditionformat-dialog #conditionVal2").val().trim();

                    //条件值是否是选区
                    var rangeArr1 = luckysheet.conditionformat.getRangeByTxt(v1);
                    if(rangeArr1.length > 1){
                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr1.length == 1){
                        var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                        var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v1 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                            
                            conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                            conditionValue.push(v1);
                        }
                        else{
                            luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr1.length == 0){
                        if(isNaN(v1) || v1 == ""){
                            luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v1);
                        }
                    }

                    var rangeArr2 = luckysheet.conditionformat.getRangeByTxt(v2);
                    if(rangeArr2.length > 1){
                        luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr2.length == 1){
                        var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                        var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v2 = luckysheet.getcellvalue(r1, c1, luckysheet.flowdata);
                            
                            conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                            conditionValue.push(v2);
                        }
                        else{
                            luckysheet.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr2.length == 0){
                        if(isNaN(v2) || v2 == ""){
                            luckysheet.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v2);
                        }
                    }
                }
                else if(conditionName == "occurrenceDate"){//日期
                    var v = $("#luckysheet-conditionformat-dialog #daterange-btn").val();

                    if(v == "" || v == null){
                        luckysheet.conditionformat.infoDialog("请选择日期", "");
                        return;
                    }

                    conditionValue.push(v);
                }
                else if(conditionName == "duplicateValue"){//重复值
                    conditionValue.push($("#luckysheet-conditionformat-dialog #conditionVal option:selected").val());
                }
                else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                    var v = $("#luckysheet-conditionformat-dialog #conditionVal").val().trim();

                    if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                        luckysheet.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                        return;
                    }

                    conditionValue.push(v);
                }
                else if(conditionName == "AboveAverage"){ //高于平均值
                    conditionValue.push("AboveAverage");
                }
                else if(conditionName == "SubAverage"){ //低于平均值
                    conditionValue.push("SubAverage");
                }

                //格式颜色
                if($("#checkTextColor").is(":checked")){
                    var textcolor = $("#textcolorshow").spectrum("get").toHexString();
                }
                else{
                    var textcolor = null;    
                }

                if($("#checkCellColor").is(":checked")){
                    var cellcolor = $("#cellcolorshow").spectrum("get").toHexString();
                }
                else{
                    var cellcolor = null;    
                }

                //保存之前的规则
                var fileH = $.extend(true, [], luckysheet.getluckysheetfile());
                var historyRules = luckysheet.conditionformat.getHistoryRules(fileH);
                
                //保存当前的规则
                var rule = {
                    "type": "default",
                    "cellrange": $.extend(true, [], luckysheet_select_save),
                    "format": {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    }, 
                    "conditionName": conditionName, 
                    "conditionRange": conditionRange, 
                    "conditionValue": conditionValue 
                };
                var ruleArr = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] == undefined ? [] : luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"];
                ruleArr.push(rule);
                luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] = ruleArr;

                var fileC = $.extend(true, [], luckysheet.getluckysheetfile());
                var currentRules = luckysheet.conditionformat.getCurrentRules(fileC);
                
                //刷新一次表格
                luckysheet.conditionformat.ref(historyRules, currentRules);
                
                //隐藏一些dom
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-conditionformat-dialog").hide();

                //发送给后台
                if(luckysheet.server.allowUpdate){
                    luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_conditionformat_save" });
                }
            });
            
            // 图标集弹出层 选择
            $(document).off("click.CFicons").on("click.CFicons", "#luckysheet-CFicons-dialog .item", function(){
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-CFicons-dialog").hide();

                if(luckysheet_select_save.length > 0){
                    var cellrange = $.extend(true, [], luckysheet_select_save);
                    var format = {
                        "len": $(this).attr("data-len"), 
                        "leftMin": $(this).attr("data-leftMin"),
                        "top": $(this).attr("data-top")
                    }

                    luckysheet.conditionformat.updateItem("icons", cellrange, format);
                }
            });
            
            // 选择单元格
            $(document).on("click", ".range .fa-table", function(){
                var id = $(this).parents(".luckysheet-modal-dialog").attr("id");
                $("#" + id).hide();
                //入口
                if(id == "luckysheet-conditionformat-dialog"){
                    if($(this).siblings("input").attr("id") == "conditionVal"){
                        var source = "0_1";
                    }
                    else{
                        var source = "0_2";    
                    }
                }
                else if(id == "luckysheet-newConditionRule-dialog"){
                    if($(this).parents(".range").attr("id") == "conditionVal"){
                        var source = "1_1";    
                    }
                    else{
                        var source = "1_2";
                    }
                }
                else if(id == "luckysheet-editorConditionRule-dialog"){
                    if($(this).parents(".range").attr("id") == "conditionVal"){
                        var source = "2_1";    
                    }
                    else{
                        var source = "2_2";
                    }
                }
                //input值
                var v = $(this).siblings("input").val();

                luckysheet.conditionformat.singleRangeDialog(source, v);
                luckysheet.selectionCopyShow(luckysheet.conditionformat.getRangeByTxt(v));
            });
            $(document).on("click", "#luckysheet-singleRange-dialog-confirm", function(){
                $("#luckysheet-modal-dialog-mask").show();
                $(this).parents("#luckysheet-singleRange-dialog").hide();

                var source = $(this).attr("data-source");
                var v = $(this).parents("#luckysheet-singleRange-dialog").find("input").val();
                
                if(source == "0_1"){
                    $("#luckysheet-conditionformat-dialog").show();
                    $("#luckysheet-conditionformat-dialog #conditionVal").val(v);
                }
                else if(source == "0_2"){
                    $("#luckysheet-conditionformat-dialog").show();
                    $("#luckysheet-conditionformat-dialog #conditionVal2").val(v);
                }
                else if(source == "1_1"){
                    $("#luckysheet-newConditionRule-dialog").show();
                    $("#luckysheet-newConditionRule-dialog #conditionVal input").val(v);
                }
                else if(source == "1_2"){
                    $("#luckysheet-newConditionRule-dialog").show();
                    $("#luckysheet-newConditionRule-dialog #conditionVal2 input").val(v);
                }
                else if(source == "2_1"){
                    $("#luckysheet-editorConditionRule-dialog").show();
                    $("#luckysheet-editorConditionRule-dialog #conditionVal input").val(v);
                }
                else if(source == "2_2"){
                    $("#luckysheet-editorConditionRule-dialog").show();
                    $("#luckysheet-editorConditionRule-dialog #conditionVal2 input").val(v);
                }

                var range = [];
                luckysheet.selectionCopyShow(range);
            });
            $(document).on("click", "#luckysheet-singleRange-dialog-close", function(){
                $("#luckysheet-modal-dialog-mask").show();
                $(this).parents("#luckysheet-singleRange-dialog").hide();

                var source = $(this).attr("data-source");
                if(source == "0_1" || source == "0_2"){
                    $("#luckysheet-conditionformat-dialog").show();
                }
                else if(source == "1_1" || source == "1_2"){
                    $("#luckysheet-newConditionRule-dialog").show();
                }
                else if(source == "2_1" || source == "2_2"){
                    $("#luckysheet-editorConditionRule-dialog").show();
                }

                var range = [];
                luckysheet.selectionCopyShow(range);
            });
            
            // 弹出层右上角关闭按钮
            $(document).on("click", ".luckysheet-modal-dialog-title-close", function(){
                var id = $(this).parents(".luckysheet-modal-dialog").attr("id");
                
                //新建规则弹出层
                if(id == "luckysheet-newConditionRule-dialog"){
                    var source=$("#" + id).find("#luckysheet-newConditionRule-dialog-close").attr("data-source");
                    //新建规则入口
                    if(source == 1){
                        $("#luckysheet-administerRule-dialog").show();
                    }
                }
                
                //编辑规则弹出层
                if(id == "luckysheet-editorConditionRule-dialog"){
                    $("#luckysheet-administerRule-dialog").show();
                }

                //选择单元格弹出层
                if(id == "luckysheet-singleRange-dialog"){
                    $("#luckysheet-modal-dialog-mask").show();

                    var source = $(this).parents("#luckysheet-singleRange-dialog").find("#luckysheet-singleRange-dialog-confirm").attr("data-source");
                    if(source == "0_1" || source == "0_2"){
                        $("#luckysheet-conditionformat-dialog").show();
                    }
                    else if(source == "1_1" || source == "1_2"){
                        $("#luckysheet-newConditionRule-dialog").show();
                    }
                    else if(source == "2_1" || source == "2_2"){
                        $("#luckysheet-editorConditionRule-dialog").show();
                    }

                    var range = [];
                    luckysheet.selectionCopyShow(range);
                }

                //选择应用范围弹出层
                if(id == "luckysheet-multiRange-dialog"){
                    $("#luckysheet-modal-dialog-mask").show();

                    $("#luckysheet-administerRule-dialog").show();

                    var range = [];
                    luckysheet.selectionCopyShow(range);
                }

                //提示框
                if(id == "luckysheet-conditionformat-info-dialog"){
                    $("#luckysheet-modal-dialog-mask").show();
                }
            });

            //提示框
            $(document).on("click", "#luckysheet-conditionformat-info-dialog-close", function(){
                $(this).parents("#luckysheet-conditionformat-info-dialog").hide();
            });
        },
        singleRangeDialog: function(source, value){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-singleRange-dialog").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-singleRange-dialog", "addclass": "luckysheet-singleRange-dialog", "title": "选择单元格", "content": '<input readonly="readonly" placeholder="请选择单元格" value="'+value+'"/>', "botton": '<button id="luckysheet-singleRange-dialog-confirm" class="btn btn-primary" data-source="'+source+'">确定</button><button id="luckysheet-singleRange-dialog-close" class="btn btn-default" data-source="'+source+'">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-singleRange-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-singleRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        multiRangeDialog: function(dataItem, value){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-multiRange-dialog").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-multiRange-dialog", "addclass": "luckysheet-multiRange-dialog", "title": "选择应用范围", "content": '<input readonly="readonly" placeholder="请选择应用范围" value="'+value+'"/>', "botton": '<button id="luckysheet-multiRange-dialog-confirm" class="btn btn-primary" data-item="'+dataItem+'">确定</button><button id="luckysheet-multiRange-dialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-multiRange-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-multiRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            luckysheet.selectionCopyShow(luckysheet.conditionformat.getRangeByTxt(value));
        },
        getTxtByRange: function(range){
            if(range.length > 0){
                var txt = [];

                for(var s = 0; s < range.length; s++){
                    var r1 = range[s].row[0], r2 = range[s].row[1];
                    var c1 = range[s].column[0], c2 = range[s].column[1];
                    
                    txt.push(luckysheet.sheetmanage.getRangetxt(luckysheet.currentSheetIndex, { "row": [r1, r2], "column": [c1, c2] }, luckysheet.currentSheetIndex));
                }

                return txt.join(",");
            }
        },
        getRangeByTxt: function(txt){
            var range = [];

            if(txt.indexOf(",") != -1){
                var arr = txt.split(",");
                for(var i = 0; i < arr.length; i++){
                    if(luckysheet.formula.iscelldata(arr[i])){
                        range.push(luckysheet.formula.getcellrange(arr[i]));
                    }
                    else{
                        range = [];
                        break;    
                    }
                }
            }
            else{
                if(luckysheet.formula.iscelldata(txt)){
                    range.push(luckysheet.formula.getcellrange(txt));
                }
            }

            return range;
        },
        colorSelectInit: function(){
            $(".luckysheet-conditionformat-config-color").spectrum({
                showPalette: true,
                showPaletteOnly:true,
                preferredFormat: "hex",
                clickoutFiresChange: false,
                showInitial: true,
                showInput: true,
                // flat: true,
                hideAfterPaletteSelect: true,
                showSelectionPalette: true,
                // showButtons: false,//隐藏选择取消按钮
                maxPaletteSize: 8,
                maxSelectionSize: 8,
                // color: currenColor,
                cancelText: "取消",
                chooseText: "确定颜色",
                togglePaletteMoreText: "自定义",
                togglePaletteLessText: "收起",
                togglePaletteOnly: true,
                clearText: "清除颜色选择",
                noColorSelectedText: "没有颜色被选择",
                localStorageKey: "spectrum.textcolor" + luckysheet.server.gridKey,
                palette: [["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
                ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
                ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
                ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
                ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
                ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
                ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
                ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],
                change: function(color){
                    if (color != null) {
                        color = color.toHexString();
                    }
                }
            });
        },
        conditionformatDialog: function(title, content){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-conditionformat-dialog").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-conditionformat-dialog", "addclass": "luckysheet-conditionformat-dialog", "title": title, "content": content, "botton": '<button id="luckysheet-conditionformat-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-conditionformat-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-conditionformat-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        
            luckysheet.conditionformat.init();
            luckysheet.conditionformat.colorSelectInit();
            if(title == "条件格式——发生日期"){
                luckysheet.conditionformat.daterangeInit("luckysheet-conditionformat-dialog");
            }
        },
        CFiconsDialog: function(){　
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-CFicons-dialog").remove();

            var content = '<div class="box">'+
                            '<div style="margin-bottom: 10px;">请点击选择一组图标：</div>'+
                            '<div class="title">方向</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="0" title="三向箭头(彩色)"><div style="background-position:0 0;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="1" title="3个三角形"><div style="background-position:0 -20px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="0" data-top="2" title="四向箭头(彩色)"><div style="background-position:0 -40px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="3" title="五向箭头(彩色)"><div style="background-position:0 -60px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="0" title="三向箭头(灰色)"><div style="background-position:-131px 0;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="1" title="四向箭头(灰色)"><div style="background-position:-131px -20px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="5" data-top="2" title="五向箭头(灰色)"><div style="background-position:-131px -40px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">形状</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="4" title="三色交通灯(无边框)"><div style="background-position:0 -80px;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="5" title="三标志"><div style="background-position:0 -100px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="0" data-top="6" title="绿-红-黑渐变"><div style="background-position:0 -120px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="4" title="三色交通灯(有边框)"><div style="background-position:-131px -80px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="5" title="四色交通灯"><div style="background-position:-131px -100px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">标记</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="7" title="三个符号(有圆圈)"><div style="background-position:0 -140px;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="8" title="三色旗"><div style="background-position:0 -160px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="7" title="三个符号(无圆圈)"><div style="background-position:-131px -140px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">等级</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="9" title="3个星形"><div style="background-position:0 -180px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="10" title="五象限图"><div style="background-position:0 -200px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="11" title="5个框"><div style="background-position:0 -220px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="9" title="四等级"><div style="background-position:-131px -180px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="5" data-top="10" title="五等级"><div style="background-position:-131px -200px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-CFicons-dialog", "addclass": "luckysheet-CFicons-dialog", "title": "图标集", "content": content, "botton": '<button class="btn btn-default luckysheet-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-CFicons-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-CFicons-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        administerRuleDialog: function(){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-administerRule-dialog").remove();
            
            //工作表
            var opHtml = ''; 
            for(var j = 0; j < luckysheetfile.length; j++){
                if(luckysheetfile[j].status == "1"){
                    opHtml += '<option value="' + luckysheetfile[j]["index"] + '" selected="selected">当前工作表：' + luckysheetfile[j]["name"] + '</option>';
                }
                else{
                    opHtml += '<option value="' + luckysheetfile[j]["index"] + '">表：' + luckysheetfile[j]["name"] + '</option>';
                }
            }

            var content = '<div class="chooseSheet">' +
                            '<label>显示其格式规则：</label>' +
                            '<select>' + opHtml + '</select>' +
                          '</div>' +
                          '<div class="ruleBox">' +
                            '<div class="ruleBtn">' +
                                '<button id="newConditionRule" class="btn btn-default">新建规则</button>' +
                                '<button id="editorConditionRule" class="btn btn-default">编辑规则</button>' +
                                '<button id="deleteConditionRule" class="btn btn-default">删除规则</button>' +
                            '</div>' +
                            '<div class="ruleList">' +
                                '<div class="listTitle">' +
                                    '<span>规则</span>' +
                                    '<span>格式</span>' +
                                    '<span>应用范围</span>' +
                                '</div>' +
                                '<div class="listBox"></div>' +
                            '</div>' +
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-administerRule-dialog", "addclass": "luckysheet-administerRule-dialog", "title": "条件格式规则管理器", "content": content, "botton": '<button id="luckysheet-administerRule-dialog-confirm" class="btn btn-primary">确定</button><button id="luckysheet-administerRule-dialog-close" class="btn btn-default">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-administerRule-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-administerRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            //当前工作表的规则列表
            var index = $("#luckysheet-administerRule-dialog .chooseSheet option:selected").val();
            luckysheet.conditionformat.getConditionRuleList(index);
        },
        getConditionRuleList: function(index){
            $("#luckysheet-administerRule-dialog .ruleList .listBox").empty();

            var ruleArr = luckysheet.conditionformat.fileClone[luckysheet.sheetmanage.getSheetIndex(index)].luckysheet_conditionformat_save; //条件格式规则集合
            if(ruleArr != null && ruleArr.length > 0){
                var textColorHtml = ''; //文本颜色dom
                var cellColorHtml = ''; //单元格颜色dom

                for(var i = 0; i < ruleArr.length; i++){
                    var type = ruleArr[i]["type"];            //规则类型
                    var format = ruleArr[i]["format"];        //规则样式
                    var cellrange = ruleArr[i]["cellrange"];  //规则应用范围

                    var ruleName;         //规则名称
                    var formatHtml = '';  //样式dom
                    if(type == "dataBar"){
                        ruleName = "数据条";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else if(type == "colorGradation"){
                        ruleName = "色阶";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else if(type == "icons"){
                        ruleName = "图标集";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else{
                        ruleName = luckysheet.conditionformat.getConditionRuleName(ruleArr[i].conditionName, ruleArr[i].conditionRange, ruleArr[i].conditionValue);
                    
                        if(format["textColor"] != null){
                            formatHtml += '<span class="colorbox" title="文本颜色" style="background-color:' + format["textColor"] + '"></span>';
                        }

                        if(format["cellColor"] != null){
                            formatHtml += '<span class="colorbox" title="单元格颜色" style="background-color:' + format["cellColor"] + '"></span>';
                        }
                    }
                    
                    //应用范围dom
                    var rangeTxtArr = [];
                    for(var s = 0; s < cellrange.length; s++){
                        var r1 = cellrange[s].row[0], r2 = cellrange[s].row[1];
                        var c1 = cellrange[s].column[0], c2 = cellrange[s].column[1];

                        rangeTxtArr.push(luckysheet.luckysheetchatatABC(c1) + (r1 + 1) + ":" + luckysheet.luckysheetchatatABC(c2) + (r2 + 1));
                    }
                    
                    //条件格式规则列表dom
                    var itemHtml =  '<div class="item" data-item="' + i + '">' +
                                        '<div class="ruleName" title="' + ruleName + '">' + ruleName + '</div>' +
                                        '<div class="format">' + formatHtml + '</div>' +
                                        '<div class="ruleRange">' +
                                            '<input class="formulaInputFocus" readonly="true" value="' + rangeTxtArr.join(",") + '"/>' +
                                            '<i class="fa fa-table" aria-hidden="true" title="点击选择应用范围"></i>' +
                                        '</div>' +
                                    '</div>';

                    $("#luckysheet-administerRule-dialog .ruleList .listBox").prepend(itemHtml);
                }

                $("#luckysheet-administerRule-dialog .ruleList .listBox .item canvas").each(function(i){
                    var x = $(this).closest(".item").attr("data-item");
                    
                    var type = ruleArr[x]["type"];
                    var format = ruleArr[x]["format"];

                    var can = $(this).get(0).getContext("2d");
                    if(type == "dataBar"){
                        if(format.length == 2){
                            var my_gradient = can.createLinearGradient(0, 0, 46, 0);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            can.fillStyle = my_gradient;
                            can.fillRect(0, 0, 46, 18);

                            can.beginPath();
                            can.moveTo(0, 0);
                            can.lineTo(0, 18);
                            can.lineTo(46, 18);
                            can.lineTo(46, 0);
                            can.lineTo(0, 0);
                            can.lineWidth = devicePixelRatio;
                            can.strokeStyle = format[0];
                            can.stroke();
                            can.closePath();
                        }
                        else if(format.length == 1){
                            can.fillStyle = format[0];
                            can.fillRect(0, 0, 46, 18);

                            can.beginPath();
                            can.moveTo(0, 0);
                            can.lineTo(0, 18);
                            can.lineTo(46, 18);
                            can.lineTo(46, 0);
                            can.lineTo(0, 0);
                            can.lineWidth = devicePixelRatio;
                            can.strokeStyle = format[0];
                            can.stroke();
                            can.closePath();
                        }
                    }
                    else if(type == "colorGradation"){
                        var my_gradient = can.createLinearGradient(0, 0, 46, 0);

                        if(format.length == 3){
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(0.5, format[1]);
                            my_gradient.addColorStop(1, format[2]);
                        }
                        else if(format.length == 2){
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                        }

                        can.fillStyle = my_gradient;
                        can.fillRect(0, 0, 46, 18);
                    }
                    else if(type == "icons"){
                        var len = format["len"];
                        var l = format["leftMin"];
                        var t = format["top"];

                        var w1 = 32 * len + 10 * (len - 1);
                        var h1 = 32;
                        var w2 = 46;
                        var h2 = 46 * 32 / w1;

                        if(l == "0"){
                            can.drawImage(luckysheet_CFiconsImg, 0, t * 32, w1, h1, 0, (18 - h2) / 2, w2, h2);
                        }
                        else if(l == "5"){
                            can.drawImage(luckysheet_CFiconsImg, 210, t * 32, w1, h1, 0, (18 - h2) / 2, w2, h2);
                        }
                    }
                })

                $("#luckysheet-administerRule-dialog .ruleList .listBox .item").eq(0).addClass("on");
            }
        },
        getConditionRuleName: function(conditionName,conditionRange,conditionValue){
            //v 有条件单元格取条件单元格，若无取条件值
            if(conditionRange[0]!=null){
                var v=luckysheet.luckysheetchatatABC(conditionRange[0]["column"][0])+(conditionRange[0]["row"][0]+1);
            }
            else{
                var v=conditionValue[0];
            }
            //返回条件格式规则名称
            if(conditionName=="greaterThan"){
                return "单元格值 > "+v;
            }
            else if(conditionName=="lessThan"){
                return "单元格值 < "+v;
            }
            else if(conditionName=="betweenness"){
                if(conditionRange[1]!=null){
                    var v2=luckysheet.luckysheetchatatABC(conditionRange[1]["column"][0])+(conditionRange[1]["row"][0]+1);
                }
                else{
                    var v2=conditionValue[1];
                }
                return "单元格值介于 "+v+" 和 "+v2+" 之间";
            }
            else if(conditionName=="equal"){
                return "单元格值 = "+v;
            }
            else if(conditionName=="textContains"){
                return "单元格值包含 ="+v;
            }
            else if(conditionName=="occurrenceDate"){
                return conditionValue;
            }
            else if(conditionName=="duplicateValue"){
                if(conditionValue=="0"){
                    return "重复值";
                }
                if(conditionValue=="1"){
                    return "唯一值";
                }
            }
            else if(conditionName=="top10"){
                return "前 "+v+" 个";
            }
            else if(conditionName=="top10%"){
                return "前 "+v+"% 个";
            }
            else if(conditionName=="last10"){
                return "后 "+v+" 个";
            }
            else if(conditionName=="last10%"){
                return "后 "+v+"% 个";
            }
            else if(conditionName=="AboveAverage"){
                return "高于平均值";
            }
            else if(conditionName=="SubAverage"){
                return "低于平均值";
            }
        },
        newConditionRuleDialog: function(source){
            //规则说明
            var ruleExplainHtml = luckysheet.conditionformat.getRuleExplain(0);
            
            //弹出层
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-administerRule-dialog").hide();
            $("#luckysheet-newConditionRule-dialog").remove();

            var content = '<div>' +
                            '<div class="boxTitle">选择规则类型：</div>' +
                            luckysheet.conditionformat.ruleTypeHtml +
                            '<div class="boxTitle">编辑规则说明：</div>' +
                            '<div class="ruleExplainBox">' +
                                ruleExplainHtml +
                            '</div>' +
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-newConditionRule-dialog", "addclass": "luckysheet-newEditorRule-dialog", "title": "新建格式规则", "content": content, "botton": '<button id="luckysheet-newConditionRule-dialog-confirm" class="btn btn-primary" data-source="'+source+'">确定</button><button id="luckysheet-newConditionRule-dialog-close" class="btn btn-default" data-source="'+source+'">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-newConditionRule-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-newConditionRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //index的规则类型focus
            $("#luckysheet-newConditionRule-dialog .ruleTypeBox .ruleTypeItem:eq(0)").addClass("on").siblings().removeClass("on");
        
            luckysheet.conditionformat.colorSelectInit();
        },
        editorConditionRuleDialog: function(){
            var rule = luckysheet.conditionformat.editorRule.data;
            var ruleType = rule["type"], ruleFormat = rule["format"];
            
            var index, type1;
            if(ruleType == "dataBar" || ruleType == "colorGradation" || ruleType == "icons"){
                index = 0;
                type1 = ruleType;
            }
            else{
                var conditionName = rule["conditionName"];

                if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "betweenness" || conditionName == "equal" || conditionName == "textContains" || conditionName == "occurrenceDate"){
                    index = 1;

                    if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "betweenness" || conditionName == "equal"){
                        type1 = "number";
                    }
                    else if(conditionName == "textContains"){
                        type1 = "text";
                    }
                    else if(conditionName == "occurrenceDate"){
                        type1 = "date";
                    }
                }
                else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                    index = 2;

                    if(conditionName == "top10" || conditionName == "top10%"){
                        type1 = "top";
                    }
                    else if(conditionName == "last10" || conditionName == "last10%"){
                        type1 = "last";
                    }
                }
                else if(conditionName == "AboveAverage" || conditionName == "SubAverage"){
                    index = 3;
                    type1 = conditionName;
                }
                else if(conditionName == "duplicateValue"){
                    index = 4;
                    type1 = rule["conditionValue"];
                }
            }

            //规则说明
            var ruleExplainHtml = luckysheet.conditionformat.getRuleExplain(index);
            
            //弹出层
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-administerRule-dialog").hide();
            $("#luckysheet-editorConditionRule-dialog").remove();

            var content = '<div>' +
                            '<div class="boxTitle">选择规则类型：</div>' +
                            luckysheet.conditionformat.ruleTypeHtml +
                            '<div class="boxTitle">编辑规则说明：</div>' +
                            '<div class="ruleExplainBox">' +
                                ruleExplainHtml +
                            '</div>' +
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-editorConditionRule-dialog", "addclass": "luckysheet-newEditorRule-dialog", "title": "编辑格式规则", "content": content, "botton": '<button id="luckysheet-editorConditionRule-dialog-confirm" class="btn btn-primary">确定</button><button id="luckysheet-editorConditionRule-dialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-editorConditionRule-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-editorConditionRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            luckysheet.conditionformat.colorSelectInit();

            //规则类型focus
            $("#luckysheet-editorConditionRule-dialog .ruleTypeBox .ruleTypeItem:eq(" + index + ")").addClass("on").siblings().removeClass("on");
            
            //type1
            $("#luckysheet-editorConditionRule-dialog #type1").val(type1);
            if(type1 == "dataBar" || type1 == "colorGradation" || type1 == "icons" || type1 == "number" || type1 == "text" || type1 == "date"){
                $("#luckysheet-editorConditionRule-dialog ." + type1 + "Box").show();
                $("#luckysheet-editorConditionRule-dialog ." + type1 + "Box").siblings().hide();
            }
            if(type1 == "date"){
                luckysheet.conditionformat.daterangeInit("luckysheet-editorConditionRule-dialog");
            }

            //type2  format  value
            if(ruleType == "dataBar" || ruleType == "colorGradation" || ruleType == "icons"){
                if(type1 == "dataBar"){
                    if(ruleFormat.length == 2){
                        $("#luckysheet-editorConditionRule-dialog .dataBarBox #type2").val("gradient");
                    }
                    else if(ruleFormat.length == 1){
                        $("#luckysheet-editorConditionRule-dialog .dataBarBox #type2").val("solid");
                    }

                    $("#luckysheet-editorConditionRule-dialog .dataBarBox .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[0]);                
                }
                else if(type1 == "colorGradation"){
                    if(ruleFormat.length == 3){
                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox #type2").val("threeColor");

                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .midVal").show();

                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .maxVal .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[0]);
                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .midVal .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[1]);
                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .minVal .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[2]);                    
                    }
                    else if(ruleFormat.length == 2){
                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox #type2").val("twoColor");

                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .midVal").hide();

                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .maxVal .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[0]);
                        $("#luckysheet-editorConditionRule-dialog .colorGradationBox .minVal .luckysheet-conditionformat-config-color").spectrum("set", ruleFormat[1]);
                    }
                }
                else if(type1 == "icons"){
                    var len = ruleFormat["len"];
                    var l = ruleFormat["leftMin"];
                    var t = ruleFormat["top"];

                    $("#luckysheet-editorConditionRule-dialog .iconsBox li").each(function(i, e){
                        if($(e).find("div").attr("data-len") == len && $(e).find("div").attr("data-leftmin") == l && $(e).find("div").attr("data-top") == t){
                            $("#luckysheet-editorConditionRule-dialog .iconsBox .showbox .model").css("background-position", $(e).find("div").css("background-position"));
                            $("#luckysheet-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-len", $(e).find("div").attr("data-len"));
                            $("#luckysheet-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-leftmin", $(e).find("div").attr("data-leftmin"));
                            $("#luckysheet-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-top", $(e).find("div").attr("data-leftmin"));
                            $("#luckysheet-editorConditionRule-dialog .iconsBox .showbox .model").attr("title", $(e).find("div").attr("title"));

                            return true;
                        }
                    });
                }
            }
            else{
                if(type1 == "number"){
                    $("#luckysheet-editorConditionRule-dialog .numberBox #type2").val(conditionName);

                    if(rule.conditionRange[0] != null){
                        var val1 = luckysheet.sheetmanage.getRangetxt(luckysheet.currentSheetIndex, { "row": rule.conditionRange[0]["row"], "column": rule.conditionRange[0]["column"] }, luckysheet.currentSheetIndex);
                    }
                    else{
                        var val1 = rule.conditionValue[0];
                    }

                    $("#luckysheet-editorConditionRule-dialog .numberBox #conditionVal input").val(val1);

                    if(conditionName == "betweenness"){
                        $("#luckysheet-editorConditionRule-dialog .numberBox .txt").show();
                        $("#luckysheet-editorConditionRule-dialog .numberBox #conditionVal2").show();

                        if(rule.conditionRange[1] != null){
                            var val2 = luckysheet.sheetmanage.getRangetxt(luckysheet.currentSheetIndex, { "row": rule.conditionRange[1]["row"], "column": rule.conditionRange[1]["column"] }, luckysheet.currentSheetIndex);
                        }
                        else{
                            var val2 = rule.conditionValue[1];
                        }

                        $("#luckysheet-editorConditionRule-dialog .numberBox #conditionVal2 input").val(val2);
                    }
                    else{
                        $("#luckysheet-editorConditionRule-dialog .numberBox .txt").hide();
                        $("#luckysheet-editorConditionRule-dialog .numberBox #conditionVal2").hide();
                    }
                }
                else if(type1 == "text"){
                    if(rule.conditionRange[0] != null){
                        var val1 = luckysheet.sheetmanage.getRangetxt(luckysheet.currentSheetIndex, { "row": rule.conditionRange[0]["row"], "column": rule.conditionRange[0]["column"] }, luckysheet.currentSheetIndex);
                    }
                    else{
                        var val1 = rule.conditionValue[0];
                    }

                    $("#luckysheet-editorConditionRule-dialog .textBox #conditionVal input").val(val1);
                }
                else if(type1 == "date"){
                    luckysheet.conditionformat.daterangeInit("luckysheet-editorConditionRule-dialog");

                    var val1 = rule.conditionValue[0];
                    $("#luckysheet-editorConditionRule-dialog .dateBox #daterange-btn").val(val1);
                }
                else if(type1 == "top" || type1 == "last"){
                    var val1 = rule.conditionValue[0];

                    if(conditionName == "top10%" || conditionName == "last10%"){
                        $("#luckysheet-editorConditionRule-dialog #isPercent").attr("checked","checked");
                    }
                }
            }
        },
        infoDialog: function(title, content){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-conditionformat-info-dialog").remove();
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-conditionformat-info-dialog", "addclass": "", "title": title, "content": content, "botton": '<button id="luckysheet-conditionformat-info-dialog-close" class="btn btn-default">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-conditionformat-info-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-conditionformat-info-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        getRuleExplain: function(index){
            var textCellColorHtml = luckysheet.conditionformat.textCellColorHtml;
            
            switch(index){
                case 0: //基于各自值设置所有单元格的格式
                    var ruleExplainHtml = '<div class="title">基于各自值设置所有单元格的格式：</div>' +
                                          '<div style="height: 30px;margin-bottom: 5px;">' +
                                            '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">格式样式：</label>' +
                                            '<select id="type1">' +
                                                '<option value="dataBar">数据条</option>' +
                                                '<option value="colorGradation">色阶</option>' +
                                                '<option value="icons">图标集</option>' +
                                            '</select>' +
                                          '</div>' +
                                          '<div>' +
                                            '<div class="type1Box dataBarBox">' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">填充类型：</label>' +
                                                    '<select id="type2">' +
                                                        '<option value="gradient">渐变</option>' +
                                                        '<option value="solid">实心</option>' +
                                                    '</select>' +
                                                '</div>' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">颜色：</label>' +
                                                    '<input data-tips="数据条颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="#638ec6" style="display: none;">' +    
                                                '</div>' +
                                            '</div>' +
                                            '<div class="type1Box colorGradationBox" style="display: none;">' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">填充类型：</label>' +
                                                    '<select id="type2">' +
                                                        '<option value="threeColor">三色</option>' +
                                                        '<option value="twoColor">双色</option>' +
                                                    '</select>' +
                                                '</div>' +
                                                '<div class="maxVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">最大值：</label>' +
                                                    '<input data-tips="最大值颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="rgb(99, 190, 123)" style="display: none;">' +
                                                '</div>' +
                                                '<div class="midVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">中间值：</label>' +
                                                    '<input data-tips="中间值颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="rgb(255, 235, 132)" style="display: none;">' +
                                                '</div>' +
                                                '<div class="minVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">最小值：</label>' +
                                                    '<input data-tips="最小值颜色" data-func="background" class="luckysheet-conditionformat-config-color" type="text" value="rgb(248, 105, 107)" style="display: none;">' +
                                                '</div>' +
                                            '</div>' +
                                            '<div class="type1Box iconsBox" style="display: none;">' +
                                                '<label>填充类型：</label>' +
                                                '<div class="showbox">' +
                                                    '<div class="model" data-len="3" data-leftmin="0" data-top="0" title="三向箭头(彩色)" style="background-position: 0 0;"></div>' +
                                                    '<span class="ui-selectmenu-icon ui-icon ui-icon-triangle-1-s" style="margin-top: 2px;"></span>' +
                                                '</div>' +
                                                '<ul>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="0" title="三向箭头(彩色)" style="background-position: 0 0;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="0" title="三向箭头(灰色)" style="background-position: -131px 0;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="1" title="3个三角形" style="background-position: 0 -20px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="0" data-top="2" title="四向箭头(彩色)" style="background-position: 0 -40px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="1" title="四向箭头(灰色)" style="background-position: -131px -20px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="3" title="五向箭头(彩色)" style="background-position: 0 -60px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="5" data-top="2" title="五向箭头(灰色)" style="background-position: -131px -40px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="4" title="三色交通灯(无边框)" style="background-position: 0 -80px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="4" title="三色交通灯(有边框)" style="background-position: -131px -80px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="5" title="三标志" style="background-position: 0 -100px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="5" title="四色交通灯" style="background-position: -131px -100px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="0" data-top="6" title="绿-红-黑渐变" style="background-position: 0 -120px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="7" title="三个符号(有圆圈)" style="background-position: 0 -140px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="7" title="三个符号(无圆圈)" style="background-position: -131px -140px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="8" title="三色旗" style="background-position: 0 -160px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="9" title="3个星形" style="background-position: 0 -180px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="10" title="五象限图" style="background-position: 0 -200px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="11" title="5个框" style="background-position: 0 -220px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="9" title="四等级" style="background-position: -131px -180px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="5" data-top="10" title="五等级" style="background-position: -131px -200px;"></div></li>' +
                                                '</ul>' +
                                            '</div>' +
                                          '</div>';
                    break;
                case 1: //只为包含以下内容的单元格设置格式
                    var ruleExplainHtml = '<div class="title">只为满足以下条件的单元格：</div>' +
                                          '<div style="height: 30px;margin-bottom: 10px;">' +
                                            '<select id="type1">' +
                                                '<option value="number">单元格值</option>' +
                                                '<option value="text">特定文本</option>' +
                                                '<option value="date">发生日期</option>' +
                                            '</select>'+
                                            '<div>' +
                                                '<div class="type1Box numberBox">' +
                                                    '<select id="type2">' +
                                                        '<option value="greaterThan">大于</option>' +
                                                        '<option value="lessThan">小于</option>' +
                                                        '<option value="betweenness">介于</option>' +
                                                        '<option value="equal">等于</option>' +
                                                    '</select>' +
                                                    '<div class="inpbox range" id="conditionVal">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<span class="txt" style="display: none;">到</span>' +
                                                    '<div class="inpbox range" id="conditionVal2" style="display: none;">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="type1Box textBox" style="display: none;">' +
                                                    '<select id="type2">' +
                                                        '<option value="">包含</option>' +
                                                    '</select>' +
                                                    '<div class="inpbox range" id="conditionVal">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="type1Box dateBox" style="display: none;">' +
                                                    '<div style="width: 162px;" class="inpbox">' +
                                                        '<input style="width: 150px;" id="daterange-btn" readonly="readonly" placeholder="请选择日期"/>' +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                          '</div>' +
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 2: //仅对排名靠前或靠后的数值设置格式
                    var ruleExplainHtml = '<div class="title">为以下排名内的值：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="top">前</option>'+
                                                '<option value="last">后</option>'+
                                            '</select>'+
                                            '<div class="inpbox" id="conditionVal">'+
                                                '<input class="formulaInputFocus" type="number" value="10"/>'+
                                            '</div>'+
                                            '<input id="isPercent" type="checkbox"/>'+
                                            '<label for="isPercent" class="txt">所选范围的百分比</label>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 3: //仅对高于或低于平均值的数值设置格式
                    var ruleExplainHtml = '<div class="title">为满足以下条件的值：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="AboveAverage">高于</option>'+
                                                '<option value="SubAverage">低于</option>'+
                                            '</select>'+
                                            '<span class="txt">选定范围的平均值</span>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 4: //仅对唯一值或重复值设置格式
                    var ruleExplainHtml = '<div class="title">全部：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="0">重复</option>'+
                                                '<option value="1">唯一</option>'+
                                            '</select>'+
                                            '<span class="txt">选定范围中的数值</span>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
            }

            return ruleExplainHtml;
        },
        daterangeInit: function(id){
            //日期选择插件
            $('.ranges_1 ul').remove();
            $('#' + id).find("#daterange-btn").daterangepicker({
                ranges: 
                    {
                        // '全部': [moment(), moment().subtract(-1, 'days')],
                        '昨天': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        '今天': [moment(), moment()],
                        // '明天': [moment().subtract(-1, 'days'), moment().subtract(-1, 'days')],
                        '上周': [moment(moment().subtract(1, 'week')).subtract(new Date().getDay() - 1, 'days'), moment().subtract(new Date().getDay(), 'days')],
                        '本周': [moment().subtract(new Date().getDay() - 1, 'days'), moment().add(7 - new Date().getDay(), 'days')],
                        '上月': [moment(moment().format('YYYY-MM')).subtract(1, 'month'), moment(moment().format('YYYY-MM')).subtract(1, 'day')],
                        '本月': [moment().format('YYYY-MM'), moment(moment(moment().format('YYYY-MM')).add(1, 'month')).subtract(1, 'day')],
                        '去年': [moment(moment(moment().format('YYYY'))).subtract(1, 'years').format('YYYY'), moment(moment().format('YYYY')).subtract(1, 'day')],
                        '本年': [moment().format('YYYY'), moment(moment(moment().add(1, 'years')).format('YYYY')).subtract(1, 'day')],
                        '最近7天': [moment().subtract(6, 'days'), moment()],
                        '最近30天': [moment().subtract(29, 'days'), moment()]
                        // '未来七天': [moment(),moment().subtract(-6, 'days')],
                        // '未来30天': [moment(),moment().subtract(-29, 'days')],
                        // '未来60天': [moment(),moment().subtract(-59, 'days'), ]
                    },
                    startDate: moment(),
                    endDate: moment()
                },
                function(start, end,label) {
                    //label:通过它来知道用户选择的是什么，传给后台进行相应的展示
                    if(label == '全部'){
                        $('#daterange-btn').val('');
                    }
                    else if(label == '昨天' || label == '今天'){
                        $('#daterange-btn').val(start.format('YYYY/MM/DD'));
                    }
                    else if(label == '上周' || label == '本周' || label == '上月' || label == '本月' || label == '去年' || label == '本年' || label == '最近7天' || label == '最近30天'){
                        $('#daterange-btn').val(start.format('YYYY/MM/DD')+'-'+end.format('YYYY/MM/DD'));
                    }
                }
            ); 
        },
        CFSplitRange: function(range1, range2, range3, type){
            var range = [];

            var offset_r = range3["row"][0] - range2["row"][0];
            var offset_c = range3["column"][0] - range2["column"][0];
            
            var r1 = range1["row"][0], r2 = range1["row"][1];
            var c1 = range1["column"][0], c2 = range1["column"][1];

            if(r1 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 全部

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 上部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 下部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 >= range2["column"][0] && c1 <= range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 左部分 

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(c2 >= range2["column"][0] && c2 <= range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 右部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左上角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右上角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左下角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右下角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r1 >= range2["row"][0] && r1 <= range2["row"][1]){
                //选区 包含 条件格式应用范围 上中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r2 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 包含 条件格式应用范围 下中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 < range2["column"][0] && c2 > range2["column"][1]){
                //选区 包含 条件格式应用范围 正中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else{
                //选区 在 条件格式应用范围 之外

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [];
                }
            }

            return range;
        },
        getcolorGradation: function(color1, color2, value1, value2, value){
            var rgb1 = color1.split(',');
            var r1 = parseInt(rgb1[0].split('(')[1]);
            var g1 = parseInt(rgb1[1]);
            var b1 = parseInt(rgb1[2].split(')')[0]);

            var rgb2 = color2.split(',');
            var r2 = parseInt(rgb2[0].split('(')[1]);
            var g2 = parseInt(rgb2[1]);
            var b2 = parseInt(rgb2[2].split(')')[0]);

            var r = Math.round(r1 - (r1 - r2) / (value1 - value2) * (value1 - value));
            var g = Math.round(g1 - (g1 - g2) / (value1 - value2) * (value1 - value));
            var b = Math.round(b1 - (b1 - b2) / (value1 - value2) * (value1 - value));

            return "rgb("+ r +", "+ g +", "+ b +")";
        },
        getCFPartRange: function(sheetIndex, range1, range2){
            var ruleArr = [];

            var cf = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)].luckysheet_conditionformat_save;
            if(cf != null && cf.length > 0){
                label:  for(var i = 0; i < cf.length; i++){
                            var cellrange = cf[i].cellrange;

                            for(var j = 0; j < cellrange.length; j++){
                                var r1 = cellrange[j].row[0], r2 = cellrange[j].row[1];
                                var c1 = cellrange[j].column[0], c2 = cellrange[j].column[1];

                                for(var s = 0; s < range.length; s++){
                                    if((range[s].row[0] >= r1 && range[s].row[0] <= r2) || (range[s].row[1] >= r1 && range[s].row[1] <= r2) || (range[s].column[0] >= c1 && range[s].column[0] <= c2) || (range[s].column[1] >= c1 && range[s].column[1] <= c2)){
                                        ruleArr.push(cf[i]);

                                        continue label;
                                    }
                                }
                            }
                        }
            }

            return ruleArr;
        },
        checksCF: function(r, c, computeMap){
            if(computeMap != null &&　(r + "_" + c) in computeMap){
                return computeMap[r + "_" + c];
            }
            else{
                return null;
            }
        },
        getComputeMap: function(){
            var index = luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex);

            var ruleArr = luckysheetfile[index]["luckysheet_conditionformat_save"];
            var data = luckysheetfile[index]["data"];

            if(data == null){
                return null;
            }

            var computeMap = luckysheet.conditionformat.compute(ruleArr, data);

            return computeMap;
        },
        compute: function(ruleArr, d){
            if(ruleArr == null){
                ruleArr = [];
            }

            //条件计算存储
            var computeMap = {};

            if(ruleArr.length > 0){
                for(var i = 0; i < ruleArr.length; i++){
                    var type = ruleArr[i]["type"];
                    var cellrange = ruleArr[i]["cellrange"];
                    var format = ruleArr[i]["format"];

                    if(type == "dataBar"){ //数据条
                        var max = null, min = null;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            if(min < 0){ //选区范围内有负数
                                var plusLen = Math.round(max / (max - min) * 10) / 10;                //正数所占比
                                var minusLen = Math.round(Math.abs(min) / (max - min) * 10) / 10;     //负数所占比

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) < 0){ //负数
                                                    var valueLen = Math.round(Math.abs(parseInt(cell.v)) / Math.abs(min) * 100) / 100;

                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["dataBar"] = { "valueType": "minus", "minusLen": minusLen, "valueLen": valueLen, "format": format };
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "dataBar": { "valueType": "minus", "minusLen": minusLen, "valueLen": valueLen, "format": format } };    
                                                    }
                                                }

                                                if(parseInt(cell.v) > 0){ //正数
                                                    var valueLen = Math.round(parseInt(cell.v) / max * 100) / 100;

                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["dataBar"] = { "valueType": "plus", "plusLen": plusLen, "minusLen": minusLen, "valueLen": valueLen, "format": format };
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "dataBar": { "valueType": "plus", "plusLen": plusLen, "minusLen": minusLen, "valueLen": valueLen, "format": format } };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else{
                                var plusLen = 1;

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(max == 0){
                                                    var valueLen = 1;
                                                }
                                                else{
                                                    var valueLen = Math.round(parseInt(cell.v) / max * 100) / 100;
                                                }

                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["dataBar"] = { "valueType": "plus", "plusLen": plusLen, "valueLen": valueLen, "format": format };
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "dataBar": { "valueType": "plus", "plusLen": plusLen, "valueLen": valueLen, "format": format } };    
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if(type == "colorGradation"){ //色阶
                        var max = null, min = null, sum = 0, count = 0;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        count++;
                                        sum += parseInt(cell.v);

                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            if(format.length == 3){ //三色色阶
                                var avg = Math.floor(sum / count);

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) == min){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[2];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[2] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > min && parseInt(cell.v) < avg){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = luckysheet.conditionformat.getcolorGradation(format[2], format[1], min, avg, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": luckysheet.conditionformat.getcolorGradation(format[2], format[1], min, avg, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == avg){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[1];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[1] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > avg && parseInt(cell.v) < max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = luckysheet.conditionformat.getcolorGradation(format[1], format[0], avg, max, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": luckysheet.conditionformat.getcolorGradation(format[1], format[0], avg, max, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[0];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[0] };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }   
                            else if(format.length == 2){ //两色色阶
                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) == min){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[1];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[1] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > min && parseInt(cell.v) < max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = luckysheet.conditionformat.getcolorGradation(format[1], format[0], min, max, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": luckysheet.conditionformat.getcolorGradation(format[1], format[0], min, max, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[0];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[0] };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if(type == "icons"){ //图标集
                        var len = parseInt(format["len"]);
                        var leftMin = parseInt(format["leftMin"]);
                        var top = parseInt(format["top"]);

                        var max = null, min = null;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            var a = Math.floor((max - min + 1) / len);
                            var b = (max - min + 1) % len;

                            if(len == 3){ //一组图标有三个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, max];   
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(len == 4){ //一组图标有四个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3];
                                    var v4 = [min + a * 3 + 1, max];
                                }
                                else if(b == 3){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, min + a * 3 - 1];
                                    var v4 = [min + a * 3, max];
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 3, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 3, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v4[0] && parseInt(cell.v) <= v4[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(len == 5){ //一组图标有五个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3];
                                    var v4 = [min + a * 3 + 1, min + a * 4];
                                    var v5 = [min + a * 4 + 1, max];
                                }
                                else if(b == 3){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, min + a * 4 + 1];
                                    var v5 = [min + a * 4 + 2, max];
                                }
                                else if(b == 4){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2 + 1];
                                    var v3 = [min + a * 2 + 2, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, min + a * 4 + 2];
                                    var v5 = [min + a * 4 + 3, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, min + a * 3 - 1];
                                    var v4 = [min + a * 3, min + a * 4 - 1];
                                    var v5 = [min + a * 4, max];
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(luckysheet.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 4, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 4, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 3, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 3, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v4[0] && parseInt(cell.v) <= v4[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v5[0] && parseInt(cell.v) <= v5[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else{
                        //获取变量值
                        var conditionName = ruleArr[i].conditionName,         //条件名称
                            conditionValue0 = ruleArr[i].conditionValue[0],   //条件值1
                            conditionValue1 = ruleArr[i].conditionValue[1],   //条件值2
                            textColor = format.textColor,          //条件格式文本颜色 fc
                            cellColor = format.cellColor;          //条件格式单元格颜色 bg
                        
                        for(var s = 0; s < cellrange.length; s++){
                            //条件类型判断    
                            if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "equal" || conditionName == "textContains"){
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值
                                        var cell = d[r][c];

                                        if(luckysheet.getObjType(cell) != "object" || luckysheet.func_methods.isRealNull(cell.v)){
                                            continue;
                                        }

                                        //符合条件
                                        if(conditionName == "greaterThan" && cell.v > conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "lessThan" && cell.v < conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "equal" && cell.v == conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "textContains" && cell.v.toString().indexOf(conditionValue0) != -1){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "betweenness"){
                                //比较条件值1和条件值2的大小
                                if(conditionValue0 > conditionValue1){
                                    var vBig = conditionValue0,
                                        vSmall = conditionValue1;
                                }
                                else{
                                    var vBig = conditionValue1,
                                        vSmall = conditionValue0;
                                }
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值
                                        var cell = d[r][c];

                                        if(luckysheet.getObjType(cell) != "object" || luckysheet.func_methods.isRealNull(cell.v)){
                                            continue;
                                        }

                                        //符合条件
                                        if(cell.v >= vSmall && cell.v <= vBig){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "occurrenceDate"){
                                //获取日期所对应的数值
                                if(conditionValue0.toString().indexOf("-") == -1){
                                    var dBig = luckysheet.mask.genarate(conditionValue0)[2],
                                        dSmall = luckysheet.mask.genarate(conditionValue0)[2];
                                }
                                else{
                                    var dBig = luckysheet.mask.genarate(conditionValue0.toString().split("-")[1])[2],   
                                        dSmall = luckysheet.mask.genarate(conditionValue0.toString().split("-")[0])[2];
                                }
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值类型为日期类型
                                        if(d[r][c].ct != null && d[r][c].ct.t == "d"){
                                            //单元格值
                                            var cellVal = luckysheet.getcellvalue(r, c, d); 
                                            //符合条件
                                            if(cellVal >= dSmall && cellVal <= dBig){
                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["textColor"] = textColor;
                                                    computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "duplicateValue"){
                                //应用范围单元格值处理
                                var dmap = {};
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        var item = luckysheet.getcellvalue(r, c, d);
                                        if(!(item in dmap)){
                                            dmap[item] = [];
                                        }
                                        dmap[item].push({"r": r, "c": c});
                                    }
                                }
                                //循环应用范围计算
                                if(conditionValue0 == "0"){//重复值
                                    for(x in dmap){
                                        if(x != "null" && x != "undefined" && dmap[x].length > 1){
                                            for(var j = 0; j < dmap[x].length; j++){
                                                if((dmap[x][j].r + "_" + dmap[x][j].c) in computeMap){
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c]["textColor"] = textColor;
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c]["cellColor"] = cellColor;    
                                                }
                                                else{
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }    
                                }
                                if(conditionValue0 == "1"){//唯一值
                                    for(x in dmap){
                                        if(x != "null" && x != "undefined" && dmap[x].length == 1){
                                            if((dmap[x][0].r + "_" + dmap[x][0].c) in computeMap){
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c]["textColor"] = textColor;
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }    
                                }
                            }
                            else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%" || conditionName == "AboveAverage" || conditionName == "SubAverage"){
                                //应用范围单元格值(数值型)
                                var dArr=[]; 
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值类型为数字类型
                                        if(d[r][c].ct != null && d[r][c].ct.t == "n"){
                                            dArr.push(luckysheet.getcellvalue(r, c, d));
                                        }
                                    }
                                }
                                //数组处理
                                if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                                    //从大到小排序
                                    for(var j = 0; j < dArr.length; j++){
                                        for(var k = 0; k < dArr.length - 1 - j; k++){
                                            if(dArr[k]<dArr[k+1]){
                                                var temp=dArr[k];
                                                dArr[k]=dArr[k+1];
                                                dArr[k+1]=temp;
                                            }
                                        }
                                    }
                                    //取条件值数组
                                    if(conditionName == "top10"){
                                        var cArr = dArr.slice(0, conditionValue0); //前10项数组
                                    }
                                    else if(conditionName == "top10%"){
                                        var cArr = dArr.slice(0, Math.floor(conditionValue0*dArr.length/100)); //前10%数组
                                    }
                                    else if(conditionName == "last10"){
                                        var cArr = dArr.slice((dArr.length-conditionValue0), dArr.length); //最后10项数组
                                    }
                                    else if(conditionName == "last10%"){
                                        var cArr = dArr.slice((dArr.length-Math.floor(conditionValue0*dArr.length/100)), dArr.length); //最后10%数组
                                    }
                                    //循环应用范围计算
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            //单元格值
                                            var cellVal = luckysheet.getcellvalue(r, c, d);
                                            //符合条件
                                            if(cArr.indexOf(cellVal) != -1){
                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["textColor"] = textColor;
                                                    computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }
                                }
                                else if(conditionName == "AboveAverage" || conditionName == "SubAverage"){
                                    //计算数组平均值
                                    var sum = 0;
                                    for(var j = 0; j < dArr.length; j++){  
                                        sum += dArr[j];
                                    }
                                    var averageNum = sum / dArr.length;
                                    //循环应用范围计算
                                    if(conditionName == "AboveAverage"){ //高于平均值
                                        for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                            for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                                if(d[r] == null || d[r][c] == null){
                                                    continue;
                                                }

                                                //单元格值
                                                var cellVal = luckysheet.getcellvalue(r, c, d);
                                                //符合条件
                                                if(cellVal > averageNum){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["textColor"] = textColor;
                                                        computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else if(conditionName == "SubAverage"){ //低于平均值
                                        for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                            for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                                if(d[r] == null || d[r][c] == null){
                                                    continue;
                                                }

                                                //单元格值
                                                var cellVal = luckysheet.getcellvalue(r, c, d);
                                                //符合条件
                                                if(cellVal < averageNum){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["textColor"] = textColor;
                                                        computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            return computeMap;
        },
        updateItem: function(type, cellrange, format){
            var index = luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex);
            var files = luckysheet.getluckysheetfile();

            //保存之前的规则
            var fileH = $.extend(true, [], files);
            var historyRules = luckysheet.conditionformat.getHistoryRules(fileH);
            
            //保存当前的规则
            if(type == "delSheet"){
                var ruleArr = [];
            }
            else{
                var rule = {
                    "type": type, 
                    "cellrange": cellrange, 
                    "format": format
                };
                var ruleArr = files[index]["luckysheet_conditionformat_save"] == null ? [] : files[index]["luckysheet_conditionformat_save"];
                ruleArr.push(rule);
            }

            files[index]["luckysheet_conditionformat_save"] = ruleArr;

            var fileC = $.extend(true, [], files);
            var currentRules = luckysheet.conditionformat.getCurrentRules(fileC);

            //刷新一次表格
            luckysheet.conditionformat.ref(historyRules, currentRules);

            //发送给后台
            if(luckysheet.server.allowUpdate){
                luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_conditionformat_save" });
            }
        },
        getHistoryRules: function(fileH){
            var historyRules = [];

            for(var h = 0; h < fileH.length; h++){
                historyRules.push({"sheetIndex": fileH[h]["index"], "luckysheet_conditionformat_save": fileH[h]["luckysheet_conditionformat_save"]});
            }

            return historyRules;
        },
        getCurrentRules: function(fileC){
            var currentRules = [];

            for(var c = 0; c < fileC.length; c++){
                currentRules.push({"sheetIndex": fileC[c]["index"], "luckysheet_conditionformat_save": fileC[c]["luckysheet_conditionformat_save"]});
            }

            return currentRules;
        },
        ref: function(historyRules, currentRules){
            if (clearjfundo) {
                luckysheet.jfundo = [];

                var redo = {};
                redo["type"] = "updateCF";
                redo["data"] = {"historyRules": historyRules, "currentRules": currentRules};
                luckysheet.jfredo.push(redo); 
            }

            setTimeout(function () {
                luckysheet.luckysheetrefreshgrid();
            }, 1);

            //编辑器qksheet表格编辑时
            if(luckysheetConfigsetting.pointEdit){
                luckysheet.pointEdit_updateData();
            }
        }
    }

    //交替颜色
    luckysheet.alternateformat = {
        rangefocus: false,
        modelfocusIndex: null,
        FixedModelColor: [
            {
                "head": { "fc": "#000", "bc": "#bfbdbe" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f8f3f7" },
                "foot": { "fc": "#000", "bc": "#dde2de" }
            },
            {
                "head": { "fc": "#000", "bc": "#4bd4e7" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#eaf7ff" },
                "foot": { "fc": "#000", "bc": "#aae9f8" }
            },
            {
                "head": { "fc": "#000", "bc": "#5ed593" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#e5fbee" },
                "foot": { "fc": "#000", "bc": "#a5efcc" }
            },
            {
                "head": { "fc": "#000", "bc": "#f6cb4b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fff9e7" },
                "foot": { "fc": "#000", "bc": "#ffebac" }
            },
            {
                "head": { "fc": "#000", "bc": "#f96420" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ffe5d9" },
                "foot": { "fc": "#000", "bc": "#ffcfba" }
            },
            {
                "head": { "fc": "#000", "bc": "#5599fc" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ecf2fe" },
                "foot": { "fc": "#000", "bc": "#afcbfa" }
            },
            {
                "head": { "fc": "#000", "bc": "#22a69b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#dff2f8" },
                "foot": { "fc": "#000", "bc": "#8dd4d0" }
            },
            {
                "head": { "fc": "#000", "bc": "#7a939a" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0eff7" },
                "foot": { "fc": "#000", "bc": "#bdcad0" }
            },
            {
                "head": { "fc": "#000", "bc": "#d7a270" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fdf3f1" },
                "foot": { "fc": "#000", "bc": "#ead2b6" }
            },
            {
                "head": { "fc": "#000", "bc": "#89c54b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f1f7e9" },
                "foot": { "fc": "#000", "bc": "#c5e3a7" }
            },
            {
                "head": { "fc": "#000", "bc": "#8f88f0" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0e5ff" },
                "foot": { "fc": "#000", "bc": "#c6c4f6" }
            },
            {
                "head": { "fc": "#000", "bc": "#fd1664" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#feddee" },
                "foot": { "fc": "#000", "bc": "#f98ab5" }
            },
            {
                "head": { "fc": "#000", "bc": "#da96d3" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fce8fb" },
                "foot": { "fc": "#000", "bc": "#f2caee" }
            },
            {
                "head": { "fc": "#000", "bc": "#b49191" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f5ebe8" },
                "foot": { "fc": "#000", "bc": "#d8c3c3" }
            },
            {
                "head": { "fc": "#000", "bc": "#91b493" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0fbf0" },
                "foot": { "fc": "#000", "bc": "#b4cfb6" }
            },
            {
                "head": { "fc": "#000", "bc": "#b4a891" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f8f6f1" },
                "foot": { "fc": "#000", "bc": "#d3cab8" }
            },
            {
                "head": { "fc": "#000", "bc": "#91abb4" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#eff7fa" },
                "foot": { "fc": "#000", "bc": "#b7cbd3" }
            },
            {
                "head": { "fc": "#000", "bc": "#b7ba82" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fafbeb" },
                "foot": { "fc": "#000", "bc": "#dadcb4" }
            },
            {
                "head": { "fc": "#000", "bc": "#df3e3e" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fde9e9" },
                "foot": { "fc": "#000", "bc": "#f89292" }
            },
            {
                "head": { "fc": "#000", "bc": "#f2711c" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fef0d7" },
                "foot": { "fc": "#000", "bc": "#fbb335" }
            },
            {
                "head": { "fc": "#000", "bc": "#b5cc18" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f9fbd4" },
                "foot": { "fc": "#000", "bc": "#e2ed2a" }
            },
            {
                "head": { "fc": "#000", "bc": "#00b5ad" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ccfaf9" },
                "foot": { "fc": "#000", "bc": "#00e4df" }
            },
            {
                "head": { "fc": "#000", "bc": "#2185d0" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#d8f3fc" },
                "foot": { "fc": "#000", "bc": "#3cc4f0" }
            },
            {
                "head": { "fc": "#000", "bc": "#a5673f" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f6ede5" },
                "foot": { "fc": "#000", "bc": "#d3a47c" }
            }            
        ],
        getModelBox: function(hasRowHeader, hasRowFooter){
            $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-modelList").empty();
            $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-modelCustom").empty();

            //格式样式 模板
            var modelListHtml = '';

            for(var i = 0; i < luckysheet.alternateformat.FixedModelColor.length; i++){
                var obj = luckysheet.alternateformat.FixedModelColor[i];

                var color1, color2, color3, color4;

                if(hasRowHeader && hasRowFooter){
                    color1 = obj["head"];
                    color2 = obj["one"];
                    color3 = obj["two"];
                    color4 = obj["foot"];
                }
                else if(hasRowHeader){
                    color1 = obj["head"];
                    color2 = obj["one"];
                    color3 = obj["two"];
                    color4 = obj["one"];
                }
                else if(hasRowFooter){
                    color1 = obj["one"];
                    color2 = obj["two"];
                    color3 = obj["one"];
                    color4 = obj["foot"];
                }
                else{
                    color1 = obj["one"];
                    color2 = obj["two"];
                    color3 = obj["one"];
                    color4 = obj["two"];
                }

                modelListHtml += '<div class="modelbox">'+
                                    '<div class="box">'+
                                        '<span style="color:'+ color1["fc"] +';background-color:'+ color1["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color2["fc"] +';background-color:'+ color2["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color3["fc"] +';background-color:'+ color3["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color4["fc"] +';background-color:'+ color4["bc"] +'"> — </span>'+
                                    '</div>'+
                                 '</div>';
            }

            $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-modelList").append(modelListHtml);

            //自定义 模板
            var modelCustom = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_alternateformat_save_modelCustom"];
            if(modelCustom != null && modelCustom.length > 0){
                var modelCustomHtml = '';

                for(var i = 0; i < modelCustom.length; i++){
                    var obj = modelCustom[i];

                    var color1, color2, color3, color4;

                    if(hasRowHeader && hasRowFooter){
                        color1 = obj["head"];
                        color2 = obj["one"];
                        color3 = obj["two"];
                        color4 = obj["foot"];
                    }
                    else if(hasRowHeader){
                        color1 = obj["head"];
                        color2 = obj["one"];
                        color3 = obj["two"];
                        color4 = obj["one"];
                    }
                    else if(hasRowFooter){
                        color1 = obj["one"];
                        color2 = obj["two"];
                        color3 = obj["one"];
                        color4 = obj["foot"];
                    }
                    else{
                        color1 = obj["one"];
                        color2 = obj["two"];
                        color3 = obj["one"];
                        color4 = obj["two"];
                    }

                    modelCustomHtml +=  '<div class="modelbox">'+
                                            '<div class="box">'+
                                                '<span style="color:'+ color1["fc"] +';background-color:'+ color1["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color2["fc"] +';background-color:'+ color2["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color3["fc"] +';background-color:'+ color3["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color4["fc"] +';background-color:'+ color4["bc"] +'"> — </span>'+
                                            '</div>'+
                                        '</div>';
                }

                $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-modelCustom").append(modelCustomHtml);
            }
        },
        init: function(){
            $("#luckysheet-modal-dialog-slider-alternateformat").remove();
            $("body").append(luckysheetAlternateformatHtml);
            luckysheet.luckysheetsizeauto();

            //关闭
            $("#luckysheet-modal-dialog-slider-alternateformat .luckysheet-model-close-btn").click(function () {
                $("#luckysheet-modal-dialog-slider-alternateformat").hide();
                luckysheet.luckysheetsizeauto();
            });

            //应用范围
            $(document).off("focus.AFrangeInput").on("focus.AFrangeInput", "#luckysheet-alternateformat-range input", function(){
                luckysheet.alternateformat.rangefocus = true;
            });
            $(document).off("blur.AFrangeInput").on("blur.AFrangeInput", "#luckysheet-alternateformat-range input", function(){
                luckysheet.alternateformat.rangefocus = false;
            });

            $(document).off("keydown.AFrangeInput").on("keydown.AFrangeInput", "#luckysheet-alternateformat-range input", function(e){
                var rangeValue = $(this).val().trim();
                if(e.keyCode == 13){
                    luckysheet.alternateformat.update();
                }
            });
            $(document).off("click.AFrangeIcon").on("click.AFrangeIcon", "#luckysheet-alternateformat-range .fa-table", function(){
                $("#luckysheet-modal-dialog-slider-alternateformat").hide();
                luckysheet.luckysheetsizeauto();

                var rangeValue = $(this).parents("#luckysheet-alternateformat-range").find("input").val().trim();
                luckysheet.alternateformat.rangeDialog(rangeValue);
            });
            $(document).off("click.AFrDCf").on("click.AFrDCf", "#luckysheet-alternateformat-rangeDialog-confirm", function(){
                var rangeValue = $(this).parents("#luckysheet-alternateformat-rangeDialog").find("input").val().trim();
                $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-range input").val(rangeValue);

                $(this).parents("#luckysheet-alternateformat-rangeDialog").hide();
                $("#luckysheet-modal-dialog-slider-alternateformat").show();
                luckysheet.luckysheetsizeauto();

                luckysheet.alternateformat.update();
            });
            $(document).off("click.AFrDCl").on("click.AFrDCl", "#luckysheet-alternateformat-rangeDialog-close", function(){
                $(this).parents("#luckysheet-alternateformat-rangeDialog").hide();
                $("#luckysheet-modal-dialog-slider-alternateformat").show();
                luckysheet.luckysheetsizeauto();
            });
            $(document).off("click.AFrDTitle").on("click.AFrDTitle", "#luckysheet-alternateformat-rangeDialog .luckysheet-modal-dialog-title-close", function(){
                $(this).parents("#luckysheet-alternateformat-rangeDialog").hide();
                $("#luckysheet-modal-dialog-slider-alternateformat").show();
                luckysheet.luckysheetsizeauto();
            });

            //页眉、页脚选中
            $(document).off("change.AFrowHeader").on("change.AFrowHeader", "#luckysheet-alternateformat-rowHeader", function(){
                if($(this).is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($("#luckysheet-alternateformat-rowFooter").is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                luckysheet.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
                luckysheet.alternateformat.modelboxOn();
                luckysheet.alternateformat.update();
            });
            $(document).off("change.AFrowFooter").on("change.AFrowFooter", "#luckysheet-alternateformat-rowFooter", function(){
                if($("#luckysheet-alternateformat-rowHeader").is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($(this).is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                luckysheet.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
                luckysheet.alternateformat.modelboxOn();
                luckysheet.alternateformat.update();
            });

            //点击样式模板
            $(document).off("click.AFmodelbox").on("click.AFmodelbox", "#luckysheet-modal-dialog-slider-alternateformat .modelbox", function(){
                var index = $(this).index();
                var $id = $(this).parents(".cf").attr("id");

                if($id == "luckysheet-alternateformat-modelList"){
                    luckysheet.alternateformat.modelfocusIndex = index;
                }
                else if($id == "luckysheet-alternateformat-modelCustom"){
                    var len = luckysheet.alternateformat.FixedModelColor.length;
                    luckysheet.alternateformat.modelfocusIndex = index + len;
                }

                luckysheet.alternateformat.modelboxOn();
                luckysheet.alternateformat.update();
            });

            //点击选择文本/单元格颜色
            $(document).off("click.AFselectColor").on("click.AFselectColor", "#luckysheet-modal-dialog-slider-alternateformat .luckysheet-color-menu-button-indicator", function(){
                var $parent = $(this).closest(".toningbox");

                if($(this).find(".luckysheet-icon-img").hasClass("luckysheet-icon-text-color")){
                    var colorType = "fc";
                    var currenColor = $parent.find(".toningShow").data("fc");
                }
                else if($(this).find(".luckysheet-icon-img").hasClass("luckysheet-icon-cell-color")){
                    var colorType = "bc";
                    var currenColor = $parent.find(".toningShow").data("bc");
                }

                //source
                if($parent.hasClass("header")){
                    var source = "0";
                }
                else if($parent.hasClass("ctOne")){
                    var source = "1";
                }
                else if($parent.hasClass("ctTwo")){
                    var source = "2";
                }
                else if($parent.hasClass("footer")){
                    var source = "3";
                }

                luckysheet.alternateformat.colorSelectDialog(currenColor, colorType, source);
            });

            //选择颜色 确定 添加自定义模板
            $(document).off("click.AFselectColorConfirm").on("click.AFselectColorConfirm", "#luckysheet-alternateformat-colorSelect-dialog-confirm", function(){
                var $parent = $(this).parents("#luckysheet-alternateformat-colorSelect-dialog");

                $("#luckysheet-modal-dialog-mask").hide();
                $parent.hide();

                //获取currenColor colorType source
                var currenColor = $parent.find(".currenColor span").attr("title");

                if($parent.find(".luckysheet-modal-dialog-title-text").text() == "选择文本颜色"){
                    var colorType = "fc";
                }
                else if($parent.find(".luckysheet-modal-dialog-title-text").text() == "选择单元格颜色"){
                    var colorType = "bc";
                }

                var source = $parent.find(".currenColor").attr("data-source");
                
                //赋给颜色
                if(source == "0"){
                    if(colorType == "fc"){
                        $("#luckysheet-alternateformat-modelToning .header .toningShow").css("color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .header .toningShow").data("fc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .header .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#luckysheet-alternateformat-modelToning .header .toningShow").css("background-color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .header .toningShow").data("bc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .header .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "1"){
                    if(colorType == "fc"){
                        $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").css("color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").data("fc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctOne .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").css("background-color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").data("bc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctOne .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "2"){
                    if(colorType == "fc"){
                        $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").css("color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").data("fc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctTwo .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").css("background-color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").data("bc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .ctTwo .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "3"){
                    if(colorType == "fc"){
                        $("#luckysheet-alternateformat-modelToning .footer .toningShow").css("color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .footer .toningShow").data("fc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .footer .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#luckysheet-alternateformat-modelToning .footer .toningShow").css("background-color", currenColor);
                        $("#luckysheet-alternateformat-modelToning .footer .toningShow").data("bc", currenColor);
                        $("#luckysheet-alternateformat-modelToning .footer .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                
                //若模板聚焦在固有模板，则新加模板；若模板聚焦在自定义模板，则修改该模板
                if($("#luckysheet-alternateformat-rowHeader").is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($("#luckysheet-alternateformat-rowFooter").is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                var index = luckysheet.alternateformat.modelfocusIndex;
                var len = luckysheet.alternateformat.FixedModelColor.length;

                if(index < len){
                    var format = $.extend(true, {}, luckysheet.alternateformat.getFormatByIndex());
                }
                else{
                    var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];
                    var modelCustom = file["luckysheet_alternateformat_save_modelCustom"];

                    var format = $.extend(true, {}, modelCustom[index - len]);
                }

                if(source == "0"){
                    if(colorType == "fc"){
                        format["head"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["head"]["bc"] = currenColor;
                    }
                }
                else if(source == "1"){
                    if(colorType == "fc"){
                        format["one"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["one"]["bc"] = currenColor;
                    }
                }
                else if(source == "2"){
                    if(colorType == "fc"){
                        format["two"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["two"]["bc"] = currenColor;
                    }
                }
                else if(source == "3"){
                    if(colorType == "fc"){
                        format["foot"]["fc"] = currenColor;
                    }
                    if(colorType == "bc"){
                        format["foot"]["bc"] = currenColor;
                    }
                }

                if(luckysheet.alternateformat.modelfocusIndex < len){
                    luckysheet.alternateformat.addCustomModel(format);
                    luckysheet.alternateformat.modelfocusIndex = luckysheet.alternateformat.getIndexByFormat(format);
                }
                else{
                    file["luckysheet_alternateformat_save_modelCustom"][index - len] = format;

                    if(luckysheet.server.allowUpdate){
                        luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, file["luckysheet_alternateformat_save_modelCustom"], { "k": "luckysheet_alternateformat_save_modelCustom" });
                    }
                }

                luckysheet.alternateformat.getModelBox(hasRowHeader, hasRowFooter);
                luckysheet.alternateformat.modelboxOn();
                luckysheet.alternateformat.update();
            });
            
            //点击 移除交替颜色 按钮
            $(document).off("click.AFremove").on("click.AFremove", "#luckysheet-alternateformat-remove", function(){
                var dataIndex = $(this).data("index");

                var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];

                var ruleArr = file["luckysheet_alternateformat_save"];

                //保存之前的规则
                var historyRules = $.extend(true, [], ruleArr);

                //保存当前的规则
                if(ruleArr.length > 1){
                    ruleArr.splice(dataIndex, 1);
                }
                else{
                    ruleArr = [];
                }

                var currentRules = $.extend(true, [], ruleArr);
                
                //刷新一次表格
                luckysheet.alternateformat.ref(historyRules, currentRules);

                if(luckysheet.server.allowUpdate){
                    luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_alternateformat_save" });
                }

                //隐藏一些dom
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-modal-dialog-slider-alternateformat").hide();

                luckysheet.luckysheetsizeauto();
            });
        },
        perfect: function(){
            var range = $.extend(true, {}, luckysheet_select_save[0]);
            var existsIndex = luckysheet.alternateformat.rangeIsExists(range)[1];
            
            var obj = $.extend(true, {}, luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_alternateformat_save"][existsIndex]);
            
            //应用范围
            var cellrange = obj["cellrange"];
            $("#luckysheet-alternateformat-range input").val(luckysheet.sheetmanage.getRangetxt(luckysheet.currentSheetIndex, { "row": cellrange["row"], "column": cellrange["column"] }, luckysheet.currentSheetIndex));
            
            luckysheet_select_save = [{ "row": cellrange["row"], "column": cellrange["column"] }];
            luckysheet.selectHightlightShow();

            //页眉、页脚
            var hasRowHeader = obj["hasRowHeader"];
            var hasRowFooter = obj["hasRowFooter"];
            
            //模板聚焦
            var format = obj["format"];
            luckysheet.alternateformat.modelfocusIndex = luckysheet.alternateformat.getIndexByFormat(format);

            if(luckysheet.alternateformat.modelfocusIndex == null){
                luckysheet.alternateformat.addCustomModel(format);
                luckysheet.alternateformat.modelfocusIndex = luckysheet.alternateformat.getIndexByFormat(format);
            }

            luckysheet.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
            luckysheet.alternateformat.modelboxOn();

            //标识 交替颜色的index
            $("#luckysheet-alternateformat-remove").data("index", existsIndex);
        },
        checkboxChange: function(hasRowHeader, hasRowFooter){
            if(hasRowHeader){
                $("#luckysheet-alternateformat-rowHeader").prop("checked", true);
                $("#luckysheet-alternateformat-modelToning .header").show();
            }
            else{
                $("#luckysheet-alternateformat-rowHeader").removeAttr("checked");  
                $("#luckysheet-alternateformat-modelToning .header").hide(); 
            }

            if(hasRowFooter){
                $("#luckysheet-alternateformat-rowFooter").prop("checked", true);
                $("#luckysheet-alternateformat-modelToning .footer").show();
            }
            else{
                $("#luckysheet-alternateformat-rowFooter").removeAttr("checked"); 
                $("#luckysheet-alternateformat-modelToning .footer").hide();  
            }

            luckysheet.alternateformat.getModelBox(hasRowHeader, hasRowFooter);
        },
        modelboxOn: function(){
            //模板 foucs
            $("#luckysheet-modal-dialog-slider-alternateformat .modelbox").removeClass("on");

            var index = luckysheet.alternateformat.modelfocusIndex;
            var len = luckysheet.alternateformat.FixedModelColor.length;
            
            if(index < len){
                $("#luckysheet-alternateformat-modelList .modelbox").eq(index).addClass("on");
            }
            else{
                $("#luckysheet-alternateformat-modelCustom .modelbox").eq(index - len).addClass("on");
            }

            //编辑 对应颜色改变
            luckysheet.alternateformat.modelToningColor();
        },
        modelToningColor: function(){
            var format = luckysheet.alternateformat.getFormatByIndex();

            //页眉
            $("#luckysheet-alternateformat-modelToning .header .toningShow").css({"color": format["head"].fc, "background-color": format["head"].bc});
            $("#luckysheet-alternateformat-modelToning .header .toningShow").data("fc", format["head"].fc).data("bc", format["head"].bc);
            $("#luckysheet-alternateformat-modelToning .header .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["head"].fc);
            $("#luckysheet-alternateformat-modelToning .header .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["head"].bc);

            //颜色1
            $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").css({"color": format["one"].fc, "background-color": format["one"].bc});
            $("#luckysheet-alternateformat-modelToning .ctOne .toningShow").data("fc", format["one"].fc).data("bc", format["one"].bc);
            $("#luckysheet-alternateformat-modelToning .ctOne .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["one"].fc);
            $("#luckysheet-alternateformat-modelToning .ctOne .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["one"].bc);

            //颜色2
            $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").css({"color": format["two"].fc, "background-color": format["two"].bc});
            $("#luckysheet-alternateformat-modelToning .ctTwo .toningShow").data("fc", format["two"].fc).data("bc", format["two"].bc);
            $("#luckysheet-alternateformat-modelToning .ctTwo .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["two"].fc);
            $("#luckysheet-alternateformat-modelToning .ctTwo .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["two"].bc);

            //页脚
            $("#luckysheet-alternateformat-modelToning .footer .toningShow").css({"color": format["foot"].fc, "background-color": format["foot"].bc});
            $("#luckysheet-alternateformat-modelToning .footer .toningShow").data("fc", format["foot"].fc).data("bc", format["foot"].bc);
            $("#luckysheet-alternateformat-modelToning .footer .luckysheet-icon-text-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["foot"].fc);
            $("#luckysheet-alternateformat-modelToning .footer .luckysheet-icon-cell-color").parents(".luckysheet-color-menu-button-indicator").css("border-bottom-color", format["foot"].bc);
        },
        addCustomModel: function(format){
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];

            if(file["luckysheet_alternateformat_save_modelCustom"] == null){
                file["luckysheet_alternateformat_save_modelCustom"] = [];
            }

            file["luckysheet_alternateformat_save_modelCustom"].push(format);

            if(luckysheet.server.allowUpdate){
                luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, file["luckysheet_alternateformat_save_modelCustom"], { "k": "luckysheet_alternateformat_save_modelCustom" });
            }
        },
        colorSelectDialog: function(currenColor, colorType, source){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-alternateformat-colorSelect-dialog").remove();

            if(colorType == "fc"){
                var title = "选择文本颜色";
            }
            else if(colorType == "bc"){
                var title = "选择单元格颜色";
            }

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-alternateformat-colorSelect-dialog", "addclass": "luckysheet-alternateformat-colorSelect-dialog", "title": title, "content": "<div class='currenColor' data-source='"+ source +"'>当前颜色：<span title='"+ currenColor +"' style='background-color:"+ currenColor +"'></span></div><div class='colorshowbox'></div>", "botton": '<button id="luckysheet-alternateformat-colorSelect-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-alternateformat-colorSelect-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-alternateformat-colorSelect-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //初始化选择颜色插件
            $("#luckysheet-alternateformat-colorSelect-dialog").find(".colorshowbox").spectrum({
                showPalette: true,
                showPaletteOnly: true,
                preferredFormat: "hex",
                clickoutFiresChange: false,
                showInitial: true,
                showInput: true,
                flat: true,
                hideAfterPaletteSelect: true,
                showSelectionPalette: true,
                showButtons: false,//隐藏选择取消按钮
                maxPaletteSize: 8,
                maxSelectionSize: 8,
                color: currenColor,
                cancelText: "取消",
                chooseText: "确定颜色",
                togglePaletteMoreText: "自定义",
                togglePaletteLessText: "收起",
                togglePaletteOnly: true,
                clearText: "清除颜色选择",
                noColorSelectedText: "没有颜色被选择",
                localStorageKey: "spectrum.textcolor" + luckysheet.server.gridKey,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    ["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc"],
                    ["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd"],
                    ["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0"],
                    ["#c00", "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79"],
                    ["#900", "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47"],
                    ["#600", "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130"]
                ],
                move: function(color){
                    if (color != null) {
                        color = color.toHexString();
                    }
                    else {
                        color = "#000";
                    }

                    $("#luckysheet-alternateformat-colorSelect-dialog .currenColor span").css("background-color", color).attr("title", color);
                }
            });
        },
        rangeDialog: function(value){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-alternateformat-rangeDialog").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-alternateformat-rangeDialog", "addclass": "luckysheet-alternateformat-rangeDialog", "title": "选择应用范围", "content": '<input readonly="readonly" placeholder="请选择交替颜色应用范围" value="'+value+'"/>', "botton": '<button id="luckysheet-alternateformat-rangeDialog-confirm" class="btn btn-primary">确定</button><button id="luckysheet-alternateformat-rangeDialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-alternateformat-rangeDialog").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-alternateformat-rangeDialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        rangeIsExists: function(range, index){
            var isExists = false;
            var existsIndex = null;

            //获取已有交替颜色所有应用范围
            var AFarr = $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_alternateformat_save"]);

            if(index != undefined && index != null){
                if(AFarr.length > 1){
                    AFarr.splice(index, 1);
                }
                else{
                    AFarr = [];
                }
            }

            if(AFarr.length > 0){
                var arr = [];
                for(var i = 0; i < AFarr.length; i++){
                    var obj = {
                        "index": i,
                        "map": luckysheet.alternateformat.getRangeMap(AFarr[i]["cellrange"]["row"], AFarr[i]["cellrange"]["column"])
                    }

                    arr.push(obj);
                }
                
                //获取当前选区
                var rangeMap = luckysheet.alternateformat.getRangeMap(range["row"], range["column"]);
                
                //遍历
                for(x in rangeMap){
                    if(isExists){
                        break;
                    } 

                    for(var j = 0; j < arr.length; j++){
                        if(x in arr[j]["map"]){
                            isExists = true;
                            existsIndex = arr[j]["index"];
                            break;
                        }
                    }
                }
            }

            return [isExists, existsIndex];
        },
        getRangeMap: function(row, column){
            var map = {};
            var st_r = row[0], ed_r = row[1], st_c = column[0], ed_c = column[1];
            
            for(var r = st_r; r <= ed_r; r++){
                for(var c = st_c; c <= ed_c; c++){
                    map[r + "_" + c] = 0;
                }
            }
            
            return map;
        },
        getIndexByFormat: function(format){
            var index = null;

            //格式样式 模板
            var modelList = luckysheet.alternateformat.FixedModelColor;
            for(var i = 0; i < modelList.length; i++){
                var obj = modelList[i];

                if(format["head"].fc == obj["head"].fc && format["head"].bc == obj["head"].bc){
                    if(format["one"].fc == obj["one"].fc && format["one"].bc == obj["one"].bc){
                        if(format["two"].fc == obj["two"].fc && format["two"].bc == obj["two"].bc){
                            if(format["foot"].fc == obj["foot"].fc && format["foot"].bc == obj["foot"].bc){
                                index = i;
                                break;
                            }
                        }
                    }
                }
            }
            
            //自定义 模板
            var modelCustom = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_alternateformat_save_modelCustom"];
            if(modelCustom != null && modelCustom.length > 0){
                for(var j = 0; j < modelCustom.length; j++){
                    var obj = modelCustom[j];

                    if(format["head"].fc == obj["head"].fc && format["head"].bc == obj["head"].bc){
                        if(format["one"].fc == obj["one"].fc && format["one"].bc == obj["one"].bc){
                            if(format["two"].fc == obj["two"].fc && format["two"].bc == obj["two"].bc){
                                if(format["foot"].fc == obj["foot"].fc && format["foot"].bc == obj["foot"].bc){
                                    index = modelList.length + j;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
           
            return index;
        },
        getFormatByIndex: function(){
            var index = luckysheet.alternateformat.modelfocusIndex;
            var len = luckysheet.alternateformat.FixedModelColor.length;

            var format = {};

            if(index < len){
                format = luckysheet.alternateformat.FixedModelColor[index];
            }
            else{
                format = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_alternateformat_save_modelCustom"][index - len];
            }

            return format;
        },
        new: function(cellrange){
            var format = luckysheet.alternateformat.getFormatByIndex();

            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];
            var ruleArr = file["luckysheet_alternateformat_save"];
            
            if(ruleArr == null){
                ruleArr = [];
            }

            //保存之前的规则
            var historyRules = $.extend(true, [], ruleArr);
            
            //保存当前的规则
            var obj = {
                "cellrange": {
                    "row": cellrange["row"],
                    "column": cellrange["column"]
                },
                "format": format,
                "hasRowHeader": true,
                "hasRowFooter": false
            }

            ruleArr.push(obj);

            var currentRules = $.extend(true, [], ruleArr);
            
            //刷新一次表格
            luckysheet.alternateformat.ref(historyRules, currentRules);

            if(luckysheet.server.allowUpdate){
                luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_alternateformat_save" });
            }
        },
        update: function(){
            //获取标识
            var dataIndex = $("#luckysheet-alternateformat-remove").data("index");
            
            //应用范围
            var rangeValue = $("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-range input").val().trim();
            if(luckysheet.formula.iscelldata(rangeValue)){
                var cellrange = luckysheet.formula.getcellrange(rangeValue);
                var isExists = luckysheet.alternateformat.rangeIsExists(cellrange, dataIndex)[0];

                if(isExists){
                    if(luckysheet.isEditMode()){
                        alert("您选择的应用范围已存在交替颜色且不属于你要编辑的应用范围！");
                    }
                    else{
                        luckysheet.tooltip.info("您选择的应用范围已存在交替颜色且不属于你要编辑的应用范围！", ""); 
                    }

                    return;
                }
            }
            else{
                if(luckysheet.isEditMode()){
                    alert("您选择的应用范围不是选区！");
                }
                else{
                    luckysheet.tooltip.info("您选择的应用范围不是选区！", "");
                }

                return;
            }

            //页眉、页脚
            if($("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-rowHeader").is(":checked")){
                var hasRowHeader = true;
            }
            else{
                var hasRowHeader = false;    
            }

            if($("#luckysheet-modal-dialog-slider-alternateformat #luckysheet-alternateformat-rowFooter").is(":checked")){
                var hasRowFooter = true;
            }
            else{
                var hasRowFooter = false;    
            }

            //获取选中样式模板的颜色
            var format = luckysheet.alternateformat.getFormatByIndex();
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];
            
            var ruleArr = file["luckysheet_alternateformat_save"];
            if(ruleArr == null){
                ruleArr = [];
            }
            
            //保存之前的规则
            var historyRules = $.extend(true, [], ruleArr);
            
            //保存当前的规则
            var obj = {
                "cellrange": {
                    "row": cellrange["row"],
                    "column": cellrange["column"]
                },
                "format": format,
                "hasRowHeader": hasRowHeader,
                "hasRowFooter": hasRowFooter
            }
            
            ruleArr[dataIndex] = obj;

            var currentRules = $.extend(true, [], ruleArr);
            
            //刷新一次表格
            luckysheet.alternateformat.ref(historyRules, currentRules);

            if(luckysheet.server.allowUpdate){
                luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, ruleArr, { "k": "luckysheet_alternateformat_save" });
            }
        },
        checksAF: function(r, c, computeMap){
            if((r + "_" + c) in computeMap){
                //返回值（fc  bc）
                return computeMap[r + "_" + c];
            }
            else{
                return null;
            }
        },
        getComputeMap: function(){
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];
            var ruleArr = file["luckysheet_alternateformat_save"];

            var computeMap = luckysheet.alternateformat.compute(ruleArr);

            return computeMap;
        },
        compute: function(obj){
            //计算存储
            var computeMap = {};

            if(obj != null && obj.length > 0){
                for(var i = 0; i < obj.length; i++){
                    var cellrange = obj[i]["cellrange"];
                    var format = obj[i]["format"];
                    var hasRowHeader = obj[i]["hasRowHeader"];
                    var hasRowFooter = obj[i]["hasRowFooter"];
                    var st_r = cellrange["row"][0], 
                        ed_r = cellrange["row"][1], 
                        st_c = cellrange["column"][0], 
                        ed_c = cellrange["column"][1];
                    
                    if(hasRowHeader && hasRowFooter){
                        //页眉所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[st_r + "_" + c] = [format["head"].fc, format["head"].bc];
                        }

                        //中间行
                        if(ed_r - st_r > 1){
                            for(var r = st_r + 1; r < ed_r; r++){
                                if((r - st_r) % 2 != 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                } 
                            }
                        }

                        //页脚所在行
                        if(ed_r > st_r){
                            for(var c = st_c; c <= ed_c; c++){
                                computeMap[ed_r + "_" + c] = [format["foot"].fc, format["foot"].bc];
                            }
                        }
                    }
                    else if(hasRowHeader){
                        //页眉所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[st_r + "_" + c] = [format["head"].fc, format["head"].bc];
                        }

                        //中间行
                        if(ed_r > st_r){
                            for(var r = st_r + 1; r <= ed_r; r++){
                                if((r - st_r) % 2 != 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                } 
                            }
                        }
                    }
                    else if(hasRowFooter){
                        //中间行
                        if(ed_r > st_r){
                            for(var r = st_r; r < ed_r; r++){
                                if((r - st_r) % 2 == 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                }
                            }
                        }

                        //页脚所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[ed_r + "_" + c] = [format["foot"].fc, format["foot"].bc];
                        }
                    }
                    else{
                        //中间行
                        for(var r = st_r; r <= ed_r; r++){
                            if((r - st_r) % 2 == 0){
                                var fc = format["one"].fc;
                                var bc = format["one"].bc;
                            }
                            else{
                                var fc = format["two"].fc;
                                var bc = format["two"].bc;
                            }

                            for(var c = st_c; c <= ed_c; c++){
                                computeMap[r + "_" + c] = [fc, bc];
                            } 
                        }
                    }
                }
            }

            return computeMap;
        },
        ref: function(historyRules, currentRules){
            if (clearjfundo) {
                luckysheet.jfundo = [];

                var redo = {};
                redo["type"] = "updateAF";
                redo["sheetIndex"] = luckysheet.currentSheetIndex;
                redo["data"] = {"historyRules": historyRules, "currentRules": currentRules};
                luckysheet.jfredo.push(redo); 
            }

            var index = luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex);
            luckysheetfile[index]["luckysheet_alternateformat_save"] = currentRules;

            setTimeout(function () {
                luckysheet.luckysheetrefreshgrid();
            }, 1);
        }
    }

    //if公式生成器
    luckysheet.ifFormulaGenerator = {
        singleRangeFocus: false,
        init: function(){
            //点击选择单元格
            $(document).off("focus.IFcompareValue").on("focus.IFcompareValue","#luckysheet-ifFormulaGenerator-dialog #compareValue",function(){
                $("#luckysheet-modal-dialog-mask").hide();
                luckysheet.ifFormulaGenerator.singleRangeFocus = true;
            });
            $(document).off("click.IFsingRange").on("click.IFsingRange","#luckysheet-ifFormulaGenerator-dialog .singRange",function(){
                var value = $("#luckysheet-ifFormulaGenerator-dialog #compareValue").val().trim();
                if(luckysheet.formula.iscelldata(value)){
                    luckysheet.ifFormulaGenerator.singleRangeDialog(value);
                }
                else{
                    luckysheet.ifFormulaGenerator.singleRangeDialog();
                }
            });
            $(document).off("click.IFsingRangeConfirm").on("click.IFsingRangeConfirm","#luckysheet-ifFormulaGenerator-singleRange-confirm",function(){
                $("#luckysheet-formula-functionrange-select").hide();

                $("#luckysheet-ifFormulaGenerator-singleRange-dialog").hide();
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();

                var value = $(this).parents("#luckysheet-ifFormulaGenerator-singleRange-dialog").find("input").val().trim();
                $("#luckysheet-ifFormulaGenerator-dialog #compareValue").val(value);

                luckysheet.ifFormulaGenerator.singleRangeFocus = false;                 
            });
            $(document).off("click.IFsingRangeCancel").on("click.IFsingRangeCancel","#luckysheet-ifFormulaGenerator-singleRange-cancel",function(){
                $("#luckysheet-formula-functionrange-select").hide();

                $("#luckysheet-ifFormulaGenerator-singleRange-dialog").hide();
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();

                luckysheet.ifFormulaGenerator.singleRangeFocus = false;                 
            });
            $(document).off("click.IFsingRangeClose").on("click.IFsingRangeClose","#luckysheet-ifFormulaGenerator-singleRange-dialog .luckysheet-modal-dialog-title-close",function(){
                $("#luckysheet-formula-functionrange-select").hide();

                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();

                luckysheet.ifFormulaGenerator.singleRangeFocus = false;
            });
            //点击选择范围
            $(document).off("click.IFmultiRange").on("click.IFmultiRange","#luckysheet-ifFormulaGenerator-dialog .multiRange",function(){
                luckysheet.ifFormulaGenerator.multiRangeDialog();

                luckysheet.ifFormulaGenerator.singleRangeFocus = false;
            });
            $(document).off("click.IFmultiRangeConfirm").on("click.IFmultiRangeConfirm","#luckysheet-ifFormulaGenerator-multiRange-confirm",function(){
                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide();

                $("#luckysheet-ifFormulaGenerator-multiRange-dialog").hide();
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();

                var value = $(this).parents("#luckysheet-ifFormulaGenerator-multiRange-dialog").find("input").val().trim();
                var cellrange = luckysheet.formula.getcellrange(value);
                var str_r = cellrange["row"][0], end_r = cellrange["row"][1], str_c = cellrange["column"][0], end_c = cellrange["column"][1];
                var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);//取数据
                var arr = [];
                //获取范围内所有数值
                for(var r = str_r; r <= end_r; r++){
                    for(var c = str_c; c <= end_c; c++){
                        if(d[r] != null && d[r][c] != null && d[r][c]["ct"] != null && d[r][c]["ct"]["t"] == "n"){
                            arr.push(d[r][c]["v"]);
                        }
                    }
                }
                //从大到小排序
                for(var j = 0; j < arr.length; j++){
                    for(var k = 0; k < arr.length - 1 - j; k++){
                        if(arr[k]<arr[k+1]){
                            var temp=arr[k];
                            arr[k]=arr[k+1];
                            arr[k+1]=temp;
                        }
                    }
                }
                var largeNum = arr[0];
                var smallNum = arr[arr.length - 1];
                //赋值
                $("#luckysheet-ifFormulaGenerator-dialog #smallRange").val(smallNum);
                $("#luckysheet-ifFormulaGenerator-dialog #largeRange").val(largeNum);
            });
            $(document).off("click.IFmultiRangeCancel").on("click.IFmultiRangeCancel","#luckysheet-ifFormulaGenerator-multiRange-cancel",function(){
                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide();

                $("#luckysheet-ifFormulaGenerator-multiRange-dialog").hide();
                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();
            });
            $(document).off("click.IFmultiRangeClose").on("click.IFmultiRangeClose","#luckysheet-ifFormulaGenerator-multiRange-dialog .luckysheet-modal-dialog-title-close",function(){
                $("#luckysheet-formula-functionrange-select").hide();
                $("#luckysheet-row-count-show").hide();
                $("#luckysheet-column-count-show").hide();

                $("#luckysheet-modal-dialog-mask").show();
                $("#luckysheet-ifFormulaGenerator-dialog").show();
            });
            //选择 划分方式
            $(document).on("change","#DivisionMethod",function(){
                var value = $(this).find("option:selected").val();
                if(value == "2"){
                    $("#DivisionMethodVal").hide();
                }
                else{
                    $("#DivisionMethodVal").show();   
                }
                $("#luckysheet-ifFormulaGenerator-dialog .ifList").empty();
            });
            //点击 生成 按钮
            $(document).off("click.IFcreateBtn").on("click.IFcreateBtn","#luckysheet-ifFormulaGenerator-dialog #createBtn",function(){
                var compareValue = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find("#compareValue").val().trim();
                if(compareValue == ""){
                    luckysheet.ifFormulaGenerator.info("比较值不能为空！");
                    return;
                }
                var method = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find("#DivisionMethod option:selected").val();
                if(method == "2"){
                    var itemHtml =  '<div class="item">'+
                                        '<input type="number" class="smallNum formulaInputFocus"/>'+
                                        '<select class="operator">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1"> < </option>'+
                                        '</select>'+
                                        '<span class="compareValue">'+compareValue+'</span>'+
                                        '<select class="operator2">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1" selected="selected"> < </option>'+
                                        '</select>'+
                                        '<input type="number" class="largeNum formulaInputFocus"/>'+
                                        '<span>标签：</span>'+
                                        '<input type="text" class="markText formulaInputFocus" value="">'+
                                        '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                    '</div>';
                    $("#luckysheet-ifFormulaGenerator-dialog .ifList").append(itemHtml);                
                }
                else{
                    var smallRange = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find("#smallRange").val().trim();
                    var largeRange = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find("#largeRange").val().trim();
                    var DivisionMethodVal = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find("#DivisionMethodVal").val().trim();
                    if(smallRange == "" || largeRange == ""){
                        luckysheet.ifFormulaGenerator.info("范围不能为空！");
                        return;
                    }
                    else if(DivisionMethodVal == ""){
                        luckysheet.ifFormulaGenerator.info("划分值不能为空！");
                        return;
                    }
                    luckysheet.ifFormulaGenerator.getIfList(compareValue, smallRange, largeRange, method, DivisionMethodVal);
                }
            });
            //点击 删除条件
            $(document).on("click","#luckysheet-ifFormulaGenerator-dialog .item .fa-remove",function(){
                $(this).parents(".item").remove();
            });
            //点击 确认 按钮
            $(document).off("click.IFconfirmBtn").on("click.IFconfirmBtn","#luckysheet-ifFormulaGenerator-dialog-confirm",function(){
                var $item = $(this).parents("#luckysheet-ifFormulaGenerator-dialog").find(".ifList .item");
                var str = '';
                $($item.toArray().reverse()).each(function(i,e){
                    var smallNum = $(e).find(".smallNum").val().trim();
                    var largeNum = $(e).find(".largeNum").val().trim();
                    var operator = $(e).find(".operator option:selected").val();
                    var operator2 = $(e).find(".operator2 option:selected").val();
                    var compareValue = $(e).find(".compareValue").text();
                    var markText = $(e).find(".markText").val().trim();
                    if(markText == ""){
                        markText = "标签" + (i + 1);
                    }
                    if(smallNum == "" && largeNum == ""){
                        return true;
                    }

                    if(operator == "0"){
                        var s = compareValue + ">=" + smallNum;
                    }
                    else{
                        var s = compareValue + ">" + smallNum;
                    }

                    if(operator2 == "0"){
                        var l = compareValue + "<=" + largeNum;
                    }
                    else{
                        var l = compareValue + "<" + largeNum;
                    }

                    if(i == 0 && largeNum == ""){
                        var a = s;
                    }
                    else if(i == ($item.length - 1) && smallNum == ""){
                        var a = l;
                    }
                    else{
                        var a = "and("+s+","+l+")";
                    }

                    if(i == 0){
                        str = 'if('+a+',"'+markText+'")';
                    }
                    else{
                        str = 'if('+a+',"'+markText+'",'+str+')';
                    }
                })
                //
                if(str.length == 0){
                    luckysheet.ifFormulaGenerator.info("没有生成可用的条件！");
                    return;
                }
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-ifFormulaGenerator-dialog").hide();

                var last = luckysheet_select_save[luckysheet_select_save.length - 1];

                var row_index = last["row_focus"], col_index = last["column_focus"];
                var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];
                
                luckysheet.luckysheetupdateCell(row, row_pre, row_index, col, col_pre, col_index, luckysheet.flowdata);

                $("#luckysheet-rich-text-editor").html("=" + str);
                $("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html());

                $("#luckysheet-wa-functionbox-confirm").click();
                // var fp = $.trim(luckysheet.formula.functionParser(str));
                // var result = eval(fp);
            });
            //info
            $(document).on("click","#luckysheet-ifFormulaGenerator-info .luckysheet-model-close-btn",function(){
                $("#luckysheet-modal-dialog-mask").show();
            });
            $(document).on("click","#luckysheet-ifFormulaGenerator-info .luckysheet-modal-dialog-title-close",function(){
                $("#luckysheet-modal-dialog-mask").show();
            });
        },
        ifFormulaDialog: function(fp){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-ifFormulaGenerator-dialog").remove();

            var compareValue = "";
            var ifListHtml = '';
            if(!!fp){
                var arr = fp.split("if(");
                for(var i = 1; i < arr.length; i++){
                    var txt = arr[i].replace("and(","").replace(/\)/g,"").replace(/\"/g,"");
                    var arr2 = txt.split(",");
                    arr2 = luckysheet.ifFormulaGenerator.clearArr(arr2);
                    
                    compareValue = luckysheet.ifFormulaGenerator.splitTxt(arr2[0])[0];
                    if(arr2.length == 3){
                        var smallNum = luckysheet.ifFormulaGenerator.splitTxt(arr2[0])[1];
                        var largeNum = luckysheet.ifFormulaGenerator.splitTxt(arr2[1])[2];
                        var markText = arr2[2];
                    }
                    else{
                        var smallNum = luckysheet.ifFormulaGenerator.splitTxt(arr2[0])[1];
                        var largeNum = luckysheet.ifFormulaGenerator.splitTxt(arr2[0])[2];
                        var markText = arr2[1];
                    }

                    var itemHtml =  '<div class="item">'+
                                        '<input type="number" class="smallNum formulaInputFocus" value="'+smallNum+'"/>'+
                                        '<select class="operator">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1"> < </option>'+
                                        '</select>'+
                                        '<span class="compareValue">'+compareValue+'</span>'+
                                        '<select class="operator2">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1" selected="selected"> < </option>'+
                                        '</select>'+
                                        '<input type="number" class="largeNum formulaInputFocus" value="'+largeNum+'"/>'+
                                        '<span>标签：</span>'+
                                        '<input type="text" class="markText formulaInputFocus" value="'+markText+'">'+
                                        '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                    '</div>'; 
                    ifListHtml += itemHtml;                             
                }
            }
            var content = '<div class="ifAttr">'+
                            '<div class="attrBox">'+
                                '<label for="compareValue"> 比较值 </label>'+
                                '<div class="inpBox">'+
                                    '<input id="compareValue" class="formulaInputFocus" value="'+compareValue+'"/>'+
                                    '<i class="singRange fa fa-table" aria-hidden="true" title="点击选择单元格"></i>'+
                                '</div>'+
                            '</div>'+
                            '<div class="attrBox">'+
                                '<label for="smallRange"> 范围 </label>'+
                                '<input type="number" id="smallRange" class="formulaInputFocus"/>'+
                                '<span class="text"> 至 </span>'+
                                '<input type="number" id="largeRange" class="formulaInputFocus"/>'+
                                '<div id="rangeAssess">'+
                                    '<span> 范围评估 </span>'+
                                    '<i class="multiRange fa fa-table" aria-hidden="true" title="点击选择范围"></i>'+
                                '</div>'+
                            '</div>'+
                            '<div class="attrBox">'+
                                '<label for="DivisionMethod"> 划分方式 </label>'+
                                '<select id="DivisionMethod">'+
                                    '<option value="0"> 划分值相同 </option>'+
                                    '<option value="1"> 划分为N份 </option>'+
                                    '<option value="2"> 自定义输入 </option>'+
                                '</select>'+
                                '<input id="DivisionMethodVal" class="formulaInputFocus"/>'+
                                '<div id="createBtn"> 生成 </div>'+
                            '</div>'+
                          '</div>'+
                          '<div class="ifList">'+ifListHtml+'</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-ifFormulaGenerator-dialog", "addclass": "luckysheet-ifFormulaGenerator-dialog", "title": "if公式生成器", "content": content, "botton": '<button id="luckysheet-ifFormulaGenerator-dialog-confirm" class="btn btn-primary">确认</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-ifFormulaGenerator-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 590).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-ifFormulaGenerator-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        clearArr: function(arr){
            for(var i = 0; i < arr.length; i++){
                if(arr[i] == "" || arr[i] == null || arr[i] == undefined){
                    arr.splice(i, 1);
                }
            }

            return arr;
        },
        splitTxt: function(txt){
            var compareValue, smallNum, largeNum;
            
            if(txt.indexOf(">=") != -1){
                compareValue = txt.split(">=")[0];
                smallNum = txt.split(">=")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf(">") != -1){
                compareValue = txt.split(">")[0];
                smallNum = txt.split(">")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf("<=") != -1){
                compareValue = txt.split("<=")[0];
                largeNum = txt.split("<=")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf("<") != -1){
                compareValue = txt.split("<")[0];
                largeNum = txt.split("<")[1];

                return [compareValue, smallNum, largeNum];
            }
        },
        singleRangeDialog: function(value){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-ifFormulaGenerator-dialog").hide();
            $("#luckysheet-ifFormulaGenerator-singleRange-dialog").remove();
            if(value != undefined && value != null){
                var val = value;
            }
            else{
                var val = "";
            }

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-ifFormulaGenerator-singleRange-dialog", "addclass": "luckysheet-ifFormulaGenerator-singleRange-dialog", "title": "选择单元格", "content": '<input readonly="readonly" placeholder="请选择单元格" value="'+val+'">', "botton": '<button id="luckysheet-ifFormulaGenerator-singleRange-confirm" class="btn btn-primary">确认</button><button id="luckysheet-ifFormulaGenerator-singleRange-cancel" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-ifFormulaGenerator-singleRange-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-ifFormulaGenerator-singleRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        multiRangeDialog: function(){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-ifFormulaGenerator-dialog").hide();
            $("#luckysheet-ifFormulaGenerator-multiRange-dialog").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-ifFormulaGenerator-multiRange-dialog", "addclass": "luckysheet-ifFormulaGenerator-multiRange-dialog", "title": "选择范围", "content": '<input readonly="readonly" placeholder="请选择范围" value="">', "botton": '<button id="luckysheet-ifFormulaGenerator-multiRange-confirm" class="btn btn-primary">确认</button><button id="luckysheet-ifFormulaGenerator-multiRange-cancel" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-ifFormulaGenerator-multiRange-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-ifFormulaGenerator-multiRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        getIfList: function(compareValue, smallRange, largeRange, method, methodVal){
            $("#luckysheet-ifFormulaGenerator-dialog .ifList").empty();

            var smallRange = parseInt(smallRange);
            var largeRange = parseInt(largeRange);
            var methodVal = parseInt(methodVal);

            var arr = [];
            if(method == "0"){
                var len = Math.ceil((largeRange - smallRange) / methodVal); 
                for(var i = 0; i <= len; i++){
                    var num = smallRange + methodVal * i;
                    if(i == 0 || num >= largeRange){
                        arr.push("");
                    }
                    else{
                        arr.push(num);
                    }
                }
                
            }
            else if(method == "1"){
                var addnum = Math.ceil((largeRange - smallRange) / methodVal);
                for(var i = 0; i <= methodVal; i++){
                    var num = smallRange + addnum * i;
                    if(i == 0 || num >= largeRange){
                        arr.push("");
                    }
                    else{
                        arr.push(num);
                    }
                }
            }
            for(var j = 0; j < arr.length - 1; j++){
                if(j == 0){
                    var markText = "小于" + arr[j + 1];
                }
                else if(j == arr.length - 2){
                    var markText = "大于等于" + arr[j];
                }
                else{
                    var markText = arr[j] + "到" + arr[j + 1];
                }
                var itemHtml =  '<div class="item">'+
                                    '<input type="number" class="smallNum formulaInputFocus" value="'+arr[j]+'"/>'+
                                    '<select class="operator">'+
                                        '<option value="0"> <= </option>'+
                                        '<option value="1"> < </option>'+
                                    '</select>'+
                                    '<span class="compareValue">'+compareValue+'</span>'+
                                    '<select class="operator2">'+
                                        '<option value="0"> <= </option>'+
                                        '<option value="1" selected="selected"> < </option>'+
                                    '</select>'+
                                    '<input type="number" class="largeNum formulaInputFocus" value="'+arr[j + 1]+'"/>'+
                                    '<span>标签：</span>'+
                                    '<input type="text" class="markText formulaInputFocus" value="'+markText+'">'+
                                    '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                '</div>';
                $("#luckysheet-ifFormulaGenerator-dialog .ifList").append(itemHtml);
            }
        },
        info: function(title){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-ifFormulaGenerator-info").remove();
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-ifFormulaGenerator-info", "addclass": "", "title": title, "content": "", "botton": '<button class="btn btn-default luckysheet-model-close-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-ifFormulaGenerator-info").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-ifFormulaGenerator-info").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        }
    }

    //插入函数
    luckysheet.insertFormula = {
        init: function(){
            $(document).off("keyup.fxSFLI").on("keyup.fxSFLI", "#searchFormulaListInput", function(){
                $("#formulaTypeList").empty();
                var txt = $(this).val().toUpperCase();

                if(txt == ""){
                    //若没有查找内容则根据类别筛选
                    luckysheet.insertFormula.formulaListByType($("#formulaTypeSelect option:selected").val());
                }
                else{
                    for(var i = 0; i < luckysheet.functionlist.length; i++){
                        if(/^[a-zA-Z]+$/.test(txt)){
                            if(luckysheet.functionlist[i].n.indexOf(txt) != "-1"){
                                $('<div class="listBox" name="'+ luckysheet.functionlist[i].n +'"><span>'+ luckysheet.functionlist[i].n +'</span><span>'+ luckysheet.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                            }
                        }
                        else if(luckysheet.functionlist[i].a.indexOf(txt) != "-1"){
                            $('<div class="listBox" name="'+ luckysheet.functionlist[i].n +'"><span>'+ luckysheet.functionlist[i].n +'</span><span>'+ luckysheet.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                        }
                    }
                }
                
                $("#formulaTypeList .listBox:first-child").addClass("on"); //默认公式列表第一个为选中状态
            });

            $(document).off("change.fxFormulaTS").on("change.fxFormulaTS", "#formulaTypeSelect", function(){
                var type = $("#formulaTypeSelect option:selected").val();
                luckysheet.insertFormula.formulaListByType(type);
            });

            $(document).off("click.fxListbox").on("click.fxListbox", "#formulaTypeList .listBox", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            //选择公式后弹出参数栏弹框
            $(document).off("click.fxFormulaCf").on("click.fxFormulaCf", "#luckysheet-search-formula-confirm", function(){
                var formula = $("#luckysheet-search-formula .listBox.on").attr("name");
                var formulaTxt = '<span dir="auto" class="luckysheet-formula-text-color">=</span><span dir="auto" class="luckysheet-formula-text-color">'+ formula.toUpperCase() +'</span><span dir="auto" class="luckysheet-formula-text-color">(</span><span dir="auto" class="luckysheet-formula-text-color">)</span>';
                $("#luckysheet-rich-text-editor").html(formulaTxt);
                $("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html());

                luckysheet.insertFormula.formulaParmDialog(formula);
            });

            //公式参数框
            $(document).off("focus.fxParamInput").on("focus.fxParamInput", "#luckysheet-search-formula-parm .parmBox input", function(){
                var parmIndex = $(this).parents(".parmBox").index();
                luckysheet.formula.data_parm_index = parmIndex;

                var formulatxt = $(this).parents("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-title-text").text();
                
                var parmLen = window.luckysheet_function[formulatxt].p.length;
                if(parmIndex >= parmLen){
                    var parmDetail = window.luckysheet_function[formulatxt].p[parmLen - 1].detail;
                    var parmRepeat = window.luckysheet_function[formulatxt].p[parmLen - 1].repeat;
                }
                else{
                    var parmDetail = window.luckysheet_function[formulatxt].p[parmIndex].detail;
                    var parmRepeat = window.luckysheet_function[formulatxt].p[parmIndex].repeat;
                }

                //参数选区显示，参数值显示
                luckysheet.insertFormula.parmTxtShow($(this).val());
                
                //计算结果
                luckysheet.insertFormula.functionStrCompute();
                
                //参数名称和释义切换
                $("#luckysheet-search-formula-parm .parmDetailsBox").empty();

                var parmName = $(this).parents(".parmBox").find(".name").text();
                $('<span>'+ parmName +':</span><span>'+ parmDetail +'</span>').appendTo($("#luckysheet-search-formula-parm .parmDetailsBox"));
                
                //公式参数可自增（参数自增最多5个）
                if(parmRepeat == "y"){
                    var parmCount = $("#luckysheet-search-formula-parm .parmBox").length;

                    if(parmCount < 5 && parmIndex == (parmCount - 1)){
                        $('<div class="parmBox"><div class="name">值'+ (parmCount + 1) +'</div><div class="txt"><input class="formulaInputFocus" /><i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i></div><div class="val">=</div></div>').appendTo($("#luckysheet-search-formula-parm .parmListBox"));
                    }
                }
            });

            $(document).off("blur.fxParamInput").on("blur.fxParamInput", "#luckysheet-search-formula-parm .parmBox input", function(){
                var txt = $(this).val();

                if(luckysheet.formula.getfunctionParam(txt).fn == null && !luckysheet.formula.iscelldata(txt)){
                    if(!luckysheet.func_methods.isRealNum(txt) && txt != "" && txt.length <= 2 && txt.indexOf('"') != 0 && txt.lastIndexOf('"') != 0){
                        txt = '"' + txt + '"';
                        $(this).val(txt);

                        luckysheet.insertFormula.parmTxtShow(txt);
                        luckysheet.insertFormula.functionStrCompute();
                    }
                }
            });
            
            $(document).off("keyup.fxParamInput").on("keyup.fxParamInput", "#luckysheet-search-formula-parm .parmBox input", function(){
                //参数选区显示，参数值显示
                luckysheet.insertFormula.parmTxtShow($(this).val());

                //计算结果
                luckysheet.insertFormula.functionStrCompute();
            });

            //点击图标选取数据范围
            $(document).off("click.fxParamI").on("click.fxParamI", "#luckysheet-search-formula-parm .parmBox i", function(){
                luckysheet.formula.data_parm_index = $(this).parents(".parmBox").index();
                
                //选取范围弹出框
                $("#luckysheet-search-formula-parm").hide();
                $("#luckysheet-modal-dialog-mask").hide();

                $("#luckysheet-search-formula-parm-select").remove();
                
                if($(this).parents(".parmBox").find(".txt input").val() == ""){
                    $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-search-formula-parm-select", "addclass": "luckysheet-search-formula-parm-select", "title": "选取数据范围", "content": "<input id='luckysheet-search-formula-parm-select-input' class='luckysheet-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='数据范围' readonly='true' placeholder='数据范围'>", "botton": '<button id="luckysheet-search-formula-parm-select-confirm" class="btn btn-primary">确认</button>', "style": "z-index:100003" }));
                }
                else{
                    $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-search-formula-parm-select", "addclass": "luckysheet-search-formula-parm-select", "title": "选取数据范围", "content": "<input id='luckysheet-search-formula-parm-select-input' class='luckysheet-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='数据范围' readonly='true' value='"+ $(this).parents(".parmBox").find(".txt input").val() +"'>", "botton": '<button id="luckysheet-search-formula-parm-select-confirm" class="btn btn-primary">确认</button>', "style": "z-index:100003" }));
                }

                var $t = $("#luckysheet-search-formula-parm-select").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
                var winw = $(window).width(), winh = $(window).height();
                var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
                $("#luckysheet-search-formula-parm-select").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
                
                //参数选区虚线框
                luckysheet.insertFormula.parmTxtShow($(this).parents(".parmBox").find(".txt input").val());
            });

            //点击确定
            $(document).off("click.fxParamCf").on("click.fxParamCf", "#luckysheet-search-formula-parm-confirm", function(){
                $("#luckysheet-wa-functionbox-confirm").click();
            });

            //选取范围后传回参数栏弹框
            $(document).off("click.fxParamSelectCf").on("click.fxParamSelectCf", "#luckysheet-search-formula-parm-select-confirm", function(){
                var parmIndex = $("#luckysheet-search-formula-parm-select-input").attr("data_parm_index");

                $("#luckysheet-search-formula-parm-select").hide();
                $("#luckysheet-search-formula-parm").show();
                $("#luckysheet-search-formula-parm .parmBox").eq(parmIndex).find(".txt input").focus();
            });
        },
        formulaListDialog: function(){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-search-formula").remove();

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-search-formula", "addclass": "luckysheet-search-formula", "title": "", "content": "<div class='inpbox'><label for='searchFormulaListInput'>查找函数：</label><input class='formulaInputFocus' id='searchFormulaListInput' placeholder='请输入您要查找的函数名称或函数功能的简要描述' spellcheck='false'/></div><div class='selbox'><label>或选择类别：</label><select id='formulaTypeSelect'><option value='0'>数学</option><option value='1'>统计</option><option value='2'>查找</option><option value='3'>Luckysheet内置</option><option value='4'>数据挖掘</option><option value='5'>数据源</option><option value='6'>日期</option><option value='7'>过滤器</option><option value='8'>财务</option><option value='9'>工程计算</option><option value='10'>逻辑</option><option value='11'>运算符</option><option value='12'>文本</option><option value='13'>转换工具</option><option value='14'>数组</option><option value='-1'>其它</option></select></div><div class='listbox'><label>选择函数：</label><div id='formulaTypeList'></div></div>", "botton": '<button id="luckysheet-search-formula-confirm" class="btn btn-primary">确认</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-search-formula").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-search-formula").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3, "user-select": "none" }).show();
            
            luckysheet.insertFormula.formulaListByType("0"); //默认公式列表为类型0
            $("#searchFormulaListInput").focus();
        },
        formulaListByType: function(type){
            $("#formulaTypeList").empty();
                        
            for(var i = 0; i < luckysheet.functionlist.length; i++){
                if((type == "-1" && luckysheet.functionlist[i].t > 14) || luckysheet.functionlist[i].t == type){
                    $('<div class="listBox" name="'+ luckysheet.functionlist[i].n +'"><span>'+ luckysheet.functionlist[i].n +'</span><span>'+ luckysheet.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                }
            }

            $("#formulaTypeList .listBox:first-child").addClass("on"); //默认公式列表第一个为选中状态
        },
        formulaParmDialog: function(formula, parm){ //参数弹出框
            var parm_title = '',
                parm_content = '',
                parm_list_content = '';

            for(var i = 0; i < luckysheet.functionlist.length; i++){
                if(luckysheet.functionlist[i].n == formula.toUpperCase()){
                    parm_title = luckysheet.functionlist[i].n;

                    for(var j = 0; j < luckysheet.functionlist[i].p.length; j++){
                        if(parm == null){
                            //无参数
                            parm_list_content += '<div class="parmBox">'+
                                                    '<div class="name">'+ luckysheet.functionlist[i].p[j].name +'</div>'+
                                                    '<div class="txt">'+
                                                        '<input class="formulaInputFocus" spellcheck="false"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>'+
                                                    '</div>'+
                                                    '<div class="val">=</div>'+
                                                 '</div>';
                        }
                        else{
                            //有参数
                            if(parm[j] == null){
                                parm[j] = "";
                            }

                            parm_list_content += '<div class="parmBox">'+
                                                    '<div class="name">'+ luckysheet.functionlist[i].p[j].name +'</div>'+
                                                    '<div class="txt">'+
                                                        '<input class="formulaInputFocus" value="'+ parm[j] +'" spellcheck="false"/>'+
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>'+
                                                    '</div>'+
                                                    '<div class="val">=</div>'+
                                                 '</div>';
                        }
                    }

                    parm_content =  '<div>'+
                                        '<div class="parmListBox">'+ parm_list_content +'</div>'+
                                        '<div class="formulaDetails">'+ luckysheet.functionlist[i].d +'</div>'+
                                        '<div class="parmDetailsBox"></div>'+
                                        '<div class="result">计算结果 = <span></span></div>'+
                                    '</div>';
                }
            }

            $("#luckysheet-search-formula").hide();
            $("#luckysheet-modal-dialog-mask").hide();
            
            $("#luckysheet-search-formula-parm").remove();
            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-search-formula-parm", "addclass": "luckysheet-search-formula-parm", "title": parm_title, "content": parm_content, "botton": '<button id="luckysheet-search-formula-parm-confirm" class="btn btn-primary">确认</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-search-formula-parm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //参数栏第一个参数聚焦，显示选取虚线框
            $("#luckysheet-search-formula-parm .parmBox:eq(0) input").focus();

            //遍历参数，有参数显示值，无显示空
            $("#luckysheet-search-formula-parm .parmBox").each(function(index,e){
                var parmtxt = $(e).find(".txt input").val();
                
                if(luckysheet.formula.getfunctionParam(parmtxt).fn == null){ //参数不是公式
                    if(luckysheet.formula.iscelldata(parmtxt)){ //参数是选区
                        var txtdata = window.luckysheet_getcelldata(parmtxt).data;

                        if(luckysheet.getObjType(txtdata) == "array"){ //参数为多个单元格选区
                            var txtArr = [];
                            
                            for(var i = 0; i < txtdata.length; i++){
                                for(var j = 0; j < txtdata[i].length; j++){
                                    var cell = txtdata[i][j];

                                    if(cell == null || luckysheet.func_methods.isRealNull(cell.v)){
                                        txtArr.push(null);
                                    }
                                    else{
                                        txtArr.push(cell.v);
                                    }
                                }
                            }

                            $("#luckysheet-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ txtArr.join(",") +"}");
                        }
                        else{ //参数为单个单元格选区
                            $("#luckysheet-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ txtdata.v +"}");
                        }
                    }
                    else{ //参数不是选区
                        $("#luckysheet-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ parmtxt +"}");
                    }
                }
                else{ //参数是公式
                    $("#luckysheet-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ eval($.trim(luckysheet.formula.functionParser("=" + parmtxt))) +"}");
                }
            })

            $("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove();                        
            luckysheet.formula.data_parm_index = 0;
            luckysheet.formula.rangestart = true;
        },
        parmTxtShow: function(parmtxt){
            if(luckysheet.formula.getfunctionParam(parmtxt).fn == null){ //参数不是公式
                if(luckysheet.formula.iscelldata(parmtxt)){ //参数是选区
                    var cellrange = luckysheet.formula.getcellrange(parmtxt);
                    var r1 = cellrange.row[0], r2 = cellrange.row[1], c1 = cellrange.column[0], c2 = cellrange.column[1];
                    var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                    var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                    $("#luckysheet-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                    $("#luckysheet-formula-help-c").hide();
                    luckysheet.luckysheet_count_show(col_pre, row_pre, col - col_pre - 1, row - row_pre - 1, cellrange.row, cellrange.column);

                    var txtdata = window.luckysheet_getcelldata(parmtxt).data;
                    if(luckysheet.getObjType(txtdata) == "array"){ //参数为多个单元格选区
                        var txtArr = [];
                        
                        for(var i = 0; i < txtdata.length; i++){
                            for(var j = 0; j < txtdata[i].length; j++){
                                var cell = txtdata[i][j];

                                if(cell == null || luckysheet.func_methods.isRealNull(cell.v)){
                                    txtArr.push(null);
                                }
                                else{
                                    txtArr.push(cell.v);
                                }
                            }
                        }

                        $("#luckysheet-search-formula-parm .parmBox").eq(luckysheet.formula.data_parm_index).find(".val").text(" = {"+ txtArr.join(",") +"}");
                    }
                    else{ //参数为单个单元格选区
                        $("#luckysheet-search-formula-parm .parmBox").eq(luckysheet.formula.data_parm_index).find(".val").text(" = {"+ txtdata.v +"}");
                    }
                }
                else{ //参数不是选区
                    $("#luckysheet-search-formula-parm .parmBox").eq(luckysheet.formula.data_parm_index).find(".val").text(" = {"+ parmtxt +"}");

                    $("#luckysheet-formula-functionrange-select").hide();
                }
            }
            else{   
                //参数是公式
                var txt;
                for(var k = 0; k < luckysheet.formula.getfunctionParam(parmtxt).param.length; k++){
                    if(luckysheet.formula.iscelldata(luckysheet.formula.getfunctionParam(parmtxt).param[k])){
                        txt = luckysheet.formula.getfunctionParam(parmtxt).param[k];
                        break;
                    }
                }

                var cellrange = luckysheet.formula.getcellrange(txt);
                var r1 = cellrange.row[0], r2 = cellrange.row[1], c1 = cellrange.column[0], c2 = cellrange.column[1];
                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                $("#luckysheet-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                // $("#luckysheet-cols-h-selected").css({ "left": col_pre, "width": col - col_pre - 1, "display": "block", "background-color": "rgba(76, 76, 76, 0.1)" });
                // $("#luckysheet-rows-h-selected").css({ "top": row_pre, "height": row - row_pre - 1, "display": "block", "background-color": "rgba(76, 76, 76, 0.1)" });
                $("#luckysheet-formula-help-c").hide();
                luckysheet.luckysheet_count_show(col_pre, row_pre, col - col_pre - 1, row - row_pre - 1, cellrange.row, cellrange.column);

                $("#luckysheet-search-formula-parm .parmBox").eq(luckysheet.formula.data_parm_index).find(".val").text(" = {"+ eval($.trim(luckysheet.formula.functionParser("=" + parmtxt))) +"}");
            }
        },
        functionStrCompute: function(){
            var isVal = true; //参数不为空
            var parmValArr = []; //参数值集合
            var lvi = -1; //最后一个有值的参数索引

            var formulatxt = $("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-title-text").text();
            
            $("#luckysheet-search-formula-parm .parmBox").each(function(i, e){
                var parmtxt = $(e).find(".txt input").val();
                var parmRequire = window.luckysheet_function[formulatxt].p[i].require;

                if(parmtxt == "" && parmRequire == "m"){
                    isVal = false;
                }

                if(parmtxt != ""){
                    lvi = i;
                }
            });

            //单元格显示
            if(lvi == -1){
                var functionHtmlTxt = "=" + $("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text() + "()"; 
            }
            else if(lvi == 0){
                var functionHtmlTxt = "=" + $("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text() + "(" + $("#luckysheet-search-formula-parm .parmBox").eq(0).find(".txt input").val() + ")"; 
            }
            else{
                for(var j = 0; j <= lvi; j++){
                    parmValArr.push($("#luckysheet-search-formula-parm .parmBox").eq(j).find(".txt input").val());
                }

                var functionHtmlTxt = "=" + $("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text() + "(" + parmValArr.join(",") + ")";    
            }

            var function_str = luckysheet.formula.functionHTMLGenerate(functionHtmlTxt);
            $("#luckysheet-rich-text-editor").html(function_str);
            $("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html());
            
            if(isVal){ //公式计算
                var fp = $.trim(luckysheet.formula.functionParser($("#luckysheet-rich-text-editor").text()));
                
                var result = null;

                try {
                    result = eval(fp);
                } 
                catch (e) {
                    result = luckysheet.formula.error.n;
                }

                $("#luckysheet-search-formula-parm .result span").text(result);
            }
        }
    }

    //选区下拉
    luckysheet.dropCell = {
        iconHtml: '<div id="luckysheet-dropCell-icon" style="position: absolute;padding: 2px;background-color: #f1f1f1;z-index: 990;cursor: pointer;">'+
                    '<div id="icon_dropCell"></div>'+
                  '</div>',
        typeListHtml: '<div id="luckysheet-dropCell-typeList" class="luckysheet-cols-menu luckysheet-rightgclick-menu luckysheet-mousedown-cancel">'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="0">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>复制单元格'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="1">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>填充序列'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="2">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>仅填充格式'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="3">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>不带格式填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="4">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>以天数填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="5">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>以工作日填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="6">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>以月填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="7">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>以年填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="luckysheet-cols-menuitem luckysheet-mousedown-cancel" data-type="8">'+
                            '<div class="luckysheet-cols-menuitem-content luckysheet-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon luckysheet-mousedown-cancel"></span>以中文小写数字填充'+
                            '</div>'+
                        '</div>'+
                      '</div>',
        copyRange: {}, //复制范围
        applyRange: {}, //应用范围
        applyType: null, //0复制单元格，1填充序列，2仅填充格式，3不带格式填充，4以天数填充，5以工作日填充，6以月填充，7以年填充，8以中文小写数字序列填充
        direction: null, //down-往下拖拽，right-往右拖拽，up-往上拖拽，left-往左拖拽
        chnNumChar: {"零": 0, "一": 1, "二": 2, "三": 3, "四": 4, "五": 5, "六": 6, "七": 7, "八": 8, "九": 9},
        chnNameValue: {"十": {value: 10, secUnit: false}, "百": {value: 100, secUnit: false}, "千": {value: 1000, secUnit: false}, "万": {value: 10000, secUnit: true}, "亿": {value: 100000000, secUnit: true}},
        ChineseToNumber: function(chnStr){
            var rtn = 0;
            var section = 0;
            var number = 0;
            var secUnit = false;
            var str = chnStr.split("");

            for(var i = 0; i < str.length; i++){
                var num = luckysheet.dropCell.chnNumChar[str[i]];
                if(typeof num != "undefined"){
                    number = num;
                    if(i == str.length - 1){
                        section += number;
                    }
                }
                else{
                    var unit = luckysheet.dropCell.chnNameValue[str[i]].value;
                    secUnit = luckysheet.dropCell.chnNameValue[str[i]].secUnit;
                    if(secUnit){
                        section = (section + number) * unit;
                        rtn += section;
                        section = 0;
                    }
                    else{
                        section += (number * unit);
                    }
                    number = 0;
                }
            }

            return rtn + section;
        },
        chnNumChar2: ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"],
        chnUnitSection: ["", "万", "亿", "万亿", "亿亿"],
        chnUnitChar: ["", "十", "百", "千"],
        SectionToChinese: function(section){
            var strIns = '', chnStr = '';
            var unitPos = 0;
            var zero = true;

            while(section > 0){
                var v = section % 10;
                if(v == 0){
                    if(!zero){
                        zero = true;
                        chnStr = luckysheet.dropCell.chnNumChar2[v] + chnStr;
                    }
                }
                else{
                    zero = false;
                    strIns = luckysheet.dropCell.chnNumChar2[v];
                    strIns += luckysheet.dropCell.chnUnitChar[unitPos];
                    chnStr = strIns + chnStr;
                }
                unitPos++;
                section = Math.floor(section / 10);
            }

            return chnStr;
        },
        NumberToChinese: function(num){
            var unitPos = 0;
            var strIns = '', chnStr = '';
            var needZero = false;

            if(num == 0){
                return luckysheet.dropCell.chnNumChar2[0];
            }
            while(num > 0){
                var section = num % 10000;
                if(needZero){
                    chnStr = luckysheet.dropCell.chnNumChar2[0] + chnStr;
                }
                strIns = luckysheet.dropCell.SectionToChinese(section);
                strIns += (section != 0) ? luckysheet.dropCell.chnUnitSection[unitPos] : luckysheet.dropCell.chnUnitSection[0];
                chnStr = strIns + chnStr;
                needZero = (section < 1000) && (section > 0);
                num = Math.floor(num / 10000);
                unitPos++;
            }

            return chnStr;
        },
        isChnNumber: function(txt){
            var isChnNumber = true;

            if(txt.length == 1){
                if(txt == "日" || (txt in luckysheet.dropCell.chnNumChar)){
                    isChnNumber = true;
                }
                else{
                    isChnNumber = false;
                }
            }
            else{
                var str = txt.split("");
                for(var i = 0; i < str.length; i++){
                    if(!((str[i] in luckysheet.dropCell.chnNumChar) || (str[i] in luckysheet.dropCell.chnNameValue))){
                        isChnNumber = false;
                        break;
                    }
                }
            }

            return isChnNumber;
        },
        isExtendNumber: function(txt){
            var reg = /[0-9]/;
            if(reg.test(txt.substr(txt.length - 1, 1))){
                var isExtendNumber = true;
            }
            else{
                var isExtendNumber = false;
            }

            if(isExtendNumber){
                var str = txt.split("");
                str.reverse();
                
                var len = 0;
                for(var i = 0; i < str.length; i++){
                    if(!reg.test(str[i])){
                        len = i;
                        break;
                    }
                }

                return [isExtendNumber, txt.substr(0, txt.length - len), txt.substr(txt.length - len, len)];    
            }
            else{
                return [isExtendNumber];
            }
        },
        isChnWeek1: function(txt){
            if(txt.length == 1){
                if(txt == "日" || luckysheet.dropCell.ChineseToNumber(txt) < 7){
                    var isChnWeek1 = true;
                }
                else{
                    var isChnWeek1 = false;    
                }
            }
            else{
                var isChnWeek1 = false;
            }

            return isChnWeek1;
        },
        isChnWeek2: function(txt){
            if(txt.length == 2){
                if(txt == "周一" || txt == "周二" || txt == "周三" || txt == "周四" || txt == "周五" || txt == "周六" || txt == "周日"){
                    var isChnWeek2 = true;
                }
                else{
                    var isChnWeek2 = false;
                }
            }
            else{
                var isChnWeek2 = false;
            }

            return isChnWeek2;
        },
        isChnWeek3: function(txt){
            if(txt.length == 3){
                if(txt == "星期一" || txt == "星期二" || txt == "星期三" || txt == "星期四" || txt == "星期五" || txt == "星期六" || txt == "星期日"){
                    var isChnWeek3 = true;
                }
                else{
                    var isChnWeek3 = false;
                }
            }
            else{
                var isChnWeek3 = false;
            }

            return isChnWeek3;
        },
        createIcon: function(){
            var copy_r = luckysheet.dropCell.copyRange["row"][1], copy_c = luckysheet.dropCell.copyRange["column"][1];
            var apply_r = luckysheet.dropCell.applyRange["row"][1], apply_c = luckysheet.dropCell.applyRange["column"][1];
            if(apply_r >= copy_r && apply_c >= copy_c){
                var row_index = apply_r;
                var col_index = apply_c;
            }
            else{
                var row_index = copy_r;
                var col_index = copy_c;   
            }
            var row = luckysheet.rowLocationByIndex(row_index)[1], row_pre = luckysheet.rowLocationByIndex(row_index)[0];
            var col = luckysheet.colLocationByIndex(col_index)[1], col_pre = luckysheet.colLocationByIndex(col_index)[0];

            $("#luckysheet-dropCell-icon").remove();
            $("#luckysheet-cell-main").append(luckysheet.dropCell.iconHtml);
            // $("body").append(luckysheet.dropCell.iconHtml);

            $("#luckysheet-dropCell-icon").css({"left": col, "top": row});

            //点击icon
            $("#luckysheet-dropCell-icon").mouseover(function(){
                $(this).css("background-color", "#ffe8e8");
            }).mouseleave(function(){
                $(this).css("background-color", "#f1f1f1");
            }).mousedown(function(event){
                $("#luckysheet-dropCell-typeList").remove();
                $("body").append(luckysheet.dropCell.typeListHtml);

                var typeItemHide = luckysheet.dropCell.typeItemHide();
                if(!typeItemHide[0] && !typeItemHide[1] && !typeItemHide[2] && !typeItemHide[3] && !typeItemHide[4] && !typeItemHide[5] && !typeItemHide[6]){
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=1]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=4]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=5]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=6]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=7]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=8]").hide();
                }

                if(!typeItemHide[2]){
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=4]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=5]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=6]").hide();
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=7]").hide();
                }

                if(!typeItemHide[3]){
                    $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type=8]").hide();
                }
                
                
                var left = $(this).offset().left;
                var top = $(this).offset().top + 25;
                var winH = $(window).height(), winW = $(window).width();
                var menuW = $("#luckysheet-dropCell-typeList").width(), menuH = $("#luckysheet-dropCell-typeList").height();
                if (left + menuW > winW) {
                    left = left - menuW;
                }

                if (top + menuH > winH) {
                    top = top - menuH - 38;
                }

                if (top < 0) {
                    top = 0;
                }

                $("#luckysheet-dropCell-typeList").css({"left": left, "top": top}).show();
                $("#luckysheet-dropCell-icon").mouseleave(function(){ $(this).css("backgroundColor", "#ffe8e8") });


                var type = luckysheet.dropCell.applyType;
                $("#luckysheet-dropCell-typeList .luckysheet-cols-menuitem[data-type="+type+"]").find("span").append('<i class="fa fa-check luckysheet-mousedown-cancel"></i>');                
                event.stopPropagation();
            });
            //点击数据填充类型
            $(document).off("click.dCtypeList").on("click.dCtypeList","#luckysheet-dropCell-typeList .luckysheet-cols-menuitem",function(){
                $("#luckysheet-dropCell-typeList .fa-check").remove();
                $(this).find("span").append('<i class="fa fa-check luckysheet-mousedown-cancel"></i>');

                var type = $(this).attr("data-type");
                luckysheet.dropCell.applyType = type;

                luckysheet.dropCell.update();
                $("#luckysheet-dropCell-typeList").hide();
                $("#luckysheet-dropCell-icon").css("backgroundColor", "#f1f1f1");
                $("#luckysheet-dropCell-icon").mouseleave(function(){ $(this).css("backgroundColor", "#f1f1f1") }); 

                luckysheet.jfcountfunc();
            });
        },
        typeItemHide: function(){
            var copyRange = luckysheet.dropCell.copyRange;
            var str_r = copyRange["row"][0], end_r = copyRange["row"][1];
            var str_c = copyRange["column"][0], end_c = copyRange["column"][1];

            var hasNumber = false, hasExtendNumber = false, hasDate = false, hasChn = false, hasChnWeek1 = false, hasChnWeek2 = false, hasChnWeek3 = false;
            for(var r = str_r; r <= end_r; r++){
                for(var c = str_c; c <= end_c; c++){
                    if(!!luckysheet.flowdata[r][c]){
                        var cell = luckysheet.flowdata[r][c];

                        if(luckysheet.getObjType(cell) == "object" && cell["v"] != null && cell["f"] == null){
                            if(cell["ct"] != null && cell["ct"].t == "n"){
                                hasNumber = true;
                            }
                            else if(cell["ct"] != null && cell["ct"].t == "d"){
                                hasDate = true;
                            }
                            else if(luckysheet.dropCell.isExtendNumber(cell["m"])[0]){
                                hasExtendNumber = true;
                            }
                            else if(luckysheet.dropCell.isChnNumber(cell["m"]) && cell["m"] != "日"){
                                hasChn = true;
                            }
                            else if(cell["m"] == "日"){
                                hasChnWeek1 = true;
                            }
                            else if(luckysheet.dropCell.isChnWeek2(cell["m"])){
                                hasChnWeek2 = true;
                            }
                            else if(luckysheet.dropCell.isChnWeek3(cell["m"])){
                                hasChnWeek3 = true;
                            }
                        }
                    }
                }
            }

            return [hasNumber, hasExtendNumber, hasDate, hasChn, hasChnWeek1, hasChnWeek2, hasChnWeek3];
        }, 
        update: function(){
            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)];
            
            var cfg = $.extend(true, {}, config);
            var borderInfoCompute = luckysheet.getBorderInfoCompute();

            var direction = luckysheet.dropCell.direction;
            var type = luckysheet.dropCell.applyType;

            //复制范围
            var copyRange = luckysheet.dropCell.copyRange;
            var copy_str_r = copyRange["row"][0], copy_end_r = copyRange["row"][1];
            var copy_str_c = copyRange["column"][0], copy_end_c = copyRange["column"][1];
            var copyData = luckysheet.dropCell.getCopyData(d, copy_str_r, copy_end_r, copy_str_c, copy_end_c, direction);
            if(direction == "down" || direction == "up"){
                var csLen = copy_end_r - copy_str_r + 1;
            }
            else if(direction == "right" || direction == "left"){
                var csLen = copy_end_c - copy_str_c + 1;
            }

            //应用范围
            var applyRange = luckysheet.dropCell.applyRange;
            var apply_str_r = applyRange["row"][0], apply_end_r = applyRange["row"][1];
            var apply_str_c = applyRange["column"][0], apply_end_c = applyRange["column"][1];

            if(direction == "down" || direction == "up"){
                var asLen = apply_end_r - apply_str_r + 1;

                for(var i = apply_str_c; i <= apply_end_c; i++){
                    var copyD = copyData[i - apply_str_c];
                    
                    var applyData = luckysheet.dropCell.getApplyData(copyD, csLen, asLen);
                    
                    if(direction == "down"){
                        for(var j = apply_str_r; j <= apply_end_r; j++){
                            var cell = applyData[j - apply_str_r];

                            if(cell.f != null){
                                var f = "=" + luckysheet.formula.functionCopy(cell.f, "down", j - apply_str_r + 1);
                                var v = luckysheet.formula.execfunction(f, j, i, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(luckysheet.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = luckysheet.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = luckysheet.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[j][i] = cell;

                            //边框
                            var bd_r = copy_str_r + (j - apply_str_r) % csLen;
                            var bd_c = i;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[j + "_" + i]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                    if(direction == "up"){
                        for(var j = apply_end_r; j >= apply_str_r; j--){
                            var cell = applyData[apply_end_r - j];

                            if(cell.f != null){
                                var f = "=" + luckysheet.formula.functionCopy(cell.f, "up", apply_end_r - j + 1);
                                var v = luckysheet.formula.execfunction(f, j, i, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(luckysheet.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = luckysheet.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = luckysheet.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[j][i] = cell;

                            //边框
                            var bd_r = copy_end_r - (apply_end_r - j) % csLen;
                            var bd_c = i;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[j + "_" + i]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                }
            }
            else if(direction == "right" || direction == "left"){
                var asLen = apply_end_c - apply_str_c + 1;

                for(var i = apply_str_r; i <= apply_end_r; i++){
                    var copyD = copyData[i - apply_str_r];
                        
                    var applyData = luckysheet.dropCell.getApplyData(copyD, csLen, asLen);

                    if(direction == "right"){
                        for(var j = apply_str_c; j <= apply_end_c; j++){
                            var cell = applyData[j - apply_str_c];

                            if(cell.f != null){
                                var f = "=" + luckysheet.formula.functionCopy(cell.f, "right", j - apply_str_c + 1);
                                var v = luckysheet.formula.execfunction(f, i, j, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(luckysheet.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = luckysheet.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = luckysheet.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[i][j] = cell;

                            //边框
                            var bd_r = i;
                            var bd_c = copy_str_c + (j - apply_str_c) % csLen;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[i + "_" + j]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                    if(direction == "left"){
                        for(var j = apply_end_c; j >= apply_str_c; j--){
                            var cell = applyData[apply_end_c - j];

                            if(cell.f != null){
                                var f = "=" + luckysheet.formula.functionCopy(cell.f, "left", apply_end_c - j + 1);
                                var v = luckysheet.formula.execfunction(f, i, j, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(luckysheet.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = luckysheet.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = luckysheet.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[i][j] = cell;

                            //边框
                            var bd_r = i;
                            var bd_c = copy_end_c - (apply_end_c - j) % csLen;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[i + "_" + j]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                }
            }

            //条件格式
            var cdformat = $.extend(true, [], file["luckysheet_conditionformat_save"]);
            if(cdformat != null && cdformat.length > 0){
                for(var i = 0; i < cdformat.length; i++){
                    var cdformat_cellrange = cdformat[i].cellrange;

                    var emptyRange = [];

                    for(var j = 0; j < cdformat_cellrange.length; j++){
                        var range = luckysheet.conditionformat.CFSplitRange(cdformat_cellrange[j], {"row": copyRange["row"], "column": copyRange["column"]}, {"row": applyRange["row"], "column": applyRange["column"]}, "operatePart");
                        if(range.length > 0){
                            emptyRange = emptyRange.concat(range);
                        }
                    }

                    if(emptyRange.length > 0){
                        cdformat[i].cellrange.push(applyRange);
                    }
                }
            }

            //刷新一次表格
            luckysheet.jfrefreshgrid(d, luckysheet_select_save, cfg, cdformat);

            luckysheet.selectHightlightShow();
        },
        getCopyData: function(d, r1, r2, c1, c2, direction){
            var copyData = [];

            if(direction == "down" || direction == "up"){
                var a1 = c1, a2 = c2, b1 = r1, b2 = r2;
            }
            else if(direction == "right" || direction == "left"){
                var a1 = r1, a2 = r2, b1 = c1, b2 = c2;
            }

            for(var a = a1; a <= a2; a++){
                var obj = {};

                var arrData = [];
                var arrIndex = [];
                var text = "";
                var extendNumberStr = null;
                var isSameStr = true;

                for(var b = b1; b <= b2; b++){
                    //单元格
                    if(direction == "down" || direction == "up"){
                        var data = d[b][a];
                    }
                    else if(direction == "right" || direction == "left"){
                        var data = d[a][b];
                    }
                    //单元格值类型
                    if(!!data && !!data["v"] && data["f"] == null){
                        if(!!data["ct"] && data["ct"]["t"] == "n"){
                            var str = "number";
                            extendNumberStr = null;
                        }
                        else if(!!data["ct"] && data["ct"]["t"] == "d"){
                            var str = "date";
                            extendNumberStr = null;
                        }
                        else if(luckysheet.dropCell.isExtendNumber(data["m"])[0]){
                            var str = "extendNumber";
                            
                            if(extendNumberStr == null){
                                isSameStr = true;
                                extendNumberStr = luckysheet.dropCell.isExtendNumber(data["m"])[1];
                            }
                            else{
                                if(luckysheet.dropCell.isExtendNumber(data["m"])[1] != extendNumberStr){
                                    isSameStr = false;
                                    extendNumberStr = luckysheet.dropCell.isExtendNumber(data["m"])[1];
                                }
                                else{
                                    isSameStr = true;
                                }
                            }
                        }
                        else if(luckysheet.dropCell.isChnNumber(data["m"])){
                            var str = "chnNumber";
                            extendNumberStr = null;
                        }
                        else if(luckysheet.dropCell.isChnWeek2(data["m"])){
                            var str = "chnWeek2";
                            extendNumberStr = null;
                        }
                        else if(luckysheet.dropCell.isChnWeek3(data["m"])){
                            var str = "chnWeek3";
                            extendNumberStr = null;
                        }
                        else{
                            var str = "other";
                            extendNumberStr = null;
                        }
                    }
                    else{
                        var str = "other";
                        extendNumberStr = null;
                    }
                    //
                    if(str == "extendNumber"){
                        if(b == b1){
                            if(b1 == b2){
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);

                                obj[text] = [];
                                obj[text].push({"data": arrData, "index": arrIndex});
                            }
                            else{
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                        }
                        else if(b == b2){
                            if(text == str && isSameStr){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }

                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1);

                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                        }
                        else{
                            if(text == str && isSameStr){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1); 
                            }
                        }
                    }
                    else{
                        if(b == b1){
                            if(b1 == b2){
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);

                                obj[text] = [];
                                obj[text].push({"data": arrData, "index": arrIndex});
                            }
                            else{
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                        }
                        else if(b == b2){
                            if(text == str){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }

                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1);

                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                        }
                        else{
                            if(text == str){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1); 
                            }
                        }
                    }
                }

                copyData.push(obj);
            }

            return copyData;
        },
        getApplyData: function(copyD, csLen, asLen){
            var applyData = [];

            var direction = luckysheet.dropCell.direction;
            var type = luckysheet.dropCell.applyType;

            var num = Math.floor(asLen / csLen);
            var rsd = asLen % csLen;

            //纯数字类型
            var copyD_number = copyD["number"];
            var applyD_number = [];
            if(!!copyD_number){
                for(var i = 0; i < copyD_number.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_number[i]["index"], rsd);
                    var len = copyD_number[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_number[i]["data"], len, direction, type, "number");
                    }
                    else if(type == "2"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_number[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_number[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_number[i]["index"]);
                    applyD_number.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //扩展数字型（即一串字符最后面的是数字）
            var copyD_extendNumber = copyD["extendNumber"];
            var applyD_extendNumber = [];
            if(!!copyD_extendNumber){
                for(var i = 0; i < copyD_extendNumber.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_extendNumber[i]["index"], rsd);
                    var len = copyD_extendNumber[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, type, "extendNumber");
                    }
                    else if(type == "2"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_extendNumber[i]["index"]);
                    applyD_extendNumber.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //日期类型
            var copyD_date = copyD["date"];
            var applyD_date = [];
            if(!!copyD_date){
                for(var i = 0; i < copyD_date.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_date[i]["index"], rsd);
                    var len = copyD_date[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_date[i]["data"], len, direction, type, "date");
                    }
                    else if(type == "8"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_date[i]["data"], len, direction, "0");
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_date[i]["data"], len, direction, type);
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_date[i]["index"]);
                    applyD_date.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //中文小写数字 或 一~日
            var copyD_chnNumber = copyD["chnNumber"];
            var applyD_chnNumber = [];
            if(!!copyD_chnNumber){
                for(var i = 0; i < copyD_chnNumber.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_chnNumber[i]["index"], rsd);
                    var len = copyD_chnNumber[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, type, "chnNumber");
                    }
                    else if(type == "2" || type == "8"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_chnNumber[i]["index"]);
                    applyD_chnNumber.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //周一~周日
            var copyD_chnWeek2 = copyD["chnWeek2"];
            var applyD_chnWeek2 = [];
            if(!!copyD_chnWeek2){
                for(var i = 0; i < copyD_chnWeek2.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_chnWeek2[i]["index"], rsd);
                    var len = copyD_chnWeek2[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, type, "chnWeek2");
                    }
                    else if(type == "2"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_chnWeek2[i]["index"]);
                    applyD_chnWeek2.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //星期一~星期日
            var copyD_chnWeek3 = copyD["chnWeek3"];
            var applyD_chnWeek3 = [];
            if(!!copyD_chnWeek3){
                for(var i = 0; i < copyD_chnWeek3.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_chnWeek3[i]["index"], rsd);
                    var len = copyD_chnWeek3[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, type, "chnWeek3");
                    }
                    else if(type == "2"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_chnWeek3[i]["index"]);
                    applyD_chnWeek3.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //其它
            var copyD_other = copyD["other"];
            var applyD_other = [];
            if(!!copyD_other){
                for(var i = 0; i < copyD_other.length; i++){
                    var s = luckysheet.dropCell.getLenS(copyD_other[i]["index"], rsd);
                    var len = copyD_other[i]["index"].length * num + s;
                    if(type == "2" || type == "3"){
                        var arrData = luckysheet.dropCell.getDataByType(copyD_other[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = luckysheet.dropCell.getDataByType(copyD_other[i]["data"], len, direction, "0");
                    }
                    var arrIndex = luckysheet.dropCell.getDataIndex(csLen, asLen, copyD_other[i]["index"]);
                    applyD_other.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //
            for(var x = 1; x <= asLen; x++){
                if(applyD_number.length > 0){
                    for(var y = 0; y < applyD_number.length; y++){
                        if(x in applyD_number[y]["index"]){
                            applyData.push(applyD_number[y]["data"][applyD_number[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_extendNumber.length > 0){
                    for(var y = 0; y < applyD_extendNumber.length; y++){
                        if(x in applyD_extendNumber[y]["index"]){
                            applyData.push(applyD_extendNumber[y]["data"][applyD_extendNumber[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_date.length > 0){
                    for(var y = 0; y < applyD_date.length; y++){
                        if(x in applyD_date[y]["index"]){
                            applyData.push(applyD_date[y]["data"][applyD_date[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnNumber.length > 0){
                    for(var y = 0; y < applyD_chnNumber.length; y++){
                        if(x in applyD_chnNumber[y]["index"]){
                            applyData.push(applyD_chnNumber[y]["data"][applyD_chnNumber[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnWeek2.length > 0){
                    for(var y = 0; y < applyD_chnWeek2.length; y++){
                        if(x in applyD_chnWeek2[y]["index"]){
                            applyData.push(applyD_chnWeek2[y]["data"][applyD_chnWeek2[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnWeek3.length > 0){
                    for(var y = 0; y < applyD_chnWeek3.length; y++){
                        if(x in applyD_chnWeek3[y]["index"]){
                            applyData.push(applyD_chnWeek3[y]["data"][applyD_chnWeek3[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_other.length > 0){
                    for(var y = 0; y < applyD_other.length; y++){
                        if(x in applyD_other[y]["index"]){
                            applyData.push(applyD_other[y]["data"][applyD_other[y]["index"][x]]);
                        }
                    }
                }
            }

            return applyData;
        },
        getLenS: function(indexArr, rsd){
            var s = 0;
            for(var j = 0; j < indexArr.length; j++){
                if(indexArr[j] <= rsd){
                    s++; 
                }
                else{
                    break;
                }
            }
            return s;
        },
        getDataIndex: function(csLen, asLen, indexArr){
            var obj = {};

            var num = Math.floor(asLen / csLen);
            var rsd = asLen % csLen;

            var sum = 0;
            if(num > 0){
                for(var i = 1; i <= num; i++){
                    for(var j = 0; j < indexArr.length; j++){
                        obj[indexArr[j] + (i - 1) * csLen] = sum;
                        sum++;
                    }
                }
                for(var a = 0; a < indexArr.length; a++){
                    if(indexArr[a] <= rsd){
                        obj[indexArr[a] + csLen * num] = sum;
                        sum++;
                    }
                    else{
                        break;
                    }
                }
            }
            else{
                for(var a = 0; a < indexArr.length; a++){
                    if(indexArr[a] <= rsd){
                        obj[indexArr[a]] = sum;
                        sum++;
                    }
                    else{
                        break;
                    }
                }
            }

            return obj;
        },
        getDataByType: function(data, len, direction, type ,dataType){
            var applyData = [];

            if(type == "0"){ //复制单元格
                if(direction == "up" || direction == "left"){
                    data.reverse();
                }
                applyData = luckysheet.dropCell.FillCopy(data, len); 
            }
            else if(type == "1"){ //填充序列
                if(dataType == "number"){
                    //数据类型是 数字 
                    applyData = luckysheet.dropCell.FillSeries(data, len, direction);
                }
                else if(dataType == "extendNumber"){
                    //扩展数字（一串字符最后面的是数字）
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = luckysheet.dropCell.FillExtendNumber(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        for(var i = 0; i < data.length; i++){
                            var txt = data[i]["m"];
                            dataNumArr.push(Number(luckysheet.dropCell.isExtendNumber(txt)[2]));
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(luckysheet.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = luckysheet.dropCell.FillExtendNumber(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = luckysheet.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "date"){ 
                    //数据类型是 日期
                    if(data.length == 1){
                        //以一天为step
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = luckysheet.dropCell.FillDays(data, len, step);
                    }
                    else{
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }

                        var judgeDate = luckysheet.dropCell.judgeDate(data);
                        if(judgeDate[0] && judgeDate[3]){
                            //日一样，月差为等差数列，以月差为step
                            var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                            applyData = luckysheet.dropCell.FillMonths(data, len, step);
                        }
                        else if(!judgeDate[0] && judgeDate[2]){
                            //日不一样，日差为等差数列，以日差为step
                            var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                            applyData = luckysheet.dropCell.FillDays(data, len, step);
                        }
                        else{
                            //其它，复制数据
                            applyData = luckysheet.dropCell.FillCopy(data, len);
                        }   
                    }
                }
                else if(dataType == "chnNumber"){
                    //数据类型是 中文小写数字
                    if(data.length == 1){
                        if(data[0]["m"] == "日" || luckysheet.dropCell.ChineseToNumber(data[0]["m"]) < 7){
                            //数字小于7，以周一~周日序列填充
                            if(direction == "down" || direction == "right"){
                                var step = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step = -1;
                            }
                            applyData = luckysheet.dropCell.FillChnWeek(data, len, step);
                        }
                        else{
                            //数字大于7，以中文小写数字序列填充
                            if(direction == "down" || direction == "right"){
                                var step = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step = -1;
                            }
                            applyData = luckysheet.dropCell.FillChnNumber(data, len, step);
                        }
                    }
                    else{
                        var hasweek = false;
                        for(var i = 0; i < data.length; i++){
                            if(data[i]["m"] == "日"){
                                hasweek = true;
                                break;
                            }
                        }

                        var dataNumArr = [];
                        var weekIndex = 0;
                        for(var i = 0; i < data.length; i++){
                            if(data[i]["m"] == "日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else if(hasweek && luckysheet.dropCell.ChineseToNumber(data[i]["m"]) > 0 && luckysheet.dropCell.ChineseToNumber(data[i]["m"]) < 7){
                                dataNumArr.push(luckysheet.dropCell.ChineseToNumber(data[i]["m"]) + weekIndex * 7);
                            }
                            else{
                                dataNumArr.push(luckysheet.dropCell.ChineseToNumber(data[i]["m"]));
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(luckysheet.dropCell.isEqualDiff(dataNumArr)){
                            if(hasweek || (dataNumArr[dataNumArr.length - 1] < 6 && dataNumArr[0] > 0) || (dataNumArr[0] < 6 && dataNumArr[dataNumArr.length - 1] > 0)){
                                //以周一~周日序列填充
                                var step = dataNumArr[1] - dataNumArr[0];
                                applyData = luckysheet.dropCell.FillChnWeek(data, len, step);
                            }
                            else{
                                //以中文小写数字序列填充
                                var step = dataNumArr[1] - dataNumArr[0];
                                applyData = luckysheet.dropCell.FillChnNumber(data, len, step);
                            }
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = luckysheet.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "chnWeek2"){
                    //周一~周日
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = luckysheet.dropCell.FillChnWeek2(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        var weekIndex = 0;

                        for(var i = 0; i < data.length; i++){
                            var lastTxt = data[i]["m"].substr(data[i]["m"].length - 1, 1);
                            if(data[i]["m"] == "周日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else{
                                dataNumArr.push(luckysheet.dropCell.ChineseToNumber(lastTxt) + weekIndex * 7);
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(luckysheet.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = luckysheet.dropCell.FillChnWeek2(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = luckysheet.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "chnWeek3"){
                    //星期一~星期日
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = luckysheet.dropCell.FillChnWeek3(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        var weekIndex = 0;

                        for(var i = 0; i < data.length; i++){
                            var lastTxt = data[i]["m"].substr(data[i]["m"].length - 1, 1);
                            if(data[i]["m"] == "星期日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else{
                                dataNumArr.push(luckysheet.dropCell.ChineseToNumber(lastTxt) + weekIndex * 7);
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(luckysheet.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = luckysheet.dropCell.FillChnWeek3(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = luckysheet.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else{
                    //数据类型是 其它
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }
                    applyData = luckysheet.dropCell.FillCopy(data, len);
                }
            }
            else if(type == "2"){ //仅填充格式
                if(direction == "up" || direction == "left"){
                    data.reverse();
                }
                applyData = luckysheet.dropCell.FillOnlyFormat(data, len);
            }
            else if(type == "3"){ //不带格式填充
                var dataArr = luckysheet.dropCell.getDataByType(data, len, direction, "1" ,dataType);
                applyData = luckysheet.dropCell.FillWithoutFormat(dataArr);
            }
            else if(type == "4"){ //以天数填充
                if(data.length == 1){
                    //以一天为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = luckysheet.dropCell.FillDays(data, len, step);
                }
                else if(data.length == 2){
                    //以日差为step
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }
                    var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                    applyData = luckysheet.dropCell.FillDays(data, len, step);
                }
                else{
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }

                    var judgeDate = luckysheet.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = luckysheet.dropCell.FillMonths(data, len, step);
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列，以日差为step
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                        applyData = luckysheet.dropCell.FillDays(data, len, step);
                    }
                    else{
                        //日差不是等差数列，复制数据
                        applyData = luckysheet.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "5"){ //以工作日填充
                if(data.length == 1){
                    //以一天为step（若那天为休息日，则跳过）
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }

                    var newLen = Math.round(len * 1.5);
                    for(var i = 1; i <= newLen; i++){
                        var d = $.extend(true, {}, data[0]);

                        var day = moment(d["m"]).add(i, "days").day();
                        if(day == 0 || day == 6){
                            continue;
                        }

                        var date = moment(d["m"]).add(step * i, "days").format("YYYY-MM-DD");
                        d["m"] = date;
                        d["v"] = luckysheet.mask.genarate(date)[2];
                        applyData.push(d);

                        if(applyData.length == len){
                            break;
                        }
                    }
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "months") != 0){
                        //日一样，且月差大于一月，以月差为step（若那天为休息日，则向前取最近的工作日）
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");

                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var day = moment(data[data.length - 1]).add(step * i, "months").day();
                            if(day == 0){
                                var date = moment(data[data.length - 1]).add(step * i, "months").subtract(2, "days").format("YYYY-MM-DD");
                            }
                            else if(day == 6){
                                var date = moment(data[data.length - 1]).add(step * i, "months").subtract(1, "days").format("YYYY-MM-DD");
                            }
                            else{
                                var date = moment(data[data.length - 1]).add(step * i, "months").format("YYYY-MM-DD");
                            }
                            
                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日不一样
                        if(Math.abs(moment(data[1]["m"]).diff(moment(data[0]["m"]))) > 7){
                            //若日差大于7天，以一月为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_month = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_month = -1;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = luckysheet.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                        else{
                            //若日差小于等于7天，以7天为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_day = 7;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_day = -7;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_day * num, "days").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = luckysheet.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                    }
                }
                else{
                    var judgeDate = luckysheet.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step（若那天为休息日，则向前取最近的工作日）
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");

                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var day = moment(data[data.length - 1]["m"]).add(step * i, "months").day();
                            if(day == 0){
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").subtract(2, "days").format("YYYY-MM-DD");
                            }
                            else if(day == 6){
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").subtract(1, "days").format("YYYY-MM-DD");
                            }
                            else{
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").format("YYYY-MM-DD");
                            }

                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列
                        if(Math.abs(moment(data[1]["m"]).diff(moment(data[0]["m"]))) > 7){
                            //若日差大于7天，以一月为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_month = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_month = -1;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = luckysheet.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                        else{
                            //若日差小于等于7天，以7天为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_day = 7;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_day = -7;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_day * num, "days").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = luckysheet.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = luckysheet.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "6"){ //以月填充
                if(data.length == 1){
                    //以一月为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = luckysheet.dropCell.FillMonths(data, len, step);
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "months") != 0){
                        //日一样，且月差大于一月，以月差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = luckysheet.dropCell.FillMonths(data, len, step);
                    }
                    else{
                        //以一月为step
                        if(direction == "down" || direction == "right"){
                            var step_month = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_month = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                }
                else{
                    var judgeDate = luckysheet.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = luckysheet.dropCell.FillMonths(data, len, step);
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列，以一月为step
                        if(direction == "down" || direction == "right"){
                            var step_month = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_month = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = luckysheet.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "7"){ //以年填充
                if(data.length == 1){
                    //以一年为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = luckysheet.dropCell.FillYears(data, len, step);
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).month() == moment(data[0]["m"]).month() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "years") != 0){
                        //日月一样，且年差大于一年，以年差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");
                        applyData = luckysheet.dropCell.FillYears(data, len, step);
                    }
                    else{
                        //以一年为step
                        if(direction == "down" || direction == "right"){
                            var step_year = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_year = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_year * num, "years").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                }
                else{
                    var judgeDate = luckysheet.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[1] && judgeDate[4]){
                        //日月一样，且年差为等差数列，以年差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");
                        applyData = luckysheet.dropCell.FillYears(data, len, step);
                    }
                    else if((judgeDate[0] && judgeDate[3]) || judgeDate[2]){
                        //日一样且月差为等差数列，或天差为等差数列，以一年为step
                        if(direction == "down" || direction == "right"){
                            var step_year = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_year = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_year * num, "years").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = luckysheet.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = luckysheet.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "8"){ //以中文小写数字序列填充
                if(data.length == 1){
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = luckysheet.dropCell.FillChnNumber(data, len, step);
                }
                else{
                    var dataNumArr = [];
                    for(var i = 0; i < data.length; i++){
                        dataNumArr.push(luckysheet.dropCell.ChineseToNumber(data[i]["m"]));
                    }

                    if(direction == "up" || direction == "left"){
                        data.reverse();
                        dataNumArr.reverse();
                    }

                    if(luckysheet.dropCell.isEqualDiff(dataNumArr)){
                        var step = dataNumArr[1] - dataNumArr[0];
                        applyData = luckysheet.dropCell.FillChnNumber(data, len, step);
                    }
                    else{
                        //不是等差数列，复制数据
                        applyData = luckysheet.dropCell.FillCopy(data, len);
                    }
                }
            }
            
            return applyData;
        },
        FillCopy: function(data, len){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                applyData.push(d);
            } 

            return applyData;
        },
        FillSeries: function(data, len, direction){
            var applyData = [];

            var dataNumArr = [];
            for(var j = 0; j < data.length; j++){
                dataNumArr.push(Number(data[j]["v"]));
            }

            if(data.length > 2 && luckysheet.dropCell.isEqualRatio(dataNumArr)){
                //等比数列
                for(var i = 1; i <= len; i++){
                    var index = (i - 1) % data.length;
                    var d = $.extend(true, {}, data[index]);

                    if(direction == "down" || direction == "right"){
                        var num = Number(data[data.length -1]["v"]) * Math.pow(Number(data[1]["v"]) / Number(data[0]["v"]), i);
                    }
                    else if(direction == "up" || direction == "left"){
                        var num = Number(data[0]["v"]) / Math.pow(Number(data[1]["v"]) / Number(data[0]["v"]), i);
                    }
                    
                    d["v"] = num;
                    d["m"] = luckysheet.mask.update(d["ct"]["fa"], num);
                    applyData.push(d);
                }
            }
            else{
                //线性数列
                var xArr = luckysheet.dropCell.getXArr(data.length);
                for(var i = 1; i <= len; i++){
                    var index = (i - 1) % data.length;
                    var d = $.extend(true, {}, data[index]);

                    if(direction == "down" || direction == "right"){
                        var y = luckysheet.dropCell.forecast(data.length + i, dataNumArr, xArr);
                    }
                    else if(direction == "up" || direction == "left"){
                        var y = luckysheet.dropCell.forecast(1 - i, dataNumArr, xArr);
                    }

                    d["v"] = y;
                    d["m"] = luckysheet.mask.update(d["ct"]["fa"], y);
                    applyData.push(d);
                }
            }

            return applyData;
        },
        FillExtendNumber: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var last = data[data.length - 1]["m"];
                var lastTxt = luckysheet.dropCell.isExtendNumber(last)[1];
                var lastNum = luckysheet.dropCell.isExtendNumber(last)[2];

                var num = Math.abs(Number(lastNum) + step * i);
                d["v"] = lastTxt + num.toString();
                d["m"] = lastTxt + num.toString();

                applyData.push(d);
            }

            return applyData;
        },
        FillOnlyFormat: function(data, len){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                delete d["f"];
                delete d["m"];
                delete d["v"];

                applyData.push(d);
            } 

            return applyData; 
        },
        FillWithoutFormat: function(dataArr){
            var applyData = [];

            for(var i = 0; i < dataArr.length; i++){
                var d = $.extend(true, {}, dataArr[i]);

                if(d["f"] == null){
                    var obj = {"m": d["v"].toString(), "v": d["v"]};
                }
                else{
                    var obj = {"f": d["f"], "m": d["v"].toString(), "v": d["v"]};
                }

                applyData.push(obj);
            }

            return applyData;
        },
        FillDays: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = luckysheet.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "days").format("YYYY-MM-DD");

                d["v"] = luckysheet.mask.genarate(date)[2];
                d["m"] = luckysheet.mask.update(d["ct"]["fa"], d["v"]);

                applyData.push(d);
            }

            return applyData;
        },
        FillMonths: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = luckysheet.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "months").format("YYYY-MM-DD");
                
                d["v"] = luckysheet.mask.genarate(date)[2];
                d["m"] = luckysheet.mask.update(d["ct"]["fa"], d["v"]);
                
                applyData.push(d);
            }

            return applyData;
        },
        FillYears: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = luckysheet.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "years").format("YYYY-MM-DD");
                
                d["v"] = luckysheet.mask.genarate(date)[2];
                d["m"] = luckysheet.mask.update(d["ct"]["fa"], d["v"]);
                
                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "日"){
                    var num = 7 + step * i;
                }
                else{
                    var num = luckysheet.dropCell.ChineseToNumber(data[data.length - 1]["m"]) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "日";
                    d["v"] = "日";
                }
                else if(rsd == 1){
                    d["m"] = "一";
                    d["v"] = "一";
                }
                else if(rsd == 2){
                    d["m"] = "二";
                    d["v"] = "二";
                }
                else if(rsd == 3){
                    d["m"] = "三";
                    d["v"] = "三";
                }
                else if(rsd == 4){
                    d["m"] = "四";
                    d["v"] = "四";
                }
                else if(rsd == 5){
                    d["m"] = "五";
                    d["v"] = "五";
                }
                else if(rsd == 6){
                    d["m"] = "六";
                    d["v"] = "六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek2: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "周日"){
                    var num = 7 + step * i;
                }
                else{
                    var last = data[data.length - 1]["m"];
                    var txt = last.substr(last.length - 1, 1);
                    var num = luckysheet.dropCell.ChineseToNumber(txt) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "周日";
                    d["v"] = "周日";
                }
                else if(rsd == 1){
                    d["m"] = "周一";
                    d["v"] = "周一";
                }
                else if(rsd == 2){
                    d["m"] = "周二";
                    d["v"] = "周二";
                }
                else if(rsd == 3){
                    d["m"] = "周三";
                    d["v"] = "周三";
                }
                else if(rsd == 4){
                    d["m"] = "周四";
                    d["v"] = "周四";
                }
                else if(rsd == 5){
                    d["m"] = "周五";
                    d["v"] = "周五";
                }
                else if(rsd == 6){
                    d["m"] = "周六";
                    d["v"] = "周六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek3: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "星期日"){
                    var num = 7 + step * i;
                }
                else{
                    var last = data[data.length - 1]["m"];
                    var txt = last.substr(last.length - 1, 1);
                    var num = luckysheet.dropCell.ChineseToNumber(txt) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "星期日";
                    d["v"] = "星期日";
                }
                else if(rsd == 1){
                    d["m"] = "星期一";
                    d["v"] = "星期一";
                }
                else if(rsd == 2){
                    d["m"] = "星期二";
                    d["v"] = "星期二";
                }
                else if(rsd == 3){
                    d["m"] = "星期三";
                    d["v"] = "星期三";
                }
                else if(rsd == 4){
                    d["m"] = "星期四";
                    d["v"] = "星期四";
                }
                else if(rsd == 5){
                    d["m"] = "星期五";
                    d["v"] = "星期五";
                }
                else if(rsd == 6){
                    d["m"] = "星期六";
                    d["v"] = "星期六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnNumber: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var num = luckysheet.dropCell.ChineseToNumber(data[data.length - 1]["m"]) + step * i;
                if(num <= 0){
                    var txt = "零";
                }
                else{
                    var txt = luckysheet.dropCell.NumberToChinese(num);
                }

                d["v"] = txt;
                d["m"] = txt.toString();
                applyData.push(d);
            }

            return applyData;
        },
        isEqualDiff: function(arr){
            var diff = true;
            var step = arr[1] - arr[0];
            for(var i = 1; i < arr.length; i++){
                if(arr[i] - arr[i - 1] != step){
                    diff = false;
                    break;
                }
            }
            return diff;
        },
        isEqualRatio: function(arr){
            var ratio = true;
            var step = arr[1] / arr[0];
            for(var i = 1; i < arr.length; i++){
                if(arr[i] / arr[i - 1] != step){
                    ratio = false;
                    break;
                }
            }
            return ratio;
        },
        getXArr: function(len){
            var xArr = [];
            for(var i = 1; i <= len; i++){
                xArr.push(i);
            }
            return xArr;
        },
        forecast: function(x, yArr, xArr){
            function getAverage(arr){
                var sum = 0;
                for(var i = 0; i < arr.length; i++){
                    sum += arr[i];
                }
                return sum / arr.length;
            }
            var ax = getAverage(xArr); //x数组 平均值
            var ay = getAverage(yArr); //y数组 平均值
            
            var sum_d = 0, sum_n = 0;
            for(var j = 0; j < xArr.length; j++){
                //分母和
                sum_d += (xArr[j] - ax)*(yArr[j] - ay);
                //分子和
                sum_n += (xArr[j] - ax)*(xArr[j] - ax);
            }

            if(sum_n == 0){
                var b = 1;
            }
            else{
                var b = sum_d / sum_n;
            }
            var a = ay - b * ax;

            return Math.round((a + b * x) * 100000) / 100000;
        },
        judgeDate: function(data){
            var isSameDay = true, isSameMonth = true, isEqualDiffDays = true, isEqualDiffMonths = true, isEqualDiffYears = true;
            var sameDay = moment(data[0]["m"]).date(), sameMonth = moment(data[0]["m"]).month(); 
            var equalDiffDays = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
            var equalDiffMonths = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
            var equalDiffYears = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");

            for(var i = 1; i < data.length; i++){
                //日是否一样
                if(moment(data[i]["m"]).date() != sameDay){
                    isSameDay = false;
                }
                //月是否一样
                if(moment(data[i]["m"]).month() != sameMonth){
                    isSameMonth = false;
                }
                //日差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "days") != equalDiffDays){
                    isEqualDiffDays = false;
                }
                //月差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "months") != equalDiffMonths){
                    isEqualDiffMonths = false;
                }
                //年差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "years") != equalDiffYears){
                    isEqualDiffYears = false;
                }
            }
            if(equalDiffDays == 0){
                isEqualDiffDays = false;
            }
            if(equalDiffMonths == 0){
                isEqualDiffMonths = false;
            }
            if(equalDiffYears == 0){
                isEqualDiffYears = false;
            }

            return [isSameDay, isSameMonth, isEqualDiffDays, isEqualDiffMonths, isEqualDiffYears];
        }
    }

    //定位
    luckysheet.locationCell = {
        createDialog: function(){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-locationCell-dialog").remove();

            var content = '<div class="listbox">'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" checked="checked" id="locationConstant">'+
                                '<label for="locationConstant">常量</label>'+
                                '<div class="subbox">'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="date" id="locationConstantDate">'+
                                        '<label for="locationConstantDate">日期</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="number" id="locationConstantNumber">'+
                                        '<label for="locationConstantNumber">数字</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="string" id="locationConstantString">'+
                                        '<label for="locationConstantString">字符</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="boolean" id="locationConstantBoolean">'+
                                        '<label for="locationConstantBoolean">逻辑值</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="error" id="locationConstantError">'+
                                        '<label for="locationConstantError">错误</label>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationFormula">'+
                                '<label for="locationFormula">公式</label>'+
                                '<div class="subbox">'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="date" id="locationFormulaDate" disabled="true">'+
                                        '<label for="locationFormulaDate" style="color: #666">日期</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="number" id="locationFormulaNumber" disabled="true">'+
                                        '<label for="locationFormulaNumber" style="color: #666">数字</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="string" id="locationFormulaString" disabled="true">'+
                                        '<label for="locationFormulaString" style="color: #666">字符</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="boolean" id="locationFormulaBoolean" disabled="true">'+
                                        '<label for="locationFormulaBoolean" style="color: #666">逻辑值</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="error" id="locationFormulaError" disabled="true">'+
                                        '<label for="locationFormulaError" style="color: #666">错误</label>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationNull">'+
                                '<label for="locationNull">空值</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationCF">'+
                                '<label for="locationCF">条件格式</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationStepRow">'+
                                '<label for="locationStepRow">间隔行</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationStepColumn">'+
                                '<label for="locationStepColumn">间隔列</label>'+
                            '</div>'+
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-locationCell-dialog", "addclass": "luckysheet-locationCell-dialog", "title": "定位条件", "content": content, "botton": '<button id="luckysheet-locationCell-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-locationCell-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-locationCell-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        init: function(){
            $(document).on("click", "#luckysheet-locationCell-dialog .listItem input:radio", function(e){
                $("#luckysheet-locationCell-dialog .listItem input:checkbox").prop("disabled", true);
                $("#luckysheet-locationCell-dialog .listItem .subbox label").css("color", "#666");

                $(this).siblings(".subbox").find("input:checkbox").removeAttr("disabled");
                $(this).siblings(".subbox").find("label").css("color", "#000");
            });

            $(document).off("click.locationCellConfirm").on("click.locationCellConfirm", "#luckysheet-locationCell-dialog #luckysheet-locationCell-dialog-confirm", function(){
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-locationCell-dialog").hide();

                var $radio = $("#luckysheet-locationCell-dialog .listItem input:radio:checked");
                var id = $radio.attr("id");
                if(id == "locationConstant" || id == "locationFormula"){
                    var $checkbox = $radio.siblings(".subbox").find("input:checkbox:checked");
                    if($checkbox.length == 0){
                        return;
                    }
                    else if($checkbox.length == 5){
                        var value = "all";
                    }
                    else{
                        var arr = [];
                        for(var i = 0; i < $checkbox.length; i++){
                            if($($checkbox[i]).hasClass("date")){
                                arr.push("d");
                            }
                            else if($($checkbox[i]).hasClass("number")){
                                arr.push("n");
                            }
                            else if($($checkbox[i]).hasClass("string")){
                                arr.push("s,g");
                            }
                            else if($($checkbox[i]).hasClass("boolean")){
                                arr.push("b");
                            }
                            else if($($checkbox[i]).hasClass("error")){
                                arr.push("e");
                            }
                        }
                        var value = arr.join(",");
                    }

                    if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                        //单个单元格
                        var range = [{"row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1]}];
                    }
                    else{
                        var range = $.extend(true, [], luckysheet_select_save);
                    }

                    luckysheet.locationCell.apply(range, id, value);
                }
                else if(id == "locationStepRow"){
                    if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1])){
                        if(luckysheet.isEditMode()){
                            alert("请选择最少两行");
                        }
                        else{
                            luckysheet.tooltip.info("提示", "请选择最少两行"); 
                        }
                        return;                            
                    }

                    var range = $.extend(true, [], luckysheet_select_save);

                    luckysheet.locationCell.apply(range, "locationStepRow");
                }
                else if(id == "locationStepColumn"){
                    if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                        if(luckysheet.isEditMode()){
                            alert("请选择最少两列");
                        }
                        else{
                            luckysheet.tooltip.info("提示", "请选择最少两列");    
                        }
                        return;                            
                    }

                    var range = $.extend(true, [], luckysheet_select_save);

                    luckysheet.locationCell.apply(range, "locationStepColumn");
                }
                else{
                    if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                        //单个单元格
                        var range = [{"row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1]}];
                    }
                    else{
                        var range = $.extend(true, [], luckysheet_select_save);
                    }

                    luckysheet.locationCell.apply(range, id);
                }
            });
        },
        apply: function(range, type, value){
            var rangeArr = [];

            if(type == "locationFormula" || type == "locationConstant" || type == "locationNull" || type == "locationCF"){
                if(type == "locationFormula"){ //公式
                    if(value == "all"){
                        var str = "luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].v != null && luckysheet.flowdata[r][c].f != null";
                    }
                    else{
                        var str = "luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].v != null && luckysheet.flowdata[r][c].f != null && luckysheet.flowdata[r][c].ct != null && value.indexOf(luckysheet.flowdata[r][c].ct.t) != -1";
                    }
                }
                else if(type == "locationConstant"){ //常量
                    if(value == "all"){
                        var str = "luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].v != null && luckysheet.flowdata[r][c].f == null && luckysheet.flowdata[r][c].ct != null";
                    }
                    else{
                        var str = "luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].v != null && luckysheet.flowdata[r][c].f == null && luckysheet.flowdata[r][c].ct != null && value.indexOf(luckysheet.flowdata[r][c].ct.t) != -1";
                    }
                }
                else if(type == "locationNull"){ //空值
                    var str = "luckysheet.flowdata[r] != null && (luckysheet.flowdata[r][c] == null || luckysheet.flowdata[r][c].v == null || luckysheet.flowdata[r][c].v == '') ";
                }
                else if(type == "locationCF"){ //条件格式
                    var index = luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex);
                    var ruleArr = luckysheetfile[index]["luckysheet_conditionformat_save"];
                    var data = luckysheetfile[index]["data"];

                    var computeMap = luckysheet.conditionformat.compute(ruleArr, data);

                    if(JSON.stringify(computeMap) == "{}"){
                        if(luckysheet.isEditMode()){
                            alert("未找到单元格");
                        }
                        else{
                            luckysheet.tooltip.info("提示", "未找到单元格");
                        }

                        return;
                    }

                    var str = "(r + '_' + c) in computeMap";
                }

                for(var s = 0; s < range.length; s++){
                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];
                    
                    if(st_r == ed_r){
                        var stack_stc = null, stack_edc = null;

                        var r = st_r;
                        for(var c = st_c; c <= ed_c; c++){
                            if(c == st_c){
                                if(eval(str)){
                                    stack_stc = c;
                                }
                                else{
                                    stack_stc = null;
                                }
                            }
                            else if(c == ed_c){
                                if(eval(str)){
                                    if(stack_stc == null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [ed_c, ed_c]});
                                    }
                                    else{
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, ed_c]});
                                    }
                                }
                                else{
                                    if(stack_edc == null && stack_stc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_stc]});
                                    }
                                    else if(stack_edc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_edc]});
                                    }
                                }
                            }
                            else{
                                if(eval(str)){
                                    if(stack_stc == null){
                                        stack_stc = c;
                                    }
                                    else{
                                        stack_edc = c;
                                    }
                                }
                                else{
                                    if(stack_edc == null && stack_stc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_stc]});
                                        stack_stc = null;
                                    }
                                    else if(stack_edc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_edc]});
                                        stack_stc = null;
                                        stack_edc = null;
                                    }
                                }
                            }
                        }
                    }
                    else{
                        var stack = {}; 

                        for(var r = st_r; r <= ed_r; r++){
                            stack[r] = [];
                            var stack_stc = null, stack_edc = null;

                            for(var c = st_c; c <= ed_c; c++){
                                if(c == ed_c){
                                    if(eval(str)){
                                        if(stack_stc == null){
                                            stack[r].push({"status": false, "range": [ed_c, ed_c]});
                                        }
                                        else{
                                            stack[r].push({"status": false, "range": [stack_stc, ed_c]});   
                                        }
                                    }
                                    else{
                                        if(stack_edc == null && stack_stc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_stc]});
                                        }
                                        else if(stack_edc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_edc]});
                                        }
                                    }
                                }
                                else if(c == st_c){
                                    if(eval(str)){
                                        stack_stc = c;
                                    }
                                    else{
                                        stack_stc = null;
                                    }
                                }
                                else{
                                    if(eval(str)){
                                        if(stack_stc == null){
                                            stack_stc = c;
                                        }
                                        else{
                                            stack_edc = c;
                                        }
                                    }
                                    else{
                                        if(stack_edc == null && stack_stc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_stc]});
                                            stack_stc = null;
                                        }
                                        else if(stack_edc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_edc]});
                                            stack_stc = null;
                                            stack_edc = null;
                                        }
                                    }
                                }
                            }
                        }

                        for(var i = st_r; i <= ed_r; i++){
                            if(i == ed_r){
                                if(stack[i].length > 0){
                                    for(var j = 0; j < stack[i].length; j++){
                                        if(!stack[i][j].status){
                                            rangeArr.push({"row": [ed_r, ed_r], "column": stack[i][j].range});
                                        }
                                    }
                                }
                            }
                            else{
                                if(stack[i].length > 0){
                                    for(var j = 0; j < stack[i].length; j++){
                                        if(!stack[i][j].status){
                                            var b = 0;
                                            
                                            for(var a = 1; a < (ed_r - i); a++){
                                                if(stack[i + a][j] != null && stack[i + a][j].range[0] == stack[i][j].range[0] && stack[i + a][j].range[1] == stack[i][j].range[1]){
                                                    b = a;
                                                    stack[i + a][j].status = true;
                                                }
                                                else{
                                                    break;
                                                }     
                                            }

                                            rangeArr.push({"row": [i, i + b], "column": stack[i][j].range});
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            else if(type == "locationStepRow"){ //间隔行
                for(var s = 0; s < range.length; s++){
                    if(range[s].row[0] == range[s].row[1]){
                        continue;
                    }

                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];

                    for(var r = st_r; r <= ed_r; r++){
                        if((r - st_r) % 2 == 0){
                            rangeArr.push({"row": [r, r], "column": [st_c, ed_c]});
                        }
                    }
                }
            }
            else if(type == "locationStepColumn"){ //间隔列
                for(var s = 0; s < range.length; s++){
                    if(range[s].column[0] == range[s].column[1]){
                        continue;
                    }

                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];

                    for(var c = st_c; c <= ed_c; c++){
                        if((c - st_c) % 2 == 0){
                            rangeArr.push({"row": [st_r, ed_r], "column": [c, c]});
                        }
                    }
                }
            }

            if(rangeArr.length == 0){
                if(luckysheet.isEditMode()){
                    alert("未找到单元格");
                }
                else{
                    luckysheet.tooltip.info("提示", "未找到单元格");  
                }
            }
            else{
                luckysheet_select_save = rangeArr;
                luckysheet.selectHightlightShow(); 

                var scrollLeft = $("#luckysheet-cell-main").scrollLeft(), scrollTop = $("#luckysheet-cell-main").scrollTop();
                var winH = $("#luckysheet-cell-main").height(), winW = $("#luckysheet-cell-main").width();

                var row = visibledatarow[luckysheet_select_save[0]["row"][1]], row_pre = luckysheet_select_save[0]["row"][0] - 1 == -1 ? 0 : visibledatarow[luckysheet_select_save[0]["row"][0] - 1];
                var col = visibledatacolumn[luckysheet_select_save[0]["column"][1]], col_pre = luckysheet_select_save[0]["column"][0] - 1 == -1 ? 0 : visibledatacolumn[luckysheet_select_save[0]["column"][0] - 1];

                if (col - scrollLeft - winW + 20 > 0) {
                    $("#luckysheet-scrollbar-x").scrollLeft(col - winW + 20);
                }
                else if (col_pre - scrollLeft - 20 < 0) {
                    $("#luckysheet-scrollbar-x").scrollLeft(col_pre - 20);
                }

                if (row - scrollTop - winH + 20 > 0) {
                    $("#luckysheet-scrollbar-y").scrollTop(row - winH + 20);
                }
                else if (row_pre - scrollTop - 20 < 0) {
                    $("#luckysheet-scrollbar-y").scrollTop(row_pre - 20);
                }
            }
        }
    }

    //更多格式
    luckysheet.moreFormat = {
        moneyFmtList: [
            {
                "name": "人民币",
                "pos": "before",
                "value": "¥"
            }, {
                "name": "美元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "欧元",
                "pos": "before",
                "value": "€"
            }, {
                "name": "英镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "港元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "日元",
                "pos": "before",
                "value": "￥"
            }, {
                "name": "阿尔巴尼亚列克",
                "pos": "before",
                "value": "Lek"
            }, {
                "name": "阿尔及利亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "阿富汗尼",
                "pos": "after",
                "value": "Af"
            }, {
                "name": "阿根廷比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "阿拉伯联合酋长国迪拉姆",
                "pos": "before",
                "value": "dh"
            }, {
                "name": "阿鲁巴弗罗林",
                "pos": "before",
                "value": "Afl"
            }, {
                "name": "阿曼里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "阿塞拜疆马纳特",
                "pos": "before",
                "value": "?"
            }, {
                "name": "埃及镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "埃塞俄比亚比尔",
                "pos": "before",
                "value": "Birr"
            }, {
                "name": "安哥拉宽扎",
                "pos": "before",
                "value": "Kz"
            }, {
                "name": "澳大利亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "澳门元",
                "pos": "before",
                "value": "MOP"
            }, {
                "name": "巴巴多斯元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "巴布亚新几内亚基那",
                "pos": "before",
                "value": "PGK"
            }, {
                "name": "巴哈马元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "巴基斯坦卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "巴拉圭瓜拉尼",
                "pos": "after",
                "value": "Gs"
            }, {
                "name": "巴林第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "巴拿马巴波亚",
                "pos": "before",
                "value": "B/"
            }, {
                "name": "巴西里亚伊",
                "pos": "before",
                "value": "R$"
            }, {
                "name": "白俄罗斯卢布",
                "pos": "after",
                "value": "р"
            }, {
                "name": "百慕大元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "保加利亚列弗",
                "pos": "before",
                "value": "lev"
            }, {
                "name": "冰岛克朗",
                "pos": "before",
                "value": "kr"
            }, {
                "name": "波黑可兑换马克",
                "pos": "before",
                "value": "KM"
            }, {
                "name": "波兰兹罗提",
                "pos": "after",
                "value": "z?"
            }, {
                "name": "玻利维亚诺",
                "pos": "before",
                "value": "Bs"
            }, {
                "name": "伯利兹元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "博茨瓦纳普拉",
                "pos": "before",
                "value": "P"
            }, {
                "name": "不丹努扎姆",
                "pos": "before",
                "value": "Nu"
            }, {
                "name": "布隆迪法郎",
                "pos": "before",
                "value": "FBu"
            }, {
                "name": "朝鲜圆",
                "pos": "before",
                "value": "?KP"
            }, {
                "name": "丹麦克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "东加勒比元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "多米尼加比索",
                "pos": "before",
                "value": "RD$"
            }, {
                "name": "俄国卢布",
                "pos": "after",
                "value": "?"
            }, {
                "name": "厄立特里亚纳克法",
                "pos": "before",
                "value": "Nfk"
            }, {
                "name": "非洲金融共同体法郎",
                "pos": "before",
                "value": "CFA"
            }, {
                "name": "菲律宾比索",
                "pos": "before",
                "value": "?"
            }, {
                "name": "斐济元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "佛得角埃斯库多",
                "pos": "before",
                "value": "CVE"
            }, {
                "name": "福克兰群岛镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "冈比亚达拉西",
                "pos": "before",
                "value": "GMD"
            }, {
                "name": "刚果法郎",
                "pos": "before",
                "value": "FrCD"
            }, {
                "name": "哥伦比亚比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "哥斯达黎加科朗",
                "pos": "before",
                "value": "?"
            }, {
                "name": "古巴比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "古巴可兑换比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "圭亚那元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "哈萨克斯坦坚戈",
                "pos": "before",
                "value": "?"
            }, {
                "name": "海地古德",
                "pos": "before",
                "value": "HTG"
            }, {
                "name": "韩元",
                "pos": "before",
                "value": "?"
            }, {
                "name": "荷属安的列斯盾",
                "pos": "before",
                "value": "NAf."
            }, {
                "name": "洪都拉斯拉伦皮拉",
                "pos": "before",
                "value": "L"
            }, {
                "name": "吉布提法郎",
                "pos": "before",
                "value": "Fdj"
            }, {
                "name": "吉尔吉斯斯坦索姆",
                "pos": "before",
                "value": "KGS"
            }, {
                "name": "几内亚法郎",
                "pos": "before",
                "value": "FG"
            }, {
                "name": "加拿大元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "加纳塞地",
                "pos": "before",
                "value": "GHS"
            }, {
                "name": "柬埔寨瑞尔",
                "pos": "before",
                "value": "Riel"
            }, {
                "name": "捷克克朗",
                "pos": "after",
                "value": "K?"
            }, {
                "name": "津巴布韦元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "卡塔尔里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "开曼群岛元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "科摩罗法郎",
                "pos": "before",
                "value": "CF"
            }, {
                "name": "科威特第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "克罗地亚库纳",
                "pos": "before",
                "value": "kn"
            }, {
                "name": "肯尼亚先令",
                "pos": "before",
                "value": "Ksh"
            }, {
                "name": "莱索托洛蒂",
                "pos": "before",
                "value": "LSL"
            }, {
                "name": "老挝基普",
                "pos": "before",
                "value": "?"
            }, {
                "name": "黎巴嫩镑",
                "pos": "before",
                "value": "L￡"
            }, {
                "name": "立陶宛立特",
                "pos": "before",
                "value": "Lt"
            }, {
                "name": "利比亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "利比亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "卢旺达法郎",
                "pos": "before",
                "value": "RF"
            }, {
                "name": "罗马尼亚列伊",
                "pos": "before",
                "value": "RON"
            }, {
                "name": "马达加斯加阿里亚里",
                "pos": "before",
                "value": "Ar"
            }, {
                "name": "马尔代夫拉菲亚",
                "pos": "before",
                "value": "Rf"
            }, {
                "name": "马拉维克瓦查",
                "pos": "before",
                "value": "MWK"
            }, {
                "name": "马来西亚林吉特",
                "pos": "before",
                "value": "RM"
            }, {
                "name": "马其顿戴第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "毛里求斯卢比",
                "pos": "before",
                "value": "MURs"
            }, {
                "name": "毛里塔尼亚乌吉亚",
                "pos": "before",
                "value": "MRO"
            }, {
                "name": "蒙古图格里克",
                "pos": "before",
                "value": "?"
            }, {
                "name": "孟加拉塔卡",
                "pos": "before",
                "value": "?"
            }, {
                "name": "秘鲁新索尔",
                "pos": "before",
                "value": "S/"
            }, {
                "name": "缅甸开亚特",
                "pos": "before",
                "value": "K"
            }, {
                "name": "摩尔多瓦列伊",
                "pos": "before",
                "value": "MDL"
            }, {
                "name": "摩洛哥迪拉姆",
                "pos": "before",
                "value": "dh"
            }, {
                "name": "莫桑比克梅蒂卡尔",
                "pos": "before",
                "value": "MTn"
            }, {
                "name": "墨西哥比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "纳米比亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "南非兰特",
                "pos": "before",
                "value": "R"
            }, {
                "name": "南苏丹镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "尼加拉瓜科多巴",
                "pos": "before",
                "value": "C$"
            }, {
                "name": "尼泊尔卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "尼日利亚奈拉",
                "pos": "before",
                "value": "?"
            }, {
                "name": "挪威克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "乔治亚拉瑞",
                "pos": "before",
                "value": "GEL"
            }, {
                "name": "人民币（离岸）",
                "pos": "before",
                "value": "￥"
            }, {
                "name": "瑞典克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "瑞士法郎",
                "pos": "before",
                "value": "CHF"
            }, {
                "name": "塞尔维亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "塞拉利昂利昂",
                "pos": "before",
                "value": "SLL"
            }, {
                "name": "塞舌尔卢比",
                "pos": "before",
                "value": "SCR"
            }, {
                "name": "沙特里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "圣多美多布拉",
                "pos": "before",
                "value": "Db"
            }, {
                "name": "圣赫勒拿群岛磅",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "斯里兰卡卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "斯威士兰里兰吉尼",
                "pos": "before",
                "value": "SZL"
            }, {
                "name": "苏丹镑",
                "pos": "before",
                "value": "SDG"
            }, {
                "name": "苏里南元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "所罗门群岛元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "索马里先令",
                "pos": "before",
                "value": "SOS"
            }, {
                "name": "塔吉克斯坦索莫尼",
                "pos": "before",
                "value": "Som"
            }, {
                "name": "太平洋法郎",
                "pos": "after",
                "value": "FCFP"
            }, {
                "name": "泰国铢",
                "pos": "before",
                "value": "?"
            }, {
                "name": "坦桑尼亚先令",
                "pos": "before",
                "value": "TSh"
            }, {
                "name": "汤加潘加",
                "pos": "before",
                "value": "T$"
            }, {
                "name": "特立尼达和多巴哥元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "突尼斯第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "土耳其里拉",
                "pos": "before",
                "value": "?"
            }, {
                "name": "瓦努阿图瓦图",
                "pos": "before",
                "value": "VUV"
            }, {
                "name": "危地马拉格查尔",
                "pos": "before",
                "value": "Q"
            }, {
                "name": "委内瑞拉博利瓦",
                "pos": "before",
                "value": "Bs"
            }, {
                "name": "文莱元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "乌干达先令",
                "pos": "before",
                "value": "UGX"
            }, {
                "name": "乌克兰格里夫尼亚",
                "pos": "before",
                "value": "грн."
            }, {
                "name": "乌拉圭比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "乌兹别克斯坦苏姆",
                "pos": "before",
                "value": "so?m"
            }, {
                "name": "西萨摩亚塔拉",
                "pos": "before",
                "value": "WST"
            }, {
                "name": "新加坡元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "新台币",
                "pos": "before",
                "value": "NT$"
            }, {
                "name": "新西兰元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "匈牙利福林",
                "pos": "before",
                "value": "Ft"
            }, {
                "name": "叙利亚镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "牙买加元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "亚美尼亚德拉姆",
                "pos": "before",
                "value": "Dram"
            }, {
                "name": "也门里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "伊拉克第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "伊朗里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "以色列新谢克尔",
                "pos": "before",
                "value": "?"
            }, {
                "name": "印度卢比",
                "pos": "before",
                "value": "?"
            }, {
                "name": "印度尼西亚卢比",
                "pos": "before",
                "value": "Rp"
            }, {
                "name": "约旦第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "越南盾",
                "pos": "after",
                "value": "?"
            }, {
                "name": "赞比亚克瓦查",
                "pos": "before",
                "value": "ZMW"
            }, {
                "name": "直布罗陀镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "智利比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "中非金融合作法郎",
                "pos": "before",
                "value": "FCFA"
            }
        ],
        dateFmtList: [
            {
                "name": "1930-08-05",
                "value": "yyyy-MM-dd"
            },
            {
                "name": "1930/8/5",
                "value": "yyyy/MM/dd"
            },
            {
                "name": "1930年8月5日",
                "value": 'yyyy"年"M"月"d"日"'
            },
            {
                "name": "08-05",
                "value": "MM-dd"
            },
            {
                "name": "8-5",
                "value": "M-d"
            },
            {
                "name": "8月5日",
                "value": 'M"月"d"日"'
            },
            {
                "name": "13:30:30",
                "value": "h:mm:ss"
            },
            {
                "name": "13:30",
                "value": "h:mm"
            },
            {
                "name": "下午01:30",
                "value": 'AM/PM hh:mm'
            },
            {
                "name": "下午1:30",
                "value": 'AM/PM h:mm'
            },
            {
                "name": "下午1:30:30",
                "value": 'AM/PM h:mm:ss'
            },
            {
                "name": "08-05 下午01:30",
                "value": "MM-dd AM/PM hh:mm"
            },
            // {
            //     "name": "1930年8月5日星期二",
            //     "value": ''
            // },
            // {
            //     "name": "1930年8月5日星期二 下午1:30:30",
            //     "value": ''
            // },
        ],
        numFmtList: [
            {
                "name": "1235",
                "value": "0"
            },
            {
                "name": "1234.56",
                "value": "0.00"
            },
            {
                "name": "1,235",
                "value": "#,##0"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00"
            },
            {
                "name": "1,235",
                "value": "#,##0_);(#,##0)"
            },
            {
                "name": "1,235",
                "value": "#,##0_);[Red](#,##0)"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00_);(#,##0.00)"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00_);[Red](#,##0.00)"
            },
            {
                "name": "$1,235",
                "value": "$#,##0_);($#,##0)"
            },
            {
                "name": "$1,235",
                "value": "$#,##0_);[Red]($#,##0)"
            },
            {
                "name": "$1,234.56",
                "value": "$#,##0.00_);($#,##0.00)"
            },
            {
                "name": "$1,234.56",
                "value": "$#,##0.00_);[Red]($#,##0.00)"
            },
            {
                "name": "1234.56",
                "value": "@"
            },
            {
                "name": "123456%",
                "value": "0%"
            },
            {
                "name": "123456.00%",
                "value": "0.00%"
            },
            {
                "name": "1.23E+03",
                "value": "0.00E+00"
            },
            {
                "name": "1.2E+3",
                "value": "##0.0E+0"
            },
            {
                "name": "1234 5/9",
                "value": "# ?/?"
            },
            {
                "name": "1234 14/25",
                "value": "# ??/??"
            },
            {
                "name": "$ 1,235",
                "value": '_($* #,##0_);_(...($* "-"_);_(@_)'
            },
            {
                "name": "1,235",
                "value": '_(* #,##0_);_(*..._(* "-"_);_(@_)'
            },
            {
                "name": "$ 1,234.56",
                // "value": '_($* #,##0.00_)...* "-"??_);_(@_)'
                "value": '_($* #,##0.00_);_(...($* "-"_);_(@_)'
            },
            {
                "name": "1,234.56",
                "value": '_(* #,##0.00_);...* "-"??_);_(@_)'
            },
        ],
        createDialog: function(type){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-moreFormat-dialog").remove();

            var title = "", content = '';
            if(type == "morecurrency"){ //货币
                title = "货币格式";

                var listHtml = '';
                for(var i = 0; i < luckysheet.moreFormat.moneyFmtList.length; i++){
                    var name = luckysheet.moreFormat.moneyFmtList[i]["name"];
                    var pos = luckysheet.moreFormat.moneyFmtList[i]["pos"];
                    var value = luckysheet.moreFormat.moneyFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                    '<input type="hidden" value="'+ pos +'"/>'+
                                '</div>';
                }

                content = '<div class="box" id="morecurrency">'+
                            '<div class="decimal">'+
                                '<label>小数位数：</label>'+
                                '<input type="number" class="formulaInputFocus" value="2" min="0" max="9"/>'+
                            '</div>'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }
            else if(type == "moredatetime"){ //日期时间
                title = "日期与时间格式";

                var listHtml = '';
                for(var i = 0; i < luckysheet.moreFormat.dateFmtList.length; i++){
                    var name = luckysheet.moreFormat.dateFmtList[i]["name"];
                    var value = luckysheet.moreFormat.dateFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                '</div>';
                }

                content = '<div class="box" id="moredatetime">'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }
            else if(type == "moredigit"){ //数字
                title = "数字格式";

                var listHtml = '';
                for(var i = 0; i < luckysheet.moreFormat.numFmtList.length; i++){
                    var name = luckysheet.moreFormat.numFmtList[i]["name"];
                    var value = luckysheet.moreFormat.numFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                '</div>';
                }

                content = '<div class="box" id="moredigit">'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-moreFormat-dialog", "addclass": "luckysheet-moreFormat-dialog", "title": title, "content": content, "botton": '<button id="luckysheet-moreFormat-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default luckysheet-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-moreFormat-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-moreFormat-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            $("#luckysheet-moreFormat-dialog .listbox .listItem").eq(0).addClass("on");
        },
        init: function(){
            //选择格式
            $(document).on("click", "#luckysheet-moreFormat-dialog .listbox .listItem", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            //确定
            $(document).off("click.moreFormatConfirm").on("click.moreFormatConfirm", "#luckysheet-moreFormat-dialog #luckysheet-moreFormat-dialog-confirm", function(){
                $("#luckysheet-moreFormat-dialog").hide();
                $("#luckysheet-modal-dialog-mask").hide();

                var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);

                var value = $("#luckysheet-moreFormat-dialog .listbox .listItem.on .value").text();
                var id = $(this).parents("#luckysheet-moreFormat-dialog").find(".box").attr("id");

                if(id == "morecurrency"){ //货币
                    if(value.indexOf("?") != -1){
                        return;
                    }

                    var decimal = parseInt($("#luckysheet-moreFormat-dialog .decimal input").val().trim());

                    if(decimal.toString() == "NaN" || decimal < 0 || decimal > 9){
                        if(luckysheet.isEditMode()){
                            alert("小数位数必须在0-9之间！");
                        }   
                        else{
                            luckysheet.tooltip.info("小数位数必须在0-9之间！", "");
                        }

                        return;
                    }

                    var str = "";
                    if(decimal > 0){
                        for(var i = 1; i <= decimal; i++){
                            str += "0";
                        }
                        str = "0." + str;
                    }
                    else{
                        str = "#";
                    }

                    var pos = $("#luckysheet-moreFormat-dialog .listbox .listItem.on input:hidden").val();

                    if(pos == "before"){
                        str = '"'+value+'" ' + str;
                    }
                    else if(pos == "after"){
                        str = str + ' "'+value+'"';
                    }

                    luckysheet.menuButton.updateFormat(d, "ct", str);
                }
                else if(id == "moredatetime"){ //日期时间
                    luckysheet.menuButton.updateFormat(d, "ct", value);
                }
                else if(id == "moredigit"){ //数字
                    luckysheet.menuButton.updateFormat(d, "ct", value);
                }
            })
        }
    }

    //查找替换
    luckysheet.searchReplace = {
        createDialog: function(source){
            $("#luckysheet-modal-dialog-mask").hide();
            $("#luckysheet-search-replace").remove();

            var content = '<div class="tabBox">' +
                            '<span id="searchTab">查找</span>' +
                            '<span id="replaceTab">替换</span>' +
                          '</div>' +
                          '<div class="ctBox">' +
                            '<div class="inputBox">' +
                                '<div class="textboxs" id="searchInput">查找内容：<input class="formulaInputFocus" spellcheck="false" value=""/></div>' +
                                '<div class="textboxs" id="replaceInput">替换内容：<input class="formulaInputFocus" spellcheck="false" value=""/></div>' +
                                '<div class="checkboxs">' +
                                    '<div id="regCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>正则表达式匹配</span>' +
                                    '</div>' +    
                                    '<div id="wordCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>整词匹配</span>' +
                                    '</div>' +    
                                    '<div id="caseCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>区分大小写匹配</span>' +
                                    '</div>' +    
                                '</div>' +
                            '</div>' +
                            '<div class="btnBox">' +
                                '<button id="replaceAllBtn" class="btn btn-default">全部替换</button>' +
                                '<button id="replaceBtn" class="btn btn-default">替换</button>' +
                                '<button id="searchAllBtn" class="btn btn-default">查找全部</button>' +
                                '<button id="searchNextBtn" class="btn btn-default">查找下一个</button>' +
                            '</div>' +
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-search-replace", "addclass": "luckysheet-search-replace", "title": "", "content": content, "botton": '<button class="btn btn-default luckysheet-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-search-replace").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-search-replace").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        
            if(source == "0"){
                $("#luckysheet-search-replace #searchTab").addClass("on").siblings().removeClass("on");
                $("#luckysheet-search-replace #replaceInput").hide();
                $("#luckysheet-search-replace #replaceAllBtn").hide();
                $("#luckysheet-search-replace #replaceBtn").hide();
            }
            else if(source == "1"){
                $("#luckysheet-search-replace #replaceTab").addClass("on").siblings().removeClass("on");
                $("#luckysheet-search-replace #replaceInput").show();
                $("#luckysheet-search-replace #replaceAllBtn").show();
                $("#luckysheet-search-replace #replaceBtn").show();
            }
        },
        init: function(){
            //查找替换 切换
            $(document).off("click.SRtabBoxspan").on("click.SRtabBoxspan", "#luckysheet-search-replace .tabBox span", function(){
                $(this).addClass("on").siblings().removeClass("on");

                var $id = $(this).attr("id");
                if($id == "searchTab"){
                    $("#luckysheet-search-replace #replaceInput").hide();
                    $("#luckysheet-search-replace #replaceAllBtn").hide();
                    $("#luckysheet-search-replace #replaceBtn").hide();

                    $("#luckysheet-search-replace #searchInput input").focus();
                }
                else if($id == "replaceTab"){
                    $("#luckysheet-search-replace #replaceInput").show();
                    $("#luckysheet-search-replace #replaceAllBtn").show();
                    $("#luckysheet-search-replace #replaceBtn").show();

                    $("#luckysheet-search-replace #replaceInput input").focus();
                }
            });

            //查找下一个
            $(document).off("keyup.SRsearchInput").on("keyup.SRsearchInput", "#luckysheet-search-replace #searchInput input", function(event){
                var kcode = event.keyCode;
                if(kcode == keycode.ENTER){
                    luckysheet.searchReplace.searchNext();
                }
            });
            $(document).off("click.SRsearchNextBtn").on("click.SRsearchNextBtn", "#luckysheet-search-replace #searchNextBtn", function(){
                luckysheet.searchReplace.searchNext();
            });

            //查找全部
            $(document).off("click.SRsearchAllBtn").on("click.SRsearchAllBtn", "#luckysheet-search-replace #searchAllBtn", function(){
                luckysheet.searchReplace.searchAll();
            });
            $(document).off("click.SRsearchAllboxItem").on("click.SRsearchAllboxItem", "#luckysheet-search-replace #searchAllbox .boxItem", function(){
                $(this).addClass("on").siblings().removeClass("on");

                var r = $(this).attr("data-row");
                var c = $(this).attr("data-col");
                var sheetIndex = $(this).attr("data-sheetIndex");

                if(sheetIndex != luckysheet.currentSheetIndex){
                    luckysheet.sheetmanage.changeSheetExec(sheetIndex);
                }

                luckysheet_select_save = [
                    { "row": [r, r], "column": [c, c] }
                ];

                luckysheet.selectHightlightShow();

                var scrollLeft = $("#luckysheet-cell-main").scrollLeft(), scrollTop = $("#luckysheet-cell-main").scrollTop();
                var winH = $("#luckysheet-cell-main").height(), winW = $("#luckysheet-cell-main").width();

                var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                if (col - scrollLeft - winW + 20 > 0) {
                    $("#luckysheet-scrollbar-x").scrollLeft(col - winW + 20);
                }
                else if (col_pre - scrollLeft - 20 < 0) {
                    $("#luckysheet-scrollbar-x").scrollLeft(col_pre - 20);
                }

                if (row - scrollTop - winH + 20 > 0) {
                    $("#luckysheet-scrollbar-y").scrollTop(row - winH + 20);
                }
                else if (row_pre - scrollTop - 20 < 0) {
                    $("#luckysheet-scrollbar-y").scrollTop(row_pre - 20);
                }
            });

            //替换
            $(document).off("click.SRreplaceBtn").on("click.SRreplaceBtn", "#luckysheet-search-replace #replaceBtn", function(){
                luckysheet.searchReplace.replace();
            });

            //全部替换
            $(document).off("click.SRreplaceAllBtn").on("click.SRreplaceAllBtn", "#luckysheet-search-replace #replaceAllBtn", function(){
                luckysheet.searchReplace.replaceAll();
            });
        },
        searchNext: function(){
            var searchText = $("#luckysheet-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                return;
            }

            if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                var range = [{ "row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], luckysheet_select_save);                
            }

            var searchIndexArr = luckysheet.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(luckysheet.isEditMode()){
                    alert("没有查找到该内容");
                }
                else{
                    luckysheet.tooltip.info("没有查找到该内容", "");
                }

                return;
            }

            var count = 0;

            if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                if(luckysheet_select_save.length == 0){
                    count = 0;
                }
                else{
                    for(var i = 0; i < searchIndexArr.length; i++){
                        if(searchIndexArr[i].r == luckysheet_select_save[0].row[0] && searchIndexArr[i].c == luckysheet_select_save[0].column[0]){
                            if(i == searchIndexArr.length - 1){
                                count = 0;
                            }
                            else{
                                count = i + 1;
                            }

                            break;
                        }
                    }
                }

                luckysheet_select_save = [
                    { "row": [searchIndexArr[count].r, searchIndexArr[count].r], "column": [searchIndexArr[count].c, searchIndexArr[count].c] }
                ];

                
            }
            else{
                var rf = range[range.length - 1].row_focus;
                var cf = range[range.length - 1].column_focus;

                for(var i = 0; i < searchIndexArr.length; i++){
                    if(searchIndexArr[i].r == rf && searchIndexArr[i].c == cf){
                        if(i == searchIndexArr.length - 1){
                            count = 0;
                        }
                        else{
                            count = i + 1;
                        }

                        break;
                    }
                }

                for(var s = 0; s < range.length; s++){
                    var r1 = range[s].row[0], r2 = range[s].row[1];
                    var c1 = range[s].column[0], c2 = range[s].column[1];

                    if(searchIndexArr[count].r >= r1 && searchIndexArr[count].r <= r2 && searchIndexArr[count].c >= c1 && searchIndexArr[count].c <= c2){
                        var obj = range[s];
                        obj["row_focus"] = searchIndexArr[count].r;
                        obj["column_focus"] = searchIndexArr[count].c;
                        range.splice(s, 1);
                        range.push(obj);

                        break;
                    }
                }

                luckysheet_select_save = range;
            }

            luckysheet.selectHightlightShow();

            var scrollLeft = $("#luckysheet-cell-main").scrollLeft(), scrollTop = $("#luckysheet-cell-main").scrollTop();
            var winH = $("#luckysheet-cell-main").height(), winW = $("#luckysheet-cell-main").width();

            var row = visibledatarow[searchIndexArr[count].r], row_pre = searchIndexArr[count].r - 1 == -1 ? 0 : visibledatarow[searchIndexArr[count].r - 1];
            var col = visibledatacolumn[searchIndexArr[count].c], col_pre = searchIndexArr[count].c - 1 == -1 ? 0 : visibledatacolumn[searchIndexArr[count].c - 1];

            if (col - scrollLeft - winW + 20 > 0) {
                $("#luckysheet-scrollbar-x").scrollLeft(col - winW + 20);
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                $("#luckysheet-scrollbar-x").scrollLeft(col_pre - 20);
            }

            if (row - scrollTop - winH + 20 > 0) {
                $("#luckysheet-scrollbar-y").scrollTop(row - winH + 20);
            }
            else if (row_pre - scrollTop - 20 < 0) {
                $("#luckysheet-scrollbar-y").scrollTop(row_pre - 20);
            }
            
            if($("#searchAllbox").is(":visible")){
                $("#luckysheet-search-replace #searchAllbox .boxItem").removeClass("on");
            }
        },
        searchAll: function(){
            $("#luckysheet-search-replace #searchAllbox").remove();
            
            var searchText = $("#luckysheet-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                return;
            }

            if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                var range = [{ "row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], luckysheet_select_save);                
            }

            var searchIndexArr = luckysheet.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(luckysheet.isEditMode()){
                    alert("没有查找到该内容");
                }
                else{
                    luckysheet.tooltip.info("没有查找到该内容", "");
                }

                return;
            }

            var searchAllHtml = '';

            for(var i = 0; i < searchIndexArr.length; i++){
                var valueShowEs = luckysheet.mask.valueShowEs(searchIndexArr[i].r, searchIndexArr[i].c, luckysheet.flowdata).toString();

                if(valueShowEs.indexOf("</") > -1 && valueShowEs.indexOf(">") > -1){
                    searchAllHtml += '<div class="boxItem" data-row="' + searchIndexArr[i].r + '" data-col="' + searchIndexArr[i].c + '" data-sheetIndex="' + luckysheet.currentSheetIndex + '">' +
                                        '<span>' + luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].name + '</span>' +
                                        '<span>' + luckysheet.luckysheetchatatABC(searchIndexArr[i].c) + (searchIndexArr[i].r + 1) + '</span>' +
                                        '<span>' + valueShowEs + '</span>' +
                                     '</div>';
                }
                else{
                    searchAllHtml += '<div class="boxItem" data-row="' + searchIndexArr[i].r + '" data-col="' + searchIndexArr[i].c + '" data-sheetIndex="' + luckysheet.currentSheetIndex + '">' +
                                        '<span>' + luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].name + '</span>' +
                                        '<span>' + luckysheet.luckysheetchatatABC(searchIndexArr[i].c) + (searchIndexArr[i].r + 1) + '</span>' +
                                        '<span title="' + valueShowEs + '">' + valueShowEs + '</span>' +
                                     '</div>';
                }
            }
            
            $('<div id="searchAllbox"><div class="boxTitle"><span>工作表</span><span>单元格</span><span>值</span></div><div class="boxMain">' + searchAllHtml + '</div></div>').appendTo($("#luckysheet-search-replace"));
            
            $("#luckysheet-search-replace #searchAllbox .boxItem").eq(0).addClass("on").siblings().removeClass("on");

            luckysheet_select_save = [
                { "row": [searchIndexArr[0].r, searchIndexArr[0].r], "column": [searchIndexArr[0].c, searchIndexArr[0].c] }
            ];

            luckysheet.selectHightlightShow();
        },
        getSearchIndexArr: function(searchText, range){
            var arr = [];
            var obj = {};

            //正则表达式匹配
            var regCheck = false;
            if($("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            for(var s = 0; s < range.length; s++){
                var r1 = range[s].row[0], r2 = range[s].row[1];
                var c1 = range[s].column[0], c2 = range[s].column[1];

                for(var r = r1; r <= r2; r++){
                    for(var c = c1; c <= c2; c++){
                        var cell = luckysheet.flowdata[r][c];

                        if(cell != null){
                            var value = luckysheet.mask.valueShowEs(r, c, luckysheet.flowdata);

                            if(value == 0){
                                value = value.toString();
                            }

                            if(value != null && value != ""){
                                value = value.toString();

                                if(wordCheck){ //整词
                                    if(caseCheck){
                                        if(searchText == value){
                                            if(!((r + "_" + c) in obj)){
                                                obj[r + "_" + c] = 0;
                                                arr.push({"r": r, "c": c});
                                            }
                                        }
                                    }
                                    else{
                                        var txt = searchText.toLowerCase();
                                        if(txt == value.toLowerCase()){
                                            if(!((r + "_" + c) in obj)){
                                                obj[r + "_" + c] = 0;
                                                arr.push({"r": r, "c": c});
                                            }
                                        }
                                    }
                                }
                                else if(regCheck){ //正则表达式
                                    if(caseCheck){
                                        var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "g");
                                    }
                                    else{
                                        var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "ig");
                                    }

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                                else if(caseCheck){ //区分大小写
                                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "g");

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                                else{
                                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "ig");

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return arr;
        },
        replace: function(){
            var searchText = $("#luckysheet-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                if(luckysheet.isEditMode()){
                    alert("请输入查找内容");
                }
                else{
                    luckysheet.tooltip.info("请输入查找内容", "");
                }

                return;
            }

            if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                var range = [{ "row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], luckysheet_select_save);                
            }

            var searchIndexArr = luckysheet.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(luckysheet.isEditMode()){
                    alert("没有可替换的内容");
                }
                else{
                    luckysheet.tooltip.info("没有可替换的内容", "");
                }

                return;
            }

            var count = null;

            var rf = luckysheet_select_save[luckysheet_select_save.length - 1].row_focus;
            var cf = luckysheet_select_save[luckysheet_select_save.length - 1].column_focus;

            for(var i = 0; i < searchIndexArr.length; i++){
                if(searchIndexArr[i].r == rf && searchIndexArr[i].c == cf){
                    count = i;
                    break;
                }
            }

            if(count == null){
                if(searchIndexArr.length == 0){
                    if(luckysheet.isEditMode()){
                        alert("找不到匹配项");
                    }
                    else{
                        luckysheet.tooltip.info("找不到匹配项", "");
                    }

                    return;
                }
                else{
                    count = 0;
                }
            }

            //正则表达式匹配
            var regCheck = false;
            if($("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            var replaceText = $("#luckysheet-search-replace #replaceInput input").val();

            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);

            if(wordCheck){
                var r = searchIndexArr[count].r;
                var c = searchIndexArr[count].c;

                var v = replaceText;

                luckysheet.setcellvalue(r, c, d, v);
            }
            else{
                if(caseCheck){
                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "g");
                }
                else{
                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "ig");
                }

                var r = searchIndexArr[count].r;
                var c = searchIndexArr[count].c;

                var v = luckysheet.mask.valueShowEs(r, c, d).toString().replace(reg, replaceText);

                luckysheet.setcellvalue(r, c, d, v);
            }

            luckysheet_select_save = [{ "row": [r, r], "column": [c, c] }];

            if($("#luckysheet-search-replace #searchAllbox").is(":visible")){
                $("#luckysheet-search-replace #searchAllbox").hide();
            }

            luckysheet.jfrefreshgrid(d, luckysheet_select_save);
            luckysheet.selectHightlightShow();

            var scrollLeft = $("#luckysheet-cell-main").scrollLeft(), scrollTop = $("#luckysheet-cell-main").scrollTop();
            var winH = $("#luckysheet-cell-main").height(), winW = $("#luckysheet-cell-main").width();

            var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
            var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

            if (col - scrollLeft - winW + 20 > 0) {
                $("#luckysheet-scrollbar-x").scrollLeft(col - winW + 20);
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                $("#luckysheet-scrollbar-x").scrollLeft(col_pre - 20);
            }

            if (row - scrollTop - winH + 20 > 0) {
                $("#luckysheet-scrollbar-y").scrollTop(row - winH + 20);
            }
            else if (row_pre - scrollTop - 20 < 0) {
                $("#luckysheet-scrollbar-y").scrollTop(row_pre - 20);
            }
        },
        replaceAll: function(){
            var searchText = $("#luckysheet-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                if(luckysheet.isEditMode()){
                    alert("请输入查找内容");
                }
                else{
                    luckysheet.tooltip.info("请输入查找内容", "");
                }

                return;
            }

            if(luckysheet_select_save.length == 0 || (luckysheet_select_save.length == 1 && luckysheet_select_save[0].row[0] == luckysheet_select_save[0].row[1] && luckysheet_select_save[0].column[0] == luckysheet_select_save[0].column[1])){
                var range = [{ "row": [0, luckysheet.flowdata.length - 1], "column": [0, luckysheet.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], luckysheet_select_save);                
            }

            var searchIndexArr = luckysheet.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(luckysheet.isEditMode()){
                    alert("没有可替换的内容");
                }
                else{
                    luckysheet.tooltip.info("没有可替换的内容", "");
                }

                return;
            }

            //正则表达式匹配
            var regCheck = false;
            if($("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            var replaceText = $("#luckysheet-search-replace #replaceInput input").val();

            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);
            var range = [];

            if(wordCheck){
                for(var i = 0; i < searchIndexArr.length; i++){
                    var r = searchIndexArr[i].r;
                    var c = searchIndexArr[i].c;

                    var v = replaceText;

                    luckysheet.setcellvalue(r, c, d, v);

                    range.push({ "row": [r, r], "column": [c, c] });
                }
            }
            else{
                if(caseCheck){
                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "g");
                }
                else{
                    var reg = new RegExp(luckysheet.func_methods.getRegExpStr(searchText), "ig");
                }

                for(var i = 0; i < searchIndexArr.length; i++){
                    var r = searchIndexArr[i].r;
                    var c = searchIndexArr[i].c;

                    var v = luckysheet.mask.valueShowEs(r, c, d).toString().replace(reg, replaceText);

                    luckysheet.setcellvalue(r, c, d, v);

                    range.push({ "row": [r, r], "column": [c, c] });
                }
            }

            if($("#luckysheet-search-replace #searchAllbox").is(":visible")){
                $("#luckysheet-search-replace #searchAllbox").hide();
            }

            luckysheet.jfrefreshgrid(d, range);

            luckysheet_select_save = $.extend(true, [], range);
            luckysheet.selectHightlightShow();

            if(luckysheet.isEditMode()){
                alert("已经帮您搜索并进行了" + searchIndexArr.length + "处替换");
            }
            else{
                luckysheet.tooltip.info("已经帮您搜索并进行了" + searchIndexArr.length + "处替换", "");
            }
        }
    }

    //分列
    luckysheet.splitColumn = {
        createDialog: function(){
            $("#luckysheet-modal-dialog-mask").show();
            $("#luckysheet-splitColumn-dialog").remove();

            var content = '<div class="box">' +
                            '<div class="boxTitle">分割符号</div>' +
                            '<div class="boxMain">' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_01" type="checkbox"/>' +
                                    '<label for="splitColumn_type_01">Tab 键</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_02" type="checkbox"/>' +
                                    '<label for="splitColumn_type_02">分号</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_03" type="checkbox"/>' +
                                    '<label for="splitColumn_type_03">逗号</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_04" type="checkbox"/>' +
                                    '<label for="splitColumn_type_04">空格</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_05" type="checkbox"/>' +
                                    '<label for="splitColumn_type_05">其它</label>' +
                                    '<input type="text" class="formulaInputFocus" maxlength="1"/>' +
                                '</div>' +
                            '</div>' +
                            '<div style="height: 22px;line-height: 22px;">' +
                                '<input id="splitColumn_type_06" type="checkbox"/>' +
                                '<label for="splitColumn_type_06">连续分隔符号视为单个处理</label>' +
                            '</div>' +
                            '<div class="boxTitle" style="margin-top: 10px;">数据预览</div>' +
                            '<div class="boxMain" id="splitColumnData">' +

                            '</div>' +
                          '</div>';

            $("body").append(luckysheet.replaceHtml(modelHTML, { "id": "luckysheet-splitColumn-dialog", "addclass": "luckysheet-splitColumn-dialog", "title": "文本分列", "content": content, "botton": '<button id="luckysheet-splitColumn-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default luckysheet-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#luckysheet-splitColumn-dialog").find(".luckysheet-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#luckysheet-splitColumn-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            var dataArr = luckysheet.splitColumn.getDataArr();
            luckysheet.splitColumn.dataPreview(dataArr);
        },
        init: function(){
            //数据预览
            $(document).off("change.SPCinpcheckbox").on("change.SPCcheckbox", "#luckysheet-splitColumn-dialog .box input[type='checkbox']", function(){
                var regStr = luckysheet.splitColumn.getRegStr();
                var dataArr = luckysheet.splitColumn.getDataArr(regStr);
                luckysheet.splitColumn.dataPreview(dataArr);
            });
            $(document).off("keyup.SPCinptext").on("keyup.SPCinptext", "#luckysheet-splitColumn-dialog .box input[type='text']", function(){
                if($(this).siblings("input[type='checkbox']").is(":checked")){
                    var regStr = luckysheet.splitColumn.getRegStr();
                    var dataArr = luckysheet.splitColumn.getDataArr(regStr);
                    luckysheet.splitColumn.dataPreview(dataArr);
                }
            })

            //确定按钮
            $(document).off("click.SPCconfirm").on("click.SPCconfirm", "#luckysheet-splitColumn-dialog #luckysheet-splitColumn-dialog-confirm", function(){
                $("#luckysheet-modal-dialog-mask").hide();
                $("#luckysheet-splitColumn-dialog").hide();

                var regStr = luckysheet.splitColumn.getRegStr();
                var dataArr = luckysheet.splitColumn.getDataArr(regStr);

                var r = luckysheet_select_save[0].row[0];
                var c = luckysheet_select_save[0].column[0];

                if(dataArr[0].length == 1){
                    return;
                }

                var dataCover = false;
                for(var i = 0; i < dataArr.length; i++){
                    for(var j = 1; j < dataArr[0].length; j++){
                        var cell = luckysheet.flowdata[r + i][c + j];

                        if(cell != null && cell.v != null){
                            dataCover = true;
                            break;
                        }
                    }
                }

                if(dataCover){
                    var func1 = function(){
                        luckysheet.splitColumn.update(r, c, dataArr);
                    } 
                    luckysheet.tooltip.confirm("提示", "此处已有数据，是否替换它？", func1);
                }
                else{
                    luckysheet.splitColumn.update(r, c, dataArr);
                }
            });
        },
        update: function(r, c, dataArr){
            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);

            for(var i = 0; i < dataArr.length; i++){
                for(var j = 0; j < dataArr[0].length; j++){
                    var v = dataArr[i][j];
                    luckysheet.setcellvalue(r + i, c + j, d, v);
                }
            }

            var st_r = luckysheet_select_save[0].row[0], 
                st_c = luckysheet_select_save[0].column[0];

            var range = [{ "row": [st_r, st_r + dataArr.length - 1], "column": [st_c, st_c + dataArr[0].length - 1] }]

            luckysheet.jfrefreshgrid(d, range);
            luckysheet.selectHightlightShow();
        },
        dataPreview: function(dataArr){
            $("#luckysheet-splitColumn-dialog #splitColumnData").empty();

            var trHtml = '';
            for(var i = 0; i < dataArr.length; i++){
                var tdHtml = '';
                for(var j = 0; j < dataArr[0].length; j++){
                    tdHtml += '<td>' + dataArr[i][j] + '</td>';
                }

                trHtml += '<tr>' + tdHtml + '</tr>';
            }

            var tableHtml = '<table>' + trHtml + '</table>';

            $("#luckysheet-splitColumn-dialog #splitColumnData").append(tableHtml);
        },
        getRegStr: function(){
            var regStr = '', mark = 0;

            $("#luckysheet-splitColumn-dialog .box input[type='checkbox']:checked").each(function(i, e){
                var $id = $(e).attr("id");

                if($id == "splitColumn_type_01"){ //Tab键
                    regStr += "\\t";
                    mark++;
                }
                else if($id == "splitColumn_type_02"){ //分号
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += ";";
                    mark++;
                }
                else if($id == "splitColumn_type_03"){ //逗号
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += ",";
                    mark++;
                }
                else if($id == "splitColumn_type_04"){ //空格
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += "\\s";
                    mark++;
                }
                else if($id == "splitColumn_type_05"){ //其它
                    var txt = $(e).siblings("input[type='text']").val().trim();

                    if(txt != ""){
                        if(mark > 0){
                            regStr += "|";
                        }

                        regStr += txt;
                    }
                }
                else if($id == "splitColumn_type_06"){ //连续分隔符号视为单个处理
                    regStr = "[" + regStr + "]+";
                }
            })

            return regStr;
        },
        getDataArr: function(regStr){
            var arr = [];

            var r1 = luckysheet_select_save[0].row[0];
            var r2 = luckysheet_select_save[0].row[1];
            var c = luckysheet_select_save[0].column[0];

            if(regStr != null && regStr != ""){
                var reg = new RegExp(regStr, "g");

                var dataArr = [];
                for(var r = r1; r <= r2; r++){
                    var rowArr = [];

                    var cell = luckysheet.flowdata[r][c];

                    if(cell != null && cell["m"] != null){
                        var value = cell["m"];
                    }
                    else{
                        var value = luckysheet.getcellvalue(r, c, luckysheet.flowdata);
                    }

                    rowArr = value.toString().split(reg);

                    dataArr.push(rowArr);
                }

                var rlen = dataArr.length;
                var clen = 0;

                for(var i = 0; i < rlen; i++){
                    if(dataArr[i].length > clen){
                        clen = dataArr[i].length;
                    }
                }

                arr = luckysheet.splitColumn.getNullData(rlen, clen);

                for(var i = 0; i < arr.length; i++){
                    for(var j = 0; j < arr[0].length; j++){
                        if(dataArr[i][j] != null){
                            arr[i][j] = dataArr[i][j];
                        }
                    }
                }
            }
            else{
                for(var r = r1; r <= r2; r++){
                    var rowArr = [];

                    var cell = luckysheet.flowdata[r][c];

                    if(cell != null && cell["m"] != null){
                        var value = cell["m"];
                    }
                    else{
                        var value = luckysheet.getcellvalue(r, c, luckysheet.flowdata);
                    }

                    rowArr.push(value);

                    arr.push(rowArr);
                }
            }

            return arr;
        },
        getNullData: function(rlen, clen){
            var arr = [];

            for(var r = 0; r < rlen; r++){
                var rowArr = [];

                for(var c = 0; c < clen; c++){
                    rowArr.push("");
                }

                arr.push(rowArr);
            }

            return arr;
        }
    }

    

    luckysheet.hasChinaword = function (s) {
        var patrn = /[\u4E00-\u9FA5]|[\uFE30-\uFFA0]/gi;
        if (!patrn.exec(s)) {
            return false;
        }
        else {
            return true;
        }
    }

    luckysheet.getdatabyselectionD = function (d, range) {
        if (range == null || range["row"] == null || range["row"].length == 0) {
            return [];
        }
        
        var dynamicArray_compute = luckysheet.dynamicArray_compute(luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["dynamicArray"]);
        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            if(d[r] == null){
                continue;
            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                continue;
            }

            var row = [];

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                var value;
                
                if((r + "_" + c) in dynamicArray_compute){
                    value = dynamicArray_compute[r + "_" + c];
                }
                else{
                    value = d[r][c];
                }

                row.push(value);
            }

            data.push(row);
        }

        return data;
    }

    luckysheet.getdatabyselection = function (range, sheetIndex) {
        if(range == null){
            range = luckysheet_select_save[0];
        }

        if (range["row"] == null || range["row"].length == 0) {
            return [];
        }

        //取数据
        if(sheetIndex != null && sheetIndex != luckysheet.currentSheetIndex){
            var d = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["data"];
            var cfg = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)]["config"];
        }
        else{
            var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);
            var cfg = config;    
        }

        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            if(d[r] == null){
                continue;
            }

            if (cfg["rowhidden"] != null && cfg["rowhidden"][r] != null) {
                continue;
            }

            var row = [];

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                row.push(d[r][c]);
            }

            data.push(row);
        }

        return data;
    }

    //计算范围行高
    luckysheet.rowlenByRange = function(d, r1, r2, cfg){
        var cfg_clone = $.extend(true, {}, cfg);
        if(cfg_clone["rowlen"] == null){
            cfg_clone["rowlen"] = {};
        }

        var ctcanvas = $("#luckysheetTableContent").get(0).getContext("2d");
        for(var r = r1; r <= r2; r++){
            if (cfg_clone["rowhidden"] != null && cfg_clone["rowhidden"][r] != null) {
                continue;
            }

            var currentRowLen = defaultrowlen;
            if(cfg_clone["rowlen"][r] != null){
                currentRowLen = cfg_clone["rowlen"][r];
            }

            for(var c = 0; c < d[r].length; c++){
                if(d[r][c] != null && d[r][c]["v"] != null && d[r][c]["tb"] != null && d[r][c]["tb"] == "2"){
                    //自动换行
                    var fontset = luckysheetfontformat(d[r][c]);
                    ctcanvas.font = fontset;
                    var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];

                    var cellText = luckysheet.getcellvalue(r,c,d).toString(); //单元格文本
                    var textWidth = ctcanvas.measureText(cellText).width; //文本宽度
                    var cellWidth = luckysheet.colLocationByIndex(c)[1] - luckysheet.colLocationByIndex(c)[0] - 8; //单元格宽度

                    var computeRowlen; //计算行高
                    if(textWidth > cellWidth){
                        var strArr = []; //文本截断数组
                        for(var strI = 1; strI <= cellText.length; strI++){
                            var strV = cellText.substring(strArr.join("").length, strI);
                            var strtextMetrics = ctcanvas.measureText(strV).width;
                            if(strtextMetrics > cellWidth){
                                strArr.push(cellText.substring(strArr.join("").length, strI-1));
                                strI = strI-2;
                            }
                            else if(strtextMetrics <= cellWidth && strI == cellText.length){
                                strArr.push(strV);
                            }
                        }
                        computeRowlen = oneLineTextHeight * strArr.length;
                    }
                    else{
                        computeRowlen = oneLineTextHeight;
                    }
                    //比较计算行高和当前行高取最大高度
                    if(computeRowlen > currentRowLen){
                        currentRowLen = computeRowlen;
                    }
                }
                else if(d[r][c] != null && d[r][c]["v"] != null && d[r][c]["tr"] != null){
                    //文本旋转
                    var fontset = luckysheetfontformat(d[r][c]);
                    ctcanvas.font = fontset;
                    var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];

                    var cellText = luckysheet.getcellvalue(r,c,d).toString(); //单元格文本
                    var textWidth = ctcanvas.measureText(cellText).width; //文本宽度

                    var computeRowlen; //计算行高
                    if(d[r][c]["tr"] == "0"){
                        //无旋转
                        computeRowlen = oneLineTextHeight;
                    }
                    else if(d[r][c]["tr"] == "1" || d[r][c]["tr"] == "2"){
                        //向下倾斜（45 旋转）----向上倾斜（-45 旋转）
                        computeRowlen = 0.707 * (textWidth + oneLineTextHeight) + 4;
                    }
                    else if(d[r][c]["tr"] == "3"){
                        //竖排文字
                        computeRowlen = cellText.length * oneLineTextHeight + 4;
                    }
                    else if(d[r][c]["tr"] == "4" || d[r][c]["tr"] == "5"){
                        //向下90（90 旋转）----向上90（-90 旋转）
                        computeRowlen = textWidth + 4;
                    }
                    computeRowlen = Math.round(computeRowlen);
                    //比较计算高度和当前高度取最大高度
                    if(computeRowlen > currentRowLen){
                        currentRowLen = computeRowlen;
                    }
                } 
                else{
                    var fontset = luckysheetfontformat(d[r][c]);
                    var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];
                    //比较计算高度和当前高度取最大高度
                    if(oneLineTextHeight > currentRowLen){
                        currentRowLen = oneLineTextHeight;
                    }
                }
            }

            if(currentRowLen != defaultrowlen){
                cfg_clone["rowlen"][r] = currentRowLen;
            }
        }

        return cfg_clone;
    }

    //计算表格行高数组
    luckysheet.computeRowlenArr = function(rowHeight, cfg){
        var rowlenArr = [];
        var rh_height = 0;

        for (var i = 0; i < rowHeight; i++) {
            var rowlen = defaultrowlen;
            if (cfg["rowlen"] != null && cfg["rowlen"][i] != null) {
                rowlen = cfg["rowlen"][i];
            }
            if (cfg["rowhidden"] != null && cfg["rowhidden"][i] != null) {
                rowlen = cfg["rowhidden"][i];
                rowlenArr.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            rowlenArr.push(rh_height);//行的临时长度分布
        }

        return rowlenArr;
    }

    luckysheet.getdatabyselectionNoCopy = function (range) {
        if (range == null || range["row"] == null || range["row"].length == 0) {
            return [];
        }

        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            var row = [];
            
            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                continue;
            }

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                var value = "";

                if (luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null) {
                    value = luckysheet.flowdata[r][c];
                }

                row.push(value);
            }
            
            data.push(row);
        }

        return data;
    }

    luckysheet.datagridgrowth = function (data, addr, addc, iscallback) {
        if (addr <= 0 && addc <= 0) {
            return data;
        }

        if (addr <= 0) {
            addr = 0;
        }

        if (addc <= 0) {
            addc = 0;
        }

        var dataClen = 0;
        if (data.length == 0) {
            data = [];
            dataClen = 0;
        }
        else {
            dataClen = data[0].length;
        }

        var coladd = [];//需要额外增加的空列
        for (var c = 0; c < addc; c++) {
            coladd.push(null);
        }

        var rowadd = [];//完整的一个空行
        for (var r = 0; r < dataClen + addc; r++) {
            rowadd.push(null);
        }

        for (var r = 0; r < data.length; r++) {
            data[r] = [].concat(data[r].concat(coladd));
        }

        for (var r = 0; r < addr; r++) {
            data.push([].concat(rowadd));
        }

        if(!!iscallback){
            luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, data.length, { "k": "row" });
            luckysheet.server.saveParam("all", luckysheet.currentSheetIndex, data[0].length, { "k": "column" });
        }

        return data;
    }

    luckysheet.cleargridelement = function (event) {
        $("#luckysheet-cols-h-hover").hide();
        $("#luckysheet-rightclick-menu").hide();

        $("#luckysheet-cell-selected-boxs .luckysheet-cell-selected").hide();
        $("#luckysheet-cols-h-selected .luckysheet-cols-h-selected").hide();
        $("#luckysheet-rows-h-selected .luckysheet-rows-h-selected").hide();

        $("#luckysheet-cell-selected-focus").hide();
        $("#luckysheet-rows-h-hover").hide();
        $("#luckysheet-selection-copy .luckysheet-selection-copy").hide();
        $("#luckysheet-cols-menu-btn").hide();
        $("#luckysheet-row-count-show, #luckysheet-column-count-show").hide();
        if (!event) {
            luckysheet.selection.clearcopy(event);
        }
        //else{
        //	luckysheet.selection.clearcopy();
        //}

        //选区下拉icon隐藏
        if($("#luckysheet-dropCell-icon").is(":visible")){
            if(event){
                $("#luckysheet-dropCell-icon").remove();
            }
        }
        //格式刷
        if(luckysheet.menuButton.luckysheetPaintModelOn && !event){
            luckysheet.menuButton.cancelPaintModel();
        }
    }

    luckysheet.orderbydata = function (data, index, isAsc) {
        if (isAsc == null) {
            isAsc = true;
        }

        var a = function (x, y) {
            var x1 = x[index] , y1 = y[index];

            if(luckysheet.getObjType(x[index]) == "object"){
                x1 = x[index].v;
            }

            if(luckysheet.getObjType(y[index]) == "object"){
                y1 = y[index].v;
            }

            if(luckysheet.func_methods.isRealNull(x1)){
                return 1;
            }

            if(luckysheet.func_methods.isRealNull(y1)){
                return -1;
            }

            // if(x1 == null){
            //     x1 = "";
            // }

            // if(y1 == null){
            //     y1 = "";
            // }

            if (luckysheet.datecontroll.isdatetime(x1) && luckysheet.datecontroll.isdatetime(y1)) {
                return luckysheet.datecontroll.diff(x1, y1);
            }
            else if (luckysheet.func_methods.isRealNum(x1) && luckysheet.func_methods.isRealNum(y1)) {
                return numeral(x1).value() - numeral(y1).value();
            }
            else if (!luckysheet.func_methods.isRealNum(x1) && !luckysheet.func_methods.isRealNum(y1)) {
                return x1.localeCompare(y1, "zh");
            }
            else if (!luckysheet.func_methods.isRealNum(x1)) {
                return 1;
            }
            else if (!luckysheet.func_methods.isRealNum(y1)) {
                return -1;
            }
        }

        var d = function (x, y) {
            var x1 = x[index] , y1 = y[index];

            if(luckysheet.getObjType(x[index]) == "object"){
                x1 = x[index].v;
            }

            if(luckysheet.getObjType(y[index]) == "object"){
                y1 = y[index].v;
            }

            if(luckysheet.func_methods.isRealNull(x1)){
                return 1;
            }

            if(luckysheet.func_methods.isRealNull(y1)){
                return -1;
            }

            // if(x1 == null){
            //     x1 = "";
            // }

            // if(y1 == null){
            //     y1 = "";
            // }

            if (luckysheet.datecontroll.isdatetime(x1) && luckysheet.datecontroll.isdatetime(y1)) {
                return luckysheet.datecontroll.diff(y1, x1);
            }
            else if (luckysheet.func_methods.isRealNum(x1) && luckysheet.func_methods.isRealNum(y1)) {
                return numeral(y1).value() - numeral(x1).value();
            }
            else if (!luckysheet.func_methods.isRealNum(x1) && !luckysheet.func_methods.isRealNum(y1)) {
                return y1.localeCompare(x1, "zh");
            }
            else if (!luckysheet.func_methods.isRealNum(x1)) {
                return -1;
            }
            else if (!luckysheet.func_methods.isRealNum(y1)) {
                return 1;
            }
        }

        if (isAsc) {
            return data.sort(a);
        }
        else {
            return data.sort(d);
        }
    }

    luckysheet.orderbydata1D = function (data, isAsc) {
        if (isAsc == null) {
            isAsc = true;
        }

        var a = function (x, y) {
            var x1 = x, y1 = y;

            if(luckysheet.getObjType(x) == "object"){
                x1 = x.v;
            }

            if(luckysheet.getObjType(y) == "object"){
                y1 = y.v;
            }

            if(x1 == null){
                x1 = "";
            }

            if(y1 == null){
                y1 = "";
            }

            if (luckysheet.datecontroll.isdatetime(x1) && luckysheet.datecontroll.isdatetime(y1)) {
                return luckysheet.datecontroll.diff(x1, y1);
            }
            else if (luckysheet.func_methods.isRealNum(x1) && luckysheet.func_methods.isRealNum(y1)) {
                return numeral(x1).value() - numeral(y1).value();
            }
            else if (!luckysheet.func_methods.isRealNum(x1) && !luckysheet.func_methods.isRealNum(y1)) {
                return x1.localeCompare(y1, "zh");
            }
            else if (!luckysheet.func_methods.isRealNum(x1)) {
                return 1;
            }
            else if (!luckysheet.func_methods.isRealNum(y1)) {
                return -1;
            }
        }

        var d = function (x, y) {
            var x1 = x, y1 = y;

            if(luckysheet.getObjType(x) == "object"){
                x1 = x.v;
            }

            if(luckysheet.getObjType(y) == "object"){
                y1 = y.v;
            }

            if(x1 == null){
                x1 = "";
            }

            if(y1 == null){
                y1 = "";
            }

            if (luckysheet.datecontroll.isdatetime(x1) && luckysheet.datecontroll.isdatetime(y1)) {
                return luckysheet.datecontroll.diff(y1, x1);
            }
            else if (luckysheet.func_methods.isRealNum(x1) && luckysheet.func_methods.isRealNum(y1)) {
                return numeral(y1).value() - numeral(x1).value();
            }
            else if (!luckysheet.func_methods.isRealNum(x1) && !luckysheet.func_methods.isRealNum(y1)) {
                return y1.localeCompare(x1, "zh");
            }
            else if (!luckysheet.func_methods.isRealNum(x1)) {
                return -1;
            }
            else if (!luckysheet.func_methods.isRealNum(y1)) {
                return 1;
            }
        }

        if (isAsc) {
            return data.sort(a);
        }
        else {
            return data.sort(d);
        }
    }

    //排序选区数据
    luckysheet.sortSelection = function(isAsc){
        if(luckysheet_select_save.length > 1){
            if(luckysheet.isEditMode()){
                alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
            }
            else{
                luckysheet.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
            }

            return;
        }

        if(isAsc == null){
            isAsc = true;
        }

        var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);

        var r1 = luckysheet_select_save[0].row[0], r2 = luckysheet_select_save[0].row[1];
        var c1 = luckysheet_select_save[0].column[0], c2 = luckysheet_select_save[0].column[1];

        var str, edr;

        for(var r = r1; r <= r2; r++){
            if(d[r] != null && d[r][c1] != null){
                var cell = d[r][c1];

                if(cell.mc != null || luckysheet.func_methods.isRealNull(cell.v)){
                    continue;
                }

                if(str == null && /[\u4e00-\u9fa5]+/g.test(cell.v)){
                    str = r + 1;
                    edr = r + 1;
                    continue;
                }
                
                if(str == null){
                    str = r;    
                }

                edr = r;
            }
        }

        if(str == null || str > r2){
            return;
        }

        var hasMc = false; //排序选区是否有合并单元格
        var data = [];

        for(var r = str; r <= edr; r++){
            var data_row = [];

            for(var c = c1; c <= c2; c++){
                if(d[r][c] != null && d[r][c].mc != null){
                    hasMc = true;
                    break;
                }

                data_row.push(d[r][c]);
            }

            data.push(data_row);
        }

        if(hasMc){
            if(luckysheet.isEditMode()){
                alert("选区有合并单元格，无法执行此操作！");
            }
            else{
                luckysheet.tooltip.info("选区有合并单元格，无法执行此操作！", "");
            }

            return;
        }

        data = luckysheet.orderbydata(data, 0, isAsc);

        for(var r = str; r <= edr; r++){
            for(var c = c1; c <= c2; c++){
                d[r][c] = data[r - str][c - c1];
            }
        }

        if(config["rowlen"] != null){
            var cfg = $.extend(true, {}, config);
            cfg = luckysheet.rowlenByRange(d, str, edr, cfg);

            luckysheet.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }], cfg, null, true);
        }
        else{
            luckysheet.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }]);
        }
    }

    //排序一列数据
    luckysheet.sortColumnSeletion = function(colIndex, isAsc){
        if(isAsc == null){
            isAsc = true;
        }

        var d = luckysheet.editor.deepCopyFlowData(luckysheet.flowdata);

        var r1 = 0, r2 = d.length - 1;
        var c1 = 0, c2 = d[0].length - 1;

        var str, edr;

        for(var r = r1; r <= r2; r++){
            if(d[r][colIndex] != null && d[r][colIndex].mc != null){
                continue;
            }

            if(d[r][colIndex] != null && !luckysheet.func_methods.isRealNull(d[r][colIndex].v) && /[\u4e00-\u9fa5]+/g.test(d[r][colIndex].v) && str == null){
                str = r + 1;
                edr = r + 1;
                continue;
            }

            if(str == null){
                str = r;    
            }

            if(d[r][colIndex] != null && !luckysheet.func_methods.isRealNull(d[r][colIndex].v)){
                edr = r;
            }
        }

        if(str == null || str > r2){
            return;
        }

        var hasMc = false; //排序选区是否有合并单元格
        var data = [];

        for(var r = str; r <= edr; r++){
            var data_row = [];

            for(var c = c1; c <= c2; c++){
                if(d[r][c] != null && d[r][c].mc != null){
                    hasMc = true;
                    break;
                }

                data_row.push(d[r][c]);
            }

            data.push(data_row);
        }

        if(hasMc){
            if(luckysheet.isEditMode()){
                alert("列排序会扩展至整个表格选区，选区有合并单元格，无法执行此操作，请选择功能栏排序功能！");
            }
            else{
                luckysheet.tooltip.info("列排序会扩展至整个表格选区，选区有合并单元格，无法执行此操作，请选择功能栏排序功能！", "");
            }

            return;
        }

        data = luckysheet.orderbydata(data, colIndex, isAsc);

        for(var r = str; r <= edr; r++){
            for(var c = c1; c <= c2; c++){
                d[r][c] = data[r - str][c - c1];
            }
        }

        if(config["rowlen"] != null){
            var cfg = $.extend(true, {}, config);
            cfg = luckysheet.rowlenByRange(d, str, edr, cfg);

            luckysheet.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }], cfg, null, true);
        }
        else{
            luckysheet.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }]);
        }
    }

    /*
    data: [{"name":"Sheet1",color:"","status":"1","order":"0","data":[], "theme":{}},{"name":"Sheet2",color:"","status":"0","order":"1","data":[]},{"name":"Sheet3",color:"","status":"0","order":"2","data":[]}],
    */
    var ;

    luckysheet.getluckysheetfile = function(){
        return luckysheetfile;
    }

    luckysheet.setluckysheetfile = function (d) {
        luckysheetfile = d;
    }

    luckysheet.getconfig = function () {
        return config;
    };

    luckysheet.setconfig = function (v) {
        config = v;

        if(luckysheetfile != null){
            luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].config = v;
        }
    };

    luckysheet.getvisibledatarow = function(){
        return visibledatarow;
    };

    luckysheet.setvisibledatarow = function (v) {
        visibledatarow = v;

        if(luckysheetfile != null){
            luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].visibledatarow = v;
        }
    };

    luckysheet.getvisibledatacolumn = function () {
        return visibledatacolumn;
    };

    luckysheet.setvisibledatacolumn = function (v) {
        visibledatacolumn = v;

        if(luckysheetfile != null){
            luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].visibledatacolumn = v;
        }
    };

    

   

    

    luckysheet.filterseletedbyindex = function (r1, r2, c1, c2) {
        var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
        var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

        $('#luckysheet-filter-selected-sheet' + luckysheet.currentSheetIndex).css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 });
        $option = $('#luckysheet-filter-options-sheet' + luckysheet.currentSheetIndex).find(".luckysheet-filter-options");
        for (var c = c1; c <= c2; c++) {
            $option.eq(c - c1).css({ "left": (visibledatacolumn[c] - 20), "top": visibledatarow[r1 - 1] });
        }
    }

    

    //范围是否只包含部分合并单元格
    luckysheet.hasPartMC = function(cfg, r1, r2, c1, c2){
        var hasPartMC = false;

        for(x in config["merge"]){
            var mc = cfg["merge"][x];

            if(r1 < mc.r){
                if(r2 >= mc.r && r2 < (mc.r + mc.rs - 1)){
                    if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 >= mc.r && r2 == (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 > mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 > (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
            }
            else if(r1 == mc.r){
                if(r2 < (mc.r + mc.rs - 1)){
                    if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 >= (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
            }
            else if(r1 <= (mc.r + mc.rs - 1)){
                if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
                else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
                else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
            }
        }

        return hasPartMC;
    }

    //范围是否都是空单元格(除第一个单元格)
    luckysheet.dynamicArray_rangeIsAllNull = function(range, data){
        var r1 = range["row"][0], r2 = range["row"][1];
        var c1 = range["column"][0], c2 = range["column"][1];

        var isAllNull = true;
        for(var r = r1; r <= r2; r++){
            for(var c = c1; c <= c2; c++){
                if(!(r == r1 && c == c1) && data[r][c] != null && data[r][c].v != null && data[r][c].v.toString() != ""){
                    isAllNull = false;
                    break;
                }
            }
        }

        return isAllNull;
    }
    luckysheet.dynamicArray_spillEditCompute = function(computeObj, r, c){
        var rowIndex = computeObj[r + "_" + c].r;
        var colIndex = computeObj[r + "_" + c].c;

        for(x in computeObj){
            if(x == (rowIndex + "_" + colIndex)){
                computeObj[x].v = "#SPILL!";
            }
            else if(computeObj[x].r == rowIndex && computeObj[x].c == colIndex){
                delete computeObj[x];
            }
        }

        return computeObj;
    }

    //点击表格区域是否属于动态数组区域
    luckysheet.dynamicArray_hightShow = function(r, c){
        var dynamicArray = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["dynamicArray"] == null ? [] : luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["dynamicArray"];
        var dynamicArray_compute = luckysheet.dynamicArray_compute(dynamicArray);
    
        if((r + "_" + c) in dynamicArray_compute && dynamicArray_compute[r + "_" + c].v != "#SPILL!"){
            var d_row = dynamicArray_compute[r + "_" + c].r;
            var d_col = dynamicArray_compute[r + "_" + c].c;

            var d_f = luckysheet.flowdata[d_row][d_col].f;

            var rlen, clen;
            for(var i = 0; i < dynamicArray.length; i++){
                if(dynamicArray[i].f == d_f){
                    rlen = dynamicArray[i].data.length;

                    if(luckysheet.getObjType(dynamicArray[i].data[0]) == "array"){
                        clen = dynamicArray[i].data[0].length;
                    }
                    else{
                        clen = 1;
                    }
                }
            }

            var d_row_end = d_row + rlen - 1;
            var d_col_end = d_col + clen - 1;

            var row = visibledatarow[d_row_end], row_pre = d_row - 1 == -1 ? 0 : visibledatarow[d_row - 1];
            var col = visibledatacolumn[d_col_end], col_pre = d_col - 1 == -1 ? 0 : visibledatacolumn[d_col - 1];

            $("#luckysheet-dynamicArray-hightShow").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "display": "block" });
        }
        else{
            $("#luckysheet-dynamicArray-hightShow").hide();
        }
    }

    //动态数组计算
    luckysheet.dynamicArray_compute = function(dynamicArray){
        var dynamicArray_compute = {};

        if(luckysheet.getObjType(dynamicArray) == "array"){
            for(var i = 0; i < dynamicArray.length; i++){
                var d_row = dynamicArray[i].r;
                var d_col = dynamicArray[i].c;
                var d_f = dynamicArray[i].f;
                
                if(luckysheet.flowdata[d_row][d_col] != null && luckysheet.flowdata[d_row][d_col].f != null && luckysheet.flowdata[d_row][d_col].f == d_f){
                    if((d_row + "_" + d_col) in dynamicArray_compute){
                        dynamicArray_compute = luckysheet.dynamicArray_spillEditCompute(dynamicArray_compute, d_row , d_col);
                    }

                    var d_data = dynamicArray[i].data;
                    var d_rowlen = d_data.length;
                    var d_collen = 1;

                    if(luckysheet.getObjType(d_data[0]) == "array"){
                        d_collen = d_data[0].length;
                    }

                    if(luckysheet.dynamicArray_rangeIsAllNull({ "row": [d_row, d_row + d_rowlen - 1], "column": [d_col, d_col + d_collen - 1] }, luckysheet.flowdata)){
                        for(var x = 0; x < d_rowlen; x++){
                            for(var y = 0; y < d_collen; y++){
                                var rowIndex = d_row + x;
                                var colIndex = d_col + y;

                                if(luckysheet.getObjType(d_data[0]) == "array"){
                                    dynamicArray_compute[rowIndex + "_" + colIndex] = {"v": d_data[x][y], "r": d_row, "c": d_col};
                                }
                                else{
                                    dynamicArray_compute[rowIndex + "_" + colIndex] = {"v": d_data[x], "r": d_row, "c": d_col};
                                }
                            }
                        }
                    }
                    else{
                        dynamicArray_compute[d_row + "_" + d_col] = {"v": "#SPILL!", "r": d_row, "c": d_col};
                    }
                }
            }
        }

        return dynamicArray_compute;       
    }

    
    

    //获取表格边框数据计算值
    luckysheet.getBorderInfoCompute = function(sheetIndex){
        var borderInfoCompute = {};

        if(sheetIndex == null){
            var cfg = config;
            var data = luckysheet.flowdata;
        }
        else{
            var cfg = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)].config;
            var data = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(sheetIndex)].data;
        }

        var borderInfo = cfg["borderInfo"];

        if(borderInfo != null && borderInfo.length > 0){
            for(var i = 0; i < borderInfo.length; i++){
                var rangeType = borderInfo[i].rangeType;

                if(rangeType == "range"){
                    var borderType = borderInfo[i].borderType;
                    var borderColor = borderInfo[i].color;
                    var borderStyle = borderInfo[i].style;

                    var borderRange = borderInfo[i].range;

                    for(var j = 0; j < borderRange.length; j++){
                        var bd_r1 = borderRange[j].row[0], bd_r2 = borderRange[j].row[1];
                        var bd_c1 = borderRange[j].column[0], bd_c2 = borderRange[j].column[1];

                        if(borderType == "border-left"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }
                                
                                if(borderInfoCompute[bd_r + "_" + bd_c1] == null){
                                    borderInfoCompute[bd_r + "_" + bd_c1] = {};
                                }

                                borderInfoCompute[bd_r + "_" + bd_c1].l = { "color": borderColor, "style": borderStyle };

                                var bd_c_left = bd_c1 - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc.c + mc.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-right"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }
                                
                                if(borderInfoCompute[bd_r + "_" + bd_c2] == null){
                                    borderInfoCompute[bd_r + "_" + bd_c2] = {};
                                }

                                borderInfoCompute[bd_r + "_" + bd_c2].r = { "color": borderColor, "style": borderStyle };

                                var bd_c_right = bd_c2 + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-top"){
                            if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r1] != null) {
                                continue;
                            }

                            for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                if(borderInfoCompute[bd_r1 + "_" + bd_c] == null){
                                    borderInfoCompute[bd_r1 + "_" + bd_c] = {};
                                }

                                borderInfoCompute[bd_r1 + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };

                                var bd_r_top = bd_r1 - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && luckysheet.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc.r + mc.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-bottom"){
                            if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r2] != null) {
                                continue;
                            }

                            for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                if(borderInfoCompute[bd_r2 + "_" + bd_c] == null){
                                    borderInfoCompute[bd_r2 + "_" + bd_c] = {};
                                }

                                borderInfoCompute[bd_r2 + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };

                                var bd_r_bottom = bd_r2 + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && luckysheet.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];

                                        var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-all"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                        var cell = data[bd_r][bd_c];

                                        var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                        if(mc.r == bd_r){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                        
                                        if(mc.r + mc.rs - 1 == bd_r){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }

                                        if(mc.c == bd_c){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        }
                                        
                                        if(mc.c + mc.cs - 1 == bd_c){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                    }

                                    if(bd_r == bd_r1){
                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            if(data[bd_r_top] != null && luckysheet.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                                var cell_top = data[bd_r_top][bd_c];

                                                var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                                if(mc.r + mc.rs - 1 == bd_r_top){
                                                    borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                    }
                                    
                                    if(bd_r == bd_r2){
                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            if(data[bd_r_bottom] != null && luckysheet.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                                var cell_bottom = data[bd_r_bottom][bd_c];

                                                var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                                if(mc.r == bd_r_bottom){
                                                    borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                    
                                    if(bd_c == bd_c1){
                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                                var cell_left = data[bd_r][bd_c_left];

                                                var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                                if(mc.c + mc.cs - 1 == bd_c_left){
                                                    borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                    
                                    if(bd_c == bd_c2){
                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                                var cell_right = data[bd_r][bd_c_right];

                                                var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                                if(mc.c == bd_c_right){
                                                    borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-outside"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(!(bd_r == bd_r1 || bd_r == bd_r2 || bd_c == bd_c1 || bd_c == bd_c2)){
                                        continue;
                                    }

                                    if(bd_r == bd_r1){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };

                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            if(data[bd_r_top] != null && luckysheet.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                                var cell_top = data[bd_r_top][bd_c];

                                                var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                                if(mc.r + mc.rs - 1 == bd_r_top){
                                                    borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                    }

                                    if(bd_r == bd_r2){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };

                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            if(data[bd_r_bottom] != null && luckysheet.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                                var cell_bottom = data[bd_r_bottom][bd_c];

                                                var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                                if(mc.r == bd_r_bottom){
                                                    borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }

                                    if(bd_c == bd_c1){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };

                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                                var cell_left = data[bd_r][bd_c_left];

                                                var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                                if(mc.c + mc.cs - 1 == bd_c_left){
                                                    borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }

                                    if(bd_c == bd_c2){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };

                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                                var cell_right = data[bd_r][bd_c_right];

                                                var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                                if(mc.c == bd_c_right){
                                                    borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-inside"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_r == bd_r1 && bd_c == bd_c1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2 && bd_c == bd_c1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r1 && bd_c == bd_c2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2 && bd_c == bd_c2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }    
                                }
                            }
                        }
                        else if(borderType == "border-horizontal"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_r == bd_r1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-vertical"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_c == bd_c1){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c2){
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-none"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(borderInfoCompute[bd_r + "_" + bd_c] != null){
                                        delete borderInfoCompute[bd_r + "_" + bd_c];
                                    }

                                    if(bd_r == bd_r1){
                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            delete borderInfoCompute[bd_r_top + "_" + bd_c].b;
                                        }
                                    }
                                    
                                    if(bd_r == bd_r2){
                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            delete borderInfoCompute[bd_r_bottom + "_" + bd_c].t;
                                        }
                                    }
                                    
                                    if(bd_c == bd_c1){
                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            delete borderInfoCompute[bd_r + "_" + bd_c_left].r;
                                        }
                                    }
                                    
                                    if(bd_c == bd_c2){
                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            delete borderInfoCompute[bd_r + "_" + bd_c_right].l;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else if(rangeType == "cell"){
                    var value = borderInfo[i].value;

                    var bd_r = value.row_index, bd_c = value.col_index;

                    if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                        continue;
                    }

                    if(value.l != null || value.r != null || value.t != null || value.b != null){
                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                        }

                        if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                            var cell = data[bd_r][bd_c];
                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                            if(value.l != null && bd_c == mc.c){ //左边框
                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": value.l.color, "style": value.l.style };

                                var bd_c_left = bd_c - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc_l = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc_l.c + mc_l.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].l = null;
                            }

                            if(value.r != null && bd_c == mc.c + mc.cs - 1){ //右边框
                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": value.r.color, "style": value.r.style };

                                var bd_c_right = bd_c + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc_r = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc_r.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].r = null;
                            }

                            if(value.t != null && bd_r == mc.r){ //上边框
                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": value.t.color, "style": value.t.style };

                                var bd_r_top = bd_r - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && luckysheet.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc_t = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc_t.r + mc_t.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].t = null;
                            }

                            if(value.b != null && bd_r == mc.r + mc.rs - 1){ //下边框
                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": value.b.color, "style": value.b.style };

                                var bd_r_bottom = bd_r + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && luckysheet.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];
                                        
                                        var mc_b = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc_b.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].b = null;
                            }
                        }
                        else{
                            if(value.l != null){ //左边框
                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": value.l.color, "style": value.l.style };

                                var bd_c_left = bd_c - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc_l = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc_l.c + mc_l.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].l = null;
                            }

                            if(value.r != null){ //右边框
                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": value.r.color, "style": value.r.style };

                                var bd_c_right = bd_c + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && luckysheet.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc_r = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc_r.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].r = null;
                            }

                            if(value.t != null){ //上边框
                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": value.t.color, "style": value.t.style };

                                var bd_r_top = bd_r - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && luckysheet.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc_t = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc_t.r + mc_t.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].t = null;
                            }

                            if(value.b != null){ //下边框
                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": value.b.color, "style": value.b.style };

                                var bd_r_bottom = bd_r + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && luckysheet.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];
                                        
                                        var mc_b = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc_b.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].b = null;
                            }
                        }
                    }
                    else{
                        delete borderInfoCompute[bd_r + "_" + bd_c];
                    }
                }
            }
        }

        return borderInfoCompute;
    }

    

    var showrightclickmenu = function ($menu, x, y) {
        var winH = $(window).height(), winW = $(window).width();
        var menuW = $menu.width(), menuH = $menu.height();
        var top = y, left = x;
        if (x + menuW > winW) {
            left = x - menuW;
        }

        if (y + menuH > winH) {
            top = y - menuH;
        }

        if (top < 0) {
            top = 0;
        }

        $menu.css({ "top": top, "left": left }).show();
    }

    luckysheet.showrightclickmenu = showrightclickmenu;

    function mouseclickposition($menu, x, y, p) {
        var winH = $(window).height(), winW = $(window).width();
        var menuW = $menu.width(), menuH = $menu.height();
        var top = y, left = x;

        if (p == null) {
            p = "lefttop";
        }

        if (p == "lefttop") {
            $menu.css({ "top": y, "left": x }).show();
        }
        else if (p == "righttop") {
            $menu.css({ "top": y, "left": x - menuW }).show();
        }
        else if (p == "leftbottom") {
            $menu.css({ "bottom": winH - y - 12, "left": x }).show();
        }
        else if (p == "rightbottom") {
            $menu.css({ "bottom": winH - y - 12, "left": x - menuW }).show();
        }
    }

    //function luckysheetsliderlistitemfilter($filter) {

    //}


    var luckysheetfontformat = function(format){
        if(luckysheet.getObjType(format) == "object"){
            var font = "";

            //font-style
            if(format.it == "0" || format.it == null){
                font += "normal ";
            }
            else{
                font += "italic ";
            }

            //font-variant
            font += "normal ";

            //font-weight
            if(format.bl == "0"  || format.bl == null){
                font += "normal ";
            }
            else{
                font += "bold ";
            }

            //font-size/line-height
            if(!format.fs){
                font += Math.ceil(10 * devicePixelRatio) + "pt ";
            }
            else{
                font += Math.ceil(format.fs * devicePixelRatio) + "pt ";
            }

            if(!format.ff){
                font += '微软雅黑, "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif';
            }
            else{
                var fontarray = luckysheet.menuButton.fontarray;
                var fontfamily = null;
                if(luckysheet.isdatatypemulti(format.ff)["num"]){
                    fontfamily = fontarray[parseInt(format.ff)];
                }
                else{
                    fontfamily = fontarray[luckysheet.menuButton.fontjson[format.ff]];
                }

                if(fontfamily == null){
                    fontfamily = "微软雅黑";
                }
                font += fontfamily + ', "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif';
            }

            return font;
        }
        else{
            return luckysheetdefaultstyle.font;
        }
    }
    luckysheet.luckysheetfontformat = luckysheetfontformat;

    

    

    luckysheet.method = {
        //翻页
        addDataAjax:function(param, index, url, func){
            var _this = this;
            if(index == null){
                index = luckysheet.currentSheetIndex;
            }

            if(url == null){
                url = luckysheet.server.loadSheetUrl;
            }

            $("#luckysheet-grid-window-1").append(luckysheetlodingHTML);
            //param.currentPage <=1 ? param.currentPage = 2 :param.currentPage++;
            param.currentPage++;
            //var arg = {"gridKey" : luckysheet.server.gridKey, "index": index};
            //param = $.extend(true, param, arg);
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(index)];
            var dataType = 'application/json;charset=UTF-8';
            // var token = sessionStorage.getItem('token');
            // rptapp
            var token = sessionStorage.getItem('x-auth-token');

            $.ajax({
                method: 'POST',
                url: url,
                // rptapp
                // headers:{"x-auth-token":JSON.parse(token)},
                headers:{"x-auth-token":token},
                data:JSON.stringify(param),
                contentType: dataType,
                success: function(d) {
                    //d可能为json字符串
                    if(typeof d == "string"){
                        d = JSON.parse(d);
                    }

                    var dataset = d.data;
                    
                    // var file = dataset[luckysheet.sheetmanage.getSheetIndex(index)];
                    // var newData = file.celldata;
                    // luckysheet.luckysheetextendData(file["row"], newData);
                    
                    // rptapp
                    var newData = dataset.celldata;
                    luckysheet.luckysheetextendData(dataset["row"], newData);
                   

                    setTimeout(function(){
                        $("#luckysheetloadingdata").fadeOut().remove();
                    }, 500);

                    if(func && typeof(func)=="function"){ 
                        func(dataset);
                    }
                }
            })
        },
        //重载
        reload:function(param, index, url, func){
            var _this = this;
            if(index == null){
                index = luckysheet.currentSheetIndex;
            }

            if(url == null){
                url = luckysheet.server.loadSheetUrl;
            }

            $("#luckysheet-grid-window-1").append(luckysheetlodingHTML);

            var arg = {"gridKey" : luckysheet.server.gridKey, "index": index};
            param = $.extend(true, param, arg);
            var file = luckysheetfile[luckysheet.sheetmanage.getSheetIndex(index)];

            $.post(url, param, function (d) {
                var dataset = eval("(" + d + ")");
                file.celldata = dataset[index.toString()];
                var data = luckysheet.sheetmanage.buildGridData(file);

                setTimeout(function(){
                    $("#luckysheetloadingdata").fadeOut().remove();
                }, 500);

                //luckysheet.sheetmanage.setSheetParam();
                file["data"] = data;
                luckysheet.flowdata = data;
                luckysheet.editor.webWorkerFlowDataCache(data);//worker存数据

                luckysheet.luckysheetcreatesheet(data[0].length, data.length, data, null, false);
                file["load"] = "1";

                luckysheet_select_save = [];
                luckysheet_selection_range = [];

                luckysheet.server.saveParam("shs", null, luckysheet.currentSheetIndex);

                luckysheet.sheetmanage.changeSheet(index);

                if(func && typeof(func)=="function"){ 
                    func();
                }
            });
        },
        clearSheetByIndex:function(i){
            var index = luckysheet.sheetmanage.getSheetIndex(i);
            var sheetfile = luckysheetfile[index];
            if(!sheetfile.isPivotTable){
                sheetfile.data = [];
                sheetfile.row = defaultrowNum;
                sheetfile.column = defaultcolumnNum;

                sheetfile.chart = [];
                sheetfile.config = null;
                sheetfile.filter = null;
                sheetfile.filter_select = null;
                sheetfile.celldata = [];
                sheetfile.pivotTable = {};
                sheetfile.calcChain = [];
                sheetfile.status = 0;
                sheetfile.load = 0;

                luckysheet.flowdata = [];
                luckysheet.editor.webWorkerFlowDataCache(luckysheet.flowdata);//worker存数据

                $("#"+ container +" .luckysheet-data-visualization-chart").remove();
                $("#"+ container +" .luckysheet-datavisual-selection-set").remove();

                $("#luckysheet-row-count-show, #luckysheet-formula-functionrange-select, #luckysheet-row-count-show, #luckysheet-column-count-show, #luckysheet-change-size-line, #luckysheet-cell-selected-focus, #luckysheet-selection-copy, #luckysheet-cell-selected-extend, #luckysheet-cell-selected-move, #luckysheet-cell-selected").hide();

                delete sheetfile.load;
            }
            else {
                // delete sheetfile;
                delete luckysheetfile[index];
            }
        },
        clear:function(index){
            var _this = this;
            if(index == "all"){
                for(var i=0;i<luckysheetfile.length;i++){
                    var sheetfile = luckysheetfile[i];
                    _this.clearSheetByIndex(sheetfile.index);
                }
                
            }
            else{
                if(index == null){
                    index = luckysheet.currentSheetIndex;
                }
                _this.clearSheetByIndex(index);
            }

            luckysheet.sheetmanage.changeSheet(luckysheetfile[0].index);
        },
        destroy:function(){
            $("#" + container).empty();
            // $("body > .luckysheet-cols-menu, body > .luckysheet-modal-dialog-slider").remove();
            $("body > .luckysheet-cols-menu").remove();

            $("#luckysheet-modal-dialog-mask, #luckysheetTextSizeTest, #luckysheet-icon-morebtn-div").remove();
            $("#luckysheet-input-box").parent().remove();
            $("#luckysheet-formula-help-c").remove();
            
            //参数重置
            luckysheet.jfredo = [];
            luckysheet.jfundo = [];

            luckysheetFreezen.initialHorizontal = true;
            luckysheetFreezen.initialVertical = true;
            luckysheetConfigsetting.pointEdit = false;
        },
        editorChart:function(c){
            var file = luckysheetfile[0];
            var chart_selection_color = luckyColor[0];
            var chart_id = "luckysheetEditMode-datav-chart";
            var chart_selection_id = chart_id + "_selection";
            c.chart_id = chart_id;
            var chartTheme = c.chartTheme;
            chartTheme = chartTheme==null?"default0000":chartTheme;

            luckysheet.insertChartTosheet(c.sheetIndex, c.dataSheetIndex, c.option, c.chartType, c.selfOption, c.defaultOption, c.row, c.column, chart_selection_color, chart_id, chart_selection_id, c.chartStyle, c.rangeConfigCheck, c.rangeRowCheck, c.rangeColCheck, c.chartMarkConfig, c.chartTitleConfig, c.winWidth, c.winHeight, c.scrollLeft, c.scrollTop, chartTheme, c.myWidth, c.myHeight, c.myLeft!=null?parseFloat(c.myLeft):null, c.myTop!=null?parseFloat(c.myTop):null, c.myindexrank, true);

            $("#"+chart_id).find(".luckysheet-modal-controll-update").click();
        }
    }

    luckysheet.jfrefreshchartall = function (flowdata1, r_st, r_ed, c_st, c_ed) {
        //chartMix
        !!window.generator && generator.changeChartCellDataHook(flowdata1, r_st, r_ed, c_st, c_ed);
        // $("#luckysheet-cell-main .luckysheet-data-visualization-chart[sheetindex='" + luckysheet.currentSheetIndex + "']").each(function () {
        //     luckysheet.jfrefreshchart($(this), flowdata1, r_st, r_ed, c_st, c_ed);    
        // });
    }

    luckysheet.jfrefreshchart = function ($obj, flowdata1, r_st, r_ed, c_st, c_ed) {
        var row = eval('(' + $obj.attr("row") + ')'), column = eval('(' + $obj.attr("column") + ')');

        if (r_st > row[1] || r_ed < row[0] || c_st > column[1] || c_ed < column[0]) {
            return;
        }
        //console.log(row[1], row[0], column[1], column[0], r_st, r_ed, c_st, c_ed, r_st > row[1] ,r_ed < row[0], c_st > column[1] , c_ed < column[0]);
        var type = $obj.attr("chartType"), style = $obj.attr("chartStyle"), selfOption = $obj.attr("selfOption"), defaultOption = $obj.attr("defaultOption"), chartMarkConfig = $obj.attr("chartMarkConfig"), chartTitleConfig = $obj.attr("chartTitleConfig"), chartTheme = $obj.attr("chartTheme");

        //console.log(type, style, selfOption, chartMarkConfig, chartTitleConfig, luckysheet.chartparam.luckysheetcurrentChart);

        luckysheet.chartparam.jgridCurrentChartSelection = { "row": row, "column": column };
        luckysheet.chartparam.jgridCurrentChartData = luckysheet.getdatabyselectionD(flowdata1, luckysheet.chartparam.jgridCurrentChartSelection);

        if (luckysheet.chartparam.jgridCurrentChartData.length >= luckysheet.chartparam.jgridCurrentChartData[0].length) {
            rangeConfigCheck = false;
        }
        else {
            rangeConfigCheck = true;
        }

        if (luckysheet.chartparam.jgridCurrentChartData.length == 1) {
            rangeRowCheck = false;
        }
        else{
            rangeRowCheck = true;
        }

        if (luckysheet.chartparam.jgridCurrentChartData[0].length == 1) {
            rangeColCheck = false;
        }
        else{
            rangeColCheck = true;
        }

        luckysheet.range_config(rangeConfigCheck, rangeRowCheck, rangeColCheck);

        luckysheet.chartparam.luckysheetcurrentChart = echarts.getInstanceById($obj.find(".luckysheet-modal-dialog-content").attr("_echarts_instance_"));
        if(luckysheet.getObjType(chartMarkConfig) != "object"){
            chartMarkConfig = eval('('+ chartMarkConfig +')');
        }

        if(luckysheet.getObjType(chartTitleConfig) != "object"){
            chartTitleConfig = eval('('+ chartTitleConfig +')');
        }

        if(luckysheet.getObjType(selfOption) != "object"){
            selfOption = eval('('+ selfOption +')');
        }

        luckysheet.chartparam.luckysheet_chart_mark_config = chartMarkConfig;
        luckysheet.chartparam.luckysheet_chart_title_config = chartTitleConfig;
        luckysheet.chartparam.luckysheet_chart_self_config = selfOption == null ? {} : selfOption;
        //luckysheet.chartparam.luckysheet_chart_default_config = defaultOption;
        luckysheet.luckysheet_datavisual_item_active("datachange", type, style);
        // = chartTheme


        if(typeof luckysheet.luckysheetConfigsetting.chartConfigChange == "function" ){
            luckysheet.luckysheetConfigsetting.chartConfigChange({ "sheetIndex": $obj.attr("sheetIndex"), "dataSheetIndex": $obj.attr("dataSheetIndex"), "option": luckysheet.chartparam.luckysheetcurrentChart.getOption(), "chartType": type, "selfOption": selfOption, "defaultOption": defaultOption, "row": row, "column": column, "chart_id": $obj.attr("chart_id"), "chart_selection_color": $obj.attr("chart_selection_color"), "chart_selection_id": $obj.attr("chart_selection_id"), "chartStyle": style, "rangeConfigCheck": rangeConfigCheck, "rangeRowCheck": rangeRowCheck, "rangeColCheck": rangeColCheck, "chartMarkConfig": chartMarkConfig, "chartTitleConfig": chartTitleConfig, "chartTheme": chartTheme });
        }

        // luckysheet.chartparam.luckysheetcurrentChart = null;
        // luckysheet.chartparam.luckysheet_chart_mark_config = null;
        // luckysheet.chartparam.luckysheet_chart_title_config = null;
    }


    //得到单元格的值
    luckysheet.getcellvalue = function (r, c, data, type) {
        try {
            if (type == null) {
                type = "v";
            }

            if (data == null) {
                data = luckysheet.flowdata;
            }

            var d_value;

            if (r != null && c != null) {
                d_value = data[r][c];
            }
            else if (r != null) {
                d_value = data[r];
            }
            else if (c != null) {
                var newData = data[0].map(function(col, i) {
                    return data.map(function(row) {
                        return row[i];
                    })
                });
                d_value = newData[c];
            }
            else {
                return data;
            }

            var retv = d_value;

            if(luckysheet.getObjType(d_value) == "object"){
                retv = d_value[type];

                if (type == "f" && retv != null) {
                    retv = luckysheet.formula.functionHTMLGenerate(retv);
                }
                else if(type == "f"){
                    retv = d_value["v"];
                }else if(d_value && d_value.ct && d_value.ct.fa == 'yyyy-MM-dd'){
                    retv = d_value.m
                }
            }

            if(retv == undefined){
                retv = null;
            }

            return retv;
        }
        catch(err) {
            console.log(err);
        }
    }

    //new runze 根据亿万格式autoFormatw和精确度accuracy 转换成 w/w0/w0.00 or 0/0.0格式
    luckysheet.setAccuracy = function(autoFormatw, accuracy){
        var acc = "0.";
        var fmt;
        if(autoFormatw == "TRUE"){
            if(accuracy == undefined){
                return "w";
            }else{
                var alength = parseInt(accuracy);
                if(alength == 0){
                    return "w0";
                }else{
                   acc = "w0."
                   for(var i = 0; i < alength; i++){
                       acc += "0";
                   }
                    fmt = acc;
                }
                
            }
        }else{
            if(accuracy == undefined){
                return "General";
            }else{
                var alength = parseInt(accuracy);
                if(alength == 0){
                    return "0";
                }else{
                   for(var i = 0; i < alength; i++){
                       acc += "0";
                   }
                    fmt = acc;
                }
                
            }
        }

        return fmt.toString();     
    }

    //设置单元格的值
    luckysheet.setcellvalue = function (r, c, d, v) {
        var cell = d[r][c];

        var vupdate;

        if(luckysheet.getObjType(v) == "object"){
            cell = v;

            if(v.f != null){
                cell.f = v.f;
            }

            if(v.spl != null){
                cell.spl = v.spl;
            }

            if(luckysheet.getObjType(v.v) == "object"){
                vupdate = v.v.v;
            }
            else{
                vupdate = v.v;
            }
        }
        else{
            var vupdate = v;
        }

        if(luckysheet.func_methods.isRealNull(vupdate)){
            if(luckysheet.getObjType(cell) == "object"){
                delete cell.m;
                delete cell.v;
            }
            else{
                cell = null;
            }

            d[r][c] = cell;

            return;
        }

        if(luckysheet.func_methods.isRealNull(cell)){
            cell = {};
        }
        
        if(vupdate.toString().substr(0, 1) == "'"){
            cell.m = vupdate.toString().substr(1);
            cell.ct = { "fa": "@", "t": "s" };
            cell.v = vupdate.toString().substr(1);
        }
        else if(vupdate.toString().toUpperCase() === "TRUE"){
            cell.m = "TRUE";
            cell.ct = { "fa": "General", "t": "b" };
            cell.v = true;
        }
        else if(vupdate.toString().toUpperCase() === "FALSE"){
            cell.m = "FALSE";
            cell.ct = { "fa": "General", "t": "b" };
            cell.v = false;
        }
        else if(luckysheet.func_methods.valueIsError(vupdate)){
            cell.m = vupdate.toString();
            cell.ct = { "fa": "General", "t": "e" };
            cell.v = vupdate;
        }
        else{
            if(cell.f != null && luckysheet.func_methods.isRealNum(vupdate) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(vupdate)){
                cell.v = parseFloat(vupdate);
                cell.ct = { "fa": "General", "t": "n" };

                if(cell.v == Infinity || cell.v == -Infinity){
                    cell.m = cell.v.toString();
                }
                else{
                    if(cell.v.toString().indexOf("e") > -1){
                        var len = cell.v.toString().split(".")[1].split("e")[0].length;
                        if(len > 5){
                            len = 5;
                        }

                        cell.m = cell.v.toExponential(len).toString();
                    }
                    else{
                        var mask = luckysheet.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);

                        cell.m = mask[0].toString(); 
                    }
                }
            }
            else if(cell.ct != null && cell.ct.fa == "@"){
                cell.m = vupdate.toString();
                cell.v = vupdate;
            }
            else if(cell.ct != null && cell.ct.fa != null && cell.ct.fa != "General"){
                if(luckysheet.func_methods.isRealNum(vupdate)){
                    vupdate = parseFloat(vupdate);
                }

                var mask = luckysheet.mask.update(cell.ct.fa, vupdate);

                if(mask === vupdate){ //若原来单元格格式 应用不了 要更新的值，则获取更新值的 格式
                    mask = luckysheet.mask.genarate(vupdate);

                    cell.m = mask[0].toString();
                    cell.ct = mask[1];
                    cell.v = mask[2];
                }
                else{
                    cell.m = mask.toString();
                    cell.v = vupdate;
                }
            }
            else{
                if(luckysheet.func_methods.isRealNum(vupdate) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(vupdate)){
                    vupdate = parseFloat(vupdate);

                    cell.v = parseFloat(vupdate);
                    cell.ct = { "fa": "General", "t": "n" };

                    if(cell.v == Infinity || cell.v == -Infinity){
                        cell.m = cell.v.toString();
                    }
                    else{
                        var mask = luckysheet.mask.genarate(cell.v);

                        cell.m = mask[0].toString();
                    }
                }
                else{
                    var mask = luckysheet.mask.genarate(vupdate);

                    cell.m = mask[0].toString();
                    cell.ct = mask[1];
                    cell.v = mask[2];
                }
            }
        }

        if(!luckysheet.server.allowUpdate && !luckysheetConfigsetting.pointEdit){
            if(cell.ct != null && /^(w|W)((0?)|(0\.0+))$/.test(cell.ct.fa) == false && cell.ct.t == "n" && cell.v != null && parseInt(cell.v).toString().length > 4){
                var autoFormatw = luckysheetConfigsetting.autoFormatw.toString().toUpperCase();
                var accuracy = luckysheetConfigsetting.accuracy;
               
                var sfmt = luckysheet.setAccuracy(autoFormatw, accuracy);

                if(sfmt != "General") {
                    cell.ct.fa = sfmt;
                    cell.m = luckysheet.mask.update(sfmt, cell.v);
                }
            }
        }

        d[r][c] = cell;
    }

    luckysheet.jfrefreshcell = function (value, ur, uc) {
        if (clearjfundo) {
            luckysheet.jfundo = [];
            luckysheet.jfredo.push({ "type": "cellchange", "sheetIndex": luckysheet.currentSheetIndex, "value": luckysheet.flowdata[ur][uc], "curvalue": $.extend(true, {}, value), "uprow": ur, "upcolumn": uc });
        }

        if (sourcechange) {
            var row = [].concat(luckysheet.flowdata[ur]);
            row[uc] = value;
            luckysheet.flowdata[ur] = row;
        }

        var data = luckysheet.flowdata;
        var luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
        var scrollWidth = $("#luckysheet-cell-main").scrollLeft(), scrollHeight = $("#luckysheet-cell-main").scrollTop();

        var start_r, start_c, end_r, end_c;

        if (ur == 0) {
            start_r = 0;
        }
        else {
            start_r = visibledatarow[ur - 1] - scrollHeight - 1;
        }
        end_r = visibledatarow[ur] - scrollHeight;

        if (uc == 0) {
            start_c = 0;
        }
        else {
            start_c = visibledatacolumn[uc - 1] - scrollWidth;
        }
        end_c = visibledatacolumn[uc] - scrollWidth;



        if ($("#luckysheet-data-visualization").length > 0 && $("#luckysheet-data-visualization").is(":visible")) {
            luckysheet.chartparam.jgridCurrentChartData = luckysheet.getdatabyselectionD(luckysheet.flowdata, luckysheet.chartparam.jgridCurrentChartSelection);
            luckysheet.luckysheet_datavisual_item_active();
        }

        if (data[ur] != null && data[ur][uc] != null) {
            var value = luckysheet.getcellvalue(ur, uc, data);

            //console.log(config);

            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][uc] != null) {
                firstcolumlen = config["columlen"][uc];
            }

            var textMetrics = luckysheetTableContent.measureText(value).width;
            if (textMetrics > firstcolumlen) {
                var v = "", value_array = value.toString().split("");
                for (var i = 0; i < value_array.length; i++) {
                    if (luckysheetTableContent.measureText(v + "" + value_array[i]).width + 12 > firstcolumlen) {
                        break;
                    }
                    v += value_array[i];
                }
                value = v + "...";
            }

            luckysheetTableContent.clearRect(start_c + rowHeaderWidth - 1, start_r + columeHeaderHeight - 1, end_c - start_c - 1, end_r - start_r - 2);
            luckysheetTableContent.fillText(value==null?"":value, start_c + 4 + rowHeaderWidth, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1);

            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][ur] != null) {
                rowlen = config["rowlen"][ur];
            }

            luckysheetTableContent.clearRect(start_c + rowHeaderWidth - 1 + firstcolumlen - 1, start_r + columeHeaderHeight - 1, 3, end_r - start_r - 2);

            //列
            if (!luckysheetcurrentisPivotTable) {
                luckysheetTableContent.beginPath();
                luckysheetTableContent.moveTo(start_c + rowHeaderWidth - 1 + firstcolumlen, start_r + columeHeaderHeight - 1);
                luckysheetTableContent.lineTo(start_c + rowHeaderWidth - 1 + firstcolumlen, start_r + columeHeaderHeight - 1 + rowlen);
                luckysheetTableContent.lineWidth = devicePixelRatio;
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                luckysheetTableContent.closePath();
                luckysheetTableContent.stroke();
            }
        }

        luckysheet.server.saveParam("v", luckysheet.currentSheetIndex, value, { "r":ur, "c":uc });

        luckysheet.jfrefreshchartall(luckysheet.flowdata, ur, ur, uc, uc);

        //编辑器qksheet表格编辑时
        if(luckysheetConfigsetting.pointEdit){
            luckysheet.pointEdit_updateData();
        }
    }

    luckysheet.jfrefreshrange = function (data, range, cdformat) {
        //单元格数据更新联动
        luckysheet.formula.execFunctionExist = [];
        for(var s = 0; s < range.length; s++){
            for(var r = range[s].row[0]; r <= range[s].row[1]; r++){
                for(var c = range[s].column[0]; c <= range[s].column[1]; c++){
                    luckysheet.formula.execFunctionExist.push({ "r": r, "c": c, "i": luckysheet.currentSheetIndex });
                }
            }
        }
        luckysheet.formula.execFunctionExist.reverse();
        luckysheet.formula.execFunctionGroup(null, null, null, null, data);
        luckysheet.formula.execFunctionGroupData = null;

        if (clearjfundo) {
            luckysheet.jfundo = [];

            luckysheet.jfredo.push({ 
                "type": "rangechange", 
                "data": luckysheet.flowdata, 
                "curdata": data, 
                "range": range, 
                "sheetIndex": luckysheet.currentSheetIndex,
                "cdformat":  $.extend(true, [], luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"]),
                "curCdformat": cdformat 
            });
        }

        //luckysheet.flowdata
        luckysheet.flowdata = data;
        luckysheet.editor.webWorkerFlowDataCache(luckysheet.flowdata);//worker存数据

        luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)].data = luckysheet.flowdata;

        //条件格式
        if(cdformat != null){
            luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["luckysheet_conditionformat_save"] = cdformat;
        }

        //刷新表格
        setTimeout(function () {
            luckysheet.luckysheetrefreshgrid();
        }, 1);

        //发送给后台
        for(var s = 0; s < range.length; s++){
            luckysheet.server.historyParam(luckysheet.flowdata, luckysheet.currentSheetIndex, range[s]);

            luckysheet.jfrefreshchartall(luckysheet.flowdata, range[s].row[0], range[s].row[1], range[s].column[0], range[s].column[1]);
        }

        //编辑器qksheet表格编辑时
        if(luckysheetConfigsetting.pointEdit){
            luckysheet.pointEdit_updateData();
        }
    }

    

    luckysheet.pointEdit_updateData = function(){
        var celldata = [];

        if(luckysheet.flowdata != null && luckysheet.flowdata.length > 0){
            celldata = luckysheet.dataToCelldata(luckysheet.flowdata);
        }

        var msTable_files = $.extend(true, [], luckysheet.getluckysheetfile());

        msTable_files[0].celldata = celldata;
        msTable_files[0].row = luckysheet.flowdata.length;
        msTable_files[0].column = luckysheet.flowdata[0].length;

        delete msTable_files[0].data;

        luckysheetConfigsetting.pointEditUpdate(msTable_files);
    }

    luckysheet.dataToCelldata = function(data){
        var celldata = [];

        for(var r = 0; r < data.length; r++){
            for(var c = 0; c < data[0].length; c++){
                var cell = data[r][c];

                if(cell != null){
                    var obj = {
                        "r": r,
                        "c": c,
                        "v": cell
                    }

                    celldata.push(obj);
                }
            }
        }

        return celldata;
    }

    

    luckysheet.luckysheetcreatesheet = function (colwidth, rowheight, data, cfg, active) {
        if(active == null){
            active = true;
        }

        visibledatarow = [];
        visibledatacolumn = [];
        rowsplit = [];
        colsplit = [];
        ch_width = 0;
        rh_height = 0;

        if(cfg != null){
            config = cfg;
        }
        else{
            config = {};
        }

        if (data.length == 0) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight, colwidth);
        }
        else if (data.length < rowheight && data[0].length < colwidth) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight - data.length, colwidth - data[0].length);
        }
        else if (data.length < rowheight) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight - data.length, 0);
        }
        else if (data[0].length < colwidth) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, 0, colwidth - data[0].length);
        }
        else {
            luckysheet.flowdata = data;
        }

        luckysheet.editor.webWorkerFlowDataCache(luckysheet.flowdata);//worker存数据

        var flowHTML = flow;
        for (var i = 0; i < colwidth; i++) {
            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][i] != null) {
                firstcolumlen = config["columlen"][i];
            }
            else {
                if (data[0] != null && data[0][i] != null) {
                    firstcolumlen = Math.ceil(luckysheet.getByteLen(data[0][i]) * 11.5);
                    if (firstcolumlen > 300) {
                        firstcolumlen = 300;
                    }
                    else if (firstcolumlen < defaultcollen) {
                        firstcolumlen = defaultcollen;
                    }

                    if (firstcolumlen != defaultcollen) {
                        if (config["columlen"] == null) {
                            config["columlen"] = {};
                        }
                        config["columlen"][i] = firstcolumlen;
                    }
                }
            }
            ch_width += firstcolumlen + 1;
            visibledatacolumn.push(ch_width); //列的临时长度分布
        }

        for (var i = 0; i < rowheight; i++) {
            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][i] != null) {
                rowlen = config["rowlen"][i];
            }
            if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                rowlen = config["rowhidden"][i];
                visibledatarow.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            visibledatarow.push(rh_height); //行的临时长度分布
        }


        rh_height+= 110;
        ch_width+= 120;


        if(active){
            luckysheet.sheetmanage.showSheet();

            setTimeout(function () {
                luckysheet.sheetmanage.restoreCache();
                luckysheet.formula.execFunctionGroup();
                luckysheet.sheetmanage.restoreSheetAll(luckysheet.currentSheetIndex);
                luckysheet.luckysheetrefreshgrid();
            }, 1);
        }
        else{
            
        }

        // setTimeout(function () {
        //     for (var i = 0; i < refreshcanvas.length; i++) {
        //         refreshcanvas[i].stroke();
        //     }
        // }, 1);
    }


    

    function luckysheetDrawgrid(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop) {
        if($("#luckysheetTableContent").length == 0){
            return;
        }

        if(luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["isPivotTable"]){
            luckysheetDrawMain_back(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop);  
        }
        else{
            luckysheetDrawMain(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop);
        }
        
        $("#luckysheetTableContent").get(0).getContext("2d").clearRect(0, 0, 46, 20);
        
        luckysheetDrawgridColumnTitle(scrollWidth, drawWidth, offsetLeft);
        luckysheetDrawgridRowTitle(scrollHeight, drawHeight, offsetTop);
    }

    function luckysheetDrawgridRowTitle(scrollHeight, drawHeight, offsetTop) {
        if (scrollHeight == null) {
            scrollHeight = $("#luckysheet-cell-main").scrollTop();
        }

        if (drawHeight == null) {
            drawHeight = luckysheetTableContentHW[1];
        }

        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }
        
        var luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
        luckysheetTableContent.clearRect(
            0,
            offsetTop * devicePixelRatio,
            (rowHeaderWidth - 1) * devicePixelRatio,
            drawHeight * devicePixelRatio
        );

        luckysheetTableContent.font = luckysheetdefaultstyle.font;
        luckysheetTableContent.textBaseline = luckysheetdefaultstyle.textBaseline;
        luckysheetTableContent.fillStyle = luckysheetdefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed;
        dataset_row_st = luckysheet_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = luckysheet_searcharray(visibledatarow, scrollHeight + drawHeight);

        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }
        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        var end_r, start_r;

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {
            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;

            //若超出绘制区域终止
            if(end_r > scrollHeight + drawHeight){
                break;
            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                //行标题栏序列号
                var textMetrics = luckysheetTableContent.measureText(r + 1);

                var horizonAlignPos = (rowHeaderWidth * devicePixelRatio - textMetrics.width) / 2;
                var verticalAlignPos = (start_r + (end_r - start_r) / 2 + offsetTop) * devicePixelRatio;

                luckysheetTableContent.fillText(r + 1, horizonAlignPos, verticalAlignPos);
            }

            //行标题栏横线
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(
                -1,
                (end_r + offsetTop - 2 + 0.5) * devicePixelRatio
            );
            luckysheetTableContent.lineTo(
                (rowHeaderWidth - 1) * devicePixelRatio,
                (end_r + offsetTop - 2 + 0.5) * devicePixelRatio
            );
            luckysheetTableContent.lineWidth = devicePixelRatio;
            luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            luckysheetTableContent.closePath();
            luckysheetTableContent.stroke();
        }

        //行标题栏竖线
        luckysheetTableContent.beginPath();
        luckysheetTableContent.moveTo(
            (rowHeaderWidth - 2 + 0.5) * devicePixelRatio,
            (offsetTop - 1) * devicePixelRatio
        );
        luckysheetTableContent.lineTo(
            (rowHeaderWidth - 2 + 0.5) * devicePixelRatio,
            (rh_height + offsetTop) * devicePixelRatio
        );
        luckysheetTableContent.lineWidth = devicePixelRatio;
        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        luckysheetTableContent.closePath();
        luckysheetTableContent.stroke();


        //清除canvas左上角区域 防止列标题栏序列号溢出显示
        luckysheetTableContent.clearRect(0, 0, rowHeaderWidth * devicePixelRatio, columeHeaderHeight * devicePixelRatio);
    }

    function luckysheetDrawgridColumnTitle(scrollWidth, drawWidth, offsetLeft) {
        if (scrollWidth == null) {
            scrollWidth = $("#luckysheet-cell-main").scrollLeft();
        }

        if (drawWidth == null) {
            drawWidth = luckysheetTableContentHW[0];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }
        
        var luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
        luckysheetTableContent.clearRect(
            offsetLeft * devicePixelRatio,
            -0.5,
            drawWidth * devicePixelRatio,
            (columeHeaderHeight - 1.5) * devicePixelRatio
        );


        luckysheetTableContent.font = luckysheetdefaultstyle.font;
        luckysheetTableContent.textBaseline = luckysheetdefaultstyle.textBaseline;
        luckysheetTableContent.fillStyle = luckysheetdefaultstyle.fillStyle;

        var dataset_col_st, dataset_col_ed;
        dataset_col_st = luckysheet_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = luckysheet_searcharray(visibledatacolumn, scrollWidth + drawWidth);

        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }
        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }

        var end_c, start_c;

        for (var c = dataset_col_st; c <= dataset_col_ed; c++) {
            if (c == 0) {
                start_c = -scrollWidth;
            }
            else {
                start_c = visibledatacolumn[c - 1] - scrollWidth;
            }
            end_c = visibledatacolumn[c] - scrollWidth;

            //若超出绘制区域终止
            if(end_c > scrollWidth + drawWidth){
                break;
            }

            //列标题栏序列号
            var abc = luckysheet.luckysheetchatatABC(c);
            var textMetrics = luckysheetTableContent.measureText(abc);

            var horizonAlignPos = Math.round((start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - textMetrics.width / 2);
            var verticalAlignPos = Math.round(columeHeaderHeight / 2 * devicePixelRatio);
            
            luckysheetTableContent.fillText(abc, horizonAlignPos, verticalAlignPos);

            //列标题栏竖线
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(
                (end_c + offsetLeft - 2 + 0.5) * devicePixelRatio,
                0.5
            );
            luckysheetTableContent.lineTo(
                (end_c + offsetLeft - 2 + 0.5) * devicePixelRatio,
                (columeHeaderHeight - 2) * devicePixelRatio
            );
            luckysheetTableContent.lineWidth = devicePixelRatio;
            luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            luckysheetTableContent.closePath();
            luckysheetTableContent.stroke();
        }

        //列标题栏横线
        luckysheetTableContent.beginPath();
        luckysheetTableContent.moveTo(
            (offsetLeft - 1) * devicePixelRatio,
            (columeHeaderHeight - 2 + 0.5) * devicePixelRatio
        );
        luckysheetTableContent.lineTo(
            (ch_width + offsetLeft - 2) * devicePixelRatio,
            (columeHeaderHeight - 2 + 0.5) * devicePixelRatio
        );
        luckysheetTableContent.lineWidth = devicePixelRatio;
        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        luckysheetTableContent.closePath();
        luckysheetTableContent.stroke();

        //清除canvas左上角区域 防止列标题栏序列号溢出显示
        luckysheetTableContent.clearRect(0, 0, rowHeaderWidth * devicePixelRatio, columeHeaderHeight * devicePixelRatio);
    }

    function luckysheetDrawMain(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop, columnOffsetCell, rowOffsetCell, mycanvas, ctx, ctxdata) {
        if(ctxdata != null){
            luckysheet.flowdata = ctxdata;
        }

        if(luckysheet.flowdata == null){
            return;
        }

        if (scrollWidth == null) {
            scrollWidth = $("#luckysheet-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#luckysheet-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = luckysheetTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = luckysheetTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }
        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }

        if (columnOffsetCell == null) {
            columnOffsetCell = 0;
        }
        if (rowOffsetCell == null) {
            rowOffsetCell = 0;
        }

        var luckysheetTableContent = null;
        if(ctx != null){
            var luckysheetTableElement = document.createElement('canvas');
            luckysheetTableElement.width = drawWidth;
            luckysheetTableElement.height = drawHeight;
            luckysheetTableContent = luckysheetTableElement.getContext("2d");
        }
        else{
            if(mycanvas == null){
                luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
            }
            else {
                if(luckysheet.getObjType(mycanvas) == "object"){
                    try{
                        luckysheetTableContent = mycanvas.get(0).getContext("2d");
                    }
                    catch(err){
                        luckysheetTableContent = mycanvas;
                    }
                }
                else{
                    luckysheetTableContent = $("#" + mycanvas).get(0).getContext("2d");
                }
            }
        }
        
        luckysheetTableContent.clearRect(
            0, 
            0, 
            luckysheetTableContentHW[0] * devicePixelRatio,
            luckysheetTableContentHW[1] * devicePixelRatio
        );

        //离屏canvas
        var offlinecanvas = null;
        if(ctx != null){
            var offlineElement = document.createElement('canvas');
            offlineElement.width = drawWidth;
            offlineElement.height = drawHeight;
            offlinecanvas = offlineElement.getContext("2d");
        }
        else{
            offlinecanvas = $("#luckysheetTableContentF").get(0).getContext("2d");
        }
        //offlinecanvas.clearRect(0, 0, luckysheetTableContentHW[0], luckysheetTableContentHW[1]);
        offlinecanvas.fillStyle = "#ffffff";
        offlinecanvas.fillRect(
            0,
            0, 
            luckysheetTableContentHW[0] * devicePixelRatio, 
            luckysheetTableContentHW[1] * devicePixelRatio
        );
        offlinecanvas.font = luckysheetdefaultstyle.font;
        offlinecanvas.textBaseline = "top";
        offlinecanvas.fillStyle = luckysheetdefaultstyle.fillStyle;

        //
        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;

        dataset_row_st = luckysheet_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = luckysheet_searcharray(visibledatarow, scrollHeight + drawHeight);

        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }

        dataset_row_st += rowOffsetCell;

        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_row_ed += rowOffsetCell;

        if (dataset_row_ed >= visibledatarow.length) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_col_st = luckysheet_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = luckysheet_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }

        dataset_col_st += columnOffsetCell;

        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }

        dataset_col_ed += columnOffsetCell;

        if (dataset_col_ed >= visibledatacolumn.length) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }


        var fill_row_st, fill_row_ed, fill_col_st, fill_col_ed;
        if(dataset_row_st == 0){
            fill_row_st = 0;
        }
        else{
            fill_row_st = visibledatarow[dataset_row_st - 1];
        }

        fill_row_ed = visibledatarow[dataset_row_ed];

        if(dataset_col_st == 0){
            fill_col_st = 0;
        }
        else{
            fill_col_st = visibledatacolumn[dataset_col_st - 1];
        }

        fill_col_ed = visibledatacolumn[dataset_col_ed];

        luckysheetTableContent.fillStyle = "#ffffff";
        luckysheetTableContent.fillRect(
            (offsetLeft - 1) * devicePixelRatio, 
            (offsetTop - 1) * devicePixelRatio, 
            (fill_col_ed - scrollWidth) * devicePixelRatio, 
            (fill_row_ed - scrollHeight) * devicePixelRatio
        );
        luckysheetTableContent.font = luckysheetdefaultstyle.font;
        luckysheetTableContent.textBaseline = "top";
        luckysheetTableContent.fillStyle = luckysheetdefaultstyle.fillStyle;

        var end_r, start_r, end_c, start_c;

        var cellupdate = [];
        var mergeCache = {};

        var borderOffset = {};

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {
            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }

            end_r = visibledatarow[r] - scrollHeight;
            
            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {
                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }

                end_c = visibledatacolumn[c] - scrollWidth;

                //横线
                if(c == dataset_col_ed && !luckysheetcurrentisPivotTable){
                    luckysheetTableContent.beginPath();
                    luckysheetTableContent.moveTo(
                        devicePixelRatio * (offsetLeft - 1), 
                        devicePixelRatio * (end_r + offsetTop - 2 + 0.5)
                    );
                    luckysheetTableContent.lineTo(
                        devicePixelRatio * (fill_col_ed - scrollWidth + offsetLeft - 2), 
                        devicePixelRatio * (end_r + offsetTop - 2 + 0.5)
                    );
                    luckysheetTableContent.lineWidth = devicePixelRatio;
                    luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                    luckysheetTableContent.closePath();
                    luckysheetTableContent.stroke();
                }

                //竖线
                if(r == dataset_row_st && !luckysheetcurrentisPivotTable){
                    luckysheetTableContent.beginPath();
                    luckysheetTableContent.moveTo(
                        devicePixelRatio * (end_c + offsetLeft - 2 + 0.5), 
                        devicePixelRatio * (offsetTop - 1)
                    );
                    luckysheetTableContent.lineTo(
                        devicePixelRatio * (end_c + offsetLeft - 2 + 0.5), 
                        devicePixelRatio * (fill_row_ed - scrollHeight + offsetTop - 2)
                    );
                    luckysheetTableContent.lineWidth = devicePixelRatio;
                    luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                    luckysheetTableContent.closePath();
                    luckysheetTableContent.stroke();
                }

                //数据透视表
                if (!!luckysheetcurrentisPivotTable && luckysheet.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(
                            devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), 
                            devicePixelRatio * (start_r + offsetTop)
                        );
                        luckysheetTableContent.lineTo(
                            devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), 
                            devicePixelRatio * (end_r - 2 + offsetTop)
                        );
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(
                            devicePixelRatio * (start_c - 1 + offsetLeft), 
                            devicePixelRatio * (end_r - 2 + 0.5 + offsetTop)
                        );
                        luckysheetTableContent.lineTo(
                            devicePixelRatio * (end_c - 2 + offsetLeft), 
                            devicePixelRatio * (end_r - 2 + 0.5 + offsetTop)
                        );
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        luckysheetTableContent.fillText(
                            "数据透视表", 
                            devicePixelRatio * (start_c + 4 + offsetLeft), 
                            devicePixelRatio *(start_r + (end_r - start_r) / 2 - 1 + offsetTop)
                        );
                    }
                }
                else if (!!luckysheetcurrentisPivotTable) {
                    if (c < luckysheet.pivotTable.pivotTableBoundary[1] && r < luckysheet.pivotTable.pivotTableBoundary[0]) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(
                            devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), 
                            devicePixelRatio*(start_r + offsetTop)
                        );
                        luckysheetTableContent.lineTo(
                            devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), 
                            devicePixelRatio*(end_r - 2 + offsetTop)
                        );
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();

                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(
                            devicePixelRatio*(start_c - 1 + offsetLeft), 
                            devicePixelRatio*(end_r - 2 + 0.5 + offsetTop)
                        );
                        luckysheetTableContent.lineTo(
                            devicePixelRatio*(end_c - 2 + offsetLeft), 
                            devicePixelRatio*(end_r - 2 + 0.5 + offsetTop)
                        );
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }
                }

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    var firstcolumlen = defaultcollen;
                    if (config["columlen"] != null && config["columlen"][c] != null) {
                        firstcolumlen = config["columlen"][c];
                    }

                    if (luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null) {
                        var value = luckysheet.flowdata[r][c];

                        if(luckysheet.getObjType(value) == "object" && ("mc" in value)){
                            borderOffset[r + "_" + c] = { 
                                "start_r": start_r,
                                "start_c": start_c, 
                                "end_r": end_r, 
                                "end_c": end_c 
                            };

                            if("rs" in value["mc"]){
                                var key = "r"+ r + "c" + c;
                                mergeCache[key] = cellupdate.length;
                            }
                            else{
                                var key = "r"+ value["mc"].r + "c" + value["mc"].c;
                                var margeMain = cellupdate[mergeCache[key]];

                                if(margeMain == null){
                                    mergeCache[key] = cellupdate.length;
                                    cellupdate.push({
                                        "r": r, 
                                        "c": c, 
                                        "start_c": start_c, 
                                        "start_r": start_r, 
                                        "end_r": end_r, 
                                        "end_c": end_c, 
                                        "firstcolumlen": firstcolumlen, 
                                        startlist: []
                                    });
                                }
                                else{
                                    if(margeMain.c == c){
                                        margeMain.end_r += (end_r - start_r - 1);
                                        margeMain.startlist.push(start_r);

                                        // borderOffset[margeMain.r + "_" + margeMain.c].end_r = margeMain.end_r;
                                    }
                                    
                                    if(margeMain.r == r){
                                        margeMain.end_c += (end_c - start_c);
                                        margeMain.firstcolumlen += firstcolumlen;

                                        // borderOffset[margeMain.r + "_" + margeMain.c].end_c = margeMain.end_c;
                                    }
                                }

                                continue;
                            }
                        }
                    }

                    cellupdate.push({
                        "r": r, 
                        "c": c, 
                        "start_r": start_r, 
                        "start_c": start_c, 
                        "end_r": end_r, 
                        "end_c": end_c, 
                        "firstcolumlen": firstcolumlen, 
                        startlist: []
                    });
                    borderOffset[r + "_" + c] = { 
                        "start_r": start_r, 
                        "start_c": start_c, 
                        "end_r": end_r, 
                        "end_c": end_c 
                    };
                }
            }
        }

        //动态数组公式计算
        var dynamicArray_compute = luckysheet.dynamicArray_compute(luckysheetfile[luckysheet.sheetmanage.getSheetIndex(luckysheet.currentSheetIndex)]["dynamicArray"]);

        //交替颜色计算
        var af_compute = luckysheet.alternateformat.getComputeMap();

        //条件格式计算
        var cf_compute = luckysheet.conditionformat.getComputeMap();

        //sparklines渲染
        var sparklinesRender = function(r, c, offsetX, offsetY, canvasid, ctx){
            if(luckysheet.flowdata[r] == null || luckysheet.flowdata[r][c] == null){
                return;
            }

            var sparklines = luckysheet.flowdata[r][c].spl;
            if(sparklines != null){
                if(typeof sparklines == "string"){
                    sparklines = eval('('+ sparklines +')');
                }

                if(luckysheet.getObjType(sparklines) == "object"){
                    var temp1 = sparklines;
                    var x = temp1.offsetX;
                    var y = temp1.offsetY;
                    x = x == null ? 0 : x;
                    y = y == null ? 0 : y;
                    luckysheet.sparkline.render(temp1.shapeseq, temp1.shapes, offsetX + x, offsetY + y, temp1.pixelWidth, temp1.pixelHeight, canvasid, ctx);
                }
                else if(luckysheet.getObjType(sparklines) == "array" && luckysheet.getObjType(sparklines[0]) == "object"){
                    for(var i = 0; i < sparklines.length; i++){
                        var temp1 = sparklines[i];
                        var x = temp1.offsetX;
                        var y = temp1.offsetY;
                        x = x == null ? 0 : x;
                        y = y == null ? 0 : y;
                        luckysheet.sparkline.render(temp1.shapeseq, temp1.shapes, offsetX + x, offsetY + y, temp1.pixelWidth, temp1.pixelHeight, canvasid, ctx);
                    }
                }
            }
        }

        //空白单元格渲染 
        var nullCellRender = function(r, c, start_r, start_c, end_r, end_c){
            var checksAF = luckysheet.alternateformat.checksAF(r, c, af_compute); //交替颜色
            var checksCF = luckysheet.conditionformat.checksCF(r, c, cf_compute); //条件格式

            var borderfix = luckysheet.menuButton.borderfix(luckysheet.flowdata, r, c);

            //背景色
            luckysheetTableContent.fillStyle = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bg");

            if(checksAF != null && checksAF[1] != null){//交替颜色 
                luckysheetTableContent.fillStyle = checksAF[1];
            }

            if(checksCF != null && checksCF["cellColor"] != null){//条件格式 
                luckysheetTableContent.fillStyle = checksCF["cellColor"];
            }

            if(luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].tc != null){//标题色
                luckysheetTableContent.fillStyle = luckysheet.flowdata[r][c].tc;
            }

            var cellsize = [
                devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                devicePixelRatio * (start_r + offsetTop + 1 + borderfix[1]), 
                devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
            ];
            luckysheetTableContent.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            if((r + "_" + c) in dynamicArray_compute){
                var value = dynamicArray_compute[r + "_" + c].v;

                luckysheetTableContent.fillStyle = "#000000";
                //文本宽度和高度
                var fontset = luckysheetdefaultstyle.font;
                luckysheetTableContent.font = fontset;

                var textMetrics = luckysheetTableContent.measureText(value).width;
                var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];

                //水平对齐 (默认为1，左对齐)
                var horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio;

                //垂直对齐 (默认为2，下对齐)
                var verticalFixed = luckysheet.browser.luckysheetrefreshfixed();
                var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight; 
                
                luckysheetTableContent.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);
            }

            //若单元格有批注
            if(luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].ps != null){
                luckysheetTableContent.beginPath();
                luckysheetTableContent.moveTo(devicePixelRatio * (end_c + offsetLeft - 6), devicePixelRatio * (start_r + offsetTop));
                luckysheetTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop));
                luckysheetTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop + 5));
                luckysheetTableContent.fillStyle = "#FC6666";
                luckysheetTableContent.fill();
                luckysheetTableContent.closePath();
            }

            //右边框
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (start_r + offsetTop));
            luckysheetTableContent.lineTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (end_r - 2 + offsetTop));
            luckysheetTableContent.lineWidth = devicePixelRatio;

            if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
                luckysheetTableContent.strokeStyle = "#000000";
            }
            else{
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            }
            
            luckysheetTableContent.stroke();
            luckysheetTableContent.closePath();

            //下边框
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(devicePixelRatio * (start_c - 2 + offsetLeft), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            luckysheetTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 2), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            luckysheetTableContent.lineWidth = devicePixelRatio;

            if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
                luckysheetTableContent.strokeStyle = "#000000";
            }
            else{
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            }
            
            luckysheetTableContent.stroke();
            luckysheetTableContent.closePath();
        }

        //非空白单元格渲染
        var cellRender = function(r, c, start_r, start_c, end_r, end_c, value, canvasType){
            var checksAF = luckysheet.alternateformat.checksAF(r, c, af_compute); //交替颜色
            var checksCF = luckysheet.conditionformat.checksCF(r, c, cf_compute); //条件格式

            var borderfix = luckysheet.menuButton.borderfix(luckysheet.flowdata, r, c);

            //文本宽度和高度
            var fontset = luckysheetfontformat(luckysheet.flowdata[r][c]);
            luckysheetTableContent.font = fontset;

            var textMetrics = luckysheetTableContent.measureText(value).width;
            var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];

            if(luckysheet.flowdata[r][c].tb == "2"){
                var strValue = value.toString();
                var cellWidth = end_c - start_c - 8;
                var strArr = [];
                
                for(var strI = 1; strI <= strValue.length; strI++){
                    var strV = strValue.substring(strArr.join("").length, strI);
                    var strtextMetrics = luckysheetTableContent.measureText(strV).width;
                    
                    if(strtextMetrics > cellWidth){
                        strArr.push(strValue.substring(strArr.join("").length, strI - 1));
                        strI = strI - 2;
                    }
                    else if(strtextMetrics <= cellWidth && strI == strValue.length){
                        strArr.push(strV);
                    }
                }

                var textH = strArr.length * oneLineTextHeight;
            }
            else if(luckysheet.flowdata[r][c].tr != null && luckysheet.flowdata[r][c].tr != "0"){
                var tr = luckysheet.flowdata[r][c].tr;
                    
                if(tr == "1" || tr == "2"){
                    var textW = 0.707 * (textMetrics + oneLineTextHeight);
                    var textH = 0.707 * (textMetrics + oneLineTextHeight);
                }
                else if(tr == "3"){
                    value = value.toString();
                    
                    if(value.length > 1){
                        var vArr = value.split("");    
                    }
                    else{
                        var vArr = [];
                        vArr.push(value);
                    }
                    
                    var textW = luckysheetTableContent.measureText(vArr[0]).width;
                    var textH = vArr.length * oneLineTextHeight;
                }
                else if(tr == "4" || tr == "5"){
                    var textW = oneLineTextHeight;
                    var textH = textMetrics;
                }
            }
            else{
                var textW = textMetrics;
                var textH = oneLineTextHeight;
            }

            //水平对齐
            var horizonAlign = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "ht"); 
            var horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio; //horizonAlign默认为1，左对齐
            if(horizonAlign == "0"){ //居中对齐
                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textMetrics) / 2;
            }
            else if(horizonAlign == "2"){ //右对齐
                horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (textMetrics);
            }

            //垂直对齐
            var verticalAlign = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "vt"); 
            var verticalFixed = luckysheet.browser.luckysheetrefreshfixed();
            var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight; //verticalAlign默认为2，下对齐
            if(verticalAlign == "0"){ //居中对齐
                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight / 2;
            }
            else if(verticalAlign == "1"){ //上对齐
                verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
            }

            //水平对齐方式是 居中或居右对齐 且单元格宽度小于文字宽度 （用离屏canvas渲染） 
            if(luckysheet.browser.BrowserType() != "Safari" && (canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH))){
            // if(canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH) || (luckysheet.flowdata[r][c].tr != null && luckysheet.flowdata[r][c].tr != "0")){
                var canvasName = offlinecanvas;

                canvasName.font = fontset;

                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
            }
            else{
                var canvasName = luckysheetTableContent;

                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 1 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
            }
                
            //单元格 背景颜色
            canvasName.fillStyle= luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bg");
            
            //若单元格有交替颜色 背景颜色
            if(checksAF != null && checksAF[1] != null){ 
                canvasName.fillStyle = checksAF[1];
            }

            //若单元格有条件格式 背景颜色
            if(checksCF != null && checksCF["cellColor"] != null){ 
                canvasName.fillStyle = checksCF["cellColor"];
            }

            //若单元格有标题色
            if(luckysheet.flowdata[r][c] != null && luckysheet.flowdata[r][c].tc != null){
                luckysheetTableContent.fillStyle = luckysheet.flowdata[r][c].tc;
            }
            
            canvasName.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            //若单元格有批注
            if(luckysheet.flowdata[r][c].ps != null){
                canvasName.beginPath();
                canvasName.moveTo(devicePixelRatio * (end_c + offsetLeft - 6), devicePixelRatio * (start_r + offsetTop));
                canvasName.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop));
                canvasName.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop + 5));
                canvasName.fillStyle = "#FC6666";
                canvasName.fill();
                canvasName.closePath();
            }

            //若单元格有条件格式数据条
            if(checksCF != null && checksCF["dataBar"] != null){
                var x = devicePixelRatio * (start_c + offsetLeft + borderfix[0] + 2);
                var y = devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1] + 2);
                var w = devicePixelRatio * (end_c - start_c - 3 + borderfix[2] - 4);
                var h = devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3] - 4);

                var valueType = checksCF["dataBar"]["valueType"];
                var valueLen = checksCF["dataBar"]["valueLen"];
                var format = checksCF["dataBar"]["format"];

                if(format.length > 1){ //渐变
                    if(valueType == "minus"){
                        //负数
                        var minusLen = checksCF["dataBar"]["minusLen"];

                        var my_gradient = canvasName.createLinearGradient(x + w * minusLen * (1 - valueLen), y, x + w * minusLen, y);
                        my_gradient.addColorStop(0, "#ffffff");
                        my_gradient.addColorStop(1, "#ff0000");
                        canvasName.fillStyle = my_gradient;
                        canvasName.fillRect(x + w * minusLen * (1 - valueLen), y, w * minusLen * valueLen, h);

                        canvasName.beginPath();
                        canvasName.moveTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y + h);
                        canvasName.lineTo(x + w * minusLen, y + h);
                        canvasName.lineTo(x + w * minusLen, y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineWidth = devicePixelRatio;
                        canvasName.strokeStyle = "#ff0000";
                        canvasName.stroke();
                        canvasName.closePath();
                    }
                    else if(valueType == "plus"){
                        //正数
                        var plusLen = checksCF["dataBar"]["plusLen"];

                        if(plusLen == 1){
                            var my_gradient = canvasName.createLinearGradient(x, y, x + w * valueLen, y);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            canvasName.fillStyle = my_gradient;
                            canvasName.fillRect(x, y, w * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x, y);
                            canvasName.lineTo(x, y + h);
                            canvasName.lineTo(x + w * valueLen, y + h);
                            canvasName.lineTo(x + w * valueLen, y);
                            canvasName.lineTo(x, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                        else{
                            var minusLen = checksCF["dataBar"]["minusLen"];

                            var my_gradient = canvasName.createLinearGradient(x + w * minusLen, y, x + w * minusLen + w * plusLen * valueLen, y);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            canvasName.fillStyle = my_gradient;
                            canvasName.fillRect(x + w * minusLen, y, w * plusLen * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x + w * minusLen, y);
                            canvasName.lineTo(x + w * minusLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y);
                            canvasName.lineTo(x + w * minusLen, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                    }
                }
                else{ //单色
                    if(valueType == "minus"){
                        //负数
                        var minusLen = checksCF["dataBar"]["minusLen"];
                        
                        canvasName.fillStyle = "#ff0000";
                        canvasName.fillRect(x + w * minusLen * (1 - valueLen), y, w * minusLen * valueLen, h);

                        canvasName.beginPath();
                        canvasName.moveTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y + h);
                        canvasName.lineTo(x + w * minusLen, y + h);
                        canvasName.lineTo(x + w * minusLen, y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineWidth = devicePixelRatio;
                        canvasName.strokeStyle = "#ff0000";
                        canvasName.stroke();
                        canvasName.closePath();
                    }
                    else if(valueType == "plus"){
                        //正数
                        var plusLen = checksCF["dataBar"]["plusLen"];

                        if(plusLen == 1){
                            canvasName.fillStyle = format[0];
                            canvasName.fillRect(x, y, w * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x, y);
                            canvasName.lineTo(x, y + h);
                            canvasName.lineTo(x + w * valueLen, y + h);
                            canvasName.lineTo(x + w * valueLen, y);
                            canvasName.lineTo(x, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                        else{
                            var minusLen = checksCF["dataBar"]["minusLen"];

                            canvasName.fillStyle = format[0];
                            canvasName.fillRect(x + w * minusLen, y, w * plusLen * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x + w * minusLen, y);
                            canvasName.lineTo(x + w * minusLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y);
                            canvasName.lineTo(x + w * minusLen, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                    }
                }
            }

            //若单元格有条件格式图标集
            if(checksCF != null && checksCF["icons"] != null){
                var l = checksCF["icons"]["left"];
                var t = checksCF["icons"]["top"];
                
                canvasName.drawImage(luckysheet_CFiconsImg, l * 42, t * 32, 32, 32, cellsize[0], verticalAlignPos + 2, oneLineTextHeight - 2, oneLineTextHeight - 2);
                
                if(horizonAlign != "0" && horizonAlign != "2"){ //左对齐时 文本渲染空出一个图标的距离
                    horizonAlignPos = horizonAlignPos + oneLineTextHeight - 2;
                }
            }

            //单元格 文本颜色
            canvasName.fillStyle = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "fc");
            
            //若单元格有交替颜色 文本颜色
            if(checksAF != null && checksAF[0] != null){ 
                canvasName.fillStyle = checksAF[0];
            }
            
            //若单元格有条件格式 文本颜色
            if(checksCF != null && checksCF["textColor"] != null){ 
                canvasName.fillStyle = checksCF["textColor"];
            }

            //单元格有下钻属性，文本颜色变成超链接的颜色
            if(luckysheet.flowdata[r][c].dd != null){
                canvasName.fillStyle = "#0000ff";

                canvasName.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);

                canvasName.beginPath();
                canvasName.strokeStyle = "#0000ff";
                canvasName.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight);
                canvasName.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight);
                canvasName.closePath();
                canvasName.stroke();
            }
            else{
                //自动换行、旋转、删除线功能
                if(luckysheet.flowdata[r][c].tb == "2"){
                    var strValue = value.toString();
                    var cellWidth = end_c - start_c - 8;
                    var strArr = [];
                    
                    for(var strI = 1; strI <= strValue.length; strI++){
                        var strV = strValue.substring(strArr.join("").length, strI);
                        var strtextMetrics = canvasName.measureText(strV).width;
                        
                        if(strtextMetrics > cellWidth){
                            strArr.push(strValue.substring(strArr.join("").length, strI - 1));
                            strI = strI - 2;
                        }
                        else if(strtextMetrics <= cellWidth && strI == strValue.length){
                            strArr.push(strV);
                        }
                    }
                    
                    for(var iFill = 0; iFill < strArr.length; iFill++){
                        //水平对齐计算
                        var strWidth = canvasName.measureText(strArr[iFill]).width;
                        if(horizonAlign == "0"){
                            horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (strWidth)/2;
                        }
                        else if(horizonAlign == "2"){
                            horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (strWidth);
                        }
                        
                        //垂直对齐计算
                        if(verticalAlign == "0"){
                            verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight * strArr.length / 2;
                        }
                        else if(verticalAlign == "1"){
                            verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        else{
                            verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight * strArr.length;
                        }
                        
                        canvasName.fillText(strArr[iFill], horizonAlignPos, (verticalAlignPos + iFill * oneLineTextHeight));
                    }
                }
                else if(luckysheet.flowdata[r][c].tr != null && luckysheet.flowdata[r][c].tr != "0"){
                    //单元格旋转属性
                    var tr = luckysheet.flowdata[r][c].tr;
                    
                    if(tr == "1" || tr == "2"){
                        //旋转重新计算水平、垂直方向坐标
                        var textW = 0.707 * (textMetrics + oneLineTextHeight);
                        var textH = 0.707 * (textMetrics + oneLineTextHeight);

                        var hAP = (start_c + 4 + offsetLeft) * devicePixelRatio;
                        if(horizonAlign == "0"){
                            hAP = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textW) / 2;
                        }
                        else if(horizonAlign == "2"){
                            hAP = (end_c + offsetLeft - 8) * devicePixelRatio - (textW);
                        }

                        var vAP = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - textH;
                        if(verticalAlign == "0"){
                            vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - textH / 2;
                        }
                        else if(verticalAlign == "1"){
                            vAP = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        
                        //向下倾斜（45 旋转）
                        if(tr == "1"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP);
                            canvasName.rotate(45 * Math.PI / 180);
                            canvasName.translate(-hAP, -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP + (0.707 * 0.707 * oneLineTextHeight), vAP - (0.707 * 0.707 * oneLineTextHeight));
                            canvasName.restore();

                            //是否有删除线
                            var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                            if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + oneLineTextHeight / 2, vAP + oneLineTextHeight / 2);
                                canvasName.lineTo(hAP + textW - oneLineTextHeight / 2, vAP + textH - oneLineTextHeight / 2);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                        
                        //向上倾斜（-45 旋转）
                        if(tr == "2"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP + textH);
                            canvasName.rotate(-45 * Math.PI / 180);
                            canvasName.translate(-hAP, -(vAP + textH));
                            canvasName.fillText(value == null ? "" : value, hAP + (0.707 * 0.707 * oneLineTextHeight), vAP + textH - (0.707 * 0.707 * oneLineTextHeight));
                            canvasName.restore();
                            
                            //是否有删除线
                            var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                            if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + oneLineTextHeight / 2, vAP + textH - oneLineTextHeight / 2);
                                canvasName.lineTo(hAP + textW - oneLineTextHeight / 2, vAP + oneLineTextHeight / 2);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                    else if(tr == "3"){
                        if(!luckysheet.func_methods.isRealNull(value)){
                            value = value.toString();
                            
                            if(value.length > 1){
                                var vArr = value.split("");    
                            }
                            else{
                                var vArr = [];
                                vArr.push(value);
                            }
                            
                            var textW = canvasName.measureText(vArr[0]).width;
                            var textH = vArr.length * oneLineTextHeight;
                            
                            for(var i = 0; i < vArr.length; i++){
                                var vWidth = canvasName.measureText(vArr[i]).width;
                                
                                //水平对齐计算
                                if(horizonAlign == "0"){
                                    horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (vWidth)/2;
                                }
                                else if(horizonAlign == "2"){
                                    horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (vWidth);
                                }
                                else{
                                    horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio;
                                }
                                
                                //垂直对齐计算
                                if(verticalAlign == "0"){
                                    verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight * vArr.length/2;
                                }
                                else if(verticalAlign == "1"){
                                    verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                                }
                                else{
                                    verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight * vArr.length;
                                }
                                
                                canvasName.fillText(vArr[i], horizonAlignPos, (verticalAlignPos + i * oneLineTextHeight));
                            }
                            
                            //是否有删除线
                            var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                            if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(horizonAlignPos + textW / 2, verticalAlignPos);
                                canvasName.lineTo(horizonAlignPos + textW / 2, verticalAlignPos + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                    else if(tr == "4" || tr == "5"){
                        //旋转重新计算水平、垂直方向坐标
                        var textW = oneLineTextHeight;
                        var textH = textMetrics;

                        var hAP = (start_c + 4 + offsetLeft) * devicePixelRatio;
                        if(horizonAlign == "0"){
                            hAP = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textW) / 2;
                        }
                        else if(horizonAlign == "2"){
                            hAP = (end_c + offsetLeft - 8) * devicePixelRatio - (textW);
                        }

                        var vAP = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - textH;
                        if(verticalAlign == "0"){
                            vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - textH / 2;
                        }
                        else if(verticalAlign == "1"){
                            vAP = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        
                        //向下90（90 旋转）
                        if(tr == "4"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP);
                            canvasName.rotate(90 * Math.PI / 180);
                            canvasName.translate(-hAP, -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP, vAP - textW);
                            canvasName.restore();

                            //是否有删除线
                            var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                            if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + textW / 2, vAP);
                                canvasName.lineTo(hAP + textW / 2, vAP + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                        
                        //向上90（-90 旋转）
                        if(tr == "5"){
                            canvasName.save();
                            canvasName.translate(hAP + textH, vAP);
                            canvasName.rotate(-90 * Math.PI / 180);
                            canvasName.translate(-(hAP + textH), -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP, vAP - textH);
                            canvasName.restore();

                            //是否有删除线
                            var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                            if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + textW / 2, vAP);
                                canvasName.lineTo(hAP + textW / 2, vAP + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                }
                else{
                    canvasName.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);
                    
                    //是否有删除线
                    var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                    if(cl == "1" && !luckysheet.func_methods.isRealNull(value)){
                        canvasName.beginPath();
                        canvasName.strokeStyle = "#000";
                        canvasName.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight / 2);
                        canvasName.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight / 2);
                        canvasName.closePath();
                        canvasName.stroke();
                    }
                }
            }

            //水平对齐方式是 居中或居右对齐 且单元格宽度小于文字宽度 （用离屏canvas渲染）
            if(luckysheet.browser.BrowserType() != "Safari" && (canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH))){
                canvasName.font = luckysheetdefaultstyle.font;
                
                if($("#luckysheetTableContentF").length > 0){
                    luckysheetTableContent.drawImage($("#luckysheetTableContentF").get(0), cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
                }
                else{
                    luckysheetTableContent.drawImage(offlineElement, cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
                }
            }

            luckysheetTableContent.font = luckysheetdefaultstyle.font;

            //右边框
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (start_r + offsetTop));
            luckysheetTableContent.lineTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (end_r - 2 + offsetTop));
            luckysheetTableContent.lineWidth = devicePixelRatio;

            if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
                luckysheetTableContent.strokeStyle = "#000000";
            }
            else{
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            }
            
            luckysheetTableContent.stroke();
            luckysheetTableContent.closePath();

            //下边框
            luckysheetTableContent.beginPath();
            luckysheetTableContent.moveTo(devicePixelRatio * (start_c - 2 + offsetLeft), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            luckysheetTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 2), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            luckysheetTableContent.lineWidth = devicePixelRatio;

            if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
                luckysheetTableContent.strokeStyle = "#000000";
            }
            else{
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            }
            
            luckysheetTableContent.stroke();
            luckysheetTableContent.closePath();
        }

        var mcArr = [];

        for(var cud = 0; cud < cellupdate.length; cud++){
            var item = cellupdate[cud];
            var r = item.r, 
                c = item.c, 
                start_r = item.start_r, 
                start_c = item.start_c, 
                end_r = item.end_r, 
                end_c = item.end_c;
            var firstcolumlen = item.firstcolumlen;

            if(luckysheet.flowdata[r] == null){
                continue;
            }
            
            if(luckysheet.flowdata[r][c] == null){ //空单元格
                nullCellRender(r, c, start_r, start_c, end_r, end_c);
            }
            else{
                var cell = luckysheet.flowdata[r][c];
                var value = null, er = r, ec = c, end_ec = end_c;

                if((typeof cell == "object") && "mc" in cell){
                    mcArr.push(cellupdate[cud]);

                    var margeMaindata = cell["mc"];
                    value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c, null, "m");
                    
                    if(value == null){
                        value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c);
                    }

                    r = margeMaindata.r;
                    c = margeMaindata.c;

                    er += margeMaindata.rs;
                    ec += margeMaindata.rc;

                    if (c == 0) {
                        start_c = -scrollWidth;
                    }
                    else {
                        start_c = visibledatacolumn[c - 1] - scrollWidth;
                    }

                    if (r == 0) {
                        start_r = -scrollHeight - 1;
                    }
                    else {
                        start_r = visibledatarow[r - 1] - scrollHeight - 1;
                    }

                    end_ec = visibledatacolumn[ec] - scrollWidth;
                }
                else{
                    value = luckysheet.getcellvalue(r, c, null, "m");
                    if(value == null){
                        value = luckysheet.getcellvalue(r, c);
                    }
                }  

                if(value == null || value.toString().length == 0){
                    nullCellRender(r, c, start_r, start_c, end_r, end_c);
                    
                    //sparklines渲染
                    var borderfix = luckysheet.menuButton.borderfix(luckysheet.flowdata, r, c);
                    var cellsize = [
                        devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                        devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                        devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                        devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                    ];
                    sparklinesRender(r, c, cellsize[0], cellsize[1], "luckysheetTableContent", luckysheetTableContent);
                }
                else{
                    if((r + "_" + c) in dynamicArray_compute){//动态数组公式
                        value = dynamicArray_compute[r + "_" + c].v;
                    }

                    cellRender(r, c, start_r, start_c, end_r, end_c, value);
                }
            }
        }

        //合并单元格再处理
        for(var m = 0; m < mcArr.length; m++){
            var item = mcArr[m];
            var r = item.r, 
                c = item.c, 
                start_r = item.start_r, 
                start_c = item.start_c, 
                end_r = item.end_r, 
                end_c = item.end_c;
            var firstcolumlen = item.firstcolumlen;

            var cell = luckysheet.flowdata[r][c];
            var value = null, er = r, ec = c, end_ec = end_c;

            var margeMaindata = cell["mc"];
            value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c, null, "m");
            
            if(value == null){
                value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c);
            }

            r = margeMaindata.r;
            c = margeMaindata.c;

            er += margeMaindata.rs;
            ec += margeMaindata.rc;

            if (c == 0) {
                start_c = -scrollWidth;
            }
            else {
                start_c = visibledatacolumn[c - 1] - scrollWidth;
            }

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }

            end_ec = visibledatacolumn[ec] - scrollWidth;

            if(value == null || value.toString().length == 0){
                nullCellRender(r, c, start_r, start_c, end_r, end_c);
                
                //sparklines渲染
                var borderfix = luckysheet.menuButton.borderfix(luckysheet.flowdata, r, c);
                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
                sparklinesRender(r, c, cellsize[0], cellsize[1], "luckysheetTableContent", luckysheetTableContent);
            }
            else{
                if((r + "_" + c) in dynamicArray_compute){//动态数组公式
                    value = dynamicArray_compute[r + "_" + c].v;
                }

                cellRender(r, c, start_r, start_c, end_r, end_c, value, "offline");
            }
        }

        //边框单独渲染
        if(config["borderInfo"] != null && config["borderInfo"].length > 0){
            //边框渲染
            var borderLeftRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + 0.5 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r + offsetTop);
                var line_st = devicePixelRatio * (start_c - 2 + 0.5 + offsetLeft);
                var line_ed = devicePixelRatio * (end_r - 2 + offsetTop);

                luckysheet.menuButton.setLineDash(canvas, linetype, "v", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderRightRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r + offsetTop);
                var line_st = devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft);
                var line_ed = devicePixelRatio * (end_r - 2 + offsetTop);

                luckysheet.menuButton.setLineDash(canvas, linetype, "v", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderBottomRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + offsetLeft);
                var m_ed = devicePixelRatio * (end_r - 2 + 0.5 + offsetTop);
                var line_st = devicePixelRatio * (end_c + offsetLeft - 2);
                var line_ed = devicePixelRatio * (end_r - 2 + 0.5 + offsetTop);

                luckysheet.menuButton.setLineDash(canvas, linetype, "h", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderTopRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r - 1 + 0.5 + offsetTop);
                var line_st = devicePixelRatio * (end_c + offsetLeft - 2);
                var line_ed = devicePixelRatio * (start_r - 1 + 0.5 + offsetTop);

                luckysheet.menuButton.setLineDash(canvas, linetype, "h", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderInfoCompute = luckysheet.getBorderInfoCompute();
            
            for(x in borderInfoCompute){
                var bd_r = x.split("_")[0], bd_c = x.split("_")[1];

                if(borderOffset[bd_r + "_" + bd_c]){
                    var start_r = borderOffset[bd_r + "_" + bd_c].start_r;
                    var start_c = borderOffset[bd_r + "_" + bd_c].start_c;
                    var end_r = borderOffset[bd_r + "_" + bd_c].end_r;
                    var end_c = borderOffset[bd_r + "_" + bd_c].end_c;

                    var borderLeft = borderInfoCompute[x].l;
                    if(borderLeft != null){
                        borderLeftRender(borderLeft.style, borderLeft.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, luckysheetTableContent);
                    }

                    var borderRight = borderInfoCompute[x].r;
                    if(borderRight != null){
                        borderRightRender(borderRight.style, borderRight.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, luckysheetTableContent);
                    }

                    var borderTop = borderInfoCompute[x].t;
                    if(borderTop != null){
                        borderTopRender(borderTop.style, borderTop.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, luckysheetTableContent);
                    }

                    var borderBottom = borderInfoCompute[x].b;
                    if(borderBottom != null){
                        borderBottomRender(borderBottom.style, borderBottom.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, luckysheetTableContent);
                    }
                }
            }
        }

        //渲染表格时有尾列时，清除右边灰色区域，防止表格有值溢出
        if(dataset_col_ed == visibledatacolumn.length - 1){
            luckysheetTableContent.clearRect(
                (fill_col_ed - scrollWidth + offsetLeft - 1) * devicePixelRatio, 
                (offsetTop - 1) * devicePixelRatio, 
                (ch_width - visibledatacolumn[dataset_col_ed]) * devicePixelRatio, 
                (fill_row_ed - scrollHeight) * devicePixelRatio
            );
        }

        if(ctx != null){
            ctx.drawImage(
                luckysheetTableElement, 
                0, 
                0, 
                drawWidth, 
                drawHeight, 
                -drawWidth/2 + offsetLeft, 
                -drawHeight/2 + offsetTop, 
                drawWidth, 
                drawHeight
            );
        }
    }
    luckysheet.luckysheetDrawMain = luckysheetDrawMain;

    //备份luckysheetDrawMain
    function luckysheetDrawMain_back(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop, columnOffsetCell, rowOffsetCell, mycanvas) {
        if (scrollWidth == null) {
            scrollWidth = $("#luckysheet-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#luckysheet-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = luckysheetTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = luckysheetTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }
        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }

        if (columnOffsetCell == null) {
            columnOffsetCell = 0;
        }
        if (rowOffsetCell == null) {
            rowOffsetCell = 0;
        }

        var luckysheetTableContent = null;
        if(mycanvas==null){
            luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
        }
        else {
            if(luckysheet.getObjType(mycanvas) == "object"){
                try{
                    luckysheetTableContent = mycanvas.get(0).getContext("2d");
                }
                catch(err){
                    luckysheetTableContent = mycanvas;
                }
            }
            else{
                luckysheetTableContent = $("#" + mycanvas).get(0).getContext("2d");
            }
        }

        //luckysheetTableContentHW = [$("#luckysheet-grid-window-1").width() - 13, $("#luckysheet-grid-window-1").height() - 13];
        //var luckysheetTableContent = $("#"+ mycanvas).get(0).getContext("2d");
        
        luckysheetTableContent.clearRect(offsetLeft*devicePixelRatio, offsetTop*devicePixelRatio, drawWidth*devicePixelRatio, drawHeight*devicePixelRatio);

        //离屏canvas
        var offlinecanvas = $("#luckysheetTableContentF").get(0).getContext("2d");
        //offlinecanvas.clearRect(0, 0, luckysheetTableContentHW[0], luckysheetTableContentHW[1]);
        offlinecanvas.fillStyle="#ffffff";
        offlinecanvas.fillRect(0, 0, luckysheetTableContentHW[0] * devicePixelRatio, luckysheetTableContentHW[1] * devicePixelRatio);


        offlinecanvas.font = luckysheetdefaultstyle.font;
        offlinecanvas.textBaseline = "top";
        offlinecanvas.fillStyle = luckysheetdefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;

        dataset_row_st = luckysheet_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = luckysheet_searcharray(visibledatarow, scrollHeight + drawHeight);

        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }

        dataset_row_st += rowOffsetCell;

        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_row_ed += rowOffsetCell;

        if (dataset_row_ed >= visibledatarow.length) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_col_st = luckysheet_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = luckysheet_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }

        dataset_col_st += columnOffsetCell;

        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }

        dataset_col_ed += columnOffsetCell;

        if (dataset_col_ed >= visibledatacolumn.length) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }


        var fill_row_st, fill_row_ed, fill_col_st, fill_col_ed;
        if(dataset_row_st==0){
            fill_row_st = 0;
        }
        else{
            fill_row_st = visibledatarow[dataset_row_st-1];
        }

        fill_row_ed = visibledatarow[dataset_row_ed];

        if(dataset_col_st==0){
            fill_col_st = 0;
        }
        else{
            fill_col_st = visibledatacolumn[dataset_col_st-1];
        }

        fill_col_ed = visibledatacolumn[dataset_col_ed];

        luckysheetTableContent.fillStyle="#ffffff";
        luckysheetTableContent.fillRect((offsetLeft - 1) * devicePixelRatio, (offsetTop - 1) * devicePixelRatio, (fill_col_ed - fill_col_st) * devicePixelRatio, (fill_row_ed - fill_row_st) * devicePixelRatio);

        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#luckysheet-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#luckysheet-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);
        var cellupdate = [];
        var mergeCache = {};
        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;


            //行
            //luckysheetTableContent.beginPath();
            //luckysheetTableContent.moveTo(0, end_r + columeHeaderHeight);
            //luckysheetTableContent.lineTo(rowHeaderWidth, end_r + columeHeaderHeight);
            //luckysheetTableContent.lineWidth = 1;
            //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //luckysheetTableContent.closePath();
            //luckysheetTableContent.stroke();


            
            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }
                end_c = visibledatacolumn[c] - scrollWidth;

                if(c==dataset_col_ed){
                    if (!luckysheetcurrentisPivotTable && end_r <= drawHeight && start_r >= -1) {
                        //行
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(offsetLeft - 1), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();

                        //luckysheetTableContent.beginPath();
                        //luckysheetTableContent.moveTo(end_c - 2 + offsetLeft, 0.5 + offsetTop);
                        //luckysheetTableContent.lineTo(end_c - 2 + offsetLeft, rh_height + offsetTop);
                        //luckysheetTableContent.lineWidth = 1;
                        //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                        //luckysheetTableContent.closePath();
                        //luckysheetTableContent.stroke();
                    }
                }

                if (r == dataset_row_st) {
                    //var abc = luckysheet.luckysheetchatatABC(c);
                    //var textMetrics = luckysheetTableContent.measureText(abc);
                    //luckysheetTableContent.fillText(abc, Math.round(start_c + offsetLeft + (end_c - start_c - textMetrics.width) / 2), Math.round(offsetTop / 2 - 2));

                    //luckysheetTableContent.clearRect(start_c + offsetLeft - 1, offsetTop-1, end_c - start_c - 1, 1);

                    // luckysheetTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight, end_c - start_c - 1, 1);

                    if (!luckysheetcurrentisPivotTable && end_c <= drawWidth + 18 && start_c >= -1) {
                        //列
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(offsetTop - 1));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(fill_row_ed - fill_row_st + offsetTop-2));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();

                        //luckysheetTableContent.beginPath();
                        //luckysheetTableContent.moveTo(0.5 + offsetLeft, end_r + offsetTop);
                        //luckysheetTableContent.lineTo(ch_width + offsetLeft, end_r + offsetTop);
                        //luckysheetTableContent.lineWidth = devicePixelRatio;
                        //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                        //luckysheetTableContent.closePath();
                        //luckysheetTableContent.stroke();
                    }
                }

                if (!!luckysheetcurrentisPivotTable && luckysheet.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                        //luckysheetTableContent.clearRect(end_c - 2 + offsetLeft, offsetTop, 2, offsetTop);
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        luckysheetTableContent.fillText("数据透视表", devicePixelRatio*(start_c + 4 + offsetLeft), devicePixelRatio*(start_r + (end_r - start_r) / 2 - 1 + offsetTop));
                    }
                }
                else if (!!luckysheetcurrentisPivotTable) {
                    if (c < luckysheet.pivotTable.pivotTableBoundary[1] && r < luckysheet.pivotTable.pivotTableBoundary[0]) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                        //luckysheetTableContent.clearRect(end_c + offsetLeft - 2, 0, 2, offsetTop);


                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        luckysheetTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }
                }

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    //&& start_r >= -2 && start_c >= -2
                    //&& end_r <= drawHeight && end_c <= drawWidth + 18
                    if (luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null && start_r >= -1 && start_c >= -1 ) {

                        var value = luckysheet.flowdata[r][c];

                        var firstcolumlen = defaultcollen;
                        if (config["columlen"] != null && config["columlen"][c] != null) {
                            firstcolumlen = config["columlen"][c];
                        }

                        if(luckysheet.getObjType(value) == "object" && ("mc" in value)){
                            
                            //console.log(value);
                            if("rs" in value["mc"]){
                                var key = "r"+ r + "c" + c;
                                mergeCache[key] = cellupdate.length;
                            }
                            else{
                                var key = "r"+ value["mc"].r + "c" + value["mc"].c;
                                var margeMain = cellupdate[mergeCache[key]];

                                if(margeMain==null){
                                    mergeCache[key] = cellupdate.length;
                                    cellupdate.push({"r":r, "c":c,"start_c":start_c, "start_r":start_r, "end_r":end_r, "end_c":end_c, "firstcolumlen":firstcolumlen, startlist:[]});
                                }
                                else{
                                    if(margeMain.c==c){
                                        margeMain.end_r += (end_r-start_r-1);
                                        margeMain.startlist.push(start_r);
                                    }
                                    
                                    if(margeMain.r==r){
                                        margeMain.end_c += (end_c-start_c);
                                        margeMain.firstcolumlen += firstcolumlen;
                                    }
                                    

                                    var margeMaindata = luckysheet.flowdata[margeMain.r][margeMain.c];
                                    if((margeMain.c + margeMaindata.mc.cs-1)==c && (margeMain.r + margeMaindata.mc.rs-1)==r){
                                        //margeMain.end_r -= 10;
                                        //margeMain.end_c -= 1;
                                    }
                                }

                                continue;
                                
                            }
                        }
                        cellupdate.push({"r":r, "c":c,"start_c":start_c, "start_r":start_r, "end_r":end_r, "end_c":end_c, "firstcolumlen":firstcolumlen, startlist:[]});
                    }
                    
                    //luckysheetTableContent.fillText("111", start_c + 4 + offsetLeft, start_r + (end_r - start_r) / 2 - 1 + offsetTop);
                    
                }

                


                //if (r == dataset_row_ed) {
                //    luckysheetTableContent.beginPath();
                //    luckysheetTableContent.moveTo(end_c + rowHeaderWidth, -0.5);
                //    luckysheetTableContent.lineTo(end_c + rowHeaderWidth, columeHeaderHeight+rh_height);
                //    luckysheetTableContent.lineWidth = 1;
                //    luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                //    luckysheetTableContent.closePath();
                //    luckysheetTableContent.stroke();
                //    console.log("end_c, rh_height", dataset_col_st, dataset_col_ed, dataset_row_st, dataset_row_ed, r_set, c_set, rowfix, $("#luckysheetsheettable_" + luckysheet.currentSheetIndex + "_" + r_set + "_" + c_set + ""), end_c, h, r,c);
                //}

            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                //luckysheetTableContent.clearRect(offsetLeft-1, start_r - 1 + offsetTop, 1, end_r - start_r - 1);

                //luckysheetTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight - 1, end_c - start_c - 1, 1);

                //var textMetrics = luckysheetTableContent.measureText(r + 1);
                //luckysheetTableContent.fillText(r + 1, (offsetLeft - textMetrics.width) / 2, start_r + (end_r - start_r) / 2 - 2 + offsetTop);
            }
            

        }



        //console.log(cellupdate)
        for(var cud=0;cud<cellupdate.length;cud++){
            //console.log(i)
            var item = cellupdate[cud];
            var r= item.r, c = item.c, start_c = item.start_c, start_r = item.start_r, end_c = item.end_c, end_r = item.end_r;
            var firstcolumlen = item.firstcolumlen;

            //offlinecanvas.fillStyle="#ffffff";
            //offlinecanvas.fillRect(0, 0, luckysheetTableContentHW[0], luckysheetTableContentHW[1]);

            //var textMetrics = luckysheetTableContent.measureText(luckysheet.flowdata[r][c]);
            var cell = luckysheet.flowdata[r][c];
            var value = null, er = r, ec = c, end_ec = end_c;
            if((typeof cell == "object") && "mc" in cell){
                var margeMaindata = cell["mc"];
                value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c, null,"m");
                if(value==null){
                    value = luckysheet.getcellvalue(margeMaindata.r, margeMaindata.c);
                }

                r = margeMaindata.r;
                c = margeMaindata.c;

                er += margeMaindata.rs;
                ec += margeMaindata.rc;

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }

                if (r == 0) {
                    start_r = -scrollHeight - 1;
                }
                else {
                    start_r = visibledatarow[r - 1] - scrollHeight - 1;
                }

                end_ec = visibledatacolumn[ec] - scrollWidth;


            }
            else{
                value = luckysheet.getcellvalue(r, c, null,"m");
                if(value==null){
                    value = luckysheet.getcellvalue(r, c);
                }
            }
            

            var borderfix = luckysheet.menuButton.borderfix(luckysheet.flowdata, r, c);
            //console.log(borderfix);
            //luckysheetTableContent.clearRect(start_c - 1 + offsetLeft, start_r + offsetTop, end_c - start_c - 1, end_r - start_r-3);
            //console.log(borderfix);
            offlinecanvas.fillStyle= luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bg");

            var cellsize = [devicePixelRatio*(start_c + offsetLeft+borderfix[0]), devicePixelRatio*(start_r + offsetTop + 0.5 +borderfix[1]), devicePixelRatio*(end_c - start_c -3+borderfix[2]), devicePixelRatio*(end_r - start_r-3 - 0.5 +borderfix[3])];
            offlinecanvas.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);


            

            // var fontsize = 13;
            // if((cell instanceof Object) && "fs" in cell){
            //     fontsize = cell.fs;
            // }

            
            // if (config["columlen"] != null && config["columlen"][c] != null) {
            //     firstcolumlen = config["columlen"][c];
            // }


            //var vformat = luckysheet.getcellformat(r, c);

            offlinecanvas.fillStyle= luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "fc");


            //console.log(fontsize);
            var fontset = luckysheetfontformat(luckysheet.flowdata[r][c]);
            offlinecanvas.font = fontset;

            var textMetrics = offlinecanvas.measureText(value).width;
            //var oneLineTextHeight = offlinecanvas.measureText("田").width;
            var oneLineTextHeight = luckysheet.menuButton.getTextSize("田", fontset)[1];
            //console.log(oneLineTextHeight,fontset);

            //console.log(textMetrics, firstcolumlen, r, c ,value);


            offlinecanvas.fillStyle= luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "fc");

            var horizonAlign = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "ht");
            var horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
            if(horizonAlign=="0"){

                // if (textMetrics > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     var mid = Math.floor(value_array.length/2), posState = true, i=1, pos = mid;
                //     while (pos>=0 && pos<value_array.length) {
                //         if(posState){
                //             v = value_array[pos] + v;
                //         }
                //         else{
                //             v += value_array[pos];
                //         }
                        
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW > firstcolumlen) {
                //             break;
                //         }

                //         if(posState){
                //             pos = mid + i;
                //         }
                //         else{
                //             pos = mid - i++;
                //         }
                //         posState = !posState;
                //     }
                //     value = v;
                // }

                //textMetrics = offlinecanvas.measureText(value).width;

                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textMetrics)/2;
                // if(horizonAlignPos<start_c + 2 + offsetLeft){
                //     horizonAlignPos = start_c + 2 + offsetLeft;
                // }
            }
            else if(horizonAlign=="2"){
                // if (textMetrics+fontsize > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     for (var i = value_array.length-1; i >=0; i--) {
                //         v = value_array[i] + v;
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW+fontsize > firstcolumlen) {
                //             break;
                //         }
                //     }
                //     value = v;
                // }

                //textMetrics = offlinecanvas.measureText(value).width;

                horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (textMetrics);
                // if(horizonAlignPos<start_c + 2 + offsetLeft){
                //     horizonAlignPos = start_c + 2 + offsetLeft;
                // }
            }
            else{
                // if (textMetrics > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     for (var i = 0; i < value_array.length; i++) {
                //         v += value_array[i];
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW > firstcolumlen) {
                //             break;
                //         }
                //     }
                //     value = v;
                // }
            }


            var verticalAlign = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "vt");
            var verticalFixed = luckysheet.browser.luckysheetrefreshfixed();
            var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight;
            if(verticalAlign=="0"){
                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight/2;
                // if(verticalAlignPos<start_r+offsetTop+8){
                //     verticalAlignPos = end_r - oneLineTextHeight + offsetTop + 1;
                // }
            }
            else if(verticalAlign=="1"){
                verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
            }

            //自动换行、旋转、删除线功能
            if(luckysheet.flowdata[r][c].tb == "2" && textMetrics > (end_c - start_c)){
                var strValue = value.toString();
                var cellWidth = end_c-start_c-8;
                var strArr = [];
                for(var strI = 1; strI <= strValue.length; strI++){
                    var strV = strValue.substring(strArr.join("").length,strI);
                    var strtextMetrics = offlinecanvas.measureText(strV).width;
                    if(strtextMetrics > cellWidth){
                        strArr.push(strValue.substring(strArr.join("").length,strI - 1));
                        strI = strI - 2;
                    }else if(strtextMetrics <= cellWidth && strI == strValue.length){
                        strArr.push(strV);
                    }
                }
                for(var iFill = 0; iFill < strArr.length; iFill++){
                    //水平对齐计算
                    var strWidth = offlinecanvas.measureText(strArr[iFill]).width;
                    if(horizonAlign == "0"){
                        horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (strWidth)/2;
                    }else if(horizonAlign == "2"){
                        horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (strWidth);
                    }else{
                        horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    }
                    //垂直对齐计算
                    if(verticalAlign == "0"){
                        verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight*strArr.length/2;
                    }else if(verticalAlign == "1"){
                        verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }else{
                        verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight*strArr.length;
                    }
                    offlinecanvas.fillText(strArr[iFill], horizonAlignPos, (verticalAlignPos+iFill*oneLineTextHeight));
                }
            }
            else if(!!luckysheet.flowdata[r][c].tr && luckysheet.flowdata[r][c].tr != "0"){
                //单元格旋转属性
                var tr = luckysheet.flowdata[r][c].tr;
                if(tr == "1" || tr == "2"){
                    //旋转重新计算水平、垂直方向坐标
                    var textW = 0.707 * (textMetrics + oneLineTextHeight);
                    var textH = 0.707 * (textMetrics + oneLineTextHeight);

                    var hAP = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    if(horizonAlign=="0"){
                        hAP = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textW)/2;
                    }
                    else if(horizonAlign=="2"){
                        hAP = (end_c + offsetLeft - 8)*devicePixelRatio - (textW);
                    }

                    var vAP = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - textH;
                    if(verticalAlign=="0"){
                        vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - textH/2;
                    }
                    else if(verticalAlign=="1"){
                        vAP = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }
                    //向下倾斜（45 旋转）
                    if(tr == "1"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP, vAP);
                        offlinecanvas.rotate(45*Math.PI/180);
                        offlinecanvas.translate(-hAP, -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP + (0.707*0.707*oneLineTextHeight), vAP - (0.707*0.707*oneLineTextHeight));
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + oneLineTextHeight/2, vAP + oneLineTextHeight/2);
                            offlinecanvas.lineTo(hAP + textW - oneLineTextHeight/2, vAP + textH - oneLineTextHeight/2);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                    //向上倾斜（-45 旋转）
                    if(tr == "2"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP + textW, vAP);
                        offlinecanvas.rotate(-45*Math.PI/180);
                        offlinecanvas.translate(-(hAP + textW), -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP - (0.707*0.707*oneLineTextHeight), vAP - (0.707*0.707*oneLineTextHeight));
                        offlinecanvas.restore();
                        
                        //是否有删除线
                        var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + oneLineTextHeight/2, vAP + textH - oneLineTextHeight/2);
                            offlinecanvas.lineTo(hAP + textW - oneLineTextHeight/2, vAP + oneLineTextHeight/2);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
                else if(tr == "3"){
                    if(!!value){
                        value = value.toString();
                        if(value.length > 1){
                            var vArr = value.split("");    
                        }
                        else{
                            var vArr = [];
                            vArr.push(value);
                        }
                        
                        var textW = offlinecanvas.measureText(vArr[0]).width;
                        var textH = vArr.length * oneLineTextHeight;
                        for(var i = 0; i < vArr.length; i++){
                            var vWidth = offlinecanvas.measureText(vArr[i]).width;
                            //水平对齐计算
                            if(horizonAlign == "0"){
                                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (vWidth)/2;
                            }else if(horizonAlign == "2"){
                                horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (vWidth);
                            }else{
                                horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
                            }
                            //垂直对齐计算
                            if(verticalAlign == "0"){
                                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight*vArr.length/2;
                            }else if(verticalAlign == "1"){
                                verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                            }else{
                                verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight*vArr.length;
                            }
                            offlinecanvas.fillText(vArr[i], horizonAlignPos, (verticalAlignPos+i*oneLineTextHeight));
                        }
                        //是否有删除线
                        var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(horizonAlignPos + textW/2, verticalAlignPos);
                            offlinecanvas.lineTo(horizonAlignPos + textW/2, verticalAlignPos + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
                else if(tr == "4" || tr == "5"){
                    //旋转重新计算水平、垂直方向坐标
                    var textW = oneLineTextHeight;
                    var textH = textMetrics;

                    var hAP = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    if(horizonAlign=="0"){
                        hAP = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textW)/2;
                    }
                    else if(horizonAlign=="2"){
                        hAP = (end_c + offsetLeft - 8)*devicePixelRatio - (textW);
                    }

                    var vAP = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - textH;
                    if(verticalAlign=="0"){
                        vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - textH/2;
                    }
                    else if(verticalAlign=="1"){
                        vAP = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }
                    //向下90（90 旋转）
                    if(tr == "4"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP, vAP);
                        offlinecanvas.rotate(90*Math.PI/180);
                        offlinecanvas.translate(-hAP, -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP, vAP - textW);
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + textW/2, vAP);
                            offlinecanvas.lineTo(hAP + textW/2, vAP + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                    //向上90（-90 旋转）
                    if(tr == "5"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP + textH, vAP);
                        offlinecanvas.rotate(-90*Math.PI/180);
                        offlinecanvas.translate(-(hAP + textH), -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP, vAP - textH);
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + textW/2, vAP);
                            offlinecanvas.lineTo(hAP + textW/2, vAP + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
            }
            else{
                //是否有删除线
                var cl = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "cl");
                if(cl == "1" && !!value){
                    luckysheetTableContent.strokeStyle = "#000000";
                    
                    offlinecanvas.beginPath();
                    offlinecanvas.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight/2);
                    offlinecanvas.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight/2);
                    offlinecanvas.closePath();
                    offlinecanvas.stroke();

                    offlinecanvas.textBaseline = "middle";
                    offlinecanvas.fillText(value==null?"":value, horizonAlignPos, verticalAlignPos + oneLineTextHeight/2);
                }
                else{
                    offlinecanvas.textBaseline = "top";
                    offlinecanvas.fillText(value==null?"":value, horizonAlignPos, verticalAlignPos);
                }
            }

            offlinecanvas.font = luckysheetdefaultstyle.font;

            //var imgData= offlinecanvas.getImageData(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            //console.log(cellsize[0], cellsize[1], cellsize[2], cellsize[3], horizonAlignPos, verticalAlignPos);

            // luckysheetTableContent.imageSmoothingEnabled = false;
            // luckysheetTableContent.mozImageSmoothingEnabled = false;
            // luckysheetTableContent.webkitImageSmoothingEnabled = false;
            // luckysheetTableContent.msImageSmoothingEnabled = false;
            // luckysheetTableContent.oImageSmoothingEnabled = false;


            luckysheetTableContent.drawImage($("#luckysheetTableContentF").get(0), cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
            

            // luckysheetTableContent.imageSmoothingEnabled = true;
            // luckysheetTableContent.mozImageSmoothingEnabled = true;
            // luckysheetTableContent.webkitImageSmoothingEnabled = true;
            // luckysheetTableContent.msImageSmoothingEnabled = true;
            // luckysheetTableContent.oImageSmoothingEnabled = true;

            //luckysheetTableContent.drawImage($("#luckysheetTableContentF").get(0), start_c - 1 + offsetLeft+borderfix[0], start_r + offsetTop+borderfix[1], end_c - start_c -2+borderfix[2], end_r - start_r-3+borderfix[3], start_c - 1 + offsetLeft+borderfix[0], start_r + offsetTop+borderfix[1], end_c - start_c -2+borderfix[2], end_r - start_r-3+borderfix[3]);

            // luckysheetTableContent.fillStyle= "#fff";
            // var clearNextCellLen = defaultcollen;
            // if (config["columlen"] != null && config["columlen"][ec +1] != null) {
            //     clearNextCellLen = config["columlen"][ec+1];
            // }
            // luckysheetTableContent.fillRect(end_ec - 3 + offsetLeft, start_r + offsetTop, clearNextCellLen, end_r - 2 -start_r-1);




            var bs = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bs");
            var bc = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bc");
            var bs_t = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bs_t");
            var bc_t = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bc_t");
            var bs_b = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bs_b");
            var bc_b = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bc_b");
            var bs_l = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bs_l");
            var bc_l = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bc_l");
            var bs_r = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bs_r");
            var bc_r = luckysheet.menuButton.checkstatus(luckysheet.flowdata, r, c , "bc_r");

            //左边框
            //console.log(r, c , value, bs_l, bc_l);
            if(bs_l!="none" || bs!="none"){
                var linetype = bs_l=="none" ?bs:bs_l;

                luckysheet.menuButton.setLineDash(luckysheetTableContent, linetype, "v", devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop), devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));

                // luckysheetTableContent.beginPath();
                // luckysheetTableContent.moveTo(start_c - 2 + offsetLeft, start_r + offsetTop);
                // luckysheetTableContent.lineTo(start_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // luckysheetTableContent.lineWidth = 1;


                luckysheetTableContent.strokeStyle = bs_l=="none" ?bc:bc_l;
                
                luckysheetTableContent.stroke();
                luckysheetTableContent.closePath();
            }
            // else{
            //     luckysheetTableContent.beginPath();
            //     luckysheetTableContent.moveTo(devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
            //     luckysheetTableContent.lineTo(devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
            //     luckysheetTableContent.lineWidth = devicePixelRatio;

            //     if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
            //         luckysheetTableContent.strokeStyle = "#000000";
            //     }
            //     else{
            //         luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //     }
                
                
            //     luckysheetTableContent.stroke();
            //     luckysheetTableContent.closePath();
            // }

            // //右边框
            if(bs_r!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_r=="none" ?bs:bs_r;

                luckysheet.menuButton.setLineDash(luckysheetTableContent, linetype, "v", devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop), devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));

                // luckysheetTableContent.beginPath();
                // luckysheetTableContent.moveTo(end_c - 2 + offsetLeft, start_r + offsetTop);
                // luckysheetTableContent.lineTo(end_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // luckysheetTableContent.lineWidth = devicePixelRatio;

                luckysheetTableContent.strokeStyle = bs_r=="none" ?bc:bc_r;
                luckysheetTableContent.stroke();
                luckysheetTableContent.closePath();
            }
            // else {
            //     luckysheetTableContent.beginPath();
            //     luckysheetTableContent.moveTo(end_c - 2 + offsetLeft, start_r + offsetTop);
            //     luckysheetTableContent.lineTo(end_c - 2 + offsetLeft, end_r - 2 + offsetTop);
            //     luckysheetTableContent.lineWidth = devicePixelRatio;

            //     luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //     luckysheetTableContent.stroke();
            //     luckysheetTableContent.closePath();
            // }

            //下边框
            if(bs_b!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_b=="none" ?bs:bs_b;

                luckysheet.menuButton.setLineDash(luckysheetTableContent, linetype, "h", devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop), devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));

                // luckysheetTableContent.beginPath();
                // luckysheetTableContent.moveTo(start_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // luckysheetTableContent.lineTo(end_c + offsetLeft-2, end_r - 2 + offsetTop);
                // luckysheetTableContent.lineWidth = devicePixelRatio;

                luckysheetTableContent.strokeStyle = bs_b=="none" ?bc:bc_b;
                luckysheetTableContent.stroke();
                luckysheetTableContent.closePath();
            }
            // else{
            //     luckysheetTableContent.beginPath();
            //     luckysheetTableContent.moveTo(devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
            //     luckysheetTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
            //     luckysheetTableContent.lineWidth = devicePixelRatio;

            //     if (!!luckysheetcurrentisPivotTable && !luckysheet.pivotTable.drawPivotTable) {
            //         luckysheetTableContent.strokeStyle = "#000000";
            //     }
            //     else{
            //         luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //     }
                
            //     luckysheetTableContent.stroke();
            //     luckysheetTableContent.closePath();
            // }

            //上边框
            if(bs_t!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_t=="none" ?bs:bs_t;

                luckysheet.menuButton.setLineDash(luckysheetTableContent, linetype, "h", devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(start_r - 1 + 0.5 + offsetTop), devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(start_r - 1 + 0.5 + offsetTop));

                // luckysheetTableContent.beginPath();
                // luckysheetTableContent.moveTo(start_c - 2 + offsetLeft, start_r - 1 + offsetTop);
                // luckysheetTableContent.lineTo(end_c + offsetLeft-2, start_r - 1 + offsetTop);
                // luckysheetTableContent.lineWidth = devicePixelRatio;

                luckysheetTableContent.strokeStyle = bs_t=="none" ?bc:bc_t;
                luckysheetTableContent.stroke();
                luckysheetTableContent.closePath();
            }

            //补全缺失的上边框
            // var startlist = item.startlist;
            // //console.log(startlist);
            // for(var i = 0;i<startlist.length;i++){
            //     luckysheetTableContent.beginPath();
                
            //     luckysheetTableContent.moveTo(end_c + offsetLeft-2, startlist[i] - 1 + offsetTop);
            //     luckysheetTableContent.lineTo(end_c + offsetLeft+ clearNextCellLen, startlist[i] - 1 + offsetTop);

            //     luckysheetTableContent.lineWidth = devicePixelRatio;
            //     luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //     luckysheetTableContent.stroke();
            //     luckysheetTableContent.closePath();
            // }

        }

        ////竖线
        //luckysheetTableContent.beginPath();
        //luckysheetTableContent.moveTo(offsetLeft - 2 , -0.5);
        //luckysheetTableContent.lineTo(offsetLeft - 2 ,rh_height + offsetTop);
        //luckysheetTableContent.lineWidth = devicePixelRatio;
        //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        //luckysheetTableContent.closePath();
        //luckysheetTableContent.stroke();


        ////横线
        //luckysheetTableContent.beginPath();
        //luckysheetTableContent.moveTo(-0.5,  -2 + offsetTop);
        //luckysheetTableContent.lineTo(ch_width + offsetLeft, -2 + offsetTop);
        //luckysheetTableContent.lineWidth = devicePixelRatio;
        //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        //luckysheetTableContent.closePath();
        //luckysheetTableContent.stroke();

        //luckysheetTableContent.clearRect(0, 0, offsetLeft - 2, offsetTop - 2);


        //luckysheetTableContent.clearRect(drawWidth > (ch_width + offsetLeft) ? (ch_width + offsetLeft - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }
    
    function luckysheetDrawgrid_c(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop) {
        if (scrollWidth == null) {
            scrollWidth = $("#luckysheet-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#luckysheet-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = luckysheetTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = luckysheetTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = 0;
        }
        if (offsetTop == null) {
            offsetTop = 0;
        }

        //luckysheetTableContentHW = [$("#luckysheet-grid-window-1").width() - 13, $("#luckysheet-grid-window-1").height() - 13];
        var luckysheetTableContent = $("#luckysheetTableContent").get(0).getContext("2d");
        luckysheetTableContent.clearRect(offsetLeft, offsetTop, drawWidth, drawHeight);


        luckysheetTableContent.font = luckysheetdefaultstyle.font;
        luckysheetTableContent.textBaseline = luckysheetdefaultstyle.textBaseline;
        luckysheetTableContent.fillStyle = luckysheetdefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;
        dataset_row_st = luckysheet_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = luckysheet_searcharray(visibledatarow, scrollHeight + drawHeight);
        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }
        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }
        dataset_col_st = luckysheet_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = luckysheet_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }
        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }
        //console.log(dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed);
        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#luckysheet-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#luckysheet-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;


            //行
            //luckysheetTableContent.beginPath();
            //luckysheetTableContent.moveTo(0, end_r + columeHeaderHeight);
            //luckysheetTableContent.lineTo(rowHeaderWidth, end_r + columeHeaderHeight);
            //luckysheetTableContent.lineWidth = devicePixelRatio;
            //luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
            //luckysheetTableContent.closePath();
            //luckysheetTableContent.stroke();



            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }
                end_c = visibledatacolumn[c] - scrollWidth;

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    //&& start_r >= -2 && start_c >= -2
                    if (luckysheet.flowdata[r] != null && luckysheet.flowdata[r][c] != null) {
                        var textMetrics = luckysheetTableContent.measureText(luckysheet.flowdata[r][c]);
                        luckysheetTableContent.clearRect(start_c + rowHeaderWidth - 1 + offsetLeft, start_r + columeHeaderHeight + offsetTop, end_c - start_c - 1, end_r - start_r);
                        luckysheetTableContent.fillText(luckysheet.flowdata[r][c], start_c + 4 + rowHeaderWidth + offsetLeft, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1 + offsetTop);

                    }
                }

                if (r == dataset_row_ed) {
                    luckysheetTableContent.clearRect(start_c + rowHeaderWidth - 1, 0, end_c - start_c - 1, columeHeaderHeight - 2);

                    if (!luckysheetcurrentisPivotTable) {
                        //列
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, 0.5 + offsetTop);
                        luckysheetTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + rh_height + offsetTop);
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }

                    var abc = luckysheet.luckysheetchatatABC(c);
                    var textMetrics = luckysheetTableContent.measureText(abc);
                    luckysheetTableContent.fillText(abc, Math.round(start_c + rowHeaderWidth + (end_c - start_c - textMetrics.width) / 2), Math.round(columeHeaderHeight / 2 - 2));
                    //console.log(abc, Math.round(start_c + (end_c - start_c) / 2), Math.round(columeHeaderHeight / 2 - 2));
                }

                if (!!luckysheetcurrentisPivotTable && luckysheet.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + start_r + offsetTop);
                        luckysheetTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + end_r - 2 + offsetTop);
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                        luckysheetTableContent.clearRect(end_c + rowHeaderWidth - 2 + offsetLeft, offsetTop, 2, columeHeaderHeight);
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(rowHeaderWidth - 1 + start_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        luckysheetTableContent.lineTo(rowHeaderWidth + end_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        luckysheetTableContent.fillText("数据透视表", start_c + 4 + rowHeaderWidth + offsetLeft, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1 + offsetTop);
                    }
                }
                else if (!!luckysheetcurrentisPivotTable) {
                    if (c < luckysheet.pivotTable.pivotTableBoundary[1] && r < luckysheet.pivotTable.pivotTableBoundary[0]) {
                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + start_r + offsetTop);
                        luckysheetTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + end_r - 2 + offsetTop);
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                        luckysheetTableContent.clearRect(end_c + rowHeaderWidth - 2, 0, 2, columeHeaderHeight);


                        luckysheetTableContent.beginPath();
                        luckysheetTableContent.moveTo(rowHeaderWidth - 1 + start_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        luckysheetTableContent.lineTo(rowHeaderWidth + end_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        luckysheetTableContent.lineWidth = devicePixelRatio;
                        luckysheetTableContent.strokeStyle = "#000000";
                        luckysheetTableContent.closePath();
                        luckysheetTableContent.stroke();
                    }
                }


                //if (r == dataset_row_ed) {
                //    luckysheetTableContent.beginPath();
                //    luckysheetTableContent.moveTo(end_c + rowHeaderWidth, -0.5);
                //    luckysheetTableContent.lineTo(end_c + rowHeaderWidth, columeHeaderHeight+rh_height);
                //    luckysheetTableContent.lineWidth = devicePixelRatio;
                //    luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                //    luckysheetTableContent.closePath();
                //    luckysheetTableContent.stroke();
                //    console.log("end_c, rh_height", dataset_col_st, dataset_col_ed, dataset_row_st, dataset_row_ed, r_set, c_set, rowfix, $("#luckysheetsheettable_" + luckysheet.currentSheetIndex + "_" + r_set + "_" + c_set + ""), end_c, h, r,c);
                //}

            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                luckysheetTableContent.clearRect(offsetLeft, start_r + columeHeaderHeight - 1 + offsetTop, rowHeaderWidth - 2, end_r - start_r - 1);
                var textMetrics = luckysheetTableContent.measureText(r + 1);
                luckysheetTableContent.fillText(r + 1, offsetLeft + (rowHeaderWidth - textMetrics.width) / 2, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 2 + offsetTop);
                //console.log((rowHeaderWidth - textMetrics.width) / 2, rowHeaderWidth, textMetrics);
            }


            if (!luckysheetcurrentisPivotTable) {
                luckysheetTableContent.beginPath();
                luckysheetTableContent.moveTo(-0.5 + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                luckysheetTableContent.lineTo(rowHeaderWidth + ch_width + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                luckysheetTableContent.lineWidth = devicePixelRatio;
                luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
                luckysheetTableContent.closePath();
                luckysheetTableContent.stroke();
            }

        }

        //竖线
        luckysheetTableContent.beginPath();
        luckysheetTableContent.moveTo(rowHeaderWidth - 2 + offsetLeft, -0.5 + offsetTop);
        luckysheetTableContent.lineTo(rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + rh_height + offsetTop);
        luckysheetTableContent.lineWidth = devicePixelRatio;
        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        luckysheetTableContent.closePath();
        luckysheetTableContent.stroke();

        //横线
        luckysheetTableContent.beginPath();
        luckysheetTableContent.moveTo(-0.5 + offsetLeft, columeHeaderHeight - 2 + offsetTop);
        luckysheetTableContent.lineTo(rowHeaderWidth + ch_width + offsetLeft, columeHeaderHeight - 2 + offsetTop);
        luckysheetTableContent.lineWidth = devicePixelRatio;
        luckysheetTableContent.strokeStyle = luckysheetdefaultstyle.strokeStyle;
        luckysheetTableContent.closePath();
        luckysheetTableContent.stroke();

        luckysheetTableContent.clearRect(offsetLeft, offsetTop, rowHeaderWidth - 2, columeHeaderHeight - 2);


        luckysheetTableContent.clearRect(drawWidth > (ch_width + rowHeaderWidth) ? (ch_width + rowHeaderWidth - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }

    luckysheet.luckysheetcreatedom = function (colwidth, rowheight, data, menu, title) {
        if(!luckysheetConfigsetting.pointEdit){
            //最少30行
            if(rowheight < 30){
                rowheight = 30;
            }

            //最少22列
            if(colwidth < 22){
                colwidth = 22;
            }
        }

        var gh = gridHTML;
        gh = luckysheet.replaceHtml(gh, { "logotitle": title });//设置title
        gh = luckysheet.replaceHtml(gh, { "menu": menuToolBar });//设置需要显示的菜单

        if (data.length == 0) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight, colwidth);
        }
        else if (data.length < rowheight && data[0].length < colwidth) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight - data.length, colwidth - data[0].length);
        }
        else if (data.length < rowheight) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, rowheight - data.length, 0);
        }
        else if (data[0].length < colwidth) {
            luckysheet.flowdata = luckysheet.datagridgrowth(data, 0, colwidth - data[0].length);
        }
        else {
            luckysheet.flowdata = data;
        }

        luckysheet.editor.webWorkerFlowDataCache(luckysheet.flowdata);//worker存数据
        
        var flowHTML = flow;
        if(config == null){
            config = {};
        }

        //列宽重置
        visibledatacolumn = [];
        ch_width = 0;
        for (var i = 0; i < colwidth; i++) {
            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][i] != null) {
                firstcolumlen = config["columlen"][i];
            }
            else {
                if (data[0] != null && data[0][i] != null) {
                    firstcolumlen = Math.ceil(luckysheet.getByteLen(data[0][i].v) * 11.5);
                    if (firstcolumlen > 300) {
                        firstcolumlen = 300;
                    }
                    else if (firstcolumlen < defaultcollen) {
                        firstcolumlen = defaultcollen;
                    }

                    if (firstcolumlen != defaultcollen) {
                        if (config["columlen"] == null) {
                            config["columlen"] = {};
                        }
                        config["columlen"][i] = firstcolumlen;
                    }
                }
            }
            ch_width += firstcolumlen + 1;
            visibledatacolumn.push(ch_width); //列的临时长度分布
        }

        //行高重置
        visibledatarow = [];
        rh_height = 0;
        for (var i = 0; i < rowheight; i++) {
            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][i] != null) {
                rowlen = config["rowlen"][i];
            }

            if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                rowlen = config["rowhidden"][i];
                visibledatarow.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            visibledatarow.push(rh_height); //行的临时长度分布
        }

        if(!luckysheetConfigsetting.pointEdit){
            //非编辑器表格编辑状态
            rh_height += 110;
            ch_width += 120;

            var addControll = '<button id="luckysheet-bottom-add-row" class="btn btn-default">添加</button><input id="luckysheet-bottom-add-row-input" type="text" class="luckysheet-datavisual-config-input luckysheet-mousedown-cancel" placeholder="100"><span style="font-size: 14px;">行</span><span style="font-size: 14px;color: #9c9c9c;">(在底部添加)</span>';
            var backControll = ' <button id="luckysheet-bottom-bottom-top" class="btn btn-default" style="">回到顶部</button>';
            // var pageControll = ' <span id="luckysheet-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ luckysheetConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (luckysheetConfigsetting.pageInfo.currentPage) +'页，每页'+ luckysheetConfigsetting.pageInfo.pageSize +'条</span> <button id="luckysheet-bottom-page-next" class="btn btn-danger" style="">下一页</button>';
            var pageControll = ' <span id="luckysheet-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ luckysheetConfigsetting.total +'条，'+ luckysheetConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (luckysheetConfigsetting.pageInfo.currentPage) +'页</span> <button id="luckysheet-bottom-page-next" class="btn btn-danger" style="">下一页</button>';
            var pageControll2 = ' <span id="luckysheet-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ luckysheetConfigsetting.total +'条，'+ luckysheetConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (luckysheetConfigsetting.pageInfo.currentPage) +'页</span>';

            var bottomControll = "";
            if(luckysheetConfigsetting.enableAddRow){
                bottomControll += addControll;
            }

            if(luckysheetConfigsetting.enablePage){
                if(parseInt(luckysheetConfigsetting.pageInfo.totalPage) == 1){
                    bottomControll += pageControll2;
                }
                else{
                    bottomControll += pageControll;
                }
            }

            bottomControll += backControll;

            var flowstr = luckysheet.replaceHtml('<div id="luckysheetcoltable_0" class="luckysheet-cell-flow-col"> <div id ="luckysheet-sheettable_0" class="luckysheet-cell-sheettable" style="height:${height}px;width:${width}px;"></div><div id="luckysheet-bottom-controll-row" class="luckysheet-bottom-controll-row"> '+ bottomControll +' </div> </div>', { "height": rh_height, "width": ch_width - 1 });
        }

        var colsheader = luckysheet.replaceHtml(columnHeaderHTML, { "width": ch_width, "index": 0, "column": "" });

        flowHTML = luckysheet.replaceHtml(flowHTML, { "width": ch_width, "flow": flowstr, "index": 0 });

        gh = luckysheet.replaceHtml(gh, { "flow": flowHTML, "rowHeader": "<div style='height:" + rh_height + "px' id='luckysheetrowHeader_0' class='luckysheetsheetchange'></div>", "columnHeader": colsheader, "functionButton": luckysheetConfigsetting.functionButton });//设置需要显示的菜单

        $("#" + container).append(gh);

        $("#luckysheet-scrollbar-x div").width(ch_width);
        $("#luckysheet-scrollbar-y div").height(rh_height - 30);

        //新建行菜单
        $("body").append(maskHTML);
        $("body").append(colsmenuHTML);
        $("body").append(rightclickHTML);
        $("body").append(inputHTML);
        $("body").append(luckysheet.replaceHtml(filtermenuHTML, { "menuid": "filter" }));
        $("body").append(luckysheet.replaceHtml(filtersubmenuHTML, { "menuid": "filter" }));
        $("body").append(sheetconfigHTML);

        //批注
        luckysheet.postil.buildAllPs(luckysheet.flowdata);
    }

    function jfexecStroke(refreshcanvas, i) {
        refreshcanvas[i++].stroke();
        if (i < refreshcanvas.length) {
            setTimeout(function () {
                jfexecStroke(refreshcanvas, i);
            }, 1000);
        }
    }

    //sparkline设置
    (function(){

        var createClass = function (/* [baseclass, [mixin, ...]], definition */) {
            var Class, args;
            Class = function () {
                this.init.apply(this, arguments);
            };
            if (arguments.length > 1) {
                if (arguments[0]) {
                    Class.prototype = $.extend(new arguments[0](), arguments[arguments.length - 1]);
                    Class._super = arguments[0].prototype;
                } else {
                    Class.prototype = arguments[arguments.length - 1];
                }
                if (arguments.length > 2) {
                    args = Array.prototype.slice.call(arguments, 1, -1);
                    args.unshift(Class.prototype);
                    $.extend.apply($, args);
                }
            } else {
                Class.prototype = arguments[0];
            }
            Class.prototype.cls = Class;
            return Class;
        };

        /**
         * Wraps a format string for tooltips
         * {{x}}
         * {{x.2}
         * {{x:months}}
         */
        var SPFormat = createClass({
            fre: /\{\{([\w.]+?)(:(.+?))?\}\}/g,
            precre: /(\w+)\.(\d+)/,

            init: function (format, fclass) {
                this.format = format;
                this.fclass = fclass;
            },

            render: function (fieldset, lookups, options) {
                var self = this,
                    fields = fieldset,
                    match, token, lookupkey, fieldvalue, prec;
                return this.format.replace(this.fre, function () {
                    var lookup;
                    token = arguments[1];
                    lookupkey = arguments[3];
                    match = self.precre.exec(token);
                    if (match) {
                        prec = match[2];
                        token = match[1];
                    } else {
                        prec = false;
                    }
                    fieldvalue = fields[token];
                    if (fieldvalue === undefined) {
                        return '';
                    }
                    if (lookupkey && lookups && lookups[lookupkey]) {
                        lookup = lookups[lookupkey];
                        if (lookup.get) { // RangeMap
                            return lookups[lookupkey].get(fieldvalue) || fieldvalue;
                        } else {
                            return lookups[lookupkey][fieldvalue] || fieldvalue;
                        }
                    }
                    if (isNumber(fieldvalue)) {
                        if (options.get('numberFormatter')) {
                            fieldvalue = options.get('numberFormatter')(fieldvalue);
                        } else {
                            fieldvalue = formatNumber(fieldvalue, prec,
                                options.get('numberDigitGroupCount'),
                                options.get('numberDigitGroupSep'),
                                options.get('numberDecimalMark'));
                        }
                    }
                    return fieldvalue;
                });
            }
        });

        // convience method to avoid needing the new operator
        $.spformat = function(format, fclass) {
            return new SPFormat(format, fclass);
        };

        var clipval = function (val, min, max) {
            if (val < min) {
                return min;
            }
            if (val > max) {
                return max;
            }
            return val;
        };

        var quartile = function (values, q) {
            var vl;
            if (q === 2) {
                vl = Math.floor(values.length / 2);
                return values.length % 2 ? values[vl] : (values[vl-1] + values[vl]) / 2;
            } else {
                if (values.length % 2 ) { // odd
                    vl = (values.length * q + q) / 4;
                    return vl % 1 ? (values[Math.floor(vl)] + values[Math.floor(vl) - 1]) / 2 : values[vl-1];
                } else { //even
                    vl = (values.length * q + 2) / 4;
                    return vl % 1 ? (values[Math.floor(vl)] + values[Math.floor(vl) - 1]) / 2 :  values[vl-1];

                }
            }
        };

        var normalizeValue = function (val) {
            var nf;
            switch (val) {
                case 'undefined':
                    val = undefined;
                    break;
                case 'null':
                    val = null;
                    break;
                case 'true':
                    val = true;
                    break;
                case 'false':
                    val = false;
                    break;
                default:
                    nf = parseFloat(val);
                    if (val == nf) {
                        val = nf;
                    }
            }
            return val;
        };

        var normalizeValues = function (vals) {
            var i, result = [];
            for (i = vals.length; i--;) {
                result[i] = normalizeValue(vals[i]);
            }
            return result;
        };


        var all = function (val, arr, ignoreNull) {
            var i;
            for (i = arr.length; i--; ) {
                if (ignoreNull && arr[i] === null) continue;
                if (arr[i] !== val) {
                    return false;
                }
            }
            return true;
        };

        // sums the numeric values in an array, ignoring other values
        var sum = function (vals) {
            var total = 0, i;
            for (i = vals.length; i--;) {
                total += typeof vals[i] === 'number' ? vals[i] : 0;
            }
            return total;
        };

        var remove = function (vals, filter) {
            var i, vl, result = [];
            for (i = 0, vl = vals.length; i < vl; i++) {
                if (vals[i] !== filter) {
                    result.push(vals[i]);
                }
            }
            return result;
        };

        var isNumber = function (num) {
            return !isNaN(parseFloat(num)) && isFinite(num);
        };

        var formatNumber = function (num, prec, groupsize, groupsep, decsep) {
            var p, i;
            num = (prec === false ? parseFloat(num).toString() : num.toFixed(prec)).split('');
            p = (p = $.inArray('.', num)) < 0 ? num.length : p;
            if (p < num.length) {
                num[p] = decsep;
            }
            for (i = p - groupsize; i > 0; i -= groupsize) {
                num.splice(i, 0, groupsep);
            }
            return num.join('');
        };


        var RangeMap = createClass({
            init: function (map) {
                var key, range, rangelist = [];
                for (key in map) {
                    if (map.hasOwnProperty(key) && typeof key === 'string' && key.indexOf(':') > -1) {
                        range = key.split(':');
                        range[0] = range[0].length === 0 ? -Infinity : parseFloat(range[0]);
                        range[1] = range[1].length === 0 ? Infinity : parseFloat(range[1]);
                        range[2] = map[key];
                        rangelist.push(range);
                    }
                }
                this.map = map;
                this.rangelist = rangelist || false;
            },

            get: function (value) {
                var rangelist = this.rangelist,
                    i, range, result;
                if ((result = this.map[value]) !== undefined) {
                    return result;
                }
                if (rangelist) {
                    for (i = rangelist.length; i--;) {
                        range = rangelist[i];
                        if (range[0] <= value && range[1] >= value) {
                            return range[2];
                        }
                    }
                }
                return undefined;
            }
        });

        // Convenience function
        $.range_map = function(map) {
            return new RangeMap(map);
        };

        luckysheet.sparkline = {
            defaultOption:{
                // Settings common to most/all chart types
                common: {
                    type: 'line',
                    lineColor: '#2ec7c9',
                    fillColor: '#CCF3F4',
                    defaultPixelsPerValue: 3,
                    width: 'auto',
                    height: 'auto',
                    composite: false,
                    tagValuesAttribute: 'values',
                    tagOptionsPrefix: 'spark',
                    enableTagOptions: false,
                    enableHighlight: true,
                    highlightLighten: 1.4,
                    tooltipSkipNull: true,
                    tooltipPrefix: '',
                    tooltipSuffix: '',
                    disableHiddenCheck: false,
                    numberFormatter: false,
                    numberDigitGroupCount: 3,
                    numberDigitGroupSep: ',',
                    numberDecimalMark: '.',
                    disableTooltips: true,
                    disableInteraction: true,
                    offsetX:0,
                    offsetY:0
                },
                // Defaults for line charts
                //=LINESPL
                line: {
                    spotColor: 0,
                    highlightSpotColor: '#5f5',
                    highlightLineColor: '#f22',
                    spotRadius: 1.5,
                    minSpotColor: 0,
                    maxSpotColor: 0,
                    lineWidth: 1,
                    normalRangeMin: undefined,
                    normalRangeMax: undefined,
                    normalRangeColor: '#ccc',
                    drawNormalOnTop: true,
                    chartRangeMin: undefined,
                    chartRangeMax: undefined,
                    chartRangeMinX: undefined,
                    chartRangeMaxX: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{y}}{{suffix}}')
                },
                // Defaults for bar charts
                bar: {
                    barColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    stackedBarColor: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    zeroColor: undefined,
                    nullColor: undefined,
                    zeroAxis: true,
                    barWidth: 4,
                    barSpacing: 1,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    colorMap: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{value}}{{suffix}}')
                },
                column: {
                    barColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    stackedBarColor: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    zeroColor: undefined,
                    nullColor: undefined,
                    zeroAxis: true,
                    barWidth: 4,
                    barSpacing: 1,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    colorMap: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{value}}{{suffix}}')
                },
                // Defaults for tristate charts
                tristate: {
                    barWidth: 4,
                    barSpacing: 1,
                    posBarColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    zeroBarColor: '#999',
                    colorMap: {},
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value:map}}'),
                    // tooltipValueLookups: { map: { '-1': 'Loss', '0': 'Draw', '1': 'Win' } }
                },
                // Defaults for discrete charts
                discrete: {
                    lineHeight: 'auto',
                    thresholdColor: "#fc5c5c",
                    thresholdValue: 0,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    // tooltipFormat: new SPFormat('{{prefix}}{{value}}{{suffix}}')
                },
                // Defaults for bullet charts
                bullet: {
                    targetColor: '#f33',
                    targetWidth: 3, // width of the target bar in pixels
                    performanceColor: '#33f',
                    rangeColors: ['#d3dafe', '#a8b6ff', '#7f94ff','#6D87FF','#5876FF','#4465FF','#2F54FF','#1A43FF','#0532FF'],
                    base: undefined, // set this to a number to change the base start number
                    // tooltipFormat: new SPFormat('{{fieldkey:fields}} - {{value}}'),
                    // tooltipValueLookups: { fields: {r: 'Range', p: 'Performance', t: 'Target'} }
                },
                // Defaults for pie charts
                pie: {
                    offset: 0,
                    sliceColors: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    borderWidth: 0,
                    borderColor: '#000',
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value}} ({{percent.1}}%)')
                },
                // Defaults for box plots
                box: {
                    raw: false,
                    boxLineColor: '#000',
                    boxFillColor: '#cdf',
                    whiskerColor: '#000',
                    outlierLineColor: '#5E5E5E',
                    outlierFillColor: '#fff',
                    medianColor: '#f00',
                    showOutliers: true,
                    outlierIQR: 1.5,
                    spotRadius: 1.5,
                    target: undefined,
                    targetColor: '#4a2',
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    // tooltipFormat: new SPFormat('{{field:fields}}: {{value}}'),
                    // tooltipFormatFieldlistKey: 'field',
                    // tooltipValueLookups: { fields: { lq: 'Lower Quartile', med: 'Median',
                    //     uq: 'Upper Quartile', lo: 'Left Outlier', ro: 'Right Outlier',
                    //     lw: 'Left Whisker', rw: 'Right Whisker'} }
                }
            },
            line:{
                type: 'line',
                init: function (el, values, options, width, height) {
                    //line._super.init.call(this, el, values, options, width, height);
                    this.vertices = [];
                    this.regionMap = [];
                    this.xvalues = [];
                    this.yvalues = [];
                    this.yminmax = [];
                    this.hightlightSpotId = null;
                    this.lastShapeId = null;
                    //this.initTarget();
                },
                getRegion: function (el, x, y) {
                    var i,
                        regionMap = this.regionMap; // maps regions to value positions
                    for (i = regionMap.length; i--;) {
                        if (regionMap[i] !== null && x >= regionMap[i][0] && x <= regionMap[i][1]) {
                            return regionMap[i][2];
                        }
                    }
                    return undefined;
                },
                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.yvalues[currentRegion] === null,
                        x: this.xvalues[currentRegion],
                        y: this.yvalues[currentRegion],
                        color: this.options.get('lineColor'),
                        fillColor: this.options.get('fillColor'),
                        offset: currentRegion
                    };
                },
                renderHighlight: function () {
                    var currentRegion = this.currentRegion,
                        target = this.target,
                        vertex = this.vertices[currentRegion],
                        options = this.options,
                        spotRadius = options.get('spotRadius'),
                        highlightSpotColor = options.get('highlightSpotColor'),
                        highlightLineColor = options.get('highlightLineColor'),
                        highlightSpot, highlightLine;

                    if (!vertex) {
                        return;
                    }
                    if (spotRadius && highlightSpotColor) {
                        highlightSpot = target.drawCircle(vertex[0], vertex[1],
                            spotRadius, undefined, highlightSpotColor);
                        this.highlightSpotId = highlightSpot.id;
                        target.insertAfterShape(this.lastShapeId, highlightSpot);
                    }
                    if (highlightLineColor) {
                        highlightLine = target.drawLine(vertex[0], this.canvasTop, vertex[0],
                            this.canvasTop + this.canvasHeight, highlightLineColor);
                        this.highlightLineId = highlightLine.id;
                        target.insertAfterShape(this.lastShapeId, highlightLine);
                    }
                },
                removeHighlight: function () {
                    var target = this.target;
                    if (this.highlightSpotId) {
                        target.removeShapeId(this.highlightSpotId);
                        this.highlightSpotId = null;
                    }
                    if (this.highlightLineId) {
                        target.removeShapeId(this.highlightLineId);
                        this.highlightLineId = null;
                    }
                },
                scanValues: function () {
                    var values = this.values,
                        valcount = values.length,
                        xvalues = this.xvalues,
                        yvalues = this.yvalues,
                        yminmax = this.yminmax,
                        i, val, isStr, isArray, sp;
                    for (i = 0; i < valcount; i++) {
                        val = values[i];
                        isStr = typeof(values[i]) === 'string';
                        isArray = typeof(values[i]) === 'object' && values[i] instanceof Array;
                        sp = isStr && values[i].split(':');
                        if (isStr && sp.length === 2) { // x:y
                            xvalues.push(Number(sp[0]));
                            yvalues.push(Number(sp[1]));
                            yminmax.push(Number(sp[1]));
                        } else if (isArray) {
                            xvalues.push(val[0]);
                            yvalues.push(val[1]);
                            yminmax.push(val[1]);
                        } else {
                            xvalues.push(i);
                            if (values[i] === null || values[i] === 'null') {
                                yvalues.push(null);
                            } else {
                                yvalues.push(Number(val));
                                yminmax.push(Number(val));
                            }
                        }
                    }
                    if (this.options.get('xvalues')) {
                        xvalues = this.options.get('xvalues');
                    }

                    this.maxy = this.maxyorg = Math.max.apply(Math, yminmax);
                    this.miny = this.minyorg = Math.min.apply(Math, yminmax);

                    this.maxx = Math.max.apply(Math, xvalues);
                    this.minx = Math.min.apply(Math, xvalues);

                    this.xvalues = xvalues;
                    this.yvalues = yvalues;
                    this.yminmax = yminmax;

                },
                processRangeOptions: function () {
                    var options = this.options,
                        normalRangeMin = options.get('normalRangeMin'),
                        normalRangeMax = options.get('normalRangeMax');

                    if (normalRangeMin !== undefined) {
                        if (normalRangeMin < this.miny) {
                            this.miny = normalRangeMin;
                        }
                        if (normalRangeMax > this.maxy) {
                            this.maxy = normalRangeMax;
                        }
                    }
                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < this.miny)) {
                        this.miny = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > this.maxy)) {
                        this.maxy = options.get('chartRangeMax');
                    }
                    if (options.get('chartRangeMinX') !== undefined && (options.get('chartRangeClipX') || options.get('chartRangeMinX') < this.minx)) {
                        this.minx = options.get('chartRangeMinX');
                    }
                    if (options.get('chartRangeMaxX') !== undefined && (options.get('chartRangeClipX') || options.get('chartRangeMaxX') > this.maxx)) {
                        this.maxx = options.get('chartRangeMaxX');
                    }

                },
                drawNormalRange: function (canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey) {
                    var normalRangeMin = this.options.get('normalRangeMin'),
                        normalRangeMax = this.options.get('normalRangeMax'),
                        ytop = canvasTop + Math.round(canvasHeight - (canvasHeight * ((normalRangeMax - this.miny) / rangey))),
                        height = Math.round((canvasHeight * (normalRangeMax - normalRangeMin)) / rangey);
                    //(x1, y1, x2, y2, lineColor, lineWidth)
                    if(height==0 && normalRangeMin==normalRangeMax){
                        height=1;
                    }
                    this.target.drawRect(canvasLeft, ytop, canvasWidth, height, undefined, this.options.get('normalRangeColor')).append();
                },
                render: function (el,userValues) {
                    this.vertices = [];
                    this.regionMap = [];
                    this.xvalues = [];
                    this.yvalues = [];
                    this.yminmax = [];
                    this.hightlightSpotId = null;
                    this.lastShapeId = null;

                    this.values = userValues;

                    var options = this.options,
                        target = this.target,

                        canvasWidth = el.mergedOptions.width,
                        canvasHeight = el.mergedOptions.height,

                        vertices = this.vertices,
                        spotRadius = options.get('spotRadius'),
                        regionMap = this.regionMap,
                        rangex, rangey, yvallast,
                        canvasTop, canvasLeft,
                        vertex, path, paths, x, y, xnext, xpos, xposnext,
                        last, next, yvalcount, lineShapes, fillShapes, plen,
                        valueSpots, hlSpotsEnabled, color, xvalues, yvalues, i;

                    // if (!line._super.render.call(this)) {
                    //     return;
                    // }

                    this.scanValues();
                    this.processRangeOptions();

                    xvalues = this.xvalues;
                    yvalues = this.yvalues;

                    if (!this.yminmax.length || this.yvalues.length < 2) {
                        // empty or all null valuess
                        return;
                    }

                    canvasTop = canvasLeft = 0;

                    rangex = this.maxx - this.minx === 0 ? 1 : this.maxx - this.minx;
                    rangey = this.maxy - this.miny === 0 ? 1 : this.maxy - this.miny;
                    yvallast = this.yvalues.length - 1;

                    if (spotRadius && (canvasWidth < (spotRadius * 4) || canvasHeight < (spotRadius * 4))) {
                        spotRadius = 0;
                    }
                    if (spotRadius) {
                        // adjust the canvas size as required so that spots will fit
                        hlSpotsEnabled = options.get('highlightSpotColor') &&  !options.get('disableInteraction');
                        if (hlSpotsEnabled || options.get('minSpotColor') || (options.get('spotColor') && yvalues[yvallast] === this.miny)) {
                            canvasHeight -= Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled || options.get('maxSpotColor') || (options.get('spotColor') && yvalues[yvallast] === this.maxy)) {
                            canvasHeight -= Math.ceil(spotRadius);
                            canvasTop += Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled ||
                             ((options.get('minSpotColor') || options.get('maxSpotColor')) && (yvalues[0] === this.miny || yvalues[0] === this.maxy))) {
                            canvasLeft += Math.ceil(spotRadius);
                            canvasWidth -= Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled || options.get('spotColor') ||
                            (options.get('minSpotColor') || options.get('maxSpotColor') &&
                                (yvalues[yvallast] === this.miny || yvalues[yvallast] === this.maxy))) {
                            canvasWidth -= Math.ceil(spotRadius);
                        }
                    }


                    canvasHeight--;

                    if (options.get('normalRangeMin') !== undefined && !options.get('drawNormalOnTop')) {
                        this.drawNormalRange(canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey);
                    }

                    path = [];
                    paths = [path];
                    last = next = null;
                    yvalcount = yvalues.length;
                    for (i = 0; i < yvalcount; i++) {
                        x = xvalues[i];
                        xnext = xvalues[i + 1];
                        y = yvalues[i];
                        xpos = canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex));
                        xposnext = i < yvalcount - 1 ? canvasLeft + Math.round((xnext - this.minx) * (canvasWidth / rangex)) : canvasWidth;
                        next = xpos + ((xposnext - xpos) / 2);
                        regionMap[i] = [last || 0, next, i];
                        last = next;
                        if (y === null) {
                            if (i) {
                                if (yvalues[i - 1] !== null) {
                                    path = [];
                                    paths.push(path);
                                }
                                vertices.push(null);
                            }
                        } else {
                            if (y < this.miny) {
                                y = this.miny;
                            }
                            if (y > this.maxy) {
                                y = this.maxy;
                            }
                            if (!path.length) {
                                // previous value was null
                                path.push([xpos, canvasTop + canvasHeight]);
                            }
                            vertex = [xpos, canvasTop + Math.round(canvasHeight - (canvasHeight * ((y - this.miny) / rangey)))];
                            path.push(vertex);
                            vertices.push(vertex);
                        }
                    }

                    lineShapes = [];
                    fillShapes = [];
                    plen = paths.length;
                    for (i = 0; i < plen; i++) {
                        path = paths[i];
                        if (path.length) {
                            if (options.get('fillColor')) {
                                path.push([path[path.length - 1][0], (canvasTop + canvasHeight)]);
                                fillShapes.push(path.slice(0));
                                path.pop();
                            }
                            // if there's only a single point in this path, then we want to display it
                            // as a vertical line which means we keep path[0]  as is
                            if (path.length > 2) {
                                // else we want the first value
                                path[0] = [path[0][0], path[1][1]];
                            }
                            lineShapes.push(path);
                        }
                    }

                    // draw the fill first, then optionally the normal range, then the line on top of that
                    plen = fillShapes.length;
                    for (i = 0; i < plen; i++) {
                        target.drawShape(fillShapes[i],
                            options.get('fillColor'), options.get('fillColor')).append();
                    }



                    plen = lineShapes.length;
                    for (i = 0; i < plen; i++) {
                        target.drawShape(lineShapes[i], options.get('lineColor'), undefined,
                            options.get('lineWidth')).append();
                    }

                    if (options.get('normalRangeMin') !== undefined && options.get('drawNormalOnTop')) {
                        this.drawNormalRange(canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey);
                    }
                    
                    if (spotRadius && options.get('valueSpots')) {
                        valueSpots = options.get('valueSpots');
                        if (valueSpots.get === undefined) {
                            valueSpots = new RangeMap(valueSpots);
                        }
                        for (i = 0; i < yvalcount; i++) {
                            color = valueSpots.get(yvalues[i]);
                            if (color) {
                                target.drawCircle(canvasLeft + Math.round((xvalues[i] - this.minx) * (canvasWidth / rangex)),
                                    canvasTop + Math.round(canvasHeight - (canvasHeight * ((yvalues[i] - this.miny) / rangey))),
                                    spotRadius, undefined,
                                    color).append();
                            }
                        }

                    }
                    if (spotRadius && options.get('spotColor') && yvalues[yvallast] !== null) {
                        target.drawCircle(canvasLeft + Math.round((xvalues[xvalues.length - 1] - this.minx) * (canvasWidth / rangex)),
                            canvasTop + Math.round(canvasHeight - (canvasHeight * ((yvalues[yvallast] - this.miny) / rangey))),
                            spotRadius, undefined,
                            options.get('spotColor')).append();
                    }
                    if (this.maxy !== this.minyorg) {
                        if (spotRadius && options.get('minSpotColor')) {
                            x = xvalues[$.inArray(this.minyorg, yvalues)];
                            target.drawCircle(canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex)),
                                canvasTop + Math.round(canvasHeight - (canvasHeight * ((this.minyorg - this.miny) / rangey))),
                                spotRadius, undefined,
                                options.get('minSpotColor')).append();
                        }
                        if (spotRadius && options.get('maxSpotColor')) {
                            x = xvalues[$.inArray(this.maxyorg, yvalues)];
                            target.drawCircle(canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex)),
                                canvasTop + Math.round(canvasHeight - (canvasHeight * ((this.maxyorg - this.miny) / rangey))),
                                spotRadius, undefined,
                                options.get('maxSpotColor')).append();
                        }
                    }

                    // this.lastShapeId = target.getLastShapeId();
                    // this.canvasTop = canvasTop;
                    // target.render();

                }
            },
            bar:{
                type: 'bar',

                init: function (el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.height;
                    var height = el.mergedOptions.width;

                    this.canvasWidth = el.mergedOptions.height;
                    this.canvasHeight = el.mergedOptions.width;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10),
                        chartRangeMin = options.get('chartRangeMin'),
                        chartRangeMax = options.get('chartRangeMax'),
                        chartRangeClip = options.get('chartRangeClip'),
                        stackMin = Infinity,
                        stackMax = -Infinity,
                        isStackString, groupMin, groupMax, stackRanges,
                        numValues, i, vlen, range, zeroAxis, xaxisOffset, min, max, clipMin, clipMax,
                        stacked, vlist, j, slen, svals, val, yoffset, yMaxCalc, canvasHeightEf;
                    //bar._super.init.call(this, el, values, options, width, height);

                    this.values = values;

                    // scan values to determine whether to stack bars
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        val = values[i];
                        isStackString = typeof(val) === 'string' && val.indexOf(':') > -1;
                        if (isStackString || $.isArray(val)) {
                            stacked = true;
                            if (isStackString) {
                                val = values[i] = normalizeValues(val.split(':'));
                            }
                            val = remove(val, null); // min/max will treat null as zero
                            groupMin = Math.min.apply(Math, val);
                            groupMax = Math.max.apply(Math, val);
                            if (groupMin < stackMin) {
                                stackMin = groupMin;
                            }
                            if (groupMax > stackMax) {
                                stackMax = groupMax;
                            }
                        }
                    }

                    this.stacked = stacked;
                    this.regionShapes = {};
                    this.barWidth = Math.floor(width/values.length)-barSpacing;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = this.barWidth + barSpacing;
                    //this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);
                    this.width = width;
                    //this.initTarget();

                    if (chartRangeClip) {
                        clipMin = chartRangeMin === undefined ? -Infinity : chartRangeMin;
                        clipMax = chartRangeMax === undefined ? Infinity : chartRangeMax;
                    }

                    numValues = [];
                    stackRanges = stacked ? [] : numValues;
                    var stackTotals = [];
                    var stackRangesNeg = [];
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        if (stacked) {
                            vlist = values[i];
                            values[i] = svals = [];
                            stackTotals[i] = 0;
                            stackRanges[i] = stackRangesNeg[i] = 0;
                            for (j = 0, slen = vlist.length; j < slen; j++) {
                                val = svals[j] = chartRangeClip ? clipval(vlist[j], clipMin, clipMax) : vlist[j];
                                if (val !== null) {
                                    if (val > 0) {
                                        stackTotals[i] += val;
                                    }
                                    if (stackMin < 0 && stackMax > 0) {
                                        if (val < 0) {
                                            stackRangesNeg[i] += Math.abs(val);
                                        } else {
                                            stackRanges[i] += val;
                                        }
                                    } else {
                                        stackRanges[i] += Math.abs(val);
                                        // stackRanges[i] += Math.abs(val - (val < 0 ? stackMax : stackMin));
                                    }
                                    numValues.push(val);
                                }
                            }
                        } else {
                            val = chartRangeClip ? clipval(values[i], clipMin, clipMax) : values[i];
                            val = values[i] = normalizeValue(val);
                            if (val !== null) {
                                numValues.push(val);
                            }
                        }
                    }
                    this.max = max = Math.max.apply(Math, numValues);
                    this.min = min = Math.min.apply(Math, numValues);
                    this.stackMax = stackMax = stacked ? Math.max.apply(Math, stackTotals) : max;
                    this.stackMin = stackMin = stacked ? Math.min.apply(Math, numValues) : min;

                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < min)) {
                        min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > max)) {
                        max = options.get('chartRangeMax');
                    }

                    this.zeroAxis = zeroAxis = options.get('zeroAxis', true);
                    if (min <= 0 && max >= 0 && zeroAxis) {
                        xaxisOffset = 0;
                    } else if (zeroAxis == false) {
                        xaxisOffset = min;
                    } else if (min > 0) {
                        xaxisOffset = 0;
                    } else {
                        xaxisOffset = max;
                    }
                    this.xaxisOffset = xaxisOffset;

                    range = stacked ? (Math.max.apply(Math, stackRanges) + Math.max.apply(Math, stackRangesNeg)) : max - xaxisOffset;

                    // as we plot zero/min values a single pixel line, we add a pixel to all other
                    // values - Reduce the effective canvas size to suit
                    this.canvasHeightEf = (zeroAxis && min < 0) ? this.canvasHeight - 2 : this.canvasHeight - 1;
                    this.isNeg = false;
                    if (min < xaxisOffset) {
                        // yMaxCalc = (stacked && max >= 0) ? stackMax : max;
                        // yoffset = (yMaxCalc - xaxisOffset) / range * this.canvasHeight;
                        yoffset = Math.floor(this.canvasHeight/2);
                        this.isNeg = true;
                        if (yoffset !== Math.ceil(yoffset)) {
                            this.canvasHeightEf -= 2;
                            yoffset = Math.ceil(yoffset);
                        }
                    } else {
                        yoffset = 0;
                    }
                    this.yoffset = yoffset;

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }

                    this.range = range;
                },

                getRegion: function (el, x, y) {
                    var result = Math.floor(x / this.totalBarWidth);
                    return (result < 0 || result >= this.values.length) ? undefined : result;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion,
                        values = ensureArray(this.values[currentRegion]),
                        result = [],
                        value, i;
                    for (i = values.length; i--;) {
                        value = values[i];
                        result.push({
                            isNull: value === null,
                            value: value,
                            color: this.calcColor(i, value, currentRegion),
                            offset: currentRegion
                        });
                    }
                    return result;
                },

                calcColor: function (stacknum, value, valuenum) {
                    var colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        options = this.options,
                        color, newColor;
                    if (this.stacked) {
                        color = options.get('stackedBarColor');
                    } else {
                        color = (value < 0) ? options.get('negBarColor') : options.get('barColor');
                    }
                    if (value === 0 && options.get('zeroColor') !== undefined) {
                        color = options.get('zeroColor');
                    }
                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    }
                    return $.isArray(color) ? color[stacknum % color.length] : color;
                },

                /**
                 * Render bar(s) for a region
                 */
                renderRegion: function (valuenum, highlight) {
                    var vals = this.values[valuenum],
                        options = this.options,
                        xaxisOffset = this.xaxisOffset,
                        result = [],
                        range = this.range,
                        stacked = this.stacked,
                        target = this.target,
                        x = valuenum * this.totalBarWidth,
                        canvasHeightEf = this.canvasHeightEf,
                        yoffset = this.yoffset,
                        y, height, color, isNull, yoffsetNeg, i, valcount, val, minPlotted, allMin;

                    vals = $.isArray(vals) ? vals : [vals];
                    valcount = vals.length;
                    val = vals[0];
                    isNull = all(null, vals);
                    allMin = all(xaxisOffset, vals, true);

                    if (isNull) {
                        if (options.get('nullColor')) {
                            color = highlight ? options.get('nullColor') : this.calcHighlightColor(options.get('nullColor'), options);
                            y = (yoffset > 0) ? yoffset - 1 : yoffset;
                            return target.drawRect(y, x, 0, this.barWidth - 1, color, color);
                        } else {
                            return undefined;
                        }
                    }
                    yoffsetNeg = yoffset;
                    if(this.isNeg){
                        canvasHeightEf = Math.floor(canvasHeightEf/2);
                    }
                    for (i = 0; i < valcount; i++) {
                        val = vals[i];

                        if (stacked && val === xaxisOffset) {
                            if (!allMin || minPlotted) {
                                continue;
                            }
                            minPlotted = true;
                        }

                        if (range > 0) {
                            height = Math.floor(canvasHeightEf * ((Math.abs(val - xaxisOffset) / range)));
                        } else {
                            height = canvasHeightEf;
                        }

                        if (val < xaxisOffset || (val === xaxisOffset && yoffset === 0)) {
                            y = yoffsetNeg - height;
                            yoffsetNeg += height;
                        } else {
                            if(stacked){
                                y = yoffset;
                                yoffset += height;
                            }
                            else{
                                y = yoffset;
                                yoffset -= height;
                            }
                            
                        }
                        color = this.calcColor(i, val, valuenum);
                        if (highlight) {
                            color = this.calcHighlightColor(color, options);
                        }
                        result.push(target.drawRect(y, x,  height - 1, this.barWidth - 1,color, color));
                    }
                    if (result.length === 1) {
                        return result[0];
                    }
                    return result;
                }
            },
            column:{
                type: 'column',

                init: function (el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10),
                        chartRangeMin = options.get('chartRangeMin'),
                        chartRangeMax = options.get('chartRangeMax'),
                        chartRangeClip = options.get('chartRangeClip'),
                        stackMin = Infinity,
                        stackMax = -Infinity,
                        isStackString, groupMin, groupMax, stackRanges,
                        numValues, i, vlen, range, zeroAxis, xaxisOffset, min, max, clipMin, clipMax,
                        stacked, vlist, j, slen, svals, val, yoffset, yMaxCalc, canvasHeightEf;
                    //bar._super.init.call(this, el, values, options, width, height);

                    this.values = values;

                    // scan values to determine whether to stack bars
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        val = values[i];
                        isStackString = typeof(val) === 'string' && val.indexOf(':') > -1;
                        if (isStackString || $.isArray(val)) {
                            stacked = true;
                            if (isStackString) {
                                val = values[i] = normalizeValues(val.split(':'));
                            }
                            val = remove(val, null); // min/max will treat null as zero
                            groupMin = Math.min.apply(Math, val);
                            groupMax = Math.max.apply(Math, val);
                            if (groupMin < stackMin) {
                                stackMin = groupMin;
                            }
                            if (groupMax > stackMax) {
                                stackMax = groupMax;
                            }
                        }
                    }

                    this.stacked = stacked;
                    this.regionShapes = {};
                    this.barWidth = Math.floor(width/values.length)-barSpacing;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = this.barWidth + barSpacing;
                    //this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);
                    this.width = width;
                    //this.initTarget();

                    if (chartRangeClip) {
                        clipMin = chartRangeMin === undefined ? -Infinity : chartRangeMin;
                        clipMax = chartRangeMax === undefined ? Infinity : chartRangeMax;
                    }

                    numValues = [];
                    stackRanges = stacked ? [] : numValues;
                    var stackTotals = [];
                    var stackRangesNeg = [];
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        if (stacked) {
                            vlist = values[i];
                            values[i] = svals = [];
                            stackTotals[i] = 0;
                            stackRanges[i] = stackRangesNeg[i] = 0;
                            for (j = 0, slen = vlist.length; j < slen; j++) {
                                val = svals[j] = chartRangeClip ? clipval(vlist[j], clipMin, clipMax) : vlist[j];
                                if (val !== null) {
                                    if (val > 0) {
                                        stackTotals[i] += val;
                                    }
                                    if (stackMin < 0 && stackMax > 0) {
                                        if (val < 0) {
                                            stackRangesNeg[i] += Math.abs(val);
                                        } else {
                                            stackRanges[i] += val;
                                        }
                                    } else {
                                        stackRanges[i] += Math.abs(val);
                                        // stackRanges[i] += Math.abs(val - (val < 0 ? stackMax : stackMin));
                                    }
                                    numValues.push(val);
                                }
                            }
                        } else {
                            val = chartRangeClip ? clipval(values[i], clipMin, clipMax) : values[i];
                            val = values[i] = normalizeValue(val);
                            if (val !== null) {
                                numValues.push(val);
                            }
                        }
                    }
                    this.max = max = Math.max.apply(Math, numValues);
                    this.min = min = Math.min.apply(Math, numValues);
                    this.stackMax = stackMax = stacked ? Math.max.apply(Math, stackTotals) : max;
                    this.stackMin = stackMin = stacked ? Math.min.apply(Math, numValues) : min;

                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < min)) {
                        min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > max)) {
                        max = options.get('chartRangeMax');
                    }

                    this.zeroAxis = zeroAxis = options.get('zeroAxis', true);
                    if (min <= 0 && max >= 0 && zeroAxis) {
                        xaxisOffset = 0;
                    } else if (zeroAxis == false) {
                        xaxisOffset = min;
                    } else if (min > 0) {
                        xaxisOffset = 0;
                    } else {
                        xaxisOffset = max;
                    }
                    this.xaxisOffset = xaxisOffset;

                    range = stacked ? (Math.max.apply(Math, stackRanges) + Math.max.apply(Math, stackRangesNeg)) : max - xaxisOffset;

                    // as we plot zero/min values a single pixel line, we add a pixel to all other
                    // values - Reduce the effective canvas size to suit
                    this.canvasHeightEf = (zeroAxis && min < 0) ? this.canvasHeight - 2 : this.canvasHeight - 1;
                    this.isNeg = false;
                    if (min < xaxisOffset) {
                        // yMaxCalc = (stacked && max >= 0) ? stackMax : max;
                        // yoffset = (yMaxCalc - xaxisOffset) / range * this.canvasHeight;
                        yoffset = Math.floor(this.canvasHeight/2);
                        this.isNeg = true;
                        if (yoffset !== Math.ceil(yoffset)) {
                            this.canvasHeightEf -= 2;
                            yoffset = Math.ceil(yoffset);
                        }
                    } else {
                        yoffset = this.canvasHeight;
                    }
                    this.yoffset = yoffset;

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }

                    this.range = range;
                },

                getRegion: function (el, x, y) {
                    var result = Math.floor(x / this.totalBarWidth);
                    return (result < 0 || result >= this.values.length) ? undefined : result;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion,
                        values = ensureArray(this.values[currentRegion]),
                        result = [],
                        value, i;
                    for (i = values.length; i--;) {
                        value = values[i];
                        result.push({
                            isNull: value === null,
                            value: value,
                            color: this.calcColor(i, value, currentRegion),
                            offset: currentRegion
                        });
                    }
                    return result;
                },

                calcColor: function (stacknum, value, valuenum) {
                    var colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        options = this.options,
                        color, newColor;
                    if (this.stacked) {
                        color = options.get('stackedBarColor');
                    } else {
                        color = (value < 0) ? options.get('negBarColor') : options.get('barColor');
                    }
                    if (value === 0 && options.get('zeroColor') !== undefined) {
                        color = options.get('zeroColor');
                    }
                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    }
                    return $.isArray(color) ? color[stacknum % color.length] : color;
                },

                /**
                 * Render bar(s) for a region
                 */
                renderRegion: function (valuenum, highlight) {
                    var vals = this.values[valuenum],
                        options = this.options,
                        xaxisOffset = this.xaxisOffset,
                        result = [],
                        range = this.range,
                        stacked = this.stacked,
                        target = this.target,
                        x = valuenum * this.totalBarWidth,
                        canvasHeightEf = this.canvasHeightEf,
                        yoffset = this.yoffset,
                        y, height, color, isNull, yoffsetNeg, i, valcount, val, minPlotted, allMin;

                    vals = $.isArray(vals) ? vals : [vals];
                    valcount = vals.length;
                    val = vals[0];
                    isNull = all(null, vals);
                    allMin = all(xaxisOffset, vals, true);

                    if (isNull) {
                        if (options.get('nullColor')) {
                            color = highlight ? options.get('nullColor') : this.calcHighlightColor(options.get('nullColor'), options);
                            y = (yoffset > 0) ? yoffset - 1 : yoffset;
                            return target.drawRect(x, y, this.barWidth - 1, 0, color, color);
                        } else {
                            return undefined;
                        }
                    }
                    yoffsetNeg = yoffset;
                    if(this.isNeg){
                        canvasHeightEf = Math.floor(canvasHeightEf/2);
                    }
                    for (i = 0; i < valcount; i++) {
                        val = vals[i];

                        if (stacked && val === xaxisOffset) {
                            if (!allMin || minPlotted) {
                                continue;
                            }
                            minPlotted = true;
                        }

                        if (range > 0) {
                            height = Math.floor(canvasHeightEf * ((Math.abs(val - xaxisOffset) / range)));
                        } else {
                            height = canvasHeightEf;
                        }

                        if (val < xaxisOffset || (val === xaxisOffset && yoffset === 0)) {
                            y = yoffsetNeg;
                            yoffsetNeg += height;
                        } else {
                            y = yoffset - height;
                            yoffset -= height;
                        }
                        color = this.calcColor(i, val, valuenum);
                        if (highlight) {
                            color = this.calcHighlightColor(color, options);
                        }
                        result.push(target.drawRect(x, y, this.barWidth - 1, height - 1, color, color));
                    }
                    if (result.length === 1) {
                        return result[0];
                    }
                    return result;
                }
            },
            tristate:{
                type: 'tristate',
                init: function(el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10);
                    //tristate._super.init.call(this, el, values, options, width, height);

                    this.regionShapes = {};
                    this.barWidth = barWidth;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = barWidth + barSpacing;
                    this.values = $.map(values, Number);
                    this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }
                    //this.initTarget();
                },

                getRegion: function (el, x, y) {
                    return Math.floor(x / this.totalBarWidth);
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        color: this.calcColor(this.values[currentRegion], currentRegion),
                        offset: currentRegion
                    };
                },

                calcColor: function (value, valuenum) {
                    var values = this.values,
                        options = this.options,
                        colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        color, newColor;

                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    } else if (values[valuenum] < 0) {
                        color = options.get('negBarColor');
                    } else if (values[valuenum] > 0) {
                        color = options.get('posBarColor');
                    } else {
                        color = options.get('zeroBarColor');
                    }
                    return color;
                },

                renderRegion: function (valuenum, highlight) {
                    var values = this.values,
                        options = this.options,
                        target = this.target,
                        canvasHeight, height, halfHeight,
                        x, y, color;

                    canvasHeight = this.canvasHeight;
                    halfHeight = Math.round(canvasHeight / 2);

                    x = valuenum * this.totalBarWidth;
                    if (values[valuenum] < 0) {
                        y = halfHeight;
                        height = halfHeight - 1;
                    } else if (values[valuenum] > 0) {
                        y = 0;
                        height = halfHeight - 1;
                    } else {
                        y = halfHeight - 1;
                        height = 2;
                    }
                    color = this.calcColor(values[valuenum], valuenum);
                    if (color === null) {
                        return;
                    }
                    if (highlight) {
                        color = this.calcHighlightColor(color, options);
                    }
                    return target.drawRect(x, y, this.barWidth - 1, height - 1, color, color);
                }
            },
            discrete:{
                type: 'discrete',

                init: function(el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    this.regionShapes = {};
                    this.values = values = $.map(values, Number);
                    this.min = Math.min.apply(Math, values);
                    this.max = Math.max.apply(Math, values);
                    this.range = this.max - this.min;
                    this.width = width;
                    this.interval = Math.floor(width / values.length);
                    this.itemWidth = width / values.length;
                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < this.min)) {
                        this.min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > this.max)) {
                        this.max = options.get('chartRangeMax');
                    }
                    //this.initTarget();
                    if (this.target) {
                        this.lineHeight = options.get('lineHeight') === 'auto' ? Math.round(this.canvasHeight * 0.3) : options.get('lineHeight');
                    }
                },

                getRegion: function (el, x, y) {
                    return Math.floor(x / this.itemWidth);
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        offset: currentRegion
                    };
                },

                renderRegion: function (valuenum, highlight) {
                    var values = this.values,
                        options = this.options,
                        min = this.min,
                        max = this.max,
                        range = this.range,
                        interval = this.interval,
                        target = this.target,
                        canvasHeight = this.canvasHeight,
                        lineHeight = this.lineHeight,
                        pheight = canvasHeight - lineHeight,
                        ytop, val, color, x;

                    val = clipval(values[valuenum], min, max);
                    x = valuenum * interval;
                    ytop = Math.round(pheight - pheight * ((val - min) / range));
                    color = (options.get('thresholdColor') && val < options.get('thresholdValue')) ? options.get('thresholdColor') : options.get('lineColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, options);
                    }
                    //return target.drawLine(x, ytop, x, ytop + lineHeight, color);

                    return this.target.drawRect(x, ytop, interval<=2?1:interval-2, lineHeight, color, color);
                }
            },
            bullet:{
                type: 'bullet',
                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var min, max, vals;
                    //bullet._super.init.call(this, el, values, options, width, height);

                    // values: target, performance, range1, range2, range3
                    this.values = values = normalizeValues(values);
                    // target or performance could be null
                    vals = values.slice();
                    vals[0] = vals[0] === null ? vals[2] : vals[0];
                    vals[1] = values[1] === null ? vals[2] : vals[1];
                    min = Math.min.apply(Math, values);
                    max = Math.max.apply(Math, values);
                    if (options.get('base') === undefined) {
                        min = min < 0 ? min : 0;
                    } else {
                        min = options.get('base');
                    }
                    this.min = min;
                    this.max = max;
                    this.range = max - min;
                    this.shapes = {};
                    this.valueShapes = {};
                    this.regiondata = {};
                    this.width = width;
                    //this.target = this.$el.simpledraw(width, height, options.get('composite'));
                    if (!values.length) {
                        this.disabled = true;
                    }
                    //this.initTarget();
                },

                getRegion: function (el, x, y) {
                    var shapeid = this.target.getShapeAt(el, x, y);
                    return (shapeid !== undefined && this.shapes[shapeid] !== undefined) ? this.shapes[shapeid] : undefined;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        fieldkey: currentRegion.substr(0, 1),
                        value: this.values[currentRegion.substr(1)],
                        region: currentRegion
                    };
                },

                changeHighlight: function (highlight) {
                    var currentRegion = this.currentRegion,
                        shapeid = this.valueShapes[currentRegion],
                        shape;
                    delete this.shapes[shapeid];
                    switch (currentRegion.substr(0, 1)) {
                        case 'r':
                            shape = this.renderRange(currentRegion.substr(1), highlight);
                            break;
                        case 'p':
                            shape = this.renderPerformance(highlight);
                            break;
                        case 't':
                            shape = this.renderTarget(highlight);
                            break;
                    }
                    this.valueShapes[currentRegion] = shape.id;
                    this.shapes[shape.id] = currentRegion;
                    this.target.replaceWithShape(shapeid, shape);
                },

                renderRange: function (rn, highlight) {
                    var rangeval = this.values[rn],
                        rangewidth = Math.round(this.canvasWidth * ((rangeval - this.min) / this.range)),
                        color = this.options.get('rangeColors')[rn - 2];
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(0, 0, rangewidth - 1, this.canvasHeight - 1, color, color);
                },

                renderPerformance: function (highlight) {
                    var perfval = this.values[1],
                        perfwidth = Math.round(this.canvasWidth * ((perfval - this.min) / this.range)),
                        color = this.options.get('performanceColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(0, Math.round(this.canvasHeight * 0.3), perfwidth - 1,
                        Math.round(this.canvasHeight * 0.4) - 1, color, color);
                },

                renderTarget: function (highlight) {
                    var targetval = this.values[0],
                        x = Math.round(this.canvasWidth * ((targetval - this.min) / this.range) - (this.options.get('targetWidth') / 2)),
                        targettop = Math.round(this.canvasHeight * 0.10),
                        targetheight = this.canvasHeight - (targettop * 2),
                        color = this.options.get('targetColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(x, targettop, this.options.get('targetWidth') - 1, targetheight - 1, color, color);
                },

                render: function (el,userValues) {
                    this.init(el,userValues);
                    var vlen = this.values.length,
                        target = this.target,
                        i, shape;
                    // if (!bullet._super.render.call(this)) {
                    //     return;
                    // }
                    for (i = 2; i < vlen; i++) {
                        shape = this.renderRange(i).append();
                        this.shapes[shape.id] = 'r' + i;
                        this.valueShapes['r' + i] = shape.id;
                    }
                    if (this.values[1] !== null) {
                        shape = this.renderPerformance().append();
                        this.shapes[shape.id] = 'p1';
                        this.valueShapes.p1 = shape.id;
                    }
                    if (this.values[0] !== null) {
                        shape = this.renderTarget().append();
                        this.shapes[shape.id] = 't0';
                        this.valueShapes.t0 = shape.id;
                    }
                    //target.render();
                }
            },
            pie:{
                type: 'pie',

                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var total = 0, i;

                    //pie._super.init.call(this, el, values, options, width, height);

                    this.shapes = {}; // map shape ids to value offsets
                    this.valueShapes = {}; // maps value offsets to shape ids
                    this.values = values = $.map(values, Number);

                    if (options.get('width') === 'auto') {
                        this.width = this.height;
                    }

                    if (values.length > 0) {
                        for (i = values.length; i--;) {
                            total += values[i];
                        }
                    }
                    this.total = total;
                    //this.initTarget();
                    this.radius = Math.floor(Math.min(this.canvasWidth, this.canvasHeight) / 2);
                },

                getRegion: function (el, x, y) {
                    var shapeid = this.target.getShapeAt(el, x, y);
                    return (shapeid !== undefined && this.shapes[shapeid] !== undefined) ? this.shapes[shapeid] : undefined;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        percent: this.values[currentRegion] / this.total * 100,
                        color: this.options.get('sliceColors')[currentRegion % this.options.get('sliceColors').length],
                        offset: currentRegion
                    };
                },

                changeHighlight: function (highlight) {
                    var currentRegion = this.currentRegion,
                         newslice = this.renderSlice(currentRegion, highlight),
                         shapeid = this.valueShapes[currentRegion];
                    delete this.shapes[shapeid];
                    this.target.replaceWithShape(shapeid, newslice);
                    this.valueShapes[currentRegion] = newslice.id;
                    this.shapes[newslice.id] = currentRegion;
                },

                renderSlice: function (valuenum, highlight) {
                    var target = this.target,
                        options = this.options,
                        radius = this.radius,
                        borderWidth = options.get('borderWidth'),
                        offset = options.get('offset'),
                        circle = 2 * Math.PI,
                        values = this.values,
                        total = this.total,
                        next = offset ? (2*Math.PI)*(offset/360) : 0,
                        start, end, i, vlen, color;

                    vlen = values.length;
                    for (i = 0; i < vlen; i++) {
                        start = next;
                        end = next;
                        if (total > 0) {  // avoid divide by zero
                            end = next + (circle * (values[i] / total));
                        }
                        if (valuenum === i) {
                            color = options.get('sliceColors')[i % options.get('sliceColors').length];
                            if (highlight) {
                                color = this.calcHighlightColor(color, options);
                            }

                            return target.drawPieSlice(radius, radius, radius - borderWidth, start, end, undefined, color);
                        }
                        next = end;
                    }
                },

                render: function (el,userValues) {
                    this.init(el,userValues);
                    var target = this.target,
                        values = this.values,
                        options = this.options,
                        radius = this.radius,
                        borderWidth = options.get('borderWidth'),
                        shape, i;

                    // if (!pie._super.render.call(this)) {
                    //     return;
                    // }
                    if (borderWidth) {
                        target.drawCircle(radius, radius, Math.floor(radius - (borderWidth / 2)),
                            options.get('borderColor'), undefined, borderWidth).append();
                    }
                    for (i = values.length; i--;) {
                        if (values[i]) { // don't render zero values
                            shape = this.renderSlice(i).append();
                            this.valueShapes[i] = shape.id; // store just the shapeid
                            this.shapes[shape.id] = i;
                        }
                    }
                    //target.render();
                }
            },
            box:{
                type: 'box',

                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    //box._super.init.call(this, el, values, options, width, height);
                    this.values = $.map(values, Number);
                    this.width = options.get('width') === 'auto' ? '4.0em' : width;
                    //this.initTarget();
                    if (!this.values.length) {
                        this.disabled = 1;
                    }
                },

                /**
                 * Simulate a single region
                 */
                getRegion: function () {
                    return 1;
                },

                getCurrentRegionFields: function () {
                    var result = [
                        { field: 'lq', value: this.quartiles[0] },
                        { field: 'med', value: this.quartiles[1] },
                        { field: 'uq', value: this.quartiles[2] }
                    ];
                    if (this.loutlier !== undefined) {
                        result.push({ field: 'lo', value: this.loutlier});
                    }
                    if (this.routlier !== undefined) {
                        result.push({ field: 'ro', value: this.routlier});
                    }
                    if (this.lwhisker !== undefined) {
                        result.push({ field: 'lw', value: this.lwhisker});
                    }
                    if (this.rwhisker !== undefined) {
                        result.push({ field: 'rw', value: this.rwhisker});
                    }
                    return result;
                },

                render:  function (el,userValues) {
                    this.init(el,userValues);

                    var target = this.target,
                        values = this.values,
                        vlen = values.length,
                        options = this.options,
                        canvasWidth = this.canvasWidth,
                        canvasHeight = this.canvasHeight,
                        minValue = options.get('chartRangeMin') === undefined ? Math.min.apply(Math, values) : options.get('chartRangeMin'),
                        maxValue = options.get('chartRangeMax') === undefined ? Math.max.apply(Math, values) : options.get('chartRangeMax'),
                        canvasLeft = 0,
                        lwhisker, loutlier, iqr, q1, q2, q3, rwhisker, routlier, i,
                        size, unitSize;

                    // if (!box._super.render.call(this)) {
                    //     return;
                    // }

                    if (options.get('raw')) {
                        if (options.get('showOutliers') && values.length > 5) {
                            loutlier = values[0];
                            lwhisker = values[1];
                            q1 = values[2];
                            q2 = values[3];
                            q3 = values[4];
                            rwhisker = values[5];
                            routlier = values[6];
                        } else {
                            lwhisker = values[0];
                            q1 = values[1];
                            q2 = values[2];
                            q3 = values[3];
                            rwhisker = values[4];
                        }
                    } else {
                        values.sort(function (a, b) { return a - b; });
                        q1 = quartile(values, 1);
                        q2 = quartile(values, 2);
                        q3 = quartile(values, 3);
                        iqr = q3 - q1;
                        if (options.get('showOutliers')) {
                            lwhisker = rwhisker = undefined;
                            for (i = 0; i < vlen; i++) {
                                if (lwhisker === undefined && values[i] > q1 - (iqr * options.get('outlierIQR'))) {
                                    lwhisker = values[i];
                                }
                                if (values[i] < q3 + (iqr * options.get('outlierIQR'))) {
                                    rwhisker = values[i];
                                }
                            }
                            loutlier = values[0];
                            routlier = values[vlen - 1];
                        } else {
                            lwhisker = values[0];
                            rwhisker = values[vlen - 1];
                        }
                    }
                    this.quartiles = [q1, q2, q3];
                    this.lwhisker = lwhisker;
                    this.rwhisker = rwhisker;
                    this.loutlier = loutlier;
                    this.routlier = routlier;

                    unitSize = canvasWidth / (maxValue - minValue + 1);
                    if (options.get('showOutliers')) {
                        canvasLeft = Math.ceil(options.get('spotRadius'));
                        canvasWidth -= 2 * Math.ceil(options.get('spotRadius'));
                        unitSize = canvasWidth / (maxValue - minValue + 1);
                        if (loutlier < lwhisker) {
                            target.drawCircle((loutlier - minValue) * unitSize + canvasLeft,
                                canvasHeight / 2,
                                options.get('spotRadius'),
                                options.get('outlierLineColor'),
                                options.get('outlierFillColor')).append();
                        }
                        if (routlier > rwhisker) {
                            target.drawCircle((routlier - minValue) * unitSize + canvasLeft,
                                canvasHeight / 2,
                                options.get('spotRadius'),
                                options.get('outlierLineColor'),
                                options.get('outlierFillColor')).append();
                        }
                    }

                    // box
                    target.drawRect(
                        Math.round((q1 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.1),
                        Math.round((q3 - q1) * unitSize),
                        Math.round(canvasHeight * 0.8),
                        options.get('boxLineColor'),
                        options.get('boxFillColor')).append();
                    // left whisker
                    target.drawLine(
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        Math.round((q1 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        options.get('lineColor')).append();
                    target.drawLine(
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 4),
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight - canvasHeight / 4),
                        options.get('whiskerColor')).append();
                    // right whisker
                    target.drawLine(Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        Math.round((q3 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        options.get('lineColor')).append();
                    target.drawLine(
                        Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 4),
                        Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight - canvasHeight / 4),
                        options.get('whiskerColor')).append();
                    // median line
                    target.drawLine(
                        Math.round((q2 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.1),
                        Math.round((q2 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.9),
                        options.get('medianColor')).append();
                    if (options.get('target')) {
                        size = Math.ceil(options.get('spotRadius'));
                        target.drawLine(
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft),
                            Math.round((canvasHeight / 2) - size),
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft),
                            Math.round((canvasHeight / 2) + size),
                            options.get('targetColor')).append();
                        target.drawLine(
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft - size),
                            Math.round(canvasHeight / 2),
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft + size),
                            Math.round(canvasHeight / 2),
                            options.get('targetColor')).append();
                    }
                    //target.render();
                }
            },
            shapeCount:0,
            shapes:{},
            shapeseq:[],
            lastShapeId:null,
            mergedOptions:null,
            init:function(userValues, userOptions){
                var extendedOptions, defaults, base;
                var userOptions = userOptions || {};
                var _this = this;
                defaults = this.defaultOption;
                base = defaults.common;
                extendedOptions = defaults[userOptions.type || base.type];

                _this.shapeCount = 0;
                _this.shapes = {};
                _this.shapeseq = [];
                _this.lastShapeId = null;

                _this.mergedOptions = $.extend({}, base, extendedOptions, userOptions);
                _this.mergedOptions.width = devicePixelRatio * _this.mergedOptions.width;
                _this.mergedOptions.height = devicePixelRatio * _this.mergedOptions.height;
                _this[_this.mergedOptions.type].render(_this, userValues);

                return { shapes:_this.shapes, shapeseq:_this.shapeseq, offsetX:_this.mergedOptions.offsetX, offsetY:_this.mergedOptions.offsetY, pixelWidth:_this.mergedOptions.width, pixelHeight:_this.mergedOptions.height};

            },
            _getContext: function (lineColor, fillColor, lineWidth) {
                if(this.ctx != null){
                    var context = this.ctx;
                }
                else{
                    var context = $("#" + this._canvasID ).get(0).getContext('2d');
                }

                if (lineColor !== undefined) {
                    context.strokeStyle = lineColor;
                }
                context.lineWidth = lineWidth === undefined ? 1 : lineWidth;
                if (fillColor !== undefined) {
                    context.fillStyle = fillColor;
                }
                return context;
            },

            reset: function () {
                var context = this._getContext();
                context.clearRect(0, 0, this.pixelWidth, this.pixelHeight);
                this.shapes = {};
                this.shapeseq = [];
                this.currentTargetShapeId = undefined;
            },

            _drawShape: function (shapeid, path, lineColor, fillColor, lineWidth) {
                var context = this._getContext(lineColor, fillColor, lineWidth),
                    i, plen;
                context.beginPath();
                context.moveTo(path[0][0] + 0.5 + this.offsetX, path[0][1] + 0.5 + this.offsetY);
                
                for (i = 1, plen = path.length; i < plen; i++) {
                    context.lineTo(path[i][0] + 0.5 + this.offsetX, path[i][1] + 0.5 + this.offsetY); // the 0.5 offset gives us crisp pixel-width lines
                }
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor !== undefined) {
                    context.fill();
                }
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX + this.offsetX, this.targetY + this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
            },

            _drawCircle: function (shapeid, x, y, radius, lineColor, fillColor, lineWidth) {
                var context = this._getContext(lineColor, fillColor, lineWidth);
                context.beginPath();
                x+=this.offsetX;
                y+=this.offsetY;
                context.arc(x, y, radius, 0, 2 * Math.PI, false);
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX+this.offsetX, this.targetY+this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor !== undefined) {
                    context.fill();
                }
            },

            _drawPieSlice: function (shapeid, x, y, radius, startAngle, endAngle, lineColor, fillColor) {
                var context = this._getContext(lineColor, fillColor);
                x+=this.offsetX;
                y+=this.offsetY;
                context.beginPath();
                context.moveTo(x, y);
                context.arc(x, y, radius, startAngle, endAngle, false);
                context.lineTo(x, y);
                context.closePath();
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor) {
                    context.fill();
                }
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX+this.offsetX, this.targetY+this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
            },

            _drawRect: function (shapeid, x, y, width, height, lineColor, fillColor) {
                // x+=this.offsetX;
                // y+=this.offsetY;
                return this._drawShape(shapeid, [[x, y], [x + width, y], [x + width, y + height], [x, y + height], [x, y]], lineColor, fillColor);
            },

            appendShape: function (shape) {
                this.shapes[shape.id] = shape;
                this.shapeseq.push(shape.id);
                this.lastShapeId = shape.id;
                return shape.id;
            },

            replaceWithShape: function (shapeid, shape) {
                var shapeseq = this.shapeseq,
                    i;
                this.shapes[shape.id] = shape;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] == shapeid) {
                        shapeseq[i] = shape.id;
                    }
                }
                delete this.shapes[shapeid];
            },

            replaceWithShapes: function (shapeids, shapes) {
                var shapeseq = this.shapeseq,
                    shapemap = {},
                    sid, i, first;

                for (i = shapeids.length; i--;) {
                    shapemap[shapeids[i]] = true;
                }
                for (i = shapeseq.length; i--;) {
                    sid = shapeseq[i];
                    if (shapemap[sid]) {
                        shapeseq.splice(i, 1);
                        delete this.shapes[sid];
                        first = i;
                    }
                }
                for (i = shapes.length; i--;) {
                    shapeseq.splice(first, 0, shapes[i].id);
                    this.shapes[shapes[i].id] = shapes[i];
                }

            },

            insertAfterShape: function (shapeid, shape) {
                var shapeseq = this.shapeseq,
                    i;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] === shapeid) {
                        shapeseq.splice(i + 1, 0, shape.id);
                        this.shapes[shape.id] = shape;
                        return;
                    }
                }
            },

            removeShapeId: function (shapeid) {
                var shapeseq = this.shapeseq,
                    i;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] === shapeid) {
                        shapeseq.splice(i, 1);
                        break;
                    }
                }
                delete this.shapes[shapeid];
            },

            getShapeAt: function (el, x, y) {
                this.targetX = x;
                this.targetY = y;
                this.render();
                return this.currentTargetShapeId;
            },
            _canvasID:"luckysheetTableContent",
            render: function (shapeseq, shapes, offsetX, offsetY, pixelWidth, pixelHeight,canvasid,ctx) {
                if(canvasid==null){
                    canvasid = "luckysheetTableContent";
                }
                this._canvasID = canvasid;

                if(ctx != null){
                    this.ctx = ctx;
                }

                var shapeCount = shapeseq.length,
                    context = this._getContext(),
                    shapeid, shape, i;
                this.offsetX = offsetX;
                this.offsetY = offsetY;
                this.pixelWidth = pixelWidth;
                this.pixelHeight = pixelHeight;
                //context.clearRect(this.offsetX, this.offsetY, this.pixelWidth, this.pixelHeight);

                // qkSparkSetting.currentSparkVlaue = {
                //     shapeseq : shapeseq,
                //     shapes:shapes,
                //     shapeCount:shapeCount,
                //     el:this
                // }

                for (i = 0; i < shapeCount; i++) {
                    shapeid = shapeseq[i];
                    shape = shapes[shapeid];
                    this['_draw' + shape.type].apply(this, shape.args);
                }
                // if (!this.interact) {
                //     // not interactive so no need to keep the shapes array
                //     this.shapes = {};
                //     this.shapeseq = [];
                // }
            },
            drawLine: function (x1, y1, x2, y2, lineColor, lineWidth) {
                return this.drawShape([[x1, y1], [x2, y2]], lineColor, lineWidth);
            },

            drawShape: function (path, lineColor, fillColor, lineWidth) {
                return this._genShape('Shape', [path, lineColor, fillColor, lineWidth]);
            },

            drawCircle: function (x, y, radius, lineColor, fillColor, lineWidth) {
                return this._genShape('Circle', [x, y, radius, lineColor, fillColor, lineWidth]);
            },

            drawPieSlice: function (x, y, radius, startAngle, endAngle, lineColor, fillColor) {
                return this._genShape('PieSlice', [x, y, radius, startAngle, endAngle, lineColor, fillColor]);
            },

            drawRect: function (x, y, width, height, lineColor, fillColor) {
                return this._genShape('Rect', [x, y, width, height, lineColor, fillColor]);
            },
            _genShape: function (shapetype, shapeargs) {
                var id = this.shapeCount++;
                shapeargs.unshift(id);
                // return new VShape(this, id, shapetype, shapeargs);
                // this.target = target;
                // this.id = id;
                // this.type = type;
                // this.args = args;
                var shape = { id:id, type:shapetype, args:shapeargs };
                this.shapes[id] = shape;
                this.shapeseq.push(id);
                this.lastShapeId = id;
                return {
                    append:function(){
                        return shape;
                    },
                    get:function(){
                        return id;
                    }
                };
            }

        }

        var barHighlightMixin = {
            changeHighlight: function (highlight) {
                var currentRegion = this.currentRegion,
                    target = this.target,
                    shapeids = this.regionShapes[currentRegion],
                    newShapes;
                // will be null if the region value was null
                if (shapeids) {
                    newShapes = this.renderRegion(currentRegion, highlight);
                    if ($.isArray(newShapes) || $.isArray(shapeids)) {
                        target.replaceWithShapes(shapeids, newShapes);
                        this.regionShapes[currentRegion] = $.map(newShapes, function (newShape) {
                            return newShape.id;
                        });
                    } else {
                        target.replaceWithShape(shapeids, newShapes);
                        this.regionShapes[currentRegion] = newShapes.id;
                    }
                }
            },
            render: function (el,userValues) {
                this.init(el, userValues);
                var values = this.values,
                    target = this.target,
                    regionShapes = this.regionShapes,
                    shapes, ids, i, j;

                // if (!this.cls._super.render.call(this)) {
                //     return;
                // }
                for (i = values.length; i--;) {
                    shapes = this.renderRegion(i);
                    if (shapes) {
                        if ($.isArray(shapes)) {
                            ids = [];
                            for (j = shapes.length; j--;) {
                                shapes[j].append();
                                ids.push(shapes[j].id);
                            }
                            regionShapes[i] = ids;
                        } else {
                            shapes.append();
                            regionShapes[i] = shapes.id; // store just the shapeid
                        }
                    } else {
                        // null value
                        regionShapes[i] = null;
                    }
                }
                //target.render();
            }
        };

        var _luckysheetSparkLineOptions = {
            get:function(type){
                return luckysheet.sparkline.mergedOptions[type];
            }
        }

        var _luckysheetSparkLineTarget = {
            drawLine:function(x1, y1, x2, y2, lineColor, lineWidth){
                return luckysheet.sparkline.drawLine(x1, y1, x2, y2, lineColor, lineWidth);
            },

            drawShape:function(path, lineColor, fillColor, lineWidth){
                return luckysheet.sparkline.drawShape(path, lineColor, fillColor, lineWidth);
            },

            drawCircle:function(x, y, radius, lineColor, fillColor, lineWidth){
                return luckysheet.sparkline.drawCircle(x, y, radius, lineColor, fillColor, lineWidth);
            },

            drawPieSlice:function(x, y, radius, startAngle, endAngle, lineColor, fillColor){
                return luckysheet.sparkline.drawPieSlice(x, y, radius, startAngle, endAngle, lineColor, fillColor);
            },

            drawRect:function(x, y, width, height, lineColor, fillColor){
                return luckysheet.sparkline.drawRect(x, y, width, height, lineColor, fillColor);
            }
        }

        // luckysheet.sparkline.line.options = _luckysheetSparkLineOptions;
        // luckysheet.sparkline.line.target = _luckysheetSparkLineTarget;

        // luckysheet.sparkline.bar.options = _luckysheetSparkLineOptions;
        // luckysheet.sparkline.bar.target = _luckysheetSparkLineTarget;

        for(let item in luckysheet.sparkline){
            if(item in {"line":null, "bar":null, "column":null, "tristate":null, "discrete":null, "bullet":null, "pie":null, "box":null}){
                luckysheet.sparkline[item].options = _luckysheetSparkLineOptions;
                luckysheet.sparkline[item].target = _luckysheetSparkLineTarget;
            }

            if(item in {"bar":null, "column":null, "tristate":null, "discrete":null}){
                luckysheet.sparkline[item].changeHighlight = barHighlightMixin.changeHighlight;
                luckysheet.sparkline[item].render = barHighlightMixin.render;
            }
        }

        // setTimeout(function(){
        //     var temp1 = luckysheet.sparkline.init([ 1, 3, 5, 8, 10, 15, 18 ], { height:20,width:100,offsetX:100,offsetY:50, type:'box', raw: true, showOutliers:true, target: 6 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([20,50,80], { height:60,width:60,offsetX:100,offsetY:150, type: 'pie' }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([10,12,12,9,7], { height:20,width:100,offsetX:100,offsetY:250, type: 'bullet' }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([4,6,7,7,4,3,2,1,4,4,5,6,7,6,6,2,4,5], { height:20,width:100,offsetX:100,offsetY:350, type: 'discrete', thresholdValue: 4  }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([1,2,0,5,-1,-2,1,-4,0,0,1,1], { type: 'tristate',height:20,width:100,offsetX:300,offsetY:150, colorMap: {'-2': '#fa7', '2': '#44f'}  }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([10,5,3], { type: 'bar',height:30,width:20,offsetX:300,offsetY:250 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([4,1,5,7,9,9,8,7,6,6,4,7,8,4,3,2,2,5,6,7], { height:50,width:90,normalRangeMin:6,normalRangeMax:6,normalRangeColor:"#000" });luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,300*devicePixelRatio,50*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init([10,8,3,-5,5,8,-9], { type: 'bar',height:40,width:60,offsetX:300,offsetY:350 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init(["0:2:12","2:6:10","7:2:5","4:10:8","10:1:4"], { type: 'bar',height:40,width:60,offsetX:500,offsetY:50 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init(["0:2","2:4","4:2","4:1"], { type: 'bar',height:40,width:60,offsetX:500,offsetY:150 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = luckysheet.sparkline.init(["0:2","2:4","4:2","4:1"], { type: 'column',height:40,width:60,offsetX:500,offsetY:250 }) ; luckysheet.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        // },3000);

    })();

    // window.luckysheet = luckysheet;
    // window.luckysheetConfigsetting = luckysheetConfigsetting;
    // return luckysheet;
    export default luckysheet;
    export {
        luckysheetCellUpdate
    }

// })();